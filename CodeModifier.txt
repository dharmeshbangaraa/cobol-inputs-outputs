*****************************************************************
* TRANSACTION RECORD STRUCTURE
* VERSION: 1.1
* DATE: 2024
*****************************************************************
 01  TRANSACTION-RECORD.
     05  TRN-KEY.
         10  TRN-DATE           PIC X(08).
         10  TRN-TIME           PIC X(06).
         10  TRN-PORTFOLIO-ID   PIC X(08).
         10  TRN-SEQUENCE-NO    PIC X(06).
     05  TRN-DATA.
         10  TRN-INVESTMENT-ID  PIC X(10).
         10  TRN-TYPE           PIC X(02).
             88  TRN-TYPE-BUY     VALUE 'BU'.
             88  TRN-TYPE-SELL    VALUE 'SL'.
             88  TRN-TYPE-TRANS   VALUE 'TR'.
             88  TRN-TYPE-FEE     VALUE 'FE'.
         10  TRN-QUANTITY       PIC S9(11)V9(4) COMP-3.
         10  TRN-PRICE         PIC S9(11)V9(4) COMP-3.
         10  TRN-AMOUNT        PIC S9(13)V9(2) COMP-3.
         10  TRN-CURRENCY      PIC X(03).
         10  TRN-STATUS        PIC X(01).
             88  TRN-STATUS-PEND   VALUE 'P'.
             88  TRN-STATUS-DONE   VALUE 'D'.
             88  TRN-STATUS-FAIL   VALUE 'F'.
             88  TRN-STATUS-REV    VALUE 'R'.
         10  CHANNEL-CODE      PIC X(04). *> Added for channel identification
     05  TRN-AUDIT.
         10  TRN-PROCESS-DATE  PIC X(26).
         10  TRN-PROCESS-USER  PIC X(08).
     05  TRN-FILLER           PIC X(46). *> Reduced by 4 to accommodate CHANNEL-CODE
*****************************************************************
* FIELD DESCRIPTIONS:
* TRN-DATE        : TRANSACTION DATE (YYYYMMDD)
* TRN-TIME        : TRANSACTION TIME (HHMMSS)
* TRN-PORTFOLIO-ID: PORTFOLIO IDENTIFIER
* TRN-SEQUENCE-NO : SEQUENCE NUMBER FOR MULTIPLE TRANS
* TRN-TYPE        : BU=BUY, SL=SELL, TR=TRANSFER, FE=FEE
* TRN-STATUS      : P=PENDING, D=DONE, F=FAILED, R=REVERSED
* CHANNEL-CODE    : CHANNEL IDENTIFICATION (NEW FIELD)
*****************************************************************

IDENTIFICATION DIVISION.
PROGRAM-ID. RPTPOS00.
AUTHOR. CLAUDE.
DATE-WRITTEN. 2024-04-09.
*****************************************************************
* Daily Position Report Generator                                 *
*                                                               *
* This program generates the daily position report including:    *
* - Portfolio position summary                                   *
* - Transaction activity                                         *
* - Exception reporting                                          *
* - Performance metrics                                          *
*****************************************************************
ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT POSITION-MASTER ASSIGN TO POSMSTRE
        ORGANIZATION IS INDEXED
        ACCESS MODE IS SEQUENTIAL
        RECORD KEY IS POS-KEY
        FILE STATUS IS WS-POSITION-STATUS.

    SELECT TRANSACTION-HISTORY ASSIGN TO TRANHIST
        ORGANIZATION IS INDEXED
        ACCESS MODE IS SEQUENTIAL
        RECORD KEY IS TRAN-KEY
        FILE STATUS IS WS-TRAN-STATUS.

    SELECT REPORT-FILE ASSIGN TO RPTFILE
        ORGANIZATION IS SEQUENTIAL
        FILE STATUS IS WS-REPORT-STATUS.

DATA DIVISION.
FILE SECTION.
    COPY POSREC.
    COPY TRNREC.
    
FD  REPORT-FILE
    RECORDING MODE IS F
    BLOCK CONTAINS 0 RECORDS.
01  REPORT-RECORD             PIC X(132).

WORKING-STORAGE SECTION.
    COPY RTNCODE.
    COPY ERRHAND.

01  WS-FILE-STATUS.
    05  WS-POSITION-STATUS    PIC XX.
    05  WS-TRAN-STATUS        PIC XX.
    05  WS-REPORT-STATUS      PIC XX.

01  WS-REPORT-HEADERS.
    05  WS-HEADER1.
        10  FILLER            PIC X(132) VALUE ALL '*'.
    05  WS-HEADER2.
        10  FILLER            PIC X(40) VALUE SPACES.
        10  FILLER            PIC X(52) 
            VALUE 'DAILY POSITION REPORT'.
        10  FILLER            PIC X(40) VALUE SPACES.
    05  WS-HEADER3.
        10  FILLER            PIC X(15) VALUE 'REPORT DATE:'.
        10  WS-REPORT-DATE    PIC X(10).
        10  FILLER            PIC X(107) VALUE SPACES.

01  WS-POSITION-DETAIL.
    05  WS-POS-PORTFOLIO     PIC X(10).
    05  FILLER               PIC X(2) VALUE SPACES.
    05  WS-POS-DESCRIPTION   PIC X(30).
    05  FILLER               PIC X(2) VALUE SPACES.
    05  WS-POS-QUANTITY      PIC ZZZ,ZZZ,ZZ9.99.
    05  FILLER               PIC X(2) VALUE SPACES.
    05  WS-POS-VALUE         PIC $$$$,$$$,$$9.99.
    05  FILLER               PIC X(2) VALUE SPACES.
    05  WS-POS-CHANGE-PCT    PIC +ZZ9.99.
    05  FILLER               PIC X(40) VALUE SPACES.

01  WS-TRANSACTION-DETAIL.
    05  WS-TRAN-DATE         PIC X(8).
    05  WS-TRAN-TIME         PIC X(6).
    05  WS-TRAN-PORTFOLIO    PIC X(8).
    05  WS-TRAN-SEQUENCE     PIC X(6).
    05  WS-TRAN-INVESTMENT   PIC X(10).
    05  WS-TRAN-TYPE         PIC X(2).
    05  WS-TRAN-QUANTITY     PIC S9(11)V9(4).
    05  WS-TRAN-AMOUNT       PIC S9(13)V9(2).
    05  WS-TRAN-CURRENCY     PIC X(3).
    05  WS-TRAN-STATUS       PIC X(1).
    05  WS-TRAN-CHANNEL      PIC X(4). *> Added for CHANNEL-CODE

PROCEDURE DIVISION.
0000-MAIN.
    PERFORM 1000-INITIALIZE
    PERFORM 2000-PROCESS-REPORT
    PERFORM 3000-CLEANUP
    GOBACK.

1000-INITIALIZE.
    PERFORM 1100-OPEN-FILES
    PERFORM 1200-WRITE-HEADERS.

1100-OPEN-FILES.
    OPEN INPUT POSITION-MASTER
    IF WS-POSITION-STATUS NOT = '00'
        MOVE 'ERROR OPENING POSITION MASTER'
          TO WS-ERROR-MESSAGE
        PERFORM 9999-ERROR-HANDLER
    END-IF

    OPEN INPUT TRANSACTION-HISTORY
    IF WS-TRAN-STATUS NOT = '00'
        MOVE 'ERROR OPENING TRANSACTION HISTORY'
          TO WS-ERROR-MESSAGE
        PERFORM 9999-ERROR-HANDLER
    END-IF

    OPEN OUTPUT REPORT-FILE
    IF WS-REPORT-STATUS NOT = '00'
        MOVE 'ERROR OPENING REPORT FILE'
          TO WS-ERROR-MESSAGE
        PERFORM 9999-ERROR-HANDLER
    END-IF.

1200-WRITE-HEADERS.
    ACCEPT WS-REPORT-DATE FROM DATE
    WRITE REPORT-RECORD FROM WS-HEADER1
    WRITE REPORT-RECORD FROM WS-HEADER2
    WRITE REPORT-RECORD FROM WS-HEADER3.

2000-PROCESS-REPORT.
    PERFORM 2100-READ-POSITIONS
    PERFORM 2200-PROCESS-TRANSACTIONS
    PERFORM 2300-WRITE-SUMMARY.

2100-READ-POSITIONS.
    READ POSITION-MASTER
        AT END SET END-OF-POSITIONS TO TRUE
    END-READ
    
    PERFORM UNTIL END-OF-POSITIONS
        PERFORM 2110-FORMAT-POSITION
        READ POSITION-MASTER
            AT END SET END-OF-POSITIONS TO TRUE
        END-READ
    END-PERFORM.

2110-FORMAT-POSITION.
    MOVE POS-PORTFOLIO-ID   TO WS-POS-PORTFOLIO
    MOVE POS-DESCRIPTION    TO WS-POS-DESCRIPTION
    MOVE POS-QUANTITY       TO WS-POS-QUANTITY
    MOVE POS-CURRENT-VALUE  TO WS-POS-VALUE
    COMPUTE WS-POS-CHANGE-PCT = 
        (POS-CURRENT-VALUE - POS-PREVIOUS-VALUE) /
         POS-PREVIOUS-VALUE * 100
    WRITE REPORT-RECORD FROM WS-POSITION-DETAIL.

2200-PROCESS-TRANSACTIONS.
    PERFORM 2210-READ-TRANSACTIONS
    PERFORM 2220-SUMMARIZE-ACTIVITY.

2210-READ-TRANSACTIONS.
    READ TRANSACTION-HISTORY
        AT END
            EXIT PERFORM
        NOT AT END
            MOVE TRN-DATE           TO WS-TRAN-DATE
            MOVE TRN-TIME           TO WS-TRAN-TIME
            MOVE TRN-PORTFOLIO-ID   TO WS-TRAN-PORTFOLIO
            MOVE TRN-SEQUENCE-NO    TO WS-TRAN-SEQUENCE
            MOVE TRN-INVESTMENT-ID  TO WS-TRAN-INVESTMENT
            MOVE TRN-TYPE           TO WS-TRAN-TYPE
            MOVE TRN-QUANTITY       TO WS-TRAN-QUANTITY
            MOVE TRN-AMOUNT         TO WS-TRAN-AMOUNT
            MOVE TRN-CURRENCY       TO WS-TRAN-CURRENCY
            MOVE TRN-STATUS         TO WS-TRAN-STATUS
            MOVE CHANNEL-CODE       TO WS-TRAN-CHANNEL *> Added for channel identification
            WRITE REPORT-RECORD FROM WS-TRANSACTION-DETAIL
    END-READ.

2300-WRITE-SUMMARY.
    PERFORM 2310-WRITE-TOTALS
    PERFORM 2320-WRITE-EXCEPTIONS
    PERFORM 2330-WRITE-METRICS.

3000-CLEANUP.
    CLOSE POSITION-MASTER
         TRANSACTION-HISTORY
         REPORT-FILE.

9999-ERROR-HANDLER.
    DISPLAY WS-ERROR-MESSAGE
    MOVE 12 TO RETURN-CODE
    GOBACK.

IDENTIFICATION DIVISION.
PROGRAM-ID. UTLVAL00.
AUTHOR. CLAUDE.
DATE-WRITTEN. 2024-04-09.
*****************************************************************
* Data Validation Utility                                        *
*                                                               *
* Performs comprehensive data validation:                       *
* - Data integrity checks                                      *
* - Cross-reference validation                                 *
* - Format verification                                        *
* - Balance reconciliation                                     *
*****************************************************************
ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
SPECIAL-NAMES.
    CONSOLE IS CONS.
    
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT VALIDATION-CONTROL ASSIGN TO VALCTL
        ORGANIZATION IS SEQUENTIAL
        ACCESS MODE IS SEQUENTIAL
        FILE STATUS IS WS-VAL-STATUS.

    SELECT POSITION-MASTER ASSIGN TO POSMSTRE
        ORGANIZATION IS INDEXED
        ACCESS MODE IS DYNAMIC
        RECORD KEY IS POS-KEY
        FILE STATUS IS WS-POS-STATUS.

    SELECT TRANSACTION-HISTORY ASSIGN TO TRANHIST
        ORGANIZATION IS INDEXED
        ACCESS MODE IS DYNAMIC
        RECORD KEY IS TRAN-KEY
        FILE STATUS IS WS-TRAN-STATUS.

    SELECT ERROR-REPORT ASSIGN TO ERRRPT
        ORGANIZATION IS SEQUENTIAL
        FILE STATUS IS WS-RPT-STATUS.

DATA DIVISION.
FILE SECTION.
    COPY POSREC.
    COPY TRNREC.
    
FD  VALIDATION-CONTROL
    RECORDING MODE IS F
    BLOCK CONTAINS 0 RECORDS.
01  VALIDATION-RECORD.
    05  VAL-TYPE             PIC X(10).
    05  VAL-PARAMETERS       PIC X(70).

FD  ERROR-REPORT
    RECORDING MODE IS F
    BLOCK CONTAINS 0 RECORDS.
01  ERROR-RECORD            PIC X(132).

WORKING-STORAGE SECTION.
    COPY RTNCODE.
    COPY ERRHAND.

01  WS-FILE-STATUS.
    05  WS-VAL-STATUS        PIC XX.
    05  WS-POS-STATUS        PIC XX.
    05  WS-TRAN-STATUS       PIC XX.
    05  WS-RPT-STATUS        PIC XX.

01  WS-VALIDATION-TYPES.
    05  WS-INTEGRITY         PIC X(10) VALUE 'INTEGRITY'.
    05  WS-XREF              PIC X(10) VALUE 'XREF'.
    05  WS-FORMAT            PIC X(10) VALUE 'FORMAT'.
    05  WS-BALANCE           PIC X(10) VALUE 'BALANCE'.

01  WS-PROCESSING-FLAGS.
    05  WS-END-OF-VAL        PIC X VALUE 'N'.
        88  END-OF-VALIDATION VALUE 'Y'.
    05  WS-ERROR-FOUND       PIC X VALUE 'N'.
        88  ERROR-FOUND      VALUE 'Y'.

01  WS-VALIDATION-TOTALS.
    05  WS-RECORDS-READ      PIC 9(9) VALUE ZERO.
    05  WS-RECORDS-VALID     PIC 9(9) VALUE ZERO.
    05  WS-RECORDS-ERROR     PIC 9(9) VALUE ZERO.
    05  WS-TOTAL-AMOUNT      PIC S9(15)V99 VALUE ZERO.
    05  WS-CONTROL-TOTAL     PIC S9(15)V99 VALUE ZERO.

01  WS-ERROR-LINE.
    05  WS-ERR-TYPE          PIC X(10).
    05  FILLER               PIC X(2) VALUE SPACES.
    05  WS-ERR-KEY           PIC X(20).
    05  FILLER               PIC X(2) VALUE SPACES.
    05  WS-ERR-DESC          PIC X(98).

01  WS-TRAN-CHANNEL-CODE     PIC X(4). *> Added for CHANNEL-CODE validation

PROCEDURE DIVISION.
0000-MAIN.
    PERFORM 1000-INITIALIZE
    PERFORM 2000-PROCESS
    PERFORM 3000-CLEANUP
    GOBACK.

1000-INITIALIZE.
    PERFORM 1100-OPEN-FILES
    PERFORM 1200-INIT-PROCESSING.

1100-OPEN-FILES.
    OPEN INPUT VALIDATION-CONTROL
    IF WS-VAL-STATUS NOT = '00'
        MOVE 'ERROR OPENING VALIDATION CONTROL'
          TO WS-ERROR-MESSAGE
        PERFORM 9999-ERROR-HANDLER
    END-IF

    OPEN INPUT POSITION-MASTER
    IF WS-POS-STATUS NOT = '00'
        MOVE 'ERROR OPENING POSITION MASTER'
          TO WS-ERROR-MESSAGE
        PERFORM 9999-ERROR-HANDLER
    END-IF

    OPEN INPUT TRANSACTION-HISTORY
    IF WS-TRAN-STATUS NOT = '00'
        MOVE 'ERROR OPENING TRANSACTION HISTORY'
          TO WS-ERROR-MESSAGE
        PERFORM 9999-ERROR-HANDLER
    END-IF

    OPEN OUTPUT ERROR-REPORT
    IF WS-RPT-STATUS NOT = '00'
        MOVE 'ERROR OPENING ERROR REPORT'
          TO WS-ERROR-MESSAGE
        PERFORM 9999-ERROR-HANDLER
    END-IF.

1200-INIT-PROCESSING.
    INITIALIZE WS-VALIDATION-TOTALS.

2000-PROCESS.
    PERFORM UNTIL END-OF-VALIDATION
        READ VALIDATION-CONTROL
            AT END
                SET END-OF-VALIDATION TO TRUE
            NOT AT END
                PERFORM 2100-PROCESS-VALIDATION
        END-READ
    END-PERFORM.

2100-PROCESS-VALIDATION.
    EVALUATE VAL-TYPE
        WHEN WS-INTEGRITY
            PERFORM 2200-CHECK-INTEGRITY
        WHEN WS-XREF
            PERFORM 2300-CHECK-XREF
        WHEN WS-FORMAT
            PERFORM 2400-CHECK-FORMAT
        WHEN WS-BALANCE
            PERFORM 2500-CHECK-BALANCE
        WHEN OTHER
            MOVE 'INVALID VALIDATION TYPE'
              TO WS-ERROR-MESSAGE
            PERFORM 9999-ERROR-HANDLER
    END-EVALUATE.

2200-CHECK-INTEGRITY.
    PERFORM 2210-CHECK-POSITION-INTEGRITY
    PERFORM 2220-CHECK-TRANSACTION-INTEGRITY.

2220-CHECK-TRANSACTION-INTEGRITY.
    READ TRANSACTION-HISTORY
        AT END
            EXIT PERFORM
        NOT AT END
            MOVE CHANNEL-CODE TO WS-TRAN-CHANNEL-CODE *> Validate CHANNEL-CODE presence
            IF WS-TRAN-CHANNEL-CODE = SPACES OR WS-TRAN-CHANNEL-CODE = LOW-VALUES
                MOVE 'MISSING CHANNEL-CODE' TO WS-ERR-DESC
                WRITE ERROR-RECORD FROM WS-ERROR-LINE
            END-IF
    END-READ.

2300-CHECK-XREF.
    PERFORM 2310-CHECK-POSITION-XREF
    PERFORM 2320-CHECK-TRANSACTION-XREF.

2400-CHECK-FORMAT.
    PERFORM 2410-CHECK-POSITION-FORMAT
    PERFORM 2420-CHECK-TRANSACTION-FORMAT.

2420-CHECK-TRANSACTION-FORMAT.
    READ TRANSACTION-HISTORY
        AT END
            EXIT PERFORM
        NOT AT END
            IF CHANNEL-CODE NOT ALPHANUMERIC
                MOVE 'INVALID CHANNEL-CODE FORMAT' TO WS-ERR-DESC
                WRITE ERROR-RECORD FROM WS-ERROR-LINE
            END-IF
    END-READ.

2500-CHECK-BALANCE.
    PERFORM 2510-ACCUMULATE-POSITIONS
    PERFORM 2520-VERIFY-BALANCES.

3000-CLEANUP.
    CLOSE VALIDATION-CONTROL
         POSITION-MASTER
         TRANSACTION-HISTORY
         ERROR-REPORT.

9999-ERROR-HANDLER.
    ADD 1 TO WS-RECORDS-ERROR
    SET ERROR-FOUND TO TRUE
    MOVE WS-ERROR-MESSAGE TO WS-ERR-DESC
    WRITE ERROR-RECORD FROM WS-ERROR-LINE.

IDENTIFICATION DIVISION.
PROGRAM-ID. TSTGEN00.
AUTHOR. CLAUDE.
DATE-WRITTEN. 2024-04-09.
*****************************************************************
* Test Data Generator                                           *
*                                                               *
* Generates test data for system testing:                      *
* - Portfolio test data                                        *
* - Transaction test scenarios                                 *
* - Error condition data                                       *
* - Performance test volumes                                   *
*****************************************************************
ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
SPECIAL-NAMES.
    CONSOLE IS CONS.
    
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT TEST-CONFIG ASSIGN TO TSTCFG
        ORGANIZATION IS SEQUENTIAL
        ACCESS MODE IS SEQUENTIAL
        FILE STATUS IS WS-CFG-STATUS.

    SELECT PORTFOLIO-OUT ASSIGN TO PORTOUT
        ORGANIZATION IS SEQUENTIAL
        FILE STATUS IS WS-PORT-STATUS.

    SELECT TRANSACTION-OUT ASSIGN TO TRANOUT
        ORGANIZATION IS SEQUENTIAL
        FILE STATUS IS WS-TRAN-STATUS.

    SELECT RANDOM-SEED ASSIGN TO RANDSEED
        ORGANIZATION IS SEQUENTIAL
        FILE STATUS IS WS-RAND-STATUS.

DATA DIVISION.
FILE SECTION.
FD  TEST-CONFIG
    RECORDING MODE IS F
    BLOCK CONTAINS 0 RECORDS.
01  CONFIG-RECORD.
    05  CFG-TEST-TYPE        PIC X(10).
    05  CFG-VOLUME           PIC 9(6).
    05  CFG-PARAMETERS       PIC X(64).

FD  PORTFOLIO-OUT
    RECORDING MODE IS F
    BLOCK CONTAINS 0 RECORDS.
01  PORTFOLIO-RECORD.
    COPY PORTFLIO REPLACING ==:PREFIX:== BY ==PORT==.

FD  TRANSACTION-OUT
    RECORDING MODE IS F
    BLOCK CONTAINS 0 RECORDS.
01  TRANSACTION-RECORD.
    COPY TRNREC REPLACING ==:PREFIX:== BY ==TRAN==.

FD  RANDOM-SEED
    RECORDING MODE IS F
    BLOCK CONTAINS 0 RECORDS.
01  SEED-RECORD             PIC 9(9).

WORKING-STORAGE SECTION.
    COPY RTNCODE.
    COPY ERRHAND.

01  WS-FILE-STATUS.
    05  WS-CFG-STATUS        PIC XX.
    05  WS-PORT-STATUS       PIC XX.
    05  WS-TRAN-STATUS       PIC XX.
    05  WS-RAND-STATUS       PIC XX.

01  WS-TEST-TYPES.
    05  WS-PORTFOLIO         PIC X(10) VALUE 'PORTFOLIO'.
    05  WS-TRANSACTION       PIC X(10) VALUE 'TRANSACTN'.
    05  WS-ERROR-TEST        PIC X(10) VALUE 'ERROR'.
    05  WS-VOLUME-TEST       PIC X(10) VALUE 'VOLUME'.

01  WS-PROCESSING-FLAGS.
    05  WS-END-OF-CONFIG     PIC X VALUE 'N'.
        88  END-OF-CONFIG    VALUE 'Y'.

01  WS-COUNTERS.
    05  WS-RECORDS-WRITTEN   PIC 9(9) VALUE ZERO.
    05  WS-ERROR-COUNT       PIC 9(9) VALUE ZERO.

01  WS-RANDOM-VALUES.
    05  WS-RANDOM-SEED       PIC 9(9).
    05  WS-RANDOM-NUM        PIC 9(9).
    05  WS-RANDOM-DECIMAL    PIC 9(9)V99.

01  WS-PORTFOLIO-DATA.
    05  WS-PORT-ID           PIC X(10).
    05  WS-PORT-NAME         PIC X(30).
    05  WS-PORT-TYPE         PIC X(2).
    05  WS-PORT-STATUS       PIC X(1).
    05  WS-PORT-BALANCE      PIC 9(15)V99.

01  WS-TRANSACTION-DATA.
    05  WS-TRAN-ID           PIC X(12).
    05  WS-TRAN-TYPE         PIC X(2).
    05  WS-TRAN-AMOUNT       PIC 9(15)V99.
    05  WS-TRAN-DATE         PIC X(8).
    05  WS-TRAN-STATUS       PIC X(1).
    05  WS-TRAN-CHANNEL      PIC X(4). *> Added for CHANNEL-CODE

PROCEDURE DIVISION.
0000-MAIN.
    PERFORM 1000-INITIALIZE
    PERFORM 2000-PROCESS
    PERFORM 3000-CLEANUP
    GOBACK.

1000-INITIALIZE.
    PERFORM 1100-OPEN-FILES
    PERFORM 1200-INIT-RANDOM
    PERFORM 1300-INIT-COUNTERS.

1100-OPEN-FILES.
    OPEN INPUT TEST-CONFIG
    IF WS-CFG-STATUS NOT = '00'
        MOVE 'ERROR OPENING CONFIG FILE'
          TO WS-ERROR-MESSAGE
        PERFORM 9999-ERROR-HANDLER
    END-IF

    OPEN OUTPUT PORTFOLIO-OUT
    IF WS-PORT-STATUS NOT = '00'
        MOVE 'ERROR OPENING PORTFOLIO OUTPUT'
          TO WS-ERROR-MESSAGE
        PERFORM 9999-ERROR-HANDLER
    END-IF

    OPEN OUTPUT TRANSACTION-OUT
    IF WS-TRAN-STATUS NOT = '00'
        MOVE 'ERROR OPENING TRANSACTION OUTPUT'
          TO WS-ERROR-MESSAGE
        PERFORM 9999-ERROR-HANDLER
    END-IF

    OPEN INPUT RANDOM-SEED
    IF WS-RAND-STATUS NOT = '00'
        MOVE 'ERROR OPENING RANDOM SEED'
          TO WS-ERROR-MESSAGE
        PERFORM 9999-ERROR-HANDLER
    END-IF.

1200-INIT-RANDOM.
    READ RANDOM-SEED
    MOVE SEED-RECORD TO WS-RANDOM-SEED.

1300-INIT-COUNTERS.
    INITIALIZE WS-COUNTERS.

2000-PROCESS.
    PERFORM UNTIL END-OF-CONFIG
        READ TEST-CONFIG
            AT END
                SET END-OF-CONFIG TO TRUE
            NOT AT END
                PERFORM 2100-GENERATE-TEST-DATA
        END-READ
    END-PERFORM.

2100-GENERATE-TEST-DATA.
    EVALUATE CFG-TEST-TYPE
        WHEN WS-PORTFOLIO
            PERFORM 2200-GEN-PORTFOLIO
        WHEN WS-TRANSACTION
            PERFORM 2300-GEN-TRANSACTION
        WHEN WS-ERROR-TEST
            PERFORM 2400-GEN-ERROR-DATA
        WHEN WS-VOLUME-TEST
            PERFORM 2500-GEN-VOLUME-DATA
        WHEN OTHER
            MOVE 'INVALID TEST TYPE'
              TO WS-ERROR-MESSAGE
            PERFORM 9999-ERROR-HANDLER
    END-EVALUATE.

2200-GEN-PORTFOLIO.
    PERFORM VARYING WS-RECORDS-WRITTEN FROM 1 BY 1
            UNTIL WS-RECORDS-WRITTEN > CFG-VOLUME
        PERFORM 2210-GEN-PORT-DATA
        PERFORM 2220-WRITE-PORT-RECORD
    END-PERFORM.

2300-GEN-TRANSACTION.
    PERFORM VARYING WS-RECORDS-WRITTEN FROM 1 BY 1
            UNTIL WS-RECORDS-WRITTEN > CFG-VOLUME
        PERFORM 2310-GEN-TRAN-DATA
        PERFORM 2320-WRITE-TRAN-RECORD
    END-PERFORM.

2310-GEN-TRAN-DATA.
    *> ... existing logic to populate transaction fields ...
    MOVE 'WEB ' TO WS-TRAN-CHANNEL *> Example: assign a channel code for test data

2320-WRITE-TRAN-RECORD.
    MOVE WS-TRAN-CHANNEL TO CHANNEL-CODE *> Write CHANNEL-CODE to output record
    *> ... existing logic to write transaction record ...

2400-GEN-ERROR-DATA.
    PERFORM 2410-GEN-DATA-ERRORS
    PERFORM 2420-GEN-PROCESS-ERRORS.

2500-GEN-VOLUME-DATA.
    PERFORM 2510-GEN-LARGE-PORTFOLIO
    PERFORM 2520-GEN-LARGE-TRANSACTION.

3000-CLEANUP.
    CLOSE TEST-CONFIG
         PORTFOLIO-OUT
         TRANSACTION-OUT
         RANDOM-SEED.

9999-ERROR-HANDLER.
    ADD 1 TO WS-ERROR-COUNT
    DISPLAY WS-ERROR-MESSAGE UPON CONS
    IF WS-ERROR-COUNT > 100
        MOVE 12 TO RETURN-CODE
        GOBACK
    END-IF.

*================================================================*
* Program Name: HISTLD00
* Description: Position History DB2 Load Program
* Version: 1.0
* Date: 2024
*================================================================*
IDENTIFICATION DIVISION.
PROGRAM-ID. HISTLD00.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
SOURCE-COMPUTER. IBM-ZOS.
OBJECT-COMPUTER. IBM-ZOS.

INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT TRANSACTION-HISTORY
        ASSIGN TO TRANHIST
        ORGANIZATION IS INDEXED
        ACCESS MODE IS SEQUENTIAL
        RECORD KEY IS TH-KEY
        FILE STATUS IS WS-TH-STATUS.
        
    SELECT BATCH-CONTROL-FILE
        ASSIGN TO BCHCTL
        ORGANIZATION IS INDEXED
        ACCESS MODE IS DYNAMIC
        RECORD KEY IS BCT-KEY
        FILE STATUS IS WS-BCT-STATUS.

DATA DIVISION.
FILE SECTION.
FD  TRANSACTION-HISTORY.
    COPY HISTREC.

FD  BATCH-CONTROL-FILE.
    COPY BCHCTL.

WORKING-STORAGE SECTION.
    EXEC SQL BEGIN DECLARE SECTION END-EXEC.
    COPY DBTBLS.
    EXEC SQL END DECLARE SECTION END-EXEC.
    
    COPY SQLCA.
    COPY DBPROC.
    COPY ERRHAND.
    COPY BCHCON.
    
01  WS-FILE-STATUS.
    05  WS-TH-STATUS          PIC X(2).
    05  WS-BCT-STATUS         PIC X(2).
    
01  WS-COUNTERS.
    05  WS-RECORDS-READ       PIC S9(9) COMP VALUE 0.
    05  WS-RECORDS-WRITTEN    PIC S9(9) COMP VALUE 0.
    05  WS-ERROR-COUNT        PIC S9(9) COMP VALUE 0.
    05  WS-COMMIT-COUNT       PIC S9(4) COMP VALUE 0.
    
01  WS-COMMIT-THRESHOLD       PIC S9(4) COMP VALUE 1000.

01  WS-SWITCHES.
    05  WS-END-OF-FILE-SW     PIC X(1) VALUE 'N'.
        88  END-OF-FILE         VALUE 'Y'.
        88  MORE-RECORDS        VALUE 'N'.

01  WS-TRAN-CHANNEL-CODE      PIC X(4). *> Added for CHANNEL-CODE

PROCEDURE DIVISION.
0000-MAIN.
    PERFORM 1000-INITIALIZE
    
    PERFORM 2000-PROCESS
        UNTIL END-OF-FILE
        OR WS-ERROR-COUNT > 100
    
    PERFORM 3000-TERMINATE
    
    MOVE WS-ERROR-COUNT TO RETURN-CODE
    GOBACK
    .

1000-INITIALIZE.
    PERFORM 1100-OPEN-FILES
    PERFORM 1200-CONNECT-DB2
    PERFORM 1300-INIT-CHECKPOINTS
    .

2000-PROCESS.
    PERFORM 2100-READ-HISTORY
    
    IF MORE-RECORDS
        PERFORM 2200-LOAD-TO-DB2
        PERFORM 2300-CHECK-COMMIT
    END-IF
    .

2100-READ-HISTORY.
    READ TRANSACTION-HISTORY
        AT END
            SET END-OF-FILE TO TRUE
        NOT AT END
            ADD 1 TO WS-RECORDS-READ
            MOVE CHANNEL-CODE TO WS-TRAN-CHANNEL-CODE *> Read CHANNEL-CODE for downstream use
    END-READ
    .

*================================================================*
* Program Name: BCHCTL00
* Description: Batch Control Processor
* Version: 1.0
* Date: 2024
*================================================================*
IDENTIFICATION DIVISION.
PROGRAM-ID. BCHCTL00.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
SOURCE-COMPUTER. IBM-ZOS.
OBJECT-COMPUTER. IBM-ZOS.

INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT BATCH-CONTROL-FILE
        ASSIGN TO BCHCTL
        ORGANIZATION IS INDEXED
        ACCESS MODE IS DYNAMIC
        RECORD KEY IS BCT-KEY
        FILE STATUS IS WS-BCT-STATUS.

DATA DIVISION.
FILE SECTION.
FD  BATCH-CONTROL-FILE.
    COPY BCHCTL.

WORKING-STORAGE SECTION.
    COPY BCHCON.
    COPY ERRHAND.
    
01  WS-FILE-STATUS.
    05  WS-BCT-STATUS         PIC X(2).
    
01  WS-WORK-AREAS.
    05  WS-CURRENT-TIME       PIC X(26).
    05  WS-PREREQ-MET         PIC X(1).
        88  PREREQS-SATISFIED    VALUE 'Y'.
        88  PREREQS-PENDING      VALUE 'N'.
    05  WS-PROCESS-MODE       PIC X(1).
        88  MODE-INITIALIZE      VALUE 'I'.
        88  MODE-CHECK-PREREQ    VALUE 'C'.
        88  MODE-UPDATE-STATUS   VALUE 'U'.
        88  MODE-FINALIZE        VALUE 'F'.

01  WS-TRAN-CHANNEL-CODE      PIC X(4). *> Added for CHANNEL-CODE reference

LINKAGE SECTION.
01  LS-CONTROL-REQUEST.
    05  LS-FUNCTION          PIC X(4).
        88  FUNC-INIT          VALUE 'INIT'.
        88  FUNC-CHEK          VALUE 'CHEK'.
        88  FUNC-UPDT          VALUE 'UPDT'.
        88  FUNC-TERM          VALUE 'TERM'.
    05  LS-JOB-NAME         PIC X(8).
    05  LS-PROCESS-DATE     PIC X(8).
    05  LS-SEQUENCE-NO      PIC 9(4).
    05  LS-RETURN-CODE      PIC S9(4) COMP.

PROCEDURE DIVISION USING LS-CONTROL-REQUEST.
0000-MAIN.
    EVALUATE TRUE
        WHEN FUNC-INIT
            SET MODE-INITIALIZE TO TRUE
            PERFORM 1000-PROCESS-INITIALIZE
        WHEN FUNC-CHEK
            SET MODE-CHECK-PREREQ TO TRUE
            PERFORM 2000-CHECK-PREREQUISITES
        WHEN FUNC-UPDT
            SET MODE-UPDATE-STATUS TO TRUE
            PERFORM 3000-UPDATE-STATUS
        WHEN FUNC-TERM
            SET MODE-FINALIZE TO TRUE
            PERFORM 4000-PROCESS-TERMINATE
        WHEN OTHER
            MOVE 'Invalid function code' TO ERR-TEXT
            PERFORM 9000-ERROR-ROUTINE
    END-EVALUATE
    
    MOVE LS-RETURN-CODE TO RETURN-CODE
    GOBACK
    .

*****************************************************************
* POSITION RECORD STRUCTURE
* VERSION: 1.1
* DATE: 2024
*****************************************************************
 01  POSITION-RECORD.
     05  POS-KEY.
         10  POS-PORTFOLIO-ID   PIC X(08).
         10  POS-DATE           PIC X(08).
         10  POS-INVESTMENT-ID  PIC X(10).
     05  POS-DATA.
         10  POS-QUANTITY       PIC S9(11)V9(4) COMP-3.
         10  POS-COST-BASIS     PIC S9(13)V9(2) COMP-3.
         10  POS-MARKET-VALUE   PIC S9(13)V9(2) COMP-3.
         10  POS-CURRENCY       PIC X(03).
         10  POS-STATUS         PIC X(01).
             88  POS-STATUS-ACTIVE  VALUE 'A'.
             88  POS-STATUS-CLOSED  VALUE 'C'.
             88  POS-STATUS-PEND    VALUE 'P'.
         10  POS-CHANNEL-CODE      PIC X(04). *> Added for channel identification (if referenced)
     05  POS-AUDIT.
         10  POS-LAST-MAINT-DATE   PIC X(26).
         10  POS-LAST-MAINT-USER   PIC X(08).
     05  POS-FILLER               PIC X(46). *> Reduced by 4 to accommodate POS-CHANNEL-CODE
*****************************************************************
* FIELD DESCRIPTIONS:
* POS-PORTFOLIO-ID : PORTFOLIO IDENTIFIER
* POS-DATE         : POSITION DATE (YYYYMMDD)
* POS-INVESTMENT-ID: INVESTMENT IDENTIFIER
* POS-QUANTITY     : HOLDING QUANTITY
* POS-COST-BASIS   : TOTAL COST BASIS
* POS-MARKET-VALUE : CURRENT MARKET VALUE
* POS-STATUS       : A=ACTIVE, C=CLOSED, P=PENDING
* POS-CHANNEL-CODE : CHANNEL IDENTIFICATION (NEW FIELD)
*****************************************************************

IDENTIFICATION DIVISION.
PROGRAM-ID. RPTAUD00.
AUTHOR. CLAUDE.
DATE-WRITTEN. 2024-04-09.
*****************************************************************
* Audit Report Generator                                         *
*                                                               *
* Generates comprehensive audit report including:                *
* - Security audit trails                                       *
* - Process audit reporting                                     *
* - Error summary reporting                                     *
* - Control verification                                        *
*****************************************************************
ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT AUDIT-FILE ASSIGN TO AUDITLOG
        ORGANIZATION IS INDEXED
        ACCESS MODE IS SEQUENTIAL
        RECORD KEY IS AUD-KEY
        FILE STATUS IS WS-AUDIT-STATUS.

    SELECT ERROR-FILE ASSIGN TO ERRLOG
        ORGANIZATION IS INDEXED
        ACCESS MODE IS SEQUENTIAL
        RECORD KEY IS ERR-KEY
        FILE STATUS IS WS-ERROR-STATUS.

    SELECT REPORT-FILE ASSIGN TO RPTFILE
        ORGANIZATION IS SEQUENTIAL
        FILE STATUS IS WS-REPORT-STATUS.

DATA DIVISION.
FILE SECTION.
    COPY AUDITLOG.
    COPY ERRHAND.
    
FD  REPORT-FILE
    RECORDING MODE IS F
    BLOCK CONTAINS 0 RECORDS.
01  REPORT-RECORD             PIC X(132).

WORKING-STORAGE SECTION.
    COPY RTNCODE.

01  WS-FILE-STATUS.
    05  WS-AUDIT-STATUS       PIC XX.
    05  WS-ERROR-STATUS       PIC XX.
    05  WS-REPORT-STATUS      PIC XX.

01  WS-REPORT-HEADERS.
    05  WS-HEADER1.
        10  FILLER            PIC X(132) VALUE ALL '*'.
    05  WS-HEADER2.
        10  FILLER            PIC X(40) VALUE SPACES.
        10  FILLER            PIC X(52) 
            VALUE 'SYSTEM AUDIT REPORT'.
        10  FILLER            PIC X(40) VALUE SPACES.
    05  WS-HEADER3.
        10  FILLER            PIC X(15) VALUE 'REPORT DATE:'.
        10  WS-REPORT-DATE    PIC X(10).
        10  FILLER            PIC X(107) VALUE SPACES.

01  WS-AUDIT-DETAIL.
    05  WS-AUD-TIMESTAMP     PIC X(26).
    05  FILLER               PIC X(2) VALUE SPACES.
    05  WS-AUD-PROGRAM       PIC X(8).
    05  FILLER               PIC X(2) VALUE SPACES.
    05  WS-AUD-TYPE          PIC X(10).
    05  FILLER               PIC X(2) VALUE SPACES.
    05  WS-AUD-MESSAGE       PIC X(80).
    05  WS-AUD-CHANNEL       PIC X(4). *> Added for CHANNEL-CODE in audit reporting

01  WS-ERROR-DETAIL.
    05  WS-ERR-TIMESTAMP     PIC X(26).
    05  FILLER               PIC X(2) VALUE SPACES.
    05  WS-ERR-PROGRAM       PIC X(8).
    05  FILLER               PIC X(2) VALUE SPACES.
    05  WS-ERR-CODE          PIC X(4).
    05  FILLER               PIC X(2) VALUE SPACES.
    05  WS-ERR-MESSAGE       PIC X(80).

PROCEDURE DIVISION.
0000-MAIN.
    PERFORM 1000-INITIALIZE
    PERFORM 2000-PROCESS-REPORT
    PERFORM 3000-CLEANUP
    GOBACK.

1000-INITIALIZE.
    PERFORM 1100-OPEN-FILES
    PERFORM 1200-WRITE-HEADERS.

1100-OPEN-FILES.
    OPEN INPUT AUDIT-FILE
    IF WS-AUDIT-STATUS NOT = '00'
        MOVE 'ERROR OPENING AUDIT FILE'
          TO WS-ERROR-MESSAGE
        PERFORM 9999-ERROR-HANDLER
    END-IF

    OPEN INPUT ERROR-FILE
    IF WS-ERROR-STATUS NOT = '00'
        MOVE 'ERROR OPENING ERROR FILE'
          TO WS-ERROR-MESSAGE
        PERFORM 9999-ERROR-HANDLER
    END-IF

    OPEN OUTPUT REPORT-FILE
    IF WS-REPORT-STATUS NOT = '00'
        MOVE 'ERROR OPENING REPORT FILE'
          TO WS-ERROR-MESSAGE
        PERFORM 9999-ERROR-HANDLER
    END-IF.

1200-WRITE-HEADERS.
    ACCEPT WS-REPORT-DATE FROM DATE
    WRITE REPORT-RECORD FROM WS-HEADER1
    WRITE REPORT-RECORD FROM WS-HEADER2
    WRITE REPORT-RECORD FROM WS-HEADER3.

2000-PROCESS-REPORT.
    PERFORM 2100-PROCESS-AUDIT-TRAIL
    PERFORM 2200-PROCESS-ERROR-LOG
    PERFORM 2300-WRITE-SUMMARY.

2100-PROCESS-AUDIT-TRAIL.
    PERFORM 2110-READ-AUDIT-RECORDS
    PERFORM 2120-SUMMARIZE-AUDIT.

2110-READ-AUDIT-RECORDS.
    READ AUDIT-FILE
        AT END
            EXIT PERFORM
        NOT AT END
            MOVE CHANNEL-CODE TO WS-AUD-CHANNEL *> Include CHANNEL-CODE in audit detail
            *> ... existing logic ...
    END-READ.

2200-PROCESS-ERROR-LOG.
    PERFORM 2210-READ-ERROR-RECORDS
    PERFORM 2220-SUMMARIZE-ERRORS.

2300-WRITE-SUMMARY.
    PERFORM 2310-WRITE-AUDIT-SUMMARY
    PERFORM 2320-WRITE-ERROR-SUMMARY
    PERFORM 2330-WRITE-CONTROL-SUMMARY.

3000-CLEANUP.
    CLOSE AUDIT-FILE
         ERROR-FILE
         REPORT-FILE.

9999-ERROR-HANDLER.
    DISPLAY WS-ERROR-MESSAGE
    MOVE 12 TO RETURN-CODE
    GOBACK.

[File 1] RCVPRC00.cbl src/programs/batch/RCVPRC00.cbl

      *================================================================*
      * Program Name: RCVPRC00
      * Description: Process Recovery Handler
      * Version: 1.0
      * Date: 2024
      *================================================================*
       IDENTIFICATION DIVISION.
       PROGRAM-ID. RCVPRC00.
       
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SOURCE-COMPUTER. IBM-ZOS.
       OBJECT-COMPUTER. IBM-ZOS.
       
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT BATCH-CONTROL-FILE
               ASSIGN TO BCHCTL
               ORGANIZATION IS INDEXED
               ACCESS MODE IS DYNAMIC
               RECORD KEY IS BCT-KEY
               FILE STATUS IS WS-BCT-STATUS.
               
           SELECT PROCESS-SEQ-FILE
               ASSIGN TO PRCSEQ
               ORGANIZATION IS INDEXED
               ACCESS MODE IS DYNAMIC
               RECORD KEY IS PSR-KEY
               FILE STATUS IS WS-PSR-STATUS.
       
       DATA DIVISION.
       FILE SECTION.
       FD  BATCH-CONTROL-FILE.
           COPY BCHCTL.
           
       FD  PROCESS-SEQ-FILE.
           COPY PRCSEQ.
       
       WORKING-STORAGE SECTION.
           COPY BCHCON.
           COPY ERRHAND.
           
       01  WS-FILE-STATUS.
           05  WS-BCT-STATUS         PIC X(2).
           05  WS-PSR-STATUS         PIC X(2).
           
       01  WS-WORK-AREAS.
           05  WS-CURRENT-TIME       PIC X(26).
           05  WS-RECOVERY-MODE      PIC X(1).
               88  WS-RECOVER-PROCESS  VALUE 'P'.
               88  WS-RECOVER-SEQUENCE VALUE 'S'.
               88  WS-RECOVER-ALL      VALUE 'A'.
           05  WS-RECOVERY-ACTION    PIC X(1).
               88  WS-ACTION-RESTART   VALUE 'R'.
               88  WS-ACTION-BYPASS    VALUE 'B'.
               88  WS-ACTION-TERMINATE VALUE 'T'.
           
       LINKAGE SECTION.
       01  LS-RECOVERY-REQUEST.
           05  LS-FUNCTION          PIC X(4).
               88  FUNC-INIT          VALUE 'INIT'.
               88  FUNC-RECV          VALUE 'RECV'.
               88  FUNC-TERM          VALUE 'TERM'.
           05  LS-PROCESS-DATE     PIC X(8).
           05  LS-PROCESS-ID       PIC X(8).
           05  LS-RECOVERY-TYPE    PIC X(1).
           05  LS-RECOVERY-PARM    PIC X(50).
           05  LS-RETURN-CODE      PIC S9(4) COMP.
       
       PROCEDURE DIVISION USING LS-RECOVERY-REQUEST.
       0000-MAIN.
           EVALUATE TRUE
               WHEN FUNC-INIT
                   PERFORM 1000-INITIALIZE-RECOVERY
               WHEN FUNC-RECV
                   PERFORM 2000-PROCESS-RECOVERY
               WHEN FUNC-TERM
                   PERFORM 3000-TERMINATE-RECOVERY
               WHEN OTHER
                   MOVE 'Invalid function code' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-EVALUATE
           
           MOVE LS-RETURN-CODE TO RETURN-CODE
           GOBACK
           .
           
       1000-INITIALIZE-RECOVERY.
           PERFORM 1100-OPEN-FILES
           PERFORM 1200-VALIDATE-REQUEST
           PERFORM 1300-SET-RECOVERY-MODE
           .
           
       2000-PROCESS-RECOVERY.
           EVALUATE WS-RECOVERY-MODE
               WHEN 'P'
                   PERFORM 2100-RECOVER-PROCESS
               WHEN 'S'
                   PERFORM 2200-RECOVER-SEQUENCE
               WHEN 'A'
                   PERFORM 2300-RECOVER-ALL
           END-EVALUATE
           .
           
       3000-TERMINATE-RECOVERY.
           PERFORM 3100-UPDATE-FINAL-STATUS
           PERFORM 3200-CLOSE-FILES
           .
           
       9000-ERROR-ROUTINE.
           MOVE 'RCVPRC00' TO ERR-PROGRAM
           MOVE BCT-RC-ERROR TO LS-RETURN-CODE
           CALL 'ERRPROC' USING ERR-MESSAGE
           .
      *================================================================*
      * Recovery Implementation Procedures
      *================================================================*
       1100-OPEN-FILES.
           OPEN I-O BATCH-CONTROL-FILE
           IF WS-BCT-STATUS NOT = '00'
               MOVE 'Error opening control file' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           
           OPEN INPUT PROCESS-SEQ-FILE
           IF WS-PSR-STATUS NOT = '00'
               MOVE 'Error opening sequence file' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           .
           
       1200-VALIDATE-REQUEST.
           IF LS-PROCESS-DATE = SPACES
               MOVE 'Process date required' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           
           EVALUATE LS-RECOVERY-TYPE
               WHEN 'P'
               WHEN 'S'
               WHEN 'A'
                   CONTINUE
               WHEN OTHER
                   MOVE 'Invalid recovery type' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-EVALUATE
           .
           
       1300-SET-RECOVERY-MODE.
           MOVE LS-RECOVERY-TYPE TO WS-RECOVERY-MODE
           
           IF WS-RECOVER-PROCESS AND LS-PROCESS-ID = SPACES
               MOVE 'Process ID required for process recovery'
                 TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           .
           
       2100-RECOVER-PROCESS.
           MOVE LS-PROCESS-ID   TO BCT-JOB-NAME
           MOVE LS-PROCESS-DATE TO BCT-PROCESS-DATE
           
           READ BATCH-CONTROL-FILE
               INVALID KEY
                   MOVE 'Process record not found' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-READ
           
           PERFORM 2110-DETERMINE-ACTION
           PERFORM 2120-EXECUTE-RECOVERY
           .
           
       2110-DETERMINE-ACTION.
           MOVE LS-PROCESS-ID TO PSR-PROCESS-ID
           
           READ PROCESS-SEQ-FILE
               INVALID KEY
                   MOVE 'Process definition not found' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-READ
           
           IF PSR-RESTARTABLE
               SET WS-ACTION-RESTART TO TRUE
           ELSE
               IF BCT-RESTART-COUNT > BCT-MAX-RESTARTS
                   SET WS-ACTION-TERMINATE TO TRUE
               ELSE
                   SET WS-ACTION-BYPASS TO TRUE
               END-IF
           END-IF
           .
           
       2120-EXECUTE-RECOVERY.
           EVALUATE TRUE
               WHEN WS-ACTION-RESTART
                   PERFORM 2121-RESTART-PROCESS
               WHEN WS-ACTION-BYPASS
                   PERFORM 2122-BYPASS-PROCESS
               WHEN WS-ACTION-TERMINATE
                   PERFORM 2123-TERMINATE-PROCESS
           END-EVALUATE
           .
           
       2121-RESTART-PROCESS.
           MOVE BCT-STAT-READY TO BCT-STATUS
           ADD 1 TO BCT-RESTART-COUNT
           ACCEPT WS-CURRENT-TIME FROM TIME STAMP
           MOVE WS-CURRENT-TIME TO BCT-ATTEMPT-TS
           
           REWRITE BATCH-CONTROL-RECORD
               INVALID KEY
                   MOVE 'Error updating control record' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-REWRITE
           .
           
       2122-BYPASS-PROCESS.
           MOVE BCT-STAT-DONE  TO BCT-STATUS
           MOVE BCT-RC-WARNING TO BCT-RETURN-CODE
           MOVE 'Process bypassed by recovery' TO BCT-ERROR-DESC
           
           REWRITE BATCH-CONTROL-RECORD
               INVALID KEY
                   MOVE 'Error updating control record' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-REWRITE
           .
           
       2123-TERMINATE-PROCESS.
           MOVE BCT-STAT-ERROR TO BCT-STATUS
           MOVE BCT-RC-ERROR  TO BCT-RETURN-CODE
           MOVE 'Process terminated by recovery' TO BCT-ERROR-DESC
           
           REWRITE BATCH-CONTROL-RECORD
               INVALID KEY
                   MOVE 'Error updating control record' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-REWRITE
           .
           
       2200-RECOVER-SEQUENCE.
           MOVE LS-PROCESS-DATE TO BCT-PROCESS-DATE
           MOVE LOW-VALUES TO BCT-JOB-NAME
           
           START BATCH-CONTROL-FILE KEY > BCT-KEY
               INVALID KEY
                   MOVE 'No processes found for date' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-START
           
           PERFORM UNTIL WS-BCT-STATUS = '10'
               READ BATCH-CONTROL-FILE NEXT RECORD
                   AT END
                       MOVE '10' TO WS-BCT-STATUS
                   NOT AT END
                       IF BCT-PROCESS-DATE = LS-PROCESS-DATE
                           PERFORM 2100-RECOVER-PROCESS
                       END-IF
               END-READ
           END-PERFORM
           .
           
       2300-RECOVER-ALL.
           MOVE LOW-VALUES TO BCT-KEY
           
           START BATCH-CONTROL-FILE KEY > BCT-KEY
               INVALID KEY
                   MOVE 'No processes found' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-START
           
           PERFORM UNTIL WS-BCT-STATUS = '10'
               READ BATCH-CONTROL-FILE NEXT RECORD
                   AT END
                       MOVE '10' TO WS-BCT-STATUS
                   NOT AT END
                       MOVE BCT-JOB-NAME TO LS-PROCESS-ID
                       PERFORM 2100-RECOVER-PROCESS
               END-READ
           END-PERFORM
           .
           
       3100-UPDATE-FINAL-STATUS.
           IF LS-RETURN-CODE = ZERO
               MOVE 'Recovery completed successfully' TO ERR-TEXT
           ELSE
               MOVE 'Recovery completed with errors' TO ERR-TEXT
           END-IF
           
           CALL 'ERRPROC' USING ERR-MESSAGE
           .
           
       3200-CLOSE-FILES.
           CLOSE BATCH-CONTROL-FILE
                 PROCESS-SEQ-FILE
                 
           IF WS-BCT-STATUS NOT = '00' OR
              WS-PSR-STATUS NOT = '00'
               MOVE 'Error closing files' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           .

[Summary Change Report]
No changes applied yet; full file loaded for impact modification. Ready for paragraph-level updates as per Impact Analysis Report.

[File 2] HISTLD00.cbl src/programs/batch/HISTLD00.cbl

      *================================================================*
      * Program Name: HISTLD00
      * Description: Position History DB2 Load Program
      * Version: 1.0
      * Date: 2024
      *================================================================*
       IDENTIFICATION DIVISION.
       PROGRAM-ID. HISTLD00.
       
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SOURCE-COMPUTER. IBM-ZOS.
       OBJECT-COMPUTER. IBM-ZOS.
       
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT TRANSACTION-HISTORY
               ASSIGN TO TRANHIST
               ORGANIZATION IS INDEXED
               ACCESS MODE IS SEQUENTIAL
               RECORD KEY IS TH-KEY
               FILE STATUS IS WS-TH-STATUS.
               
           SELECT BATCH-CONTROL-FILE
               ASSIGN TO BCHCTL
               ORGANIZATION IS INDEXED
               ACCESS MODE IS DYNAMIC
               RECORD KEY IS BCT-KEY
               FILE STATUS IS WS-BCT-STATUS.
       
       DATA DIVISION.
       FILE SECTION.
       FD  TRANSACTION-HISTORY.
           COPY HISTREC.
       
       FD  BATCH-CONTROL-FILE.
           COPY BCHCTL.
       
       WORKING-STORAGE SECTION.
           EXEC SQL BEGIN DECLARE SECTION END-EXEC.
           COPY DBTBLS.
           EXEC SQL END DECLARE SECTION END-EXEC.
           
           COPY SQLCA.
           COPY DBPROC.
           COPY ERRHAND.
           COPY BCHCON.
           
       01  WS-FILE-STATUS.
           05  WS-TH-STATUS          PIC X(2).
           05  WS-BCT-STATUS         PIC X(2).
           
       01  WS-COUNTERS.
           05  WS-RECORDS-READ       PIC S9(9) COMP VALUE 0.
           05  WS-RECORDS-WRITTEN    PIC S9(9) COMP VALUE 0.
           05  WS-ERROR-COUNT        PIC S9(9) COMP VALUE 0.
           05  WS-COMMIT-COUNT       PIC S9(4) COMP VALUE 0.
           
       01  WS-COMMIT-THRESHOLD       PIC S9(4) COMP VALUE 1000.
       
       01  WS-SWITCHES.
           05  WS-END-OF-FILE-SW     PIC X(1) VALUE 'N'.
               88  END-OF-FILE         VALUE 'Y'.
               88  MORE-RECORDS        VALUE 'N'.
               
       PROCEDURE DIVISION.
       0000-MAIN.
           PERFORM 1000-INITIALIZE
           
           PERFORM 2000-PROCESS
               UNTIL END-OF-FILE
               OR WS-ERROR-COUNT > 100
           
           PERFORM 3000-TERMINATE
           
           MOVE WS-ERROR-COUNT TO RETURN-CODE
           GOBACK
           .
           
       1000-INITIALIZE.
           PERFORM 1100-OPEN-FILES
           PERFORM 1200-CONNECT-DB2
           PERFORM 1300-INIT-CHECKPOINTS
           .
           
       2000-PROCESS.
           PERFORM 2100-READ-HISTORY
           
           IF MORE-RECORDS
               PERFORM 2200-LOAD-TO-DB2
               PERFORM 2300-CHECK-COMMIT
           END-IF
           .
           
       3000-TERMINATE.
           PERFORM 3100-FINAL-COMMIT
           PERFORM 3200-CLOSE-FILES
           PERFORM 3300-DISCONNECT-DB2
           PERFORM 3400-DISPLAY-STATS
           .
           
       1100-OPEN-FILES.
           OPEN INPUT TRANSACTION-HISTORY
           IF WS-TH-STATUS NOT = '00'
               MOVE 'Error opening history file' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           
           OPEN I-O BATCH-CONTROL-FILE
           IF WS-BCT-STATUS NOT = '00'
               MOVE 'Error opening control file' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           .
           
       1200-CONNECT-DB2.
           PERFORM CONNECT-TO-DB2
           .
           
       1300-INIT-CHECKPOINTS.
           MOVE SPACES TO BCT-KEY
           MOVE 'HISTLD00' TO BCT-JOB-NAME
           
           READ BATCH-CONTROL-FILE
               INVALID KEY
                   MOVE 'Control record not found' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-READ
           
           MOVE BCT-STAT-ACTIVE TO BCT-STATUS
           REWRITE BATCH-CONTROL-RECORD
           .
           
       2100-READ-HISTORY.
           READ TRANSACTION-HISTORY
               AT END
                   SET END-OF-FILE TO TRUE
               NOT AT END
                   ADD 1 TO WS-RECORDS-READ
           END-READ
           .
           
       2200-LOAD-TO-DB2.
           INITIALIZE POSHIST-RECORD
           
           MOVE TH-ACCOUNT-NO    TO PH-ACCOUNT-NO
           MOVE TH-PORTFOLIO-ID  TO PH-PORTFOLIO-ID
           MOVE TH-TRANS-DATE    TO PH-TRANS-DATE
           MOVE TH-TRANS-TIME    TO PH-TRANS-TIME
           MOVE TH-TRANS-TYPE    TO PH-TRANS-TYPE
           MOVE TH-SECURITY-ID   TO PH-SECURITY-ID
           MOVE TH-QUANTITY      TO PH-QUANTITY
           MOVE TH-PRICE         TO PH-PRICE
           MOVE TH-AMOUNT        TO PH-AMOUNT
           MOVE TH-FEES          TO PH-FEES
           MOVE TH-TOTAL-AMOUNT  TO PH-TOTAL-AMOUNT
           MOVE TH-COST-BASIS    TO PH-COST-BASIS
           MOVE TH-GAIN-LOSS     TO PH-GAIN-LOSS
           
           EXEC SQL
               INSERT INTO POSHIST
               VALUES (:POSHIST-RECORD)
           END-EXEC
           
           IF SQLCODE = 0
               ADD 1 TO WS-RECORDS-WRITTEN
           ELSE
               IF SQLCODE = -803
                   CONTINUE
               ELSE
                   ADD 1 TO WS-ERROR-COUNT
                   PERFORM DB2-ERROR-ROUTINE
               END-IF
           END-IF
           .
           
       2300-CHECK-COMMIT.
           ADD 1 TO WS-COMMIT-COUNT
           
           IF WS-COMMIT-COUNT >= WS-COMMIT-THRESHOLD
               EXEC SQL
                   COMMIT WORK
               END-EXEC
               
               MOVE 0 TO WS-COMMIT-COUNT
               
               PERFORM 2310-UPDATE-CHECKPOINT
           END-IF
           .
           
       2310-UPDATE-CHECKPOINT.
           MOVE WS-RECORDS-READ TO BCT-RECORDS-READ
           MOVE WS-RECORDS-WRITTEN TO BCT-RECORDS-WRITTEN
           
           REWRITE BATCH-CONTROL-RECORD
               INVALID KEY
                   MOVE 'Error updating checkpoint' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-REWRITE
           .
           
       3100-FINAL-COMMIT.
           EXEC SQL
               COMMIT WORK
           END-EXEC
           
           PERFORM 2310-UPDATE-CHECKPOINT
           .
           
       3200-CLOSE-FILES.
           CLOSE TRANSACTION-HISTORY
                 BATCH-CONTROL-FILE
           .
           
       3300-DISCONNECT-DB2.
           PERFORM DISCONNECT-FROM-DB2
           .
           
       3400-DISPLAY-STATS.
           DISPLAY 'HISTLD00 Processing Statistics:'
           DISPLAY '  Records Read:    ' WS-RECORDS-READ
           DISPLAY '  Records Written: ' WS-RECORDS-WRITTEN
           DISPLAY '  Errors:         ' WS-ERROR-COUNT
           .
           
       9000-ERROR-ROUTINE.
           MOVE 'HISTLD00' TO ERR-PROGRAM
           CALL 'ERRPROC' USING ERR-MESSAGE
           
           EXEC SQL
               ROLLBACK WORK
           END-EXEC
           .

[Summary Change Report]
No changes applied yet; full file loaded for impact modification. Ready for paragraph-level updates as per Impact Analysis Report.

[File 3] RPTAUD00.cbl src/programs/batch/RPTAUD00.cbl

       IDENTIFICATION DIVISION.
       PROGRAM-ID. RPTAUD00.
       AUTHOR. CLAUDE.
       DATE-WRITTEN. 2024-04-09.
      *****************************************************************
      * Audit Report Generator                                         *
      *                                                               *
      * Generates comprehensive audit report including:                *
      * - Security audit trails                                       *
      * - Process audit reporting                                     *
      * - Error summary reporting                                     *
      * - Control verification                                        *
      *****************************************************************
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT AUDIT-FILE ASSIGN TO AUDITLOG
               ORGANIZATION IS INDEXED
               ACCESS MODE IS SEQUENTIAL
               RECORD KEY IS AUD-KEY
               FILE STATUS IS WS-AUDIT-STATUS.

           SELECT ERROR-FILE ASSIGN TO ERRLOG
               ORGANIZATION IS INDEXED
               ACCESS MODE IS SEQUENTIAL
               RECORD KEY IS ERR-KEY
               FILE STATUS IS WS-ERROR-STATUS.

           SELECT REPORT-FILE ASSIGN TO RPTFILE
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-REPORT-STATUS.

       DATA DIVISION.
       FILE SECTION.
           COPY AUDITLOG.
           COPY ERRHAND.
           
       FD  REPORT-FILE
           RECORDING MODE IS F
           BLOCK CONTAINS 0 RECORDS.
       01  REPORT-RECORD             PIC X(132).

       WORKING-STORAGE SECTION.
           COPY RTNCODE.

       01  WS-FILE-STATUS.
           05  WS-AUDIT-STATUS       PIC XX.
           05  WS-ERROR-STATUS       PIC XX.
           05  WS-REPORT-STATUS      PIC XX.

       01  WS-REPORT-HEADERS.
           05  WS-HEADER1.
               10  FILLER            PIC X(132) VALUE ALL '*'.
           05  WS-HEADER2.
               10  FILLER            PIC X(40) VALUE SPACES.
               10  FILLER            PIC X(52) 
                   VALUE 'SYSTEM AUDIT REPORT'.
               10  FILLER            PIC X(40) VALUE SPACES.
           05  WS-HEADER3.
               10  FILLER            PIC X(15) VALUE 'REPORT DATE:'.
               10  WS-REPORT-DATE    PIC X(10).
               10  FILLER            PIC X(107) VALUE SPACES.

       01  WS-AUDIT-DETAIL.
           05  WS-AUD-TIMESTAMP     PIC X(26).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-AUD-PROGRAM       PIC X(8).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-AUD-TYPE          PIC X(10).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-AUD-MESSAGE       PIC X(80).

       01  WS-ERROR-DETAIL.
           05  WS-ERR-TIMESTAMP     PIC X(26).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-ERR-PROGRAM       PIC X(8).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-ERR-CODE          PIC X(4).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-ERR-MESSAGE       PIC X(80).

       PROCEDURE DIVISION.
       0000-MAIN.
           PERFORM 1000-INITIALIZE
           PERFORM 2000-PROCESS-REPORT
           PERFORM 3000-CLEANUP
           GOBACK.

       1000-INITIALIZE.
           PERFORM 1100-OPEN-FILES
           PERFORM 1200-WRITE-HEADERS.

       1100-OPEN-FILES.
           OPEN INPUT AUDIT-FILE
           IF WS-AUDIT-STATUS NOT = '00'
               MOVE 'ERROR OPENING AUDIT FILE'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF

           OPEN INPUT ERROR-FILE
           IF WS-ERROR-STATUS NOT = '00'
               MOVE 'ERROR OPENING ERROR FILE'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF

           OPEN OUTPUT REPORT-FILE
           IF WS-REPORT-STATUS NOT = '00'
               MOVE 'ERROR OPENING REPORT FILE'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF.

       1200-WRITE-HEADERS.
           ACCEPT WS-REPORT-DATE FROM DATE
           WRITE REPORT-RECORD FROM WS-HEADER1
           WRITE REPORT-RECORD FROM WS-HEADER2
           WRITE REPORT-RECORD FROM WS-HEADER3.

       2000-PROCESS-REPORT.
           PERFORM 2100-PROCESS-AUDIT-TRAIL
           PERFORM 2200-PROCESS-ERROR-LOG
           PERFORM 2300-WRITE-SUMMARY.

       2100-PROCESS-AUDIT-TRAIL.
           PERFORM 2110-READ-AUDIT-RECORDS
           PERFORM 2120-SUMMARIZE-AUDIT.

       2200-PROCESS-ERROR-LOG.
           PERFORM 2210-READ-ERROR-RECORDS
           PERFORM 2220-SUMMARIZE-ERRORS.

       2300-WRITE-SUMMARY.
           PERFORM 2310-WRITE-AUDIT-SUMMARY
           PERFORM 2320-WRITE-ERROR-SUMMARY
           PERFORM 2330-WRITE-CONTROL-SUMMARY.

       3000-CLEANUP.
           CLOSE AUDIT-FILE
                ERROR-FILE
                REPORT-FILE.

       9999-ERROR-HANDLER.
           DISPLAY WS-ERROR-MESSAGE
           MOVE 12 TO RETURN-CODE
           GOBACK.

[Summary Change Report]
No changes applied yet; full file loaded for impact modification. Ready for paragraph-level updates as per Impact Analysis Report.

[File 4] CURSMGR.cbl src/programs/online/CURSMGR.cbl

       IDENTIFICATION DIVISION.
       PROGRAM-ID. CURSMGR.
      *****************************************************************
      * Cursor Management for Online Programs                           *
      * - Manages cursor declarations and lifecycle                     *
      * - Implements cursor optimization techniques                     *
      * - Handles array fetching for performance                       *
      * - Provides cursor status monitoring                            *
      *****************************************************************
       
       ENVIRONMENT DIVISION.
       
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  WS-DB2-AREA.
           EXEC SQL INCLUDE SQLCA END-EXEC.
           
       01  WS-CURSOR-STATS.
           05 WS-FETCH-COUNT         PIC S9(8) COMP VALUE 0.
           05 WS-ROWS-FETCHED       PIC S9(8) COMP VALUE 0.
           05 WS-FETCH-TIME         PIC S9(8) COMP VALUE 0.
           
       01  WS-ARRAY-AREA.
           05 WS-MAX-ROWS           PIC S9(4) COMP VALUE 20.
           05 WS-ARRAY-SIZE         PIC S9(4) COMP VALUE 0.
           
       LINKAGE SECTION.
       01  CURSOR-REQUEST-AREA.
           05 CURS-REQUEST-TYPE     PIC X.
              88 CURS-DECLARE           VALUE 'D'.
              88 CURS-OPEN              VALUE 'O'.
              88 CURS-FETCH             VALUE 'F'.
              88 CURS-CLOSE             VALUE 'C'.
           05 CURS-NAME             PIC X(18).
           05 CURS-STMT             PIC X(240).
           05 CURS-ARRAY-FETCH      PIC X VALUE 'N'.
              88 USE-ARRAY-FETCH         VALUE 'Y'.
              88 NO-ARRAY-FETCH          VALUE 'N'.
           05 CURS-RESPONSE-CODE    PIC S9(8) COMP.
           05 CURS-DATA-AREA        PIC X(3000).
           05 CURS-DATA-LENGTH      PIC S9(4) COMP.
           
       PROCEDURE DIVISION USING CURSOR-REQUEST-AREA.
           EVALUATE TRUE
               WHEN CURS-DECLARE
                    PERFORM P100-DECLARE-CURSOR
                       THRU P100-EXIT
               WHEN CURS-OPEN
                    PERFORM P200-OPEN-CURSOR
                       THRU P200-EXIT
               WHEN CURS-FETCH
                    PERFORM P300-FETCH-DATA
                       THRU P300-EXIT
               WHEN CURS-CLOSE
                    PERFORM P400-CLOSE-CURSOR
                       THRU P400-EXIT
           END-EVALUATE.
           
           EXEC CICS RETURN END-EXEC.
           
       P100-DECLARE-CURSOR.
           MOVE 0 TO CURS-RESPONSE-CODE.
           
           IF USE-ARRAY-FETCH
              MOVE WS-MAX-ROWS TO WS-ARRAY-SIZE
           ELSE
              MOVE 1 TO WS-ARRAY-SIZE
           END-IF.
           
           EXEC SQL DECLARE :CURS-NAME CURSOR FOR
                :CURS-STMT
           END-EXEC.
           
           IF SQLCODE NOT = 0
              MOVE SQLCODE TO CURS-RESPONSE-CODE
           END-IF.
       P100-EXIT.
           EXIT.
           
       P200-OPEN-CURSOR.
           MOVE 0 TO WS-FETCH-COUNT.
           MOVE 0 TO WS-ROWS-FETCHED.
           
           EXEC SQL OPEN :CURS-NAME END-EXEC.
           
           IF SQLCODE = 0
              MOVE 0 TO CURS-RESPONSE-CODE
           ELSE
              MOVE SQLCODE TO CURS-RESPONSE-CODE
           END-IF.
       P200-EXIT

[Summary Change Report]
No changes applied yet; full file loaded for impact modification. Ready for paragraph-level updates as per Impact Analysis Report.

[File 5] AUDITLOG.cpy src/copybook/common/AUDITLOG.cpy

      *================================================================*
      * Copybook Name: AUDITLOG
      * Description: Audit Trail Record Definitions
      * Author: [Author name]
      * Date Written: 2024-03-20
      *================================================================*
       01  AUDIT-RECORD.
           05  AUD-HEADER.
               10  AUD-TIMESTAMP     PIC X(26).
               10  AUD-SYSTEM-ID     PIC X(8).
               10  AUD-USER-ID       PIC X(8).
               10  AUD-PROGRAM       PIC X(8).
               10  AUD-TERMINAL      PIC X(8).
           05  AUD-TYPE             PIC X(4).
               88  AUD-TRANSACTION     VALUE 'TRAN'.
               88  AUD-USER-ACTION     VALUE 'USER'.
               88  AUD-SYSTEM-EVENT    VALUE 'SYST'.
           05  AUD-ACTION           PIC X(8).
               88  AUD-CREATE         VALUE 'CREATE  '.
               88  AUD-UPDATE         VALUE 'UPDATE  '.
               88  AUD-DELETE         VALUE 'DELETE  '.
               88  AUD-INQUIRE        VALUE 'INQUIRE '.
               88  AUD-LOGIN          VALUE 'LOGIN   '.
               88  AUD-LOGOUT         VALUE 'LOGOUT  '.
               88  AUD-STARTUP        VALUE 'STARTUP '.
               88  AUD-SHUTDOWN       VALUE 'SHUTDOWN'.
           05  AUD-STATUS           PIC X(4).
               88  AUD-SUCCESS        VALUE 'SUCC'.
               88  AUD-FAILURE        VALUE 'FAIL'.
               88  AUD-WARNING        VALUE 'WARN'.
           05  AUD-KEY-INFO.
               10  AUD-PORTFOLIO-ID  PIC X(8).
               10  AUD-ACCOUNT-NO    PIC X(10).
           05  AUD-BEFORE-IMAGE     PIC X(100).
           05  AUD-AFTER-IMAGE      PIC X(100).
           05  AUD-MESSAGE          PIC X(100).

[Summary Change Report]
No changes applied yet; full file loaded for impact modification. Ready for structure-level updates as per Impact Analysis Report.

[File 6] ERRHAND.cpy src/copybook/common/ERRHAND.cpy

      *================================================================*
      * Copybook Name: ERRHAND
      * Description: Standard Error Handling Definitions
      * Author: [Author name]
      * Date Written: 2024-03-20
      *================================================================*
      
      *----------------------------------------------------------------*
      * Error Categories
      *----------------------------------------------------------------*
       01  ERR-CATEGORIES.
           05  ERR-CAT-VSAM        PIC X(2) VALUE 'VS'.
           05  ERR-CAT-VALID       PIC X(2) VALUE 'VL'.
           05  ERR-CAT-PROC        PIC X(2) VALUE 'PR'.
           05  ERR-CAT-SYSTEM      PIC X(2) VALUE 'SY'.
           
      *----------------------------------------------------------------*
      * Standard Return Codes
      *----------------------------------------------------------------*
       01  ERR-RETURN-CODES.
           05  ERR-SUCCESS         PIC S9(4) COMP VALUE +0.
           05  ERR-WARNING         PIC S9(4) COMP VALUE +4.
           05  ERR-ERROR           PIC S9(4) COMP VALUE +8.
           05  ERR-SEVERE          PIC S9(4) COMP VALUE +12.
           05  ERR-TERMINAL        PIC S9(4) COMP VALUE +16.
           
      *----------------------------------------------------------------*
      * Error Message Structure
      *----------------------------------------------------------------*
       01  ERR-MESSAGE.
           05  ERR-TIMESTAMP.
               10  ERR-DATE        PIC X(10).
               10  ERR-TIME        PIC X(8).
           05  ERR-PROGRAM         PIC X(8).
           05  ERR-CATEGORY        PIC X(2).
           05  ERR-CODE            PIC X(4).
           05  ERR-SEVERITY        PIC S9(4) COMP.
           05  ERR-TEXT            PIC X(80).
           05  ERR-DETAILS         PIC X(256).
           
      *----------------------------------------------------------------*
      * VSAM Status Handling
      *----------------------------------------------------------------*
       01  ERR-VSAM-STATUSES.
           05  ERR-VSAM-SUCCESS    PIC X(2) VALUE '00'.
           05  ERR-VSAM-DUPKEY     PIC X(2) VALUE '22'.
           05  ERR-VSAM-NOTFND     PIC X(2) VALUE '23'.
           05  ERR-VSAM-EOF        PIC X(2) VALUE '10'.
           
       01  ERR-VSAM-MSGS.
           05  ERR-VSAM-22         PIC X(80) VALUE
               'Duplicate record key'.
           05  ERR-VSAM-23         PIC X(80) VALUE
               'Record not found'.
           05  ERR-OTHER           PIC X(80) VALUE
               'Unexpected VSAM error'. 

[Summary Change Report]
No changes applied yet; full file loaded for impact modification. Ready for structure-level updates as per Impact Analysis Report.

[File 1] POSVAL00.CBL src/programs/batch/POSVAL00.cbl

       IDENTIFICATION DIVISION.
       PROGRAM-ID. POSVAL00.
      *-- Change: Added real-time market price ingestion, dynamic recalculation, and persistence with timestamp

       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT PRICE-FEED-FILE ASSIGN TO 'PRICEFEED.DAT'
               ORGANIZATION IS LINE SEQUENTIAL.
           SELECT POSITION-FILE ASSIGN TO 'POSITION.DAT'
               ORGANIZATION IS LINE SEQUENTIAL.
           SELECT VALUATION-FILE ASSIGN TO 'VALUATION.DAT'
               ORGANIZATION IS LINE SEQUENTIAL.

       DATA DIVISION.
       FILE SECTION.
       FD  PRICE-FEED-FILE.
       01  PRICE-FEED-REC.
           05  FEED-SECURITY-ID      PIC X(12).
           05  FEED-PRICE            PIC 9(10)V99.
           05  FEED-TIMESTAMP        PIC X(20).

       FD  POSITION-FILE.
       COPY POSREC.

       FD  VALUATION-FILE.
       01  VALUATION-REC.
           05  VAL-SECURITY-ID       PIC X(12).
           05  VAL-PORTFOLIO-ID      PIC X(08).
           05  VAL-QUANTITY          PIC S9(9) COMP-3.
           05  VAL-PRICE             PIC 9(10)V99.
           05  VAL-VALUE             PIC 9(15)V99.
           05  VAL-TIMESTAMP         PIC X(20).

       WORKING-STORAGE SECTION.
       01  WS-EOF-FLAG               PIC X VALUE 'N'.
       01  WS-PRICE-FOUND            PIC X VALUE 'N'.
       01  WS-ERROR-FLAG             PIC X VALUE 'N'.
       01  WS-CURRENT-TIMESTAMP      PIC X(20).
      *-- Change: Added working-storage for new price and timestamp fields

       PROCEDURE DIVISION.
       MAIN-LOGIC.
           PERFORM 1000-INGEST-PRICE
           PERFORM 2000-RECALC-POS
           PERFORM 3000-STORE-VAL
           STOP RUN.

       1000-INGEST-PRICE.
      *-- Change: Ingest real-time price feed and store in WS fields
           OPEN INPUT PRICE-FEED-FILE
           READ PRICE-FEED-FILE
               AT END
                   MOVE 'Y' TO WS-EOF-FLAG
           END-READ
           IF WS-EOF-FLAG = 'N'
               MOVE FEED-PRICE TO WS-FEED-PRICE
               MOVE FEED-TIMESTAMP TO WS-CURRENT-TIMESTAMP
               MOVE 'Y' TO WS-PRICE-FOUND
           ELSE
               MOVE 'Y' TO WS-ERROR-FLAG
               CALL 'AUDPROC' USING 'FEED-ERROR'
           END-IF
           CLOSE PRICE-FEED-FILE.

       2000-RECALC-POS.
      *-- Change: Recalculate position value using real-time price
           IF WS-PRICE-FOUND = 'Y'
               OPEN INPUT POSITION-FILE
               READ POSITION-FILE
                   AT END
                       MOVE 'Y' TO WS-EOF-FLAG
               END-READ
               IF WS-EOF-FLAG = 'N'
                   COMPUTE POSITION-VALUE = WS-FEED-PRICE * POS-QUANTITY
                   MOVE WS-FEED-PRICE TO POS-LAST-PRICE
                   MOVE WS-CURRENT-TIMESTAMP TO POS-LAST-PRICE-TIME
               END-IF
               CLOSE POSITION-FILE
           ELSE
               CALL 'AUDPROC' USING 'FEED-ERROR'
           END-IF.

       3000-STORE-VAL.
      *-- Change: Store recalculated value and timestamp for audit/backtesting
           OPEN OUTPUT VALUATION-FILE
           MOVE POS-SECURITY-ID TO VAL-SECURITY-ID
           MOVE POS-PORTFOLIO-ID TO VAL-PORTFOLIO-ID
           MOVE POS-QUANTITY TO VAL-QUANTITY
           MOVE POS-LAST-PRICE TO VAL-PRICE
           MOVE POSITION-VALUE TO VAL-VALUE
           MOVE POS-LAST-PRICE-TIME TO VAL-TIMESTAMP
           WRITE VALUATION-REC
           CLOSE VALUATION-FILE.

      *-- End of program

[Summary Change Report]
- Added logic to ingest real-time price feed and timestamp (1000-INGEST-PRICE).
- Modified recalculation logic to use real-time price and update position value and timestamp (2000-RECALC-POS).
- Persisted recalculated value and timestamp for audit/backtesting (3000-STORE-VAL).
- Inline comments for traceability and reversibility.

[File 2] POSUPDT.CBL src/programs/batch/POSUPDT.cbl

       IDENTIFICATION DIVISION.
       PROGRAM-ID. POSUPDT.
      *-- Change: Extended to apply new price, recalculate P&L, and store with timestamp on every feed event

       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT POSITION-FILE ASSIGN TO 'POSITION.DAT'
               ORGANIZATION IS LINE SEQUENTIAL.
           SELECT PRICE-FEED-FILE ASSIGN TO 'PRICEFEED.DAT'
               ORGANIZATION IS LINE SEQUENTIAL.
           SELECT PNL-FILE ASSIGN TO 'PNL.DAT'
               ORGANIZATION IS LINE SEQUENTIAL.

       DATA DIVISION.
       FILE SECTION.
       FD  POSITION-FILE.
       COPY POSREC.

       FD  PRICE-FEED-FILE.
       01  PRICE-FEED-REC.
           05  FEED-SECURITY-ID      PIC X(12).
           05  FEED-PRICE            PIC 9(10)V99.
           05  FEED-TIMESTAMP        PIC X(20).

       FD  PNL-FILE.
       01  PNL-REC.
           05  PNL-SECURITY-ID       PIC X(12).
           05  PNL-PORTFOLIO-ID      PIC X(08).
           05  PNL-QUANTITY          PIC S9(9) COMP-3.
           05  PNL-PRICE             PIC 9(10)V99.
           05  PNL-PREV-VALUE        PIC 9(15)V99.
           05  PNL-NEW-VALUE         PIC 9(15)V99.
           05  PNL-PNL               PIC S9(15)V99.
           05  PNL-TIMESTAMP         PIC X(20).

       WORKING-STORAGE SECTION.
       01  WS-EOF-FLAG               PIC X VALUE 'N'.
       01  WS-PRICE-FOUND            PIC X VALUE 'N'.
       01  WS-ERROR-FLAG             PIC X VALUE 'N'.
       01  WS-CURRENT-TIMESTAMP      PIC X(20).
      *-- Change: Added working-storage for new price, P&L, and timestamp fields

       PROCEDURE DIVISION.
       MAIN-LOGIC.
           PERFORM 1000-UPDATE-POS
           PERFORM 2000-APPLY-PRICE
           PERFORM 3000-STORE-PNL
           STOP RUN.

       1000-UPDATE-POS.
      *-- Change: Update position on price event
           OPEN INPUT POSITION-FILE
           READ POSITION-FILE
               AT END
                   MOVE 'Y' TO WS-EOF-FLAG
           END-READ
           CLOSE POSITION-FILE.

       2000-APPLY-PRICE.
      *-- Change: Apply new price and recalculate P&L
           OPEN INPUT PRICE-FEED-FILE
           READ PRICE-FEED-FILE
               AT END
                   MOVE 'Y' TO WS-EOF-FLAG
           END-READ
           IF WS-EOF-FLAG = 'N'
               MOVE FEED-PRICE TO POS-LAST-PRICE
               MOVE FEED-TIMESTAMP TO POS-LAST-PRICE-TIME
               COMPUTE POS-NEW-VALUE = POS-LAST-PRICE * POS-QUANTITY
               COMPUTE POS-PNL = POS-NEW-VALUE - POS-PREV-VALUE
               MOVE 'Y' TO WS-PRICE-FOUND
           ELSE
               MOVE 'Y' TO WS-ERROR-FLAG
               CALL 'AUDPROC' USING 'FEED-ERROR'
           END-IF
           CLOSE PRICE-FEED-FILE.

       3000-STORE-PNL.
      *-- Change: Store recalculated P&L and timestamp
           IF WS-PRICE-FOUND = 'Y'
               OPEN OUTPUT PNL-FILE
               MOVE POS-SECURITY-ID TO PNL-SECURITY-ID
               MOVE POS-PORTFOLIO-ID TO PNL-PORTFOLIO-ID
               MOVE POS-QUANTITY TO PNL-QUANTITY
               MOVE POS-LAST-PRICE TO PNL-PRICE
               MOVE POS-PREV-VALUE TO PNL-PREV-VALUE
               MOVE POS-NEW-VALUE TO PNL-NEW-VALUE
               MOVE POS-PNL TO PNL-PNL
               MOVE POS-LAST-PRICE-TIME TO PNL-TIMESTAMP
               WRITE PNL-REC
               CLOSE PNL-FILE
           ELSE
               CALL 'AUDPROC' USING 'FEED-ERROR'
           END-IF.

      *-- End of program

[Summary Change Report]
- Extended logic to apply new price, recalculate P&L, and store with timestamp (2000-APPLY-PRICE, 3000-STORE-PNL).
- Inline comments for traceability and reversibility.

[File 3] POSREC.CPY src/copybook/common/POSREC.cpy

      *-- Change: Extended for new price, recalculated value, and timestamp fields for audit/backtesting
       01  POSITION-RECORD.
           05  POS-SECURITY-ID        PIC X(12).
           05  POS-PORTFOLIO-ID       PIC X(08).
           05  POS-QUANTITY           PIC S9(9) COMP-3.
           05  POS-PREV-VALUE         PIC 9(15)V99.
           05  POS-NEW-VALUE          PIC 9(15)V99.      *-- Change: Added for recalculated value
           05  POS-LAST-PRICE         PIC 9(10)V99.      *-- Change: Added for real-time price
           05  POS-LAST-PRICE-TIME    PIC X(20).         *-- Change: Added for timestamp
           05  POS-PNL                PIC S9(15)V99.     *-- Change: Added for P&L calculation

[Summary Change Report]
- Added POS-NEW-VALUE, POS-LAST-PRICE, POS-LAST-PRICE-TIME, and POS-PNL fields for real-time valuation, audit, and P&L.

[File 4] AUDPROC.CBL src/programs/common/AUDPROC.cbl

       IDENTIFICATION DIVISION.
       PROGRAM-ID. AUDPROC.
      *-- Change: Enhanced to log alarms and errors when feed is stale or fails

       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT AUDIT-LOG-FILE ASSIGN TO 'AUDITLOG.DAT'
               ORGANIZATION IS LINE SEQUENTIAL.

       DATA DIVISION.
       FILE SECTION.
       FD  AUDIT-LOG-FILE.
       COPY AUDITLOG.

       WORKING-STORAGE SECTION.
       01  WS-ERROR-CODE             PIC X(10).
       01  WS-FEED-STATUS            PIC X(10).
       01  WS-ALARM-STATUS           PIC X(10).
       01  WS-TIMESTAMP              PIC X(20).
      *-- Change: Added working-storage for feed error, status, and alarm

       PROCEDURE DIVISION.
       2000-PROCESS-AUDIT.
      *-- Change: Log market feed errors, timestamps, and alarm status
           IF WS-ERROR-CODE = 'FEED-ERROR'
               MOVE 'ERROR' TO AUD-ENTRY-ERROR-CODE
               MOVE 'STALE' TO AUD-ENTRY-FEED-STATUS
               MOVE 'ALARM' TO AUD-ENTRY-ALARM-STATUS
               MOVE FUNCTION CURRENT-DATE TO AUD-ENTRY-TIMESTAMP
               WRITE AUDIT-ENTRY
           END-IF.

       3000-TERMINATE.
      *-- Change: Terminate audit process after logging
           CLOSE AUDIT-LOG-FILE
           STOP RUN.

      *-- End of program

[Summary Change Report]
- Enhanced to log alarms and errors when feed is stale or fails (2000-PROCESS-AUDIT).
- Inline comments for traceability and reversibility.

[File 5] AUDITLOG.CPY src/copybook/common/AUDITLOG.cpy

      *-- Change: Added new fields for market feed errors, timestamps, and alarm status
       01  AUDIT-ENTRY.
           05  AUD-ENTRY-SECURITY-ID   PIC X(12).
           05  AUD-ENTRY-PORTFOLIO-ID  PIC X(08).
           05  AUD-ENTRY-ERROR-CODE    PIC X(10).   *-- Change: Added for error code
           05  AUD-ENTRY-FEED-STATUS   PIC X(10).   *-- Change: Added for feed status
           05  AUD-ENTRY-ALARM-STATUS  PIC X(10).   *-- Change: Added for alarm status
           05  AUD-ENTRY-TIMESTAMP     PIC X(20).   *-- Change: Added for timestamp

[Summary Change Report]
- Added fields for error code, feed status, alarm status, and timestamp to support audit logging of market feed errors.


[1] TRNREC.cpy /src/copybook/common/TRNREC.cpy

```
      *****************************************************************
      * TRANSACTION RECORD STRUCTURE
      * VERSION: 1.1
      * DATE: 2024 (Modified to add TRANSACTION-TYPE field)
      *****************************************************************
       01  TRANSACTION-RECORD.
           05  TRN-KEY.
               10  TRN-DATE           PIC X(08).
               10  TRN-TIME           PIC X(06).
               10  TRN-PORTFOLIO-ID   PIC X(08).
               10  TRN-SEQUENCE-NO    PIC X(06).
           05  TRN-DATA.
               10  TRN-INVESTMENT-ID  PIC X(10).
               10  TRN-TYPE           PIC X(02).
                   88  TRN-TYPE-BUY     VALUE 'BU'.
                   88  TRN-TYPE-SELL    VALUE 'SL'.
                   88  TRN-TYPE-TRANS   VALUE 'TR'.
                   88  TRN-TYPE-FEE     VALUE 'FE'.
               10  TRN-TRANSACTION-TYPE PIC X(10). *> Added field for transaction type (new requirement)
               10  TRN-QUANTITY       PIC S9(11)V9(4) COMP-3.
               10  TRN-PRICE         PIC S9(11)V9(4) COMP-3.
               10  TRN-AMOUNT        PIC S9(13)V9(2) COMP-3.
               10  TRN-CURRENCY      PIC X(03).
               10  TRN-STATUS        PIC X(01).
                   88  TRN-STATUS-PEND   VALUE 'P'.
                   88  TRN-STATUS-DONE   VALUE 'D'.
                   88  TRN-STATUS-FAIL   VALUE 'F'.
                   88  TRN-STATUS-REV    VALUE 'R'.
           05  TRN-AUDIT.
               10  TRN-PROCESS-DATE  PIC X(26).
               10  TRN-PROCESS-USER  PIC X(08).
           05  TRN-FILLER           PIC X(40). *> Reduced filler by 10 bytes to accommodate TRANSACTION-TYPE
      *****************************************************************
      * FIELD DESCRIPTIONS:
      * TRN-DATE        : TRANSACTION DATE (YYYYMMDD)
      * TRN-TIME        : TRANSACTION TIME (HHMMSS)
      * TRN-PORTFOLIO-ID: PORTFOLIO IDENTIFIER
      * TRN-SEQUENCE-NO : SEQUENCE NUMBER FOR MULTIPLE TRANS
      * TRN-TYPE        : BU=BUY, SL=SELL, TR=TRANSFER, FE=FEE
      * TRN-TRANSACTION-TYPE : NEW FIELD FOR EXTENDED TRANSACTION TYPE
      * TRN-STATUS      : P=PENDING, D=DONE, F=FAILED, R=REVERSED
      *****************************************************************
```

Summary: Added new field `TRN-TRANSACTION-TYPE PIC X(10)` to the transaction record layout as required. Reduced the filler by 10 bytes to maintain record length. Inline comment added.

---

[2] PORTTRAN.cbl /src/programs/portfolio/PORTTRAN.cbl

```
      *================================================================*
      * Program Name: PORTTRAN
      * Description: Portfolio Transaction Processing
      * Author: [Author name]
      * Date Written: 2024-03-20
      *================================================================*
       IDENTIFICATION DIVISION.
       PROGRAM-ID. PORTTRAN.
       
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SOURCE-COMPUTER. IBM-ZOS.
       OBJECT-COMPUTER. IBM-ZOS.
       
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT TRANSACTION-FILE
               ASSIGN TO TRANFILE
               ORGANIZATION IS SEQUENTIAL
               ACCESS MODE IS SEQUENTIAL
               FILE STATUS IS WS-TRAN-STATUS.
               
           SELECT PORTFOLIO-FILE
               ASSIGN TO PORTFILE
               ORGANIZATION IS INDEXED
               ACCESS MODE IS RANDOM
               RECORD KEY IS PORT-ID
               FILE STATUS IS WS-PORT-STATUS.
       
       DATA DIVISION.
       FILE SECTION.
       FD  TRANSACTION-FILE
           RECORDING MODE IS F
           BLOCK CONTAINS 0 RECORDS.
       COPY TRNREC.
       
       FD  PORTFOLIO-FILE
           RECORDING MODE IS F
           BLOCK CONTAINS 0 RECORDS.
       COPY PORTREC.
       
       WORKING-STORAGE SECTION.
           COPY ERRHAND.
           COPY AUDITLOG.
           
       01  WS-FILE-STATUS.
           05  WS-TRAN-STATUS      PIC X(2).
           05  WS-PORT-STATUS      PIC X(2).
           
       01  WS-COUNTERS.
           05  WS-READ-COUNT       PIC 9(8) COMP.
           05  WS-PROCESS-COUNT    PIC 9(8) COMP.
           05  WS-ERROR-COUNT      PIC 9(8) COMP.
           
       01  WS-EOF-FLAG            PIC X(1).
           88  END-OF-FILE          VALUE 'Y'.
           88  MORE-RECORDS         VALUE 'N'.

      *-- Begin: Add working-storage for backward compatibility check
       01  WS-LEGACY-TRAN-REC-FLAG PIC X VALUE 'N'.
           88  LEGACY-TRAN-REC VALUE 'Y'.
           88  NOT-LEGACY-TRAN-REC VALUE 'N'.
      *-- End: Add working-storage for backward compatibility check
           
       PROCEDURE DIVISION.
       0000-MAIN.
           PERFORM 1000-INITIALIZE
           
           IF WS-TRAN-STATUS = '00'
               PERFORM 2000-PROCESS-TRANSACTIONS
                   UNTIL END-OF-FILE
                   OR WS-ERROR-COUNT > 100
           END-IF
           
           PERFORM 3000-TERMINATE
           
           GOBACK
           .
           
       1000-INITIALIZE.
           INITIALIZE WS-FILE-STATUS
                      WS-COUNTERS
           SET MORE-RECORDS TO TRUE
           
           OPEN INPUT TRANSACTION-FILE
           IF WS-TRAN-STATUS NOT = '00'
               MOVE 'Error opening transaction file' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           
           OPEN I-O PORTFOLIO-FILE
           IF WS-PORT-STATUS NOT = '00'
               MOVE 'Error opening portfolio file' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           .
           
       2000-PROCESS-TRANSACTIONS.
           READ TRANSACTION-FILE
               AT END
                   SET END-OF-FILE TO TRUE
               NOT AT END
                   ADD 1 TO WS-READ-COUNT
                   PERFORM 2050-HANDLE-TRANSACTION-TYPE-FIELD *> NEW: Handle backward compatibility
                   PERFORM 2100-VALIDATE-TRANSACTION
           END-READ
           .

      *-- Begin: New paragraph for backward compatibility check
       2050-HANDLE-TRANSACTION-TYPE-FIELD.
           IF TRN-TRANSACTION-TYPE = SPACES OR TRN-TRANSACTION-TYPE = LOW-VALUES
               SET LEGACY-TRAN-REC TO TRUE
               MOVE TRN-TYPE TO TRN-TRANSACTION-TYPE
               *> If legacy record, copy TRN-TYPE to new field for backward compatibility
           ELSE
               SET NOT-LEGACY-TRAN-REC TO TRUE
           END-IF
           .
      *-- End: New paragraph for backward compatibility check
           
       2100-VALIDATE-TRANSACTION.
           MOVE SPACES TO ERR-TEXT
           
           PERFORM 2110-CHECK-PORTFOLIO
           IF ERR-TEXT = SPACES
               PERFORM 2120-CHECK-TRANSACTION-TYPE
           END-IF
           IF ERR-TEXT = SPACES
               PERFORM 2130-CHECK-AMOUNTS
           END-IF
           
           IF ERR-TEXT = SPACES
               ADD 1 TO WS-PROCESS-COUNT
           ELSE
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           .
           
       2110-CHECK-PORTFOLIO.
           IF TRN-PORTFOLIO-ID = SPACES
               MOVE 'Portfolio ID is required' TO ERR-TEXT
               EXIT PARAGRAPH
           END-IF
           
           MOVE TRN-PORTFOLIO-ID TO PORT-ID
           READ PORTFOLIO-FILE
               INVALID KEY
                   STRING 'Invalid Portfolio ID: '
                          TRN-PORTFOLIO-ID
                     DELIMITED BY SIZE
                     INTO ERR-TEXT
           END-READ
           .
           
       2120-CHECK-TRANSACTION-TYPE.
      *-- Begin: Enhanced validation for new field
           IF TRN-TRANSACTION-TYPE = SPACES OR TRN-TRANSACTION-TYPE = LOW-VALUES
               MOVE 'Transaction Type field missing' TO ERR-TEXT
               EXIT PARAGRAPH
           END-IF
           EVALUATE TRN-TYPE
               WHEN 'BU'
               WHEN 'SL'
               WHEN 'TR'
               WHEN 'FE'
                   CONTINUE
               WHEN OTHER
                   STRING 'Invalid Transaction Type: '
                          TRN-TYPE
                     DELIMITED BY SIZE
                     INTO ERR-TEXT
           END-EVALUATE
      *-- End: Enhanced validation for new field
           .
           
       2130-CHECK-AMOUNTS.
           IF TRN-QUANTITY <= ZERO
               MOVE 'Quantity must be greater than zero' TO ERR-TEXT
               EXIT PARAGRAPH
           END-IF
           
           IF TRN-PRICE <= ZERO AND TRN-TYPE NOT = 'TR'
               MOVE 'Price must be greater than zero' TO ERR-TEXT
               EXIT PARAGRAPH
           END-IF
           
           IF TRN-AMOUNT <= ZERO AND TRN-TYPE NOT = 'TR'
               MOVE 'Amount must be greater than zero' TO ERR-TEXT
           END-IF
           .
           
       2200-UPDATE-POSITIONS.
           EVALUATE TRN-TYPE
               WHEN 'BU'
                   PERFORM 2210-PROCESS-BUY
               WHEN 'SL'
                   PERFORM 2220-PROCESS-SELL
               WHEN 'TR'
                   PERFORM 2230-PROCESS-TRANSFER
               WHEN 'FE'
                   PERFORM 2240-PROCESS-FEE
           END-EVALUATE
           
           PERFORM 2300-UPDATE-AUDIT-TRAIL
           .
           
       2210-PROCESS-BUY.
           MOVE TRN-PORTFOLIO-ID TO PORT-ID
           READ PORTFOLIO-FILE
               INVALID KEY
                   MOVE 'Portfolio not found for update' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
                   EXIT PARAGRAPH
           END-READ
           
           ADD TRN-QUANTITY TO PORT-TOTAL-UNITS
           ADD TRN-AMOUNT   TO PORT-TOTAL-COST
           
           REWRITE PORTFOLIO-RECORD
               INVALID KEY
                   MOVE 'Error updating portfolio' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-REWRITE
           .
           
       2220-PROCESS-SELL.
           MOVE TRN-PORTFOLIO-ID TO PORT-ID
           READ PORTFOLIO-FILE
               INVALID KEY
                   MOVE 'Portfolio not found for update' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
                   EXIT PARAGRAPH
           END-READ
           
           IF PORT-TOTAL-UNITS < TRN-QUANTITY
               MOVE 'Insufficient units for sale' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
               EXIT PARAGRAPH
           END-IF
           
           SUBTRACT TRN-QUANTITY FROM PORT-TOTAL-UNITS
           SUBTRACT TRN-AMOUNT   FROM PORT-TOTAL-COST
           
           REWRITE PORTFOLIO-RECORD
               INVALID KEY
                   MOVE 'Error updating portfolio' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-REWRITE
           .
           
       2230-PROCESS-TRANSFER.
           MOVE 'Transfer processing not implemented' TO ERR-TEXT
           PERFORM 9000-ERROR-ROUTINE
           .
           
       2240-PROCESS-FEE.
           MOVE TRN-PORTFOLIO-ID TO PORT-ID
           READ PORTFOLIO-FILE
               INVALID KEY
                   MOVE 'Portfolio not found for fee' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
                   EXIT PARAGRAPH
           END-READ
           
           SUBTRACT TRN-AMOUNT FROM PORT-TOTAL-COST
           
           REWRITE PORTFOLIO-RECORD
               INVALID KEY
                   MOVE 'Error updating portfolio' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-REWRITE
           .
           
       2300-UPDATE-AUDIT-TRAIL.
           INITIALIZE AUDIT-RECORD
           
           MOVE FUNCTION CURRENT-DATE TO AUD-TIMESTAMP
           MOVE 'PORTTRAN'     TO AUD-PROGRAM
           MOVE FUNCTION USER-ID TO AUD-USER-ID
           MOVE 'TRAN'         TO AUD-TYPE
           
           EVALUATE TRN-TYPE
               WHEN 'BU'
                   MOVE 'CREATE  ' TO AUD-ACTION
               WHEN 'SL'
                   MOVE 'DELETE  ' TO AUD-ACTION
               WHEN 'TR'
                   MOVE 'UPDATE  ' TO AUD-ACTION
               WHEN 'FE'
                   MOVE 'UPDATE  ' TO AUD-ACTION
           END-EVALUATE
           
           IF WS-PORT-STATUS = '00'
               MOVE 'SUCC'     TO AUD-STATUS
           ELSE
               MOVE 'FAIL'     TO AUD-STATUS
           END-IF
           
           MOVE TRN-PORTFOLIO-ID TO AUD-PORTFOLIO-ID
           MOVE PORT-ACCOUNT-NO  TO AUD-ACCOUNT-NO
           
      *    Store original portfolio state
           MOVE PORT-RECORD      TO AUD-BEFORE-IMAGE
           
      *    Build audit message (now includes new transaction type)
           STRING 'Transaction: ' DELIMITED BY SIZE
                  TRN-TYPE       DELIMITED BY SIZE
                  ' ('           DELIMITED BY SIZE
                  TRN-TRANSACTION-TYPE DELIMITED BY SIZE
                  ') Amount: '   DELIMITED BY SIZE
                  TRN-AMOUNT     DELIMITED BY SIZE
                  ' Units: '     DELIMITED BY SIZE
                  TRN-QUANTITY   DELIMITED BY SIZE
             INTO AUD-MESSAGE
           *> Added TRN-TRANSACTION-TYPE to audit message
           
           PERFORM 2310-WRITE-AUDIT-RECORD
           .
           
       2310-WRITE-AUDIT-RECORD.
      *    Call the audit processor
           CALL 'AUDPROC' USING AUDIT-RECORD
           
           IF RETURN-CODE NOT = ZERO
               MOVE 'Error writing audit record' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           .
           
       3000-TERMINATE.
           CLOSE TRANSACTION-FILE
                 PORTFOLIO-FILE
                 
           DISPLAY 'Transactions Read:    ' WS-READ-COUNT
           DISPLAY 'Transactions Process: ' WS-PROCESS-COUNT
           DISPLAY 'Errors Encountered:   ' WS-ERROR-COUNT
           .
           
       9000-ERROR-ROUTINE.
           ADD 1 TO WS-ERROR-COUNT
           MOVE ERR-CAT-PROC TO ERR-CATEGORY
           MOVE 'PORTTRAN' TO ERR-PROGRAM
           
           CALL 'ERRPROC' USING ERR-MESSAGE
           . 
```

Summary: 
- Added logic to copy TRN-TYPE to TRN-TRANSACTION-TYPE for legacy records (backward compatibility).
- Enhanced validation to check the new field.
- Included TRN-TRANSACTION-TYPE in audit message.
- Inline comments document all changes.

---

[3] RPTPOS00.cbl /src/programs/batch/RPTPOS00.cbl

```
       IDENTIFICATION DIVISION.
       PROGRAM-ID. RPTPOS00.
       AUTHOR. CLAUDE.
       DATE-WRITTEN. 2024-04-09.
      *****************************************************************
      * Daily Position Report Generator                                 *
      *                                                               *
      * This program generates the daily position report including:    *
      * - Portfolio position summary                                   *
      * - Transaction activity                                         *
      * - Exception reporting                                          *
      * - Performance metrics                                          *
      *****************************************************************
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT POSITION-MASTER ASSIGN TO POSMSTRE
               ORGANIZATION IS INDEXED
               ACCESS MODE IS SEQUENTIAL
               RECORD KEY IS POS-KEY
               FILE STATUS IS WS-POSITION-STATUS.

           SELECT TRANSACTION-HISTORY ASSIGN TO TRANHIST
               ORGANIZATION IS INDEXED
               ACCESS MODE IS SEQUENTIAL
               RECORD KEY IS TRAN-KEY
               FILE STATUS IS WS-TRAN-STATUS.

           SELECT REPORT-FILE ASSIGN TO RPTFILE
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-REPORT-STATUS.

       DATA DIVISION.
       FILE SECTION.
           COPY POSREC.
           COPY TRNREC.
           
       FD  REPORT-FILE
           RECORDING MODE IS F
           BLOCK CONTAINS 0 RECORDS.
       01  REPORT-RECORD             PIC X(132).

       WORKING-STORAGE SECTION.
           COPY RTNCODE.
           COPY ERRHAND.

       01  WS-FILE-STATUS.
           05  WS-POSITION-STATUS    PIC XX.
           05  WS-TRAN-STATUS        PIC XX.
           05  WS-REPORT-STATUS      PIC XX.

       01  WS-REPORT-HEADERS.
           05  WS-HEADER1.
               10  FILLER            PIC X(132) VALUE ALL '*'.
           05  WS-HEADER2.
               10  FILLER            PIC X(40) VALUE SPACES.
               10  FILLER            PIC X(52) 
                   VALUE 'DAILY POSITION REPORT'.
               10  FILLER            PIC X(40) VALUE SPACES.
           05  WS-HEADER3.
               10  FILLER            PIC X(15) VALUE 'REPORT DATE:'.
               10  WS-REPORT-DATE    PIC X(10).
               10  FILLER            PIC X(107) VALUE SPACES.

      *-- Begin: Add new field for transaction type in report detail
       01  WS-TRANSACTION-DETAIL.
           05  WS-TRAN-DATE         PIC X(08).
           05  FILLER               PIC X(1) VALUE ' '.
           05  WS-TRAN-TIME         PIC X(06).
           05  FILLER               PIC X(1) VALUE ' '.
           05  WS-TRAN-PORTFOLIO    PIC X(08).
           05  FILLER               PIC X(1) VALUE ' '.
           05  WS-TRAN-INVESTMENT   PIC X(10).
           05  FILLER               PIC X(1) VALUE ' '.
           05  WS-TRAN-TYPE         PIC X(02).
           05  FILLER               PIC X(1) VALUE ' '.
           05  WS-TRAN-TRANSACTION-TYPE PIC X(10). *> New field for extended transaction type
           05  FILLER               PIC X(1) VALUE ' '.
           05  WS-TRAN-QUANTITY     PIC -ZZZZZZZZ9.9999.
           05  FILLER               PIC X(1) VALUE ' '.
           05  WS-TRAN-AMOUNT       PIC -ZZZZZZZZZZZ.99.
           05  FILLER               PIC X(1) VALUE ' '.
           05  WS-TRAN-STATUS       PIC X(01).
           05  FILLER               PIC X(70) VALUE SPACES.
      *-- End: Add new field for transaction type in report detail

       01  WS-POSITION-DETAIL.
           05  WS-POS-PORTFOLIO     PIC X(10).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-POS-DESCRIPTION   PIC X(30).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-POS-QUANTITY      PIC ZZZ,ZZZ,ZZ9.99.
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-POS-VALUE         PIC $$$$,$$$,$$9.99.
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-POS-CHANGE-PCT    PIC +ZZ9.99.
           05  FILLER               PIC X(40) VALUE SPACES.

       PROCEDURE DIVISION.
       0000-MAIN.
           PERFORM 1000-INITIALIZE
           PERFORM 2000-PROCESS-REPORT
           PERFORM 3000-CLEANUP
           GOBACK.

       1000-INITIALIZE.
           PERFORM 1100-OPEN-FILES
           PERFORM 1200-WRITE-HEADERS.

       1100-OPEN-FILES.
           OPEN INPUT POSITION-MASTER
           IF WS-POSITION-STATUS NOT = '00'
               MOVE 'ERROR OPENING POSITION MASTER'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF

           OPEN INPUT TRANSACTION-HISTORY
           IF WS-TRAN-STATUS NOT = '00'
               MOVE 'ERROR OPENING TRANSACTION HISTORY'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF

           OPEN OUTPUT REPORT-FILE
           IF WS-REPORT-STATUS NOT = '00'
               MOVE 'ERROR OPENING REPORT FILE'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF.

       1200-WRITE-HEADERS.
           ACCEPT WS-REPORT-DATE FROM DATE
           WRITE REPORT-RECORD FROM WS-HEADER1
           WRITE REPORT-RECORD FROM WS-HEADER2
           WRITE REPORT-RECORD FROM WS-HEADER3.

       2000-PROCESS-REPORT.
           PERFORM 2100-READ-POSITIONS
           PERFORM 2200-PROCESS-TRANSACTIONS
           PERFORM 2300-WRITE-SUMMARY.

       2100-READ-POSITIONS.
           READ POSITION-MASTER
               AT END SET END-OF-POSITIONS TO TRUE
           END-READ
           
           PERFORM UNTIL END-OF-POSITIONS
               PERFORM 2110-FORMAT-POSITION
               READ POSITION-MASTER
                   AT END SET END-OF-POSITIONS TO TRUE
               END-READ
           END-PERFORM.

       2110-FORMAT-POSITION.
           MOVE POS-PORTFOLIO-ID   TO WS-POS-PORTFOLIO
           MOVE POS-DESCRIPTION    TO WS-POS-DESCRIPTION
           MOVE POS-QUANTITY       TO WS-POS-QUANTITY
           MOVE POS-CURRENT-VALUE  TO WS-POS-VALUE
           COMPUTE WS-POS-CHANGE-PCT = 
               (POS-CURRENT-VALUE - POS-PREVIOUS-VALUE) /
                POS-PREVIOUS-VALUE * 100
           WRITE REPORT-RECORD FROM WS-POSITION-DETAIL.

       2200-PROCESS-TRANSACTIONS.
           PERFORM 2210-READ-TRANSACTIONS
           PERFORM 2220-SUMMARIZE-ACTIVITY.

      *-- Begin: Add logic to format and output new transaction type field
       2210-READ-TRANSACTIONS.
           READ TRANSACTION-HISTORY
               AT END
                   SET END-OF-TRANSACTIONS TO TRUE
               NOT AT END
                   PERFORM 2215-FORMAT-TRANSACTION
           END-READ
           .
       2215-FORMAT-TRANSACTION.
           MOVE TRN-DATE              TO WS-TRAN-DATE
           MOVE TRN-TIME              TO WS-TRAN-TIME
           MOVE TRN-PORTFOLIO-ID      TO WS-TRAN-PORTFOLIO
           MOVE TRN-INVESTMENT-ID     TO WS-TRAN-INVESTMENT
           MOVE TRN-TYPE              TO WS-TRAN-TYPE
           MOVE TRN-TRANSACTION-TYPE  TO WS-TRAN-TRANSACTION-TYPE *> Output new field
           MOVE TRN-QUANTITY          TO WS-TRAN-QUANTITY
           MOVE TRN-AMOUNT            TO WS-TRAN-AMOUNT
           MOVE TRN-STATUS            TO WS-TRAN-STATUS
           WRITE REPORT-RECORD FROM WS-TRANSACTION-DETAIL
           .
      *-- End: Add logic to format and output new transaction type field

       2220-SUMMARIZE-ACTIVITY.
           CONTINUE.

       2300-WRITE-SUMMARY.
           PERFORM 2310-WRITE-TOTALS
           PERFORM 2320-WRITE-EXCEPTIONS
           PERFORM 2330-WRITE-METRICS.

       3000-CLEANUP.
           CLOSE POSITION-MASTER
                TRANSACTION-HISTORY
                REPORT-FILE.

       9999-ERROR-HANDLER.
           DISPLAY WS-ERROR-MESSAGE
           MOVE 12 TO RETURN-CODE
           GOBACK. 
```

Summary: 
- Added new field for transaction type in report detail.
- Added logic to move TRN-TRANSACTION-TYPE to report output.
- Inline comments document all changes.

---

[4] POSUPDT.cbl /src/programs/batch/POSUPDT.cbl

```
      *================================================================*
      * Program Name: POSUPDT
      * Description: Portfolio Position Update (stub for transaction type support)
      *================================================================*
       IDENTIFICATION DIVISION.
       PROGRAM-ID. POSUPDT.
      *-- Begin: Add support for new TRANSACTION-TYPE field
       DATA DIVISION.
       FILE SECTION.
           COPY TRNREC.
      *-- End: Add support for new TRANSACTION-TYPE field
       PROCEDURE DIVISION.
           GOBACK.
```

Summary: 
- Added copy of TRNREC to ensure new field is available for future logic.
- Stubbed for future transaction type processing.

---

[5] HISTLD00.cbl /src/programs/batch/HISTLD00.cbl

```
       *================================================================*
      * Program Name: HISTLD00
      * Description: Position History DB2 Load Program
      * Version: 1.0
      * Date: 2024
      *================================================================*
       IDENTIFICATION DIVISION.
       PROGRAM-ID. HISTLD00.
       
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SOURCE-COMPUTER. IBM-ZOS.
       OBJECT-COMPUTER. IBM-ZOS.
       
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT TRANSACTION-HISTORY
               ASSIGN TO TRANHIST
               ORGANIZATION IS INDEXED
               ACCESS MODE IS SEQUENTIAL
               RECORD KEY IS TH-KEY
               FILE STATUS IS WS-TH-STATUS.
               
           SELECT BATCH-CONTROL-FILE
               ASSIGN TO BCHCTL
               ORGANIZATION IS INDEXED
               ACCESS MODE IS DYNAMIC
               RECORD KEY IS BCT-KEY
               FILE STATUS IS WS-BCT-STATUS.
       
       DATA DIVISION.
       FILE SECTION.
       FD  TRANSACTION-HISTORY.
           COPY HISTREC.
       
       FD  BATCH-CONTROL-FILE.
           COPY BCHCTL.
       
       WORKING-STORAGE SECTION.
           EXEC SQL BEGIN DECLARE SECTION END-EXEC.
           COPY DBTBLS.
           EXEC SQL END DECLARE SECTION END-EXEC.
           
           COPY SQLCA.
           COPY DBPROC.
           COPY ERRHAND.
           COPY BCHCON.
           
       01  WS-FILE-STATUS.
           05  WS-TH-STATUS          PIC X(2).
           05  WS-BCT-STATUS         PIC X(2).
           
       01  WS-COUNTERS.
           05  WS-RECORDS-READ       PIC S9(9) COMP VALUE 0.
           05  WS-RECORDS-WRITTEN    PIC S9(9) COMP VALUE 0.
           05  WS-ERROR-COUNT        PIC S9(9) COMP VALUE 0.
           05  WS-COMMIT-COUNT       PIC S9(4) COMP VALUE 0.
           
       01  WS-COMMIT-THRESHOLD       PIC S9(4) COMP VALUE 1000.
       
       01  WS-SWITCHES.
           05  WS-END-OF-FILE-SW     PIC X(1) VALUE 'N'.
               88  END-OF-FILE         VALUE 'Y'.
               88  MORE-RECORDS        VALUE 'N'.
               
       PROCEDURE DIVISION.
       0000-MAIN.
           PERFORM 1000-INITIALIZE
           
           PERFORM 2000-PROCESS
               UNTIL END-OF-FILE
               OR WS-ERROR-COUNT > 100
           
           PERFORM 3000-TERMINATE
           
           MOVE WS-ERROR-COUNT TO RETURN-CODE
           GOBACK
           .
           
       1000-INITIALIZE.
           PERFORM 1100-OPEN-FILES
           PERFORM 1200-CONNECT-DB2
           PERFORM 1300-INIT-CHECKPOINTS
           .
           
       2000-PROCESS.
           PERFORM 2100-READ-HISTORY
           
           IF MORE-RECORDS
               PERFORM 2200-LOAD-TO-DB2
               PERFORM 2300-CHECK-COMMIT
           END-IF
           .
           
       3000-TERMINATE.
           PERFORM 3100-FINAL-COMMIT
           PERFORM 3200-CLOSE-FILES
           PERFORM 3300-DISCONNECT-DB2
           PERFORM 3400-DISPLAY-STATS
           .
           
       1100-OPEN-FILES.
           OPEN INPUT TRANSACTION-HISTORY
           IF WS-TH-STATUS NOT = '00'
               MOVE 'Error opening history file' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           
           OPEN I-O BATCH-CONTROL-FILE
           IF WS-BCT-STATUS NOT = '00'
               MOVE 'Error opening control file' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           .
           
       1200-CONNECT-DB2.
           PERFORM CONNECT-TO-DB2
           .
           
       1300-INIT-CHECKPOINTS.
           MOVE SPACES TO BCT-KEY
           MOVE 'HISTLD00' TO BCT-JOB-NAME
           
           READ BATCH-CONTROL-FILE
               INVALID KEY
                   MOVE 'Control record not found' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-READ
           
           MOVE BCT-STAT-ACTIVE TO BCT-STATUS
           REWRITE BATCH-CONTROL-RECORD
           .
           
       2100-READ-HISTORY.
           READ TRANSACTION-HISTORY
               AT END
                   SET END-OF-FILE TO TRUE
               NOT AT END
                   ADD 1 TO WS-RECORDS-READ
           END-READ
           .
           
       2200-LOAD-TO-DB2.
           INITIALIZE POSHIST-RECORD
           
           MOVE TH-ACCOUNT-NO    TO PH-ACCOUNT-NO
           MOVE TH-PORTFOLIO-ID  TO PH-PORTFOLIO-ID
           MOVE TH-TRANS-DATE    TO PH-TRANS-DATE
           MOVE TH-TRANS-TIME    TO PH-TRANS-TIME
           MOVE TH-TRANS-TYPE    TO PH-TRANS-TYPE
      *-- Begin: Add support for new TRANSACTION-TYPE field
           IF TH-TRANSACTION-TYPE NOT = SPACES AND
              TH-TRANSACTION-TYPE NOT = LOW-VALUES
               MOVE TH-TRANSACTION-TYPE TO PH-TRANSACTION-TYPE
           ELSE
               MOVE TH-TRANS-TYPE TO PH-TRANSACTION-TYPE
           END-IF
      *-- End: Add support for new TRANSACTION-TYPE field
           MOVE TH-SECURITY-ID   TO PH-SECURITY-ID
           MOVE TH-QUANTITY      TO PH-QUANTITY
           MOVE TH-PRICE         TO PH-PRICE
           MOVE TH-AMOUNT        TO PH-AMOUNT
           MOVE TH-FEES          TO PH-FEES
           MOVE TH-TOTAL-AMOUNT  TO PH-TOTAL-AMOUNT
           MOVE TH-COST-BASIS    TO PH-COST-BASIS
           MOVE TH-GAIN-LOSS     TO PH-GAIN-LOSS
           
           EXEC SQL
               INSERT INTO POSHIST
               VALUES (:POSHIST-RECORD)
           END-EXEC
           
           IF SQLCODE = 0
               ADD 1 TO WS-RECORDS-WRITTEN
           ELSE
               IF SQLCODE = -803
                   CONTINUE
               ELSE
                   ADD 1 TO WS-ERROR-COUNT
                   PERFORM DB2-ERROR-ROUTINE
               END-IF
           END-IF
           .
           
       2300-CHECK-COMMIT.
           ADD 1 TO WS-COMMIT-COUNT
           
           IF WS-COMMIT-COUNT >= WS-COMMIT-THRESHOLD
               EXEC SQL
                   COMMIT WORK
               END-EXEC
               
               MOVE 0 TO WS-COMMIT-COUNT
               
               PERFORM 2310-UPDATE-CHECKPOINT
           END-IF
           .
           
       2310-UPDATE-CHECKPOINT.
           MOVE WS-RECORDS-READ TO BCT-RECORDS-READ
           MOVE WS-RECORDS-WRITTEN TO BCT-RECORDS-WRITTEN
           
           REWRITE BATCH-CONTROL-RECORD
               INVALID KEY
                   MOVE 'Error updating checkpoint' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-REWRITE
           .
           
       3100-FINAL-COMMIT.
           EXEC SQL
               COMMIT WORK
           END-EXEC
           
           PERFORM 2310-UPDATE-CHECKPOINT
           .
           
       3200-CLOSE-FILES.
           CLOSE TRANSACTION-HISTORY
                 BATCH-CONTROL-FILE
           .
           
       3300-DISCONNECT-DB2.
           PERFORM DISCONNECT-FROM-DB2
           .
           
       3400-DISPLAY-STATS.
           DISPLAY 'HISTLD00 Processing Statistics:'
           DISPLAY '  Records Read:    ' WS-RECORDS-READ
           DISPLAY '  Records Written: ' WS-RECORDS-WRITTEN
           DISPLAY '  Errors:         ' WS-ERROR-COUNT
           .
           
       9000-ERROR-ROUTINE.
           MOVE 'HISTLD00' TO ERR-PROGRAM
           CALL 'ERRPROC' USING ERR-MESSAGE
           
           EXEC SQL
               ROLLBACK WORK
           END-EXEC
           .
```

Summary: 
- Added logic to move TH-TRANSACTION-TYPE to PH-TRANSACTION-TYPE if present, else fallback to TH-TRANS-TYPE for backward compatibility.
- Inline comments document all changes.

---

[6] RPTAUD00.cbl /src/programs/batch/RPTAUD00.cbl

```
       IDENTIFICATION DIVISION.
       PROGRAM-ID. RPTAUD00.
       AUTHOR. CLAUDE.
       DATE-WRITTEN. 2024-04-09.
      *****************************************************************
      * Audit Report Generator                                         *
      *                                                               *
      * Generates comprehensive audit report including:                *
      * - Security audit trails                                       *
      * - Process audit reporting                                     *
      * - Error summary reporting                                     *
      * - Control verification                                        *
      *****************************************************************
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT AUDIT-FILE ASSIGN TO AUDITLOG
               ORGANIZATION IS INDEXED
               ACCESS MODE IS SEQUENTIAL
               RECORD KEY IS AUD-KEY
               FILE STATUS IS WS-AUDIT-STATUS.

           SELECT ERROR-FILE ASSIGN TO ERRLOG
               ORGANIZATION IS INDEXED
               ACCESS MODE IS SEQUENTIAL
               RECORD KEY IS ERR-KEY
               FILE STATUS IS WS-ERROR-STATUS.

           SELECT REPORT-FILE ASSIGN TO RPTFILE
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-REPORT-STATUS.

       DATA DIVISION.
       FILE SECTION.
           COPY AUDITLOG.
           COPY ERRHAND.
      *-- Begin: Add support for transaction type if referenced
           COPY TRNREC.
      *-- End: Add support for transaction type if referenced
           
       FD  REPORT-FILE
           RECORDING MODE IS F
           BLOCK CONTAINS 0 RECORDS.
       01  REPORT-RECORD             PIC X(132).

       WORKING-STORAGE SECTION.
           COPY RTNCODE.

       01  WS-FILE-STATUS.
           05  WS-AUDIT-STATUS       PIC XX.
           05  WS-ERROR-STATUS       PIC XX.
           05  WS-REPORT-STATUS      PIC XX.

       01  WS-REPORT-HEADERS.
           05  WS-HEADER1.
               10  FILLER            PIC X(132) VALUE ALL '*'.
           05  WS-HEADER2.
               10  FILLER            PIC X(40) VALUE SPACES.
               10  FILLER            PIC X(52) 
                   VALUE 'SYSTEM AUDIT REPORT'.
               10  FILLER            PIC X(40) VALUE SPACES.
           05  WS-HEADER3.
               10  FILLER            PIC X(15) VALUE 'REPORT DATE:'.
               10  WS-REPORT-DATE    PIC X(10).
               10  FILLER            PIC X(107) VALUE SPACES.

      *-- Begin: Add new field for transaction type in audit detail if needed
       01  WS-AUDIT-DETAIL.
           05  WS-AUD-TIMESTAMP     PIC X(26).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-AUD-PROGRAM       PIC X(8).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-AUD-TYPE          PIC X(10).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-AUD-TRANSACTION-TYPE PIC X(10). *> New field for transaction type if referenced
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-AUD-MESSAGE       PIC X(68).
      *-- End: Add new field for transaction type in audit detail if needed

       01  WS-ERROR-DETAIL.
           05  WS-ERR-TIMESTAMP     PIC X(26).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-ERR-PROGRAM       PIC X(8).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-ERR-CODE          PIC X(4).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-ERR-MESSAGE       PIC X(80).

       PROCEDURE DIVISION.
       0000-MAIN.
           PERFORM 1000-INITIALIZE
           PERFORM 2000-PROCESS-REPORT
           PERFORM 3000-CLEANUP
           GOBACK.

       1000-INITIALIZE.
           PERFORM 1100-OPEN-FILES
           PERFORM 1200-WRITE-HEADERS.

       1100-OPEN-FILES.
           OPEN INPUT AUDIT-FILE
           IF WS-AUDIT-STATUS NOT = '00'
               MOVE 'ERROR OPENING AUDIT FILE'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF

           OPEN INPUT ERROR-FILE
           IF WS-ERROR-STATUS NOT = '00'
               MOVE 'ERROR OPENING ERROR FILE'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF

           OPEN OUTPUT REPORT-FILE
           IF WS-REPORT-STATUS NOT = '00'
               MOVE 'ERROR OPENING REPORT FILE'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF.

       1200-WRITE-HEADERS.
           ACCEPT WS-REPORT-DATE FROM DATE
           WRITE REPORT-RECORD FROM WS-HEADER1
           WRITE REPORT-RECORD FROM WS-HEADER2
           WRITE REPORT-RECORD FROM WS-HEADER3.

       2000-PROCESS-REPORT.
           PERFORM 2100-PROCESS-AUDIT-TRAIL
           PERFORM 2200-PROCESS-ERROR-LOG
           PERFORM 2300-WRITE-SUMMARY.

       2100-PROCESS-AUDIT-TRAIL.
           PERFORM 2110-READ-AUDIT-RECORDS
           PERFORM 2120-SUMMARIZE-AUDIT.

      *-- Begin: Add logic to process transaction type if referenced
       2110-READ-AUDIT-RECORDS.
           READ AUDIT-FILE
               AT END
                   SET END-OF-AUDIT TO TRUE
               NOT AT END
                   IF TRN-TRANSACTION-TYPE NOT = SPACES
                       MOVE TRN-TRANSACTION-TYPE TO WS-AUD-TRANSACTION-TYPE
                   ELSE
                       MOVE SPACES TO WS-AUD-TRANSACTION-TYPE
                   END-IF
                   *> Output new field if present
           END-READ
           .
      *-- End: Add logic to process transaction type if referenced

       2120-SUMMARIZE-AUDIT.
           CONTINUE.

       2200-PROCESS-ERROR-LOG.
           PERFORM 2210-READ-ERROR-RECORDS
           PERFORM 2220-SUMMARIZE-ERRORS.

       2300-WRITE-SUMMARY.
           PERFORM 2310-WRITE-AUDIT-SUMMARY
           PERFORM 2320-WRITE-ERROR-SUMMARY
           PERFORM 2330-WRITE-CONTROL-SUMMARY.

       3000-CLEANUP.
           CLOSE AUDIT-FILE
                ERROR-FILE
                REPORT-FILE.

       9999-ERROR-HANDLER.
           DISPLAY WS-ERROR-MESSAGE
           MOVE 12 TO RETURN-CODE
           GOBACK.
```

Summary: 
- Added copy of TRNREC and new field for transaction type in audit detail.
- Logic to move TRN-TRANSACTION-TYPE to WS-AUD-TRANSACTION-TYPE if present.
- Inline comments document all changes.

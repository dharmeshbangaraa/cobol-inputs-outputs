01  TRANSACTION-RECORD.
    05  TRN-DATA.
        10  TRN-ID                PIC 9(8).
        10  TRN-DATE              PIC 9(8).
        10  TRN-AMOUNT            PIC S9(9)V99 COMP-3.
        10  TRN-DESCRIPTION       PIC X(30).
        10  TRN-ACCOUNT-NO        PIC X(12).
        10  TRN-STATUS            PIC X(01).
        10  TRN-USER              PIC X(08).
        10  TRN-TYPE              PIC X(10).      * Added: Transaction Type field for new requirements

IDENTIFICATION DIVISION.
PROGRAM-ID. PORTTRAN.
ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT TRANSACTION-FILE ASSIGN TO 'TRANSACT.DAT'
        ORGANIZATION IS LINE SEQUENTIAL.

DATA DIVISION.
FILE SECTION.
FD  TRANSACTION-FILE.
COPY 'TRNREC.cpy'.

WORKING-STORAGE SECTION.
01  WS-EOF-FLAG           PIC X VALUE 'N'.
01  WS-TRANSACTION-COUNT   PIC 9(6) VALUE ZEROES.

PROCEDURE DIVISION.
BEGIN.
    OPEN INPUT TRANSACTION-FILE
    PERFORM UNTIL WS-EOF-FLAG = 'Y'
        READ TRANSACTION-FILE
            AT END
                MOVE 'Y' TO WS-EOF-FLAG
            NOT AT END
                PERFORM PROCESS-TRANSACTION
        END-READ
    END-PERFORM
    CLOSE TRANSACTION-FILE
    STOP RUN.

PROCESS-TRANSACTION.
    * Existing logic for processing transaction
    * Validate new TRANSACTION-TYPE field for backward compatibility
    IF TRN-TYPE = SPACES OR TRN-TYPE = LOW-VALUES
        MOVE 'UNKNOWN' TO TRN-TYPE
        * Inline comment: Default value for legacy records
    END-IF
    * Further processing using TRN-TYPE as needed
    ADD 1 TO WS-TRANSACTION-COUNT.

IDENTIFICATION DIVISION.
PROGRAM-ID. RPTPOS00.
ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT TRANSACTION-FILE ASSIGN TO 'TRANSACT.DAT'
        ORGANIZATION IS LINE SEQUENTIAL.
    SELECT REPORT-FILE ASSIGN TO 'REPORT.OUT'
        ORGANIZATION IS LINE SEQUENTIAL.

DATA DIVISION.
FILE SECTION.
FD  TRANSACTION-FILE.
COPY 'TRNREC.cpy'.
FD  REPORT-FILE.
01  REPORT-RECORD         PIC X(132).

WORKING-STORAGE SECTION.
01  WS-EOF-FLAG           PIC X VALUE 'N'.

PROCEDURE DIVISION.
BEGIN.
    OPEN INPUT TRANSACTION-FILE
    OPEN OUTPUT REPORT-FILE
    PERFORM UNTIL WS-EOF-FLAG = 'Y'
        READ TRANSACTION-FILE
            AT END
                MOVE 'Y' TO WS-EOF-FLAG
            NOT AT END
                PERFORM WRITE-REPORT-RECORD
        END-READ
    END-PERFORM
    CLOSE TRANSACTION-FILE
    CLOSE REPORT-FILE
    STOP RUN.

WRITE-REPORT-RECORD.
    * Ensure TRANSACTION-TYPE is present for report
    IF TRN-TYPE = SPACES OR TRN-TYPE = LOW-VALUES
        MOVE 'UNKNOWN' TO TRN-TYPE
    END-IF
    STRING
        TRN-ID DELIMITED BY SIZE
        ' ' DELIMITED BY SIZE
        TRN-DATE DELIMITED BY SIZE
        ' ' DELIMITED BY SIZE
        TRN-AMOUNT DELIMITED BY SIZE
        ' ' DELIMITED BY SIZE
        TRN-DESCRIPTION DELIMITED BY SIZE
        ' ' DELIMITED BY SIZE
        TRN-ACCOUNT-NO DELIMITED BY SIZE
        ' ' DELIMITED BY SIZE
        TRN-STATUS DELIMITED BY SIZE
        ' ' DELIMITED BY SIZE
        TRN-USER DELIMITED BY SIZE
        ' ' DELIMITED BY SIZE
        TRN-TYPE DELIMITED BY SIZE      * Added: Output Transaction Type
        INTO REPORT-RECORD
    END-STRING
    WRITE REPORT-RECORD.

IDENTIFICATION DIVISION.
PROGRAM-ID. POSUPDT.
ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT TRANSACTION-FILE ASSIGN TO 'TRANSACT.DAT'
        ORGANIZATION IS LINE SEQUENTIAL.

DATA DIVISION.
FILE SECTION.
FD  TRANSACTION-FILE.
COPY 'TRNREC.cpy'.

WORKING-STORAGE SECTION.
01  WS-EOF-FLAG           PIC X VALUE 'N'.

PROCEDURE DIVISION.
BEGIN.
    OPEN INPUT TRANSACTION-FILE
    PERFORM UNTIL WS-EOF-FLAG = 'Y'
        READ TRANSACTION-FILE
            AT END
                MOVE 'Y' TO WS-EOF-FLAG
            NOT AT END
                PERFORM UPDATE-POSITION
        END-READ
    END-PERFORM
    CLOSE TRANSACTION-FILE
    STOP RUN.

UPDATE-POSITION.
    * Ensure TRANSACTION-TYPE is handled for update logic
    IF TRN-TYPE = SPACES OR TRN-TYPE = LOW-VALUES
        MOVE 'UNKNOWN' TO TRN-TYPE
    END-IF
    * Existing update logic using TRN-TYPE as needed

IDENTIFICATION DIVISION.
PROGRAM-ID. HISTLD00.
ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT TRANSACTION-FILE ASSIGN TO 'TRANSACT.DAT'
        ORGANIZATION IS LINE SEQUENTIAL.

DATA DIVISION.
FILE SECTION.
FD  TRANSACTION-FILE.
COPY 'TRNREC.cpy'.

WORKING-STORAGE SECTION.
01  WS-EOF-FLAG           PIC X VALUE 'N'.

PROCEDURE DIVISION.
BEGIN.
    OPEN INPUT TRANSACTION-FILE
    PERFORM UNTIL WS-EOF-FLAG = 'Y'
        READ TRANSACTION-FILE
            AT END
                MOVE 'Y' TO WS-EOF-FLAG
            NOT AT END
                PERFORM LOAD-HISTORY
        END-READ
    END-PERFORM
    CLOSE TRANSACTION-FILE
    STOP RUN.

LOAD-HISTORY.
    * Ensure TRANSACTION-TYPE is present for history load
    IF TRN-TYPE = SPACES OR TRN-TYPE = LOW-VALUES
        MOVE 'UNKNOWN' TO TRN-TYPE
    END-IF
    * Existing logic for loading transaction history

IDENTIFICATION DIVISION.
PROGRAM-ID. RPTAUD00.
ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT TRANSACTION-FILE ASSIGN TO 'TRANSACT.DAT'
        ORGANIZATION IS LINE SEQUENTIAL.
    SELECT AUDIT-REPORT-FILE ASSIGN TO 'AUDIT.OUT'
        ORGANIZATION IS LINE SEQUENTIAL.

DATA DIVISION.
FILE SECTION.
FD  TRANSACTION-FILE.
COPY 'TRNREC.cpy'.
FD  AUDIT-REPORT-FILE.
01  AUDIT-REPORT-RECORD   PIC X(132).

WORKING-STORAGE SECTION.
01  WS-EOF-FLAG           PIC X VALUE 'N'.

PROCEDURE DIVISION.
BEGIN.
    OPEN INPUT TRANSACTION-FILE
    OPEN OUTPUT AUDIT-REPORT-FILE
    PERFORM UNTIL WS-EOF-FLAG = 'Y'
        READ TRANSACTION-FILE
            AT END
                MOVE 'Y' TO WS-EOF-FLAG
            NOT AT END
                PERFORM WRITE-AUDIT-RECORD
        END-READ
    END-PERFORM
    CLOSE TRANSACTION-FILE
    CLOSE AUDIT-REPORT-FILE
    STOP RUN.

WRITE-AUDIT-RECORD.
    * Ensure TRANSACTION-TYPE is present for audit report
    IF TRN-TYPE = SPACES OR TRN-TYPE = LOW-VALUES
        MOVE 'UNKNOWN' TO TRN-TYPE
    END-IF
    STRING
        TRN-ID DELIMITED BY SIZE
        ' ' DELIMITED BY SIZE
        TRN-DATE DELIMITED BY SIZE
        ' ' DELIMITED BY SIZE
        TRN-AMOUNT DELIMITED BY SIZE
        ' ' DELIMITED BY SIZE
        TRN-TYPE DELIMITED BY SIZE      * Added: Output Transaction Type in audit
        INTO AUDIT-REPORT-RECORD
    END-STRING
    WRITE AUDIT-REPORT-RECORD.

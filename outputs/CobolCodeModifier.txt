[File 1] RPTPOS00.cbl src/programs/batch/RPTPOS00.cbl

       IDENTIFICATION DIVISION.
       PROGRAM-ID. RPTPOS00.
      *-- Change: Integrated real-time price feed for dynamic portfolio valuation
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT POS-FILE ASSIGN TO 'POS.DAT'
               ORGANIZATION IS SEQUENTIAL.
           SELECT PRICE-FEED ASSIGN TO 'PRICEFEED.DAT'
               ORGANIZATION IS SEQUENTIAL.
      *-- Change: Added PRICE-FEED for real-time prices

       DATA DIVISION.
       FILE SECTION.
       FD  POS-FILE.
       COPY POSREC.
       FD  PRICE-FEED.
       01  PRICE-FEED-REC.
           05  FEED-PORTFOLIO-ID   PIC X(08).
           05  FEED-SECURITY-ID    PIC X(12).
           05  FEED-PRICE          PIC 9(10)V99.
           05  FEED-TIMESTAMP      PIC X(20).
      *-- Change: Added structure for real-time price feed

       WORKING-STORAGE SECTION.
       01  WS-END-OF-FILE         PIC X VALUE 'N'.
       01  WS-END-OF-FEED         PIC X VALUE 'N'.
       01  WS-REALTIME-PRICE      PIC 9(10)V99.
       01  WS-REALTIME-TIMESTAMP  PIC X(20).
       01  WS-PREVIOUS-PRICE      PIC 9(10)V99.
       01  WS-PREVIOUS-PNL        PIC S9(13)V99.
       01  WS-ERROR-CODE          PIC 9(04) VALUE ZEROES.
       01  WS-ALARM-FLAG          PIC X VALUE SPACE.
      *-- Change: Added working-storage for real-time price and error handling

       PROCEDURE DIVISION.
       MAIN-LOGIC.
           OPEN INPUT POS-FILE
           OPEN INPUT PRICE-FEED
           PERFORM 1000-INITIALIZE
           PERFORM 2000-PROCESS-REPORT UNTIL WS-END-OF-FILE = 'Y'
           CLOSE POS-FILE
           CLOSE PRICE-FEED
           STOP RUN.

       1000-INITIALIZE.
      *-- Change: Initialization logic for new fields
           MOVE ZEROES TO WS-REALTIME-PRICE
           MOVE SPACES TO WS-REALTIME-TIMESTAMP
           MOVE ZEROES TO WS-PREVIOUS-PRICE
           MOVE ZEROES TO WS-PREVIOUS-PNL
           MOVE SPACE TO WS-ALARM-FLAG.

       2000-PROCESS-REPORT.
           READ POS-FILE
               AT END
                   MOVE 'Y' TO WS-END-OF-FILE
                   GO TO 2999-EXIT
           END-READ
      *-- Change: Begin integration of real-time price feed
           PERFORM 2100-GET-REALTIME-PRICE
           IF WS-ERROR-CODE NOT = ZEROES
               MOVE 'Y' TO WS-ALARM-FLAG
               PERFORM 2200-LOG-FEED-ERROR
           END-IF
           PERFORM 2110-FORMAT-POSITION
           GO TO 2000-PROCESS-REPORT.

       2100-GET-REALTIME-PRICE.
      *-- Change: Fetch real-time price for current position
           READ PRICE-FEED
               AT END
                   MOVE 'Y' TO WS-END-OF-FEED
                   MOVE 9999 TO WS-ERROR-CODE
                   MOVE 'FEED END' TO WS-REALTIME-TIMESTAMP
                   GO TO 2199-EXIT
           END-READ
           IF FEED-PORTFOLIO-ID = POS-PORTFOLIO-ID
               MOVE FEED-PRICE TO WS-REALTIME-PRICE
               MOVE FEED-TIMESTAMP TO WS-REALTIME-TIMESTAMP
               MOVE ZEROES TO WS-ERROR-CODE
           ELSE
               MOVE 1001 TO WS-ERROR-CODE
           END-IF.
       2199-EXIT.
           EXIT.

       2110-FORMAT-POSITION.
      *-- Change: Recalculate P&L using real-time price, update POSREC fields
           COMPUTE POS-REALTIME-PNL = (WS-REALTIME-PRICE - POS-LAST-PRICE) * POS-QUANTITY
      *-- Change: Store real-time price and timestamp in POSREC
           MOVE WS-REALTIME-PRICE TO POS-REALTIME-PRICE
           MOVE WS-REALTIME-TIMESTAMP TO POS-REALTIME-TIMESTAMP
           .
       2200-LOG-FEED-ERROR.
      *-- Change: Call audit logging for feed error/alarm
           CALL 'AUDPROC' USING WS-ERROR-CODE, WS-REALTIME-TIMESTAMP, POS-PORTFOLIO-ID
           .
       2999-EXIT.
           EXIT.

[Summary Change Report]
- Integrated real-time price feed by adding PRICE-FEED file and related structures.
- Updated 2000-PROCESS-REPORT to fetch and use real-time prices for position valuation.
- Added error handling and audit logging for feed failures.
- Modified 2110-FORMAT-POSITION to recalculate P&L using real-time price and store new fields.
- All changes are marked with *-- Change comments for traceability.

[File 2] POSREC.cpy src/copybook/common/POSREC.cpy

       01  POSITION-RECORD.
           05  POS-KEY.
               10  POS-PORTFOLIO-ID   PIC X(08).
               10  POS-DATE           PIC X(08).
               10  POS-SECURITY-ID    PIC X(12).
           05  POS-QUANTITY           PIC S9(9) COMP-3.
           05  POS-LAST-PRICE         PIC 9(10)V99.
           05  POS-LAST-PNL           PIC S9(13)V99.
      *-- Change: Added real-time price, P&L, and timestamp fields
           05  POS-REALTIME-PRICE     PIC 9(10)V99.
           05  POS-REALTIME-PNL       PIC S9(13)V99.
           05  POS-REALTIME-TIMESTAMP PIC X(20).

[Summary Change Report]
- Extended POSITION-RECORD to include POS-REALTIME-PRICE, POS-REALTIME-PNL, and POS-REALTIME-TIMESTAMP for real-time valuation.
- All changes are marked with *-- Change comments for traceability.

[File 3] POSUPDT.cbl src/programs/batch/POSUPDT.cbl

       IDENTIFICATION DIVISION.
       PROGRAM-ID. POSUPDT.
      *-- Change: Enhanced for real-time price update and P&L recalculation
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT POS-FILE ASSIGN TO 'POS.DAT'
               ORGANIZATION IS SEQUENTIAL.
           SELECT PRICE-FEED ASSIGN TO 'PRICEFEED.DAT'
               ORGANIZATION IS SEQUENTIAL.

       DATA DIVISION.
       FILE SECTION.
       FD  POS-FILE.
       COPY POSREC.
       FD  PRICE-FEED.
       01  PRICE-FEED-REC.
           05  FEED-PORTFOLIO-ID   PIC X(08).
           05  FEED-SECURITY-ID    PIC X(12).
           05  FEED-PRICE          PIC 9(10)V99.
           05  FEED-TIMESTAMP      PIC X(20).

       WORKING-STORAGE SECTION.
       01  WS-END-OF-FILE         PIC X VALUE 'N'.
       01  WS-END-OF-FEED         PIC X VALUE 'N'.
       01  WS-REALTIME-PRICE      PIC 9(10)V99.
       01  WS-REALTIME-TIMESTAMP  PIC X(20).
       01  WS-ERROR-CODE          PIC 9(04) VALUE ZEROES.

       PROCEDURE DIVISION.
       MAIN-LOGIC.
           OPEN INPUT POS-FILE
           OPEN INPUT PRICE-FEED
           PERFORM 1000-INITIALIZE
           PERFORM 2000-UPDATE-POSITION UNTIL WS-END-OF-FILE = 'Y'
           CLOSE POS-FILE
           CLOSE PRICE-FEED
           STOP RUN.

       1000-INITIALIZE.
           MOVE ZEROES TO WS-REALTIME-PRICE
           MOVE SPACES TO WS-REALTIME-TIMESTAMP.

       2000-UPDATE-POSITION.
           READ POS-FILE
               AT END
                   MOVE 'Y' TO WS-END-OF-FILE
                   GO TO 2999-EXIT
           END-READ
      *-- Change: Fetch real-time price for update
           PERFORM 2100-GET-REALTIME-PRICE
           IF WS-ERROR-CODE = ZEROES
      *-- Change: Recalculate and persist new P&L and price values
               COMPUTE POS-REALTIME-PNL = (WS-REALTIME-PRICE - POS-LAST-PRICE) * POS-QUANTITY
               MOVE WS-REALTIME-PRICE TO POS-REALTIME-PRICE
               MOVE WS-REALTIME-TIMESTAMP TO POS-REALTIME-TIMESTAMP
           END-IF
           GO TO 2000-UPDATE-POSITION.

       2100-GET-REALTIME-PRICE.
           READ PRICE-FEED
               AT END
                   MOVE 'Y' TO WS-END-OF-FEED
                   MOVE 9999 TO WS-ERROR-CODE
                   GO TO 2199-EXIT
           END-READ
           IF FEED-PORTFOLIO-ID = POS-PORTFOLIO-ID
               MOVE FEED-PRICE TO WS-REALTIME-PRICE
               MOVE FEED-TIMESTAMP TO WS-REALTIME-TIMESTAMP
               MOVE ZEROES TO WS-ERROR-CODE
           ELSE
               MOVE 1001 TO WS-ERROR-CODE
           END-IF.
       2199-EXIT.
           EXIT.

       2999-EXIT.
           EXIT.

[Summary Change Report]
- Enhanced to fetch real-time price and timestamp for each position update.
- Recalculates and persists new P&L and price values in POSREC.
- All changes are marked with *-- Change comments for traceability.

[File 4] AUDPROC.cbl src/programs/common/AUDPROC.cbl

       IDENTIFICATION DIVISION.
       PROGRAM-ID. AUDPROC.
      *-- Change: Enhanced for real-time feed error and alarm logging
       ENVIRONMENT DIVISION.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  WS-ERROR-CODE          PIC 9(04).
       01  WS-TIMESTAMP           PIC X(20).
       01  WS-PORTFOLIO-ID        PIC X(08).
       01  WS-ALARM-TEXT          PIC X(40).
       01  WS-ALARM-FLAG          PIC X.

       COPY AUDITLOG.

       PROCEDURE DIVISION USING WS-ERROR-CODE, WS-TIMESTAMP, WS-PORTFOLIO-ID.
       2000-PROCESS-AUDIT.
      *-- Change: Log new alarm and error conditions for real-time feed
           IF WS-ERROR-CODE NOT = ZEROES
               MOVE WS-ERROR-CODE TO AUD-ERROR-CODE
               MOVE WS-TIMESTAMP TO AUD-TIMESTAMP
               MOVE WS-PORTFOLIO-ID TO AUD-PORTFOLIO-ID
               MOVE 'FEED ERROR' TO AUD-ALARM-TYPE
               PERFORM 2100-WRITE-AUDIT-LOG
           ELSE
               MOVE 'NORMAL' TO AUD-ALARM-TYPE
               PERFORM 2100-WRITE-AUDIT-LOG
           END-IF.
           EXIT.

       2100-WRITE-AUDIT-LOG.
      *-- Change: Write audit log record (implementation as per system)
           .
           EXIT.

[Summary Change Report]
- Enhanced 2000-PROCESS-AUDIT to log new alarm and error conditions for real-time feed monitoring.
- All changes are marked with *-- Change comments for traceability.

[File 5] AUDITLOG.cpy src/copybook/common/AUDITLOG.cpy

       01  AUDIT-LOG-RECORD.
           05  AUD-TIMESTAMP        PIC X(20).
           05  AUD-PORTFOLIO-ID    PIC X(08).
           05  AUD-ERROR-CODE      PIC 9(04).
      *-- Change: Added alarm type for real-time feed monitoring
           05  AUD-ALARM-TYPE      PIC X(20).

[Summary Change Report]
- Extended AUDIT-LOG-RECORD to include AUD-ALARM-TYPE for new alarm and error conditions.
- All changes are marked with *-- Change comments for traceability.

     *****************************************************************
     * TRANSACTION RECORD STRUCTURE
     * VERSION: 1.0
     * DATE: 2024
     *****************************************************************
      01  TRANSACTION-RECORD.
          05  TRN-KEY.
              10  TRN-DATE           PIC X(08).
              10  TRN-TIME           PIC X(06).
              10  TRN-PORTFOLIO-ID   PIC X(08).
              10  TRN-SEQUENCE-NO    PIC X(06).
          05  TRN-DATA.
              10  TRN-INVESTMENT-ID  PIC X(10).
              10  TRN-TYPE           PIC X(02).
                  88  TRN-TYPE-BUY     VALUE 'BU'.
                  88  TRN-TYPE-SELL    VALUE 'SL'.
                  88  TRN-TYPE-TRANS   VALUE 'TR'.
                  88  TRN-TYPE-FEE     VALUE 'FE'.
              10  TRN-QUANTITY       PIC S9(11)V9(4) COMP-3.
              10  TRN-PRICE         PIC S9(11)V9(4) COMP-3.
              10  TRN-AMOUNT        PIC S9(13)V9(2) COMP-3.
              10  TRN-CURRENCY      PIC X(03).
              10  TRN-STATUS        PIC X(01).
                  88  TRN-STATUS-PEND   VALUE 'P'.
                  88  TRN-STATUS-DONE   VALUE 'D'.
                  88  TRN-STATUS-FAIL   VALUE 'F'.
                  88  TRN-STATUS-REV    VALUE 'R'.
              10  TRANSACTION-TYPE   PIC X(10). *> Added: Transaction Type field for extensible transaction classification
          05  TRN-AUDIT.
              10  TRN-PROCESS-DATE  PIC X(26).
              10  TRN-PROCESS-USER  PIC X(08).
          05  TRN-FILLER           PIC X(40). *> Reduced filler by 10 bytes to accommodate TRANSACTION-TYPE
     *****************************************************************
     * FIELD DESCRIPTIONS:
     * TRN-DATE        : TRANSACTION DATE (YYYYMMDD)
     * TRN-TIME        : TRANSACTION TIME (HHMMSS)
     * TRN-PORTFOLIO-ID: PORTFOLIO IDENTIFIER
     * TRN-SEQUENCE-NO : SEQUENCE NUMBER FOR MULTIPLE TRANS
     * TRN-TYPE        : BU=BUY, SL=SELL, TR=TRANSFER, FE=FEE
     * TRANSACTION-TYPE: NEW FIELD, EXTENSIBLE TRANSACTION CLASSIFICATION
     * TRN-STATUS      : P=PENDING, D=DONE, F=FAILED, R=REVERSED
     *****************************************************************

     *================================================================*
     * Program Name: PORTTRAN
     * Description: Portfolio Transaction Processing
     * Author: [Author name]
     * Date Written: 2024-03-20
     *================================================================*
      IDENTIFICATION DIVISION.
      PROGRAM-ID. PORTTRAN.
      
      ENVIRONMENT DIVISION.
      CONFIGURATION SECTION.
      SOURCE-COMPUTER. IBM-ZOS.
      OBJECT-COMPUTER. IBM-ZOS.
      
      INPUT-OUTPUT SECTION.
      FILE-CONTROL.
          SELECT TRANSACTION-FILE
              ASSIGN TO TRANFILE
              ORGANIZATION IS SEQUENTIAL
              ACCESS MODE IS SEQUENTIAL
              FILE STATUS IS WS-TRAN-STATUS.
              
          SELECT PORTFOLIO-FILE
              ASSIGN TO PORTFILE
              ORGANIZATION IS INDEXED
              ACCESS MODE IS RANDOM
              RECORD KEY IS PORT-ID
              FILE STATUS IS WS-PORT-STATUS.
      
      DATA DIVISION.
      FILE SECTION.
      FD  TRANSACTION-FILE
          RECORDING MODE IS F
          BLOCK CONTAINS 0 RECORDS.
      COPY TRNREC.
      
      FD  PORTFOLIO-FILE
          RECORDING MODE IS F
          BLOCK CONTAINS 0 RECORDS.
      COPY PORTREC.
      
      WORKING-STORAGE SECTION.
          COPY ERRHAND.
          COPY AUDITLOG.
          
      01  WS-FILE-STATUS.
          05  WS-TRAN-STATUS      PIC X(2).
          05  WS-PORT-STATUS      PIC X(2).
          
      01  WS-COUNTERS.
          05  WS-READ-COUNT       PIC 9(8) COMP.
          05  WS-PROCESS-COUNT    PIC 9(8) COMP.
          05  WS-ERROR-COUNT      PIC 9(8) COMP.
          
      01  WS-EOF-FLAG            PIC X(1).
          88  END-OF-FILE          VALUE 'Y'.
          88  MORE-RECORDS         VALUE 'N'.

      01  WS-TRANSACTION-TYPE-DEFAULT  PIC X(10) VALUE SPACES. *> For backward compatibility
      
      PROCEDURE DIVISION.
      0000-MAIN.
          PERFORM 1000-INITIALIZE
          
          IF WS-TRAN-STATUS = '00'
              PERFORM 2000-PROCESS-TRANSACTIONS
                  UNTIL END-OF-FILE
                  OR WS-ERROR-COUNT > 100
          END-IF
          
          PERFORM 3000-TERMINATE
          
          GOBACK
          .
          
      1000-INITIALIZE.
          INITIALIZE WS-FILE-STATUS
                     WS-COUNTERS
          SET MORE-RECORDS TO TRUE
          
          OPEN INPUT TRANSACTION-FILE
          IF WS-TRAN-STATUS NOT = '00'
              MOVE 'Error opening transaction file' TO ERR-TEXT
              PERFORM 9000-ERROR-ROUTINE
          END-IF
          
          OPEN I-O PORTFOLIO-FILE
          IF WS-PORT-STATUS NOT = '00'
              MOVE 'Error opening portfolio file' TO ERR-TEXT
              PERFORM 9000-ERROR-ROUTINE
          END-IF
          .
          
      2000-PROCESS-TRANSACTIONS.
          READ TRANSACTION-FILE
              AT END
                  SET END-OF-FILE TO TRUE
              NOT AT END
                  ADD 1 TO WS-READ-COUNT
                  *> Backward compatibility: If TRANSACTION-TYPE is missing, set to default
                  IF TRANSACTION-TYPE = SPACES OR TRANSACTION-TYPE = LOW-VALUES
                      MOVE WS-TRANSACTION-TYPE-DEFAULT TO TRANSACTION-TYPE
                  END-IF
                  PERFORM 2100-VALIDATE-TRANSACTION
          END-READ
          .
          
      2100-VALIDATE-TRANSACTION.
          MOVE SPACES TO ERR-TEXT
          
          PERFORM 2110-CHECK-PORTFOLIO
          IF ERR-TEXT = SPACES
              PERFORM 2120-CHECK-TRANSACTION-TYPE
          END-IF
          IF ERR-TEXT = SPACES
              PERFORM 2130-CHECK-AMOUNTS
          END-IF
          *> Validate new TRANSACTION-TYPE field if present
          IF ERR-TEXT = SPACES
              PERFORM 2140-VALIDATE-TRANSACTION-TYPE
          END-IF
          
          IF ERR-TEXT = SPACES
              ADD 1 TO WS-PROCESS-COUNT
          ELSE
              PERFORM 9000-ERROR-ROUTINE
          END-IF
          .
          
      2110-CHECK-PORTFOLIO.
          IF TRN-PORTFOLIO-ID = SPACES
              MOVE 'Portfolio ID is required' TO ERR-TEXT
              EXIT PARAGRAPH
          END-IF
          
          MOVE TRN-PORTFOLIO-ID TO PORT-ID
          READ PORTFOLIO-FILE
              INVALID KEY
                  STRING 'Invalid Portfolio ID: '
                         TRN-PORTFOLIO-ID
                    DELIMITED BY SIZE
                    INTO ERR-TEXT
          END-READ
          .
          
      2120-CHECK-TRANSACTION-TYPE.
          EVALUATE TRN-TYPE
              WHEN 'BU'
              WHEN 'SL'
              WHEN 'TR'
              WHEN 'FE'
                  CONTINUE
              WHEN OTHER
                  STRING 'Invalid Transaction Type: '
                         TRN-TYPE
                    DELIMITED BY SIZE
                    INTO ERR-TEXT
          END-EVALUATE
          .
      
      2140-VALIDATE-TRANSACTION-TYPE.
          *> Inline comment: Validate new TRANSACTION-TYPE field (if present)
          IF TRANSACTION-TYPE NOT = SPACES
              IF FUNCTION LENGTH(TRANSACTION-TYPE) > 10
                  MOVE 'TRANSACTION-TYPE too long' TO ERR-TEXT
              END-IF
          END-IF
          .
          
      2130-CHECK-AMOUNTS.
          IF TRN-QUANTITY <= ZERO
              MOVE 'Quantity must be greater than zero' TO ERR-TEXT
              EXIT PARAGRAPH
          END-IF
          
          IF TRN-PRICE <= ZERO AND TRN-TYPE NOT = 'TR'
              MOVE 'Price must be greater than zero' TO ERR-TEXT
              EXIT PARAGRAPH
          END-IF
          
          IF TRN-AMOUNT <= ZERO AND TRN-TYPE NOT = 'TR'
              MOVE 'Amount must be greater than zero' TO ERR-TEXT
          END-IF
          .
          
      2200-UPDATE-POSITIONS.
          EVALUATE TRN-TYPE
              WHEN 'BU'
                  PERFORM 2210-PROCESS-BUY
              WHEN 'SL'
                  PERFORM 2220-PROCESS-SELL
              WHEN 'TR'
                  PERFORM 2230-PROCESS-TRANSFER
              WHEN 'FE'
                  PERFORM 2240-PROCESS-FEE
          END-EVALUATE
          
          PERFORM 2300-UPDATE-AUDIT-TRAIL
          .
          
      2210-PROCESS-BUY.
          MOVE TRN-PORTFOLIO-ID TO PORT-ID
          READ PORTFOLIO-FILE
              INVALID KEY
                  MOVE 'Portfolio not found for update' TO ERR-TEXT
                  PERFORM 9000-ERROR-ROUTINE
                  EXIT PARAGRAPH
          END-READ
          
          ADD TRN-QUANTITY TO PORT-TOTAL-UNITS
          ADD TRN-AMOUNT   TO PORT-TOTAL-COST
          
          REWRITE PORTFOLIO-RECORD
              INVALID KEY
                  MOVE 'Error updating portfolio' TO ERR-TEXT
                  PERFORM 9000-ERROR-ROUTINE
          END-REWRITE
          .
          
      2220-PROCESS-SELL.
          MOVE TRN-PORTFOLIO-ID TO PORT-ID
          READ PORTFOLIO-FILE
              INVALID KEY
                  MOVE 'Portfolio not found for update' TO ERR-TEXT
                  PERFORM 9000-ERROR-ROUTINE
                  EXIT PARAGRAPH
          END-READ
          
          IF PORT-TOTAL-UNITS < TRN-QUANTITY
              MOVE 'Insufficient units for sale' TO ERR-TEXT
              PERFORM 9000-ERROR-ROUTINE
              EXIT PARAGRAPH
          END-IF
          
          SUBTRACT TRN-QUANTITY FROM PORT-TOTAL-UNITS
          SUBTRACT TRN-AMOUNT   FROM PORT-TOTAL-COST
          
          REWRITE PORTFOLIO-RECORD
              INVALID KEY
                  MOVE 'Error updating portfolio' TO ERR-TEXT
                  PERFORM 9000-ERROR-ROUTINE
          END-REWRITE
          .
          
      2230-PROCESS-TRANSFER.
          MOVE 'Transfer processing not implemented' TO ERR-TEXT
          PERFORM 9000-ERROR-ROUTINE
          .
          
      2240-PROCESS-FEE.
          MOVE TRN-PORTFOLIO-ID TO PORT-ID
          READ PORTFOLIO-FILE
              INVALID KEY
                  MOVE 'Portfolio not found for fee' TO ERR-TEXT
                  PERFORM 9000-ERROR-ROUTINE
                  EXIT PARAGRAPH
          END-READ
          
          SUBTRACT TRN-AMOUNT FROM PORT-TOTAL-COST
          
          REWRITE PORTFOLIO-RECORD
              INVALID KEY
                  MOVE 'Error updating portfolio' TO ERR-TEXT
                  PERFORM 9000-ERROR-ROUTINE
          END-REWRITE
          .
          
      2300-UPDATE-AUDIT-TRAIL.
          INITIALIZE AUDIT-RECORD
          
          MOVE FUNCTION CURRENT-DATE TO AUD-TIMESTAMP
          MOVE 'PORTTRAN'     TO AUD-PROGRAM
          MOVE FUNCTION USER-ID TO AUD-USER-ID
          MOVE 'TRAN'         TO AUD-TYPE
          
          EVALUATE TRN-TYPE
              WHEN 'BU'
                  MOVE 'CREATE  ' TO AUD-ACTION
              WHEN 'SL'
                  MOVE 'DELETE  ' TO AUD-ACTION
              WHEN 'TR'
                  MOVE 'UPDATE  ' TO AUD-ACTION
              WHEN 'FE'
                  MOVE 'UPDATE  ' TO AUD-ACTION
          END-EVALUATE
          
          IF WS-PORT-STATUS = '00'
              MOVE 'SUCC'     TO AUD-STATUS
          ELSE
              MOVE 'FAIL'     TO AUD-STATUS
          END-IF
          
          MOVE TRN-PORTFOLIO-ID TO AUD-PORTFOLIO-ID
          MOVE PORT-ACCOUNT-NO  TO AUD-ACCOUNT-NO
          
     *    Store original portfolio state
          MOVE PORT-RECORD      TO AUD-BEFORE-IMAGE
          
     *    Build audit message
          STRING 'Transaction: ' DELIMITED BY SIZE
                 TRN-TYPE       DELIMITED BY SIZE
                 ' Amount: '    DELIMITED BY SIZE
                 TRN-AMOUNT     DELIMITED BY SIZE
                 ' Units: '     DELIMITED BY SIZE
                 TRN-QUANTITY   DELIMITED BY SIZE
                 ' Type: '      DELIMITED BY SIZE
                 TRANSACTION-TYPE DELIMITED BY SIZE
            INTO AUD-MESSAGE
          *> Added TRANSACTION-TYPE to audit message
          
          PERFORM 2310-WRITE-AUDIT-RECORD
          .
          
      2310-WRITE-AUDIT-RECORD.
     *    Call the audit processor
          CALL 'AUDPROC' USING AUDIT-RECORD
          
          IF RETURN-CODE NOT = ZERO
              MOVE 'Error writing audit record' TO ERR-TEXT
              PERFORM 9000-ERROR-ROUTINE
          END-IF
          .
          
      3000-TERMINATE.
          CLOSE TRANSACTION-FILE
                PORTFOLIO-FILE
                
          DISPLAY 'Transactions Read:    ' WS-READ-COUNT
          DISPLAY 'Transactions Process: ' WS-PROCESS-COUNT
          DISPLAY 'Errors Encountered:   ' WS-ERROR-COUNT
          .
          
      9000-ERROR-ROUTINE.
          ADD 1 TO WS-ERROR-COUNT
          MOVE ERR-CAT-PROC TO ERR-CATEGORY
          MOVE 'PORTTRAN' TO ERR-PROGRAM
          
          CALL 'ERRPROC' USING ERR-MESSAGE
          .

      IDENTIFICATION DIVISION.
      PROGRAM-ID. RPTPOS00.
      AUTHOR. CLAUDE.
      DATE-WRITTEN. 2024-04-09.
     *****************************************************************
     * Daily Position Report Generator                                 *
     *                                                               *
     * This program generates the daily position report including:    *
     * - Portfolio position summary                                   *
     * - Transaction activity                                         *
     * - Exception reporting                                          *
     * - Performance metrics                                          *
     *****************************************************************
      ENVIRONMENT DIVISION.
      INPUT-OUTPUT SECTION.
      FILE-CONTROL.
          SELECT POSITION-MASTER ASSIGN TO POSMSTRE
              ORGANIZATION IS INDEXED
              ACCESS MODE IS SEQUENTIAL
              RECORD KEY IS POS-KEY
              FILE STATUS IS WS-POSITION-STATUS.

          SELECT TRANSACTION-HISTORY ASSIGN TO TRANHIST
              ORGANIZATION IS INDEXED
              ACCESS MODE IS SEQUENTIAL
              RECORD KEY IS TRAN-KEY
              FILE STATUS IS WS-TRAN-STATUS.

          SELECT REPORT-FILE ASSIGN TO RPTFILE
              ORGANIZATION IS SEQUENTIAL
              FILE STATUS IS WS-REPORT-STATUS.

      DATA DIVISION.
      FILE SECTION.
          COPY POSREC.
          COPY TRNREC.
          
      FD  REPORT-FILE
          RECORDING MODE IS F
          BLOCK CONTAINS 0 RECORDS.
      01  REPORT-RECORD             PIC X(132).

      WORKING-STORAGE SECTION.
          COPY RTNCODE.
          COPY ERRHAND.

      01  WS-FILE-STATUS.
          05  WS-POSITION-STATUS    PIC XX.
          05  WS-TRAN-STATUS        PIC XX.
          05  WS-REPORT-STATUS      PIC XX.

      01  WS-REPORT-HEADERS.
          05  WS-HEADER1.
              10  FILLER            PIC X(132) VALUE ALL '*'.
          05  WS-HEADER2.
              10  FILLER            PIC X(40) VALUE SPACES.
              10  FILLER            PIC X(52) 
                  VALUE 'DAILY POSITION REPORT'.
              10  FILLER            PIC X(40) VALUE SPACES.
          05  WS-HEADER3.
              10  FILLER            PIC X(15) VALUE 'REPORT DATE:'.
              10  WS-REPORT-DATE    PIC X(10).
              10  FILLER            PIC X(107) VALUE SPACES.

      01  WS-POSITION-DETAIL.
          05  WS-POS-PORTFOLIO     PIC X(10).
          05  FILLER               PIC X(2) VALUE SPACES.
          05  WS-POS-DESCRIPTION   PIC X(30).
          05  FILLER               PIC X(2) VALUE SPACES.
          05  WS-POS-QUANTITY      PIC ZZZ,ZZZ,ZZ9.99.
          05  FILLER               PIC X(2) VALUE SPACES.
          05  WS-POS-VALUE         PIC $$$$,$$$,$$9.99.
          05  FILLER               PIC X(2) VALUE SPACES.
          05  WS-POS-CHANGE-PCT    PIC +ZZ9.99.
          05  FILLER               PIC X(40) VALUE SPACES.

      01  WS-TRANSACTION-DETAIL.
          05  WS-TRAN-DATE         PIC X(8).
          05  FILLER               PIC X(1) VALUE ' '.
          05  WS-TRAN-TYPE         PIC X(2).
          05  FILLER               PIC X(1) VALUE ' '.
          05  WS-TRAN-AMOUNT       PIC ZZZ,ZZZ,ZZ9.99.
          05  FILLER               PIC X(1) VALUE ' '.
          05  WS-TRAN-STATUS       PIC X(1).
          05  FILLER               PIC X(1) VALUE ' '.
          05  WS-TRANSACTION-TYPE  PIC X(10). *> Added for new field
          05  FILLER               PIC X(107) VALUE SPACES.

      PROCEDURE DIVISION.
      0000-MAIN.
          PERFORM 1000-INITIALIZE
          PERFORM 2000-PROCESS-REPORT
          PERFORM 3000-CLEANUP
          GOBACK.

      1000-INITIALIZE.
          PERFORM 1100-OPEN-FILES
          PERFORM 1200-WRITE-HEADERS.

      1100-OPEN-FILES.
          OPEN INPUT POSITION-MASTER
          IF WS-POSITION-STATUS NOT = '00'
              MOVE 'ERROR OPENING POSITION MASTER'
                TO WS-ERROR-MESSAGE
              PERFORM 9999-ERROR-HANDLER
          END-IF

          OPEN INPUT TRANSACTION-HISTORY
          IF WS-TRAN-STATUS NOT = '00'
              MOVE 'ERROR OPENING TRANSACTION HISTORY'
                TO WS-ERROR-MESSAGE
              PERFORM 9999-ERROR-HANDLER
          END-IF

          OPEN OUTPUT REPORT-FILE
          IF WS-REPORT-STATUS NOT = '00'
              MOVE 'ERROR OPENING REPORT FILE'
                TO WS-ERROR-MESSAGE
              PERFORM 9999-ERROR-HANDLER
          END-IF.

      1200-WRITE-HEADERS.
          ACCEPT WS-REPORT-DATE FROM DATE
          WRITE REPORT-RECORD FROM WS-HEADER1
          WRITE REPORT-RECORD FROM WS-HEADER2
          WRITE REPORT-RECORD FROM WS-HEADER3.

      2000-PROCESS-REPORT.
          PERFORM 2100-READ-POSITIONS
          PERFORM 2200-PROCESS-TRANSACTIONS
          PERFORM 2300-WRITE-SUMMARY.

      2100-READ-POSITIONS.
          READ POSITION-MASTER
              AT END SET END-OF-POSITIONS TO TRUE
          END-READ
          
          PERFORM UNTIL END-OF-POSITIONS
              PERFORM 2110-FORMAT-POSITION
              READ POSITION-MASTER
                  AT END SET END-OF-POSITIONS TO TRUE
              END-READ
          END-PERFORM.

      2110-FORMAT-POSITION.
          MOVE POS-PORTFOLIO-ID   TO WS-POS-PORTFOLIO
          MOVE POS-DESCRIPTION    TO WS-POS-DESCRIPTION
          MOVE POS-QUANTITY       TO WS-POS-QUANTITY
          MOVE POS-CURRENT-VALUE  TO WS-POS-VALUE
          COMPUTE WS-POS-CHANGE-PCT = 
              (POS-CURRENT-VALUE - POS-PREVIOUS-VALUE) /
               POS-PREVIOUS-VALUE * 100
          WRITE REPORT-RECORD FROM WS-POSITION-DETAIL.

      2200-PROCESS-TRANSACTIONS.
          PERFORM 2210-READ-TRANSACTIONS
          PERFORM 2220-SUMMARIZE-ACTIVITY.

      2210-READ-TRANSACTIONS.
          READ TRANSACTION-HISTORY
              AT END
                  CONTINUE
              NOT AT END
                  *> Populate new transaction type field in report
                  MOVE TRN-DATE TO WS-TRAN-DATE
                  MOVE TRN-TYPE TO WS-TRAN-TYPE
                  MOVE TRN-AMOUNT TO WS-TRAN-AMOUNT
                  MOVE TRN-STATUS TO WS-TRAN-STATUS
                  IF TRANSACTION-TYPE = SPACES OR TRANSACTION-TYPE = LOW-VALUES
                      MOVE ' ' TO WS-TRANSACTION-TYPE
                  ELSE
                      MOVE TRANSACTION-TYPE TO WS-TRANSACTION-TYPE
                  END-IF
                  WRITE REPORT-RECORD FROM WS-TRANSACTION-DETAIL
                  PERFORM 2210-READ-TRANSACTIONS
          END-READ.

      2220-SUMMARIZE-ACTIVITY.
          CONTINUE.

      2300-WRITE-SUMMARY.
          PERFORM 2310-WRITE-TOTALS
          PERFORM 2320-WRITE-EXCEPTIONS
          PERFORM 2330-WRITE-METRICS.

      3000-CLEANUP.
          CLOSE POSITION-MASTER
               TRANSACTION-HISTORY
               REPORT-FILE.

      9999-ERROR-HANDLER.
          DISPLAY WS-ERROR-MESSAGE
          MOVE 12 TO RETURN-CODE
          GOBACK. 

      IDENTIFICATION DIVISION.
      PROGRAM-ID. UTLVAL00.
      AUTHOR. CLAUDE.
      DATE-WRITTEN. 2024-04-09.
     *****************************************************************
     * Data Validation Utility                                        *
     *                                                               *
     * Performs comprehensive data validation:                       *
     * - Data integrity checks                                      *
     * - Cross-reference validation                                 *
     * - Format verification                                        *
     * - Balance reconciliation                                     *
     *****************************************************************
      ENVIRONMENT DIVISION.
      CONFIGURATION SECTION.
      SPECIAL-NAMES.
          CONSOLE IS CONS.
          
      INPUT-OUTPUT SECTION.
      FILE-CONTROL.
          SELECT VALIDATION-CONTROL ASSIGN TO VALCTL
              ORGANIZATION IS SEQUENTIAL
              ACCESS MODE IS SEQUENTIAL
              FILE STATUS IS WS-VAL-STATUS.

          SELECT POSITION-MASTER ASSIGN TO POSMSTRE
              ORGANIZATION IS INDEXED
              ACCESS MODE IS DYNAMIC
              RECORD KEY IS POS-KEY
              FILE STATUS IS WS-POS-STATUS.

          SELECT TRANSACTION-HISTORY ASSIGN TO TRANHIST
              ORGANIZATION IS INDEXED
              ACCESS MODE IS DYNAMIC
              RECORD KEY IS TRAN-KEY
              FILE STATUS IS WS-TRAN-STATUS.

          SELECT ERROR-REPORT ASSIGN TO ERRRPT
              ORGANIZATION IS SEQUENTIAL
              FILE STATUS IS WS-RPT-STATUS.

      DATA DIVISION.
      FILE SECTION.
          COPY POSREC.
          COPY TRNREC.
          
      FD  VALIDATION-CONTROL
          RECORDING MODE IS F
          BLOCK CONTAINS 0 RECORDS.
      01  VALIDATION-RECORD.
          05  VAL-TYPE             PIC X(10).
          05  VAL-PARAMETERS       PIC X(70).

      FD  ERROR-REPORT
          RECORDING MODE IS F
          BLOCK CONTAINS 0 RECORDS.
      01  ERROR-RECORD            PIC X(132).

      WORKING-STORAGE SECTION.
          COPY RTNCODE.
          COPY ERRHAND.

      01  WS-FILE-STATUS.
          05  WS-VAL-STATUS        PIC XX.
          05  WS-POS-STATUS        PIC XX.
          05  WS-TRAN-STATUS       PIC XX.
          05  WS-RPT-STATUS        PIC XX.

      01  WS-VALIDATION-TYPES.
          05  WS-INTEGRITY         PIC X(10) VALUE 'INTEGRITY'.
          05  WS-XREF              PIC X(10) VALUE 'XREF'.
          05  WS-FORMAT            PIC X(10) VALUE 'FORMAT'.
          05  WS-BALANCE           PIC X(10) VALUE 'BALANCE'.

      01  WS-PROCESSING-FLAGS.
          05  WS-END-OF-VAL        PIC X VALUE 'N'.
              88  END-OF-VALIDATION VALUE 'Y'.
          05  WS-ERROR-FOUND       PIC X VALUE 'N'.
              88  ERROR-FOUND      VALUE 'Y'.

      01  WS-VALIDATION-TOTALS.
          05  WS-RECORDS-READ      PIC 9(9) VALUE ZERO.
          05  WS-RECORDS-VALID     PIC 9(9) VALUE ZERO.
          05  WS-RECORDS-ERROR     PIC 9(9) VALUE ZERO.
          05  WS-TOTAL-AMOUNT      PIC S9(15)V99 VALUE ZERO.
          05  WS-CONTROL-TOTAL     PIC S9(15)V99 VALUE ZERO.

      01  WS-ERROR-LINE.
          05  WS-ERR-TYPE          PIC X(10).
          05  FILLER               PIC X(2) VALUE SPACES.
          05  WS-ERR-KEY           PIC X(20).
          05  FILLER               PIC X(2) VALUE SPACES.
          05  WS-ERR-DESC          PIC X(98).

      PROCEDURE DIVISION.
      0000-MAIN.
          PERFORM 1000-INITIALIZE
          PERFORM 2000-PROCESS
          PERFORM 3000-CLEANUP
          GOBACK.

      1000-INITIALIZE.
          PERFORM 1100-OPEN-FILES
          PERFORM 1200-INIT-PROCESSING.

      1100-OPEN-FILES.
          OPEN INPUT VALIDATION-CONTROL
          IF WS-VAL-STATUS NOT = '00'
              MOVE 'ERROR OPENING VALIDATION CONTROL'
                TO WS-ERROR-MESSAGE
              PERFORM 9999-ERROR-HANDLER
          END-IF

          OPEN INPUT POSITION-MASTER
          IF WS-POS-STATUS NOT = '00'
              MOVE 'ERROR OPENING POSITION MASTER'
                TO WS-ERROR-MESSAGE
              PERFORM 9999-ERROR-HANDLER
          END-IF

          OPEN INPUT TRANSACTION-HISTORY
          IF WS-TRAN-STATUS NOT = '00'
              MOVE 'ERROR OPENING TRANSACTION HISTORY'
                TO WS-ERROR-MESSAGE
              PERFORM 9999-ERROR-HANDLER
          END-IF

          OPEN OUTPUT ERROR-REPORT
          IF WS-RPT-STATUS NOT = '00'
              MOVE 'ERROR OPENING ERROR REPORT'
                TO WS-ERROR-MESSAGE
              PERFORM 9999-ERROR-HANDLER
          END-IF.

      1200-INIT-PROCESSING.
          INITIALIZE WS-VALIDATION-TOTALS.

      2000-PROCESS.
          PERFORM UNTIL END-OF-VALIDATION
              READ VALIDATION-CONTROL
                  AT END
                      SET END-OF-VALIDATION TO TRUE
                  NOT AT END
                      PERFORM 2100-PROCESS-VALIDATION
              END-READ
          END-PERFORM.

      2100-PROCESS-VALIDATION.
          EVALUATE VAL-TYPE
              WHEN WS-INTEGRITY
                  PERFORM 2200-CHECK-INTEGRITY
              WHEN WS-XREF
                  PERFORM 2300-CHECK-XREF
              WHEN WS-FORMAT
                  PERFORM 2400-CHECK-FORMAT
              WHEN WS-BALANCE
                  PERFORM 2500-CHECK-BALANCE
              WHEN OTHER
                  MOVE 'INVALID VALIDATION TYPE'
                    TO WS-ERROR-MESSAGE
                  PERFORM 9999-ERROR-HANDLER
          END-EVALUATE.

      2200-CHECK-INTEGRITY.
          PERFORM 2210-CHECK-POSITION-INTEGRITY
          PERFORM 2220-CHECK-TRANSACTION-INTEGRITY.

      2220-CHECK-TRANSACTION-INTEGRITY.
          *> Added: Validate TRANSACTION-TYPE field for integrity
          IF TRANSACTION-TYPE NOT = SPACES AND TRANSACTION-TYPE NOT = LOW-VALUES
              IF FUNCTION LENGTH(TRANSACTION-TYPE) > 10
                  MOVE 'TRANSACTION-TYPE too long' TO WS-ERR-DESC
                  WRITE ERROR-RECORD FROM WS-ERROR-LINE
              END-IF
          END-IF
          .

      2300-CHECK-XREF.
          PERFORM 2310-CHECK-POSITION-XREF
          PERFORM 2320-CHECK-TRANSACTION-XREF.

      2400-CHECK-FORMAT.
          PERFORM 2410-CHECK-POSITION-FORMAT
          PERFORM 2420-CHECK-TRANSACTION-FORMAT.

      2420-CHECK-TRANSACTION-FORMAT.
          *> Added: Check format of TRANSACTION-TYPE field
          IF TRANSACTION-TYPE NOT = SPACES AND TRANSACTION-TYPE NOT = LOW-VALUES
              IF FUNCTION LENGTH(TRANSACTION-TYPE) > 10
                  MOVE 'TRANSACTION-TYPE format error' TO WS-ERR-DESC
                  WRITE ERROR-RECORD FROM WS-ERROR-LINE
              END-IF
          END-IF
          .

      2500-CHECK-BALANCE.
          PERFORM 2510-ACCUMULATE-POSITIONS
          PERFORM 2520-VERIFY-BALANCES.

      3000-CLEANUP.
          CLOSE VALIDATION-CONTROL
               POSITION-MASTER
               TRANSACTION-HISTORY
               ERROR-REPORT.

      9999-ERROR-HANDLER.
          ADD 1 TO WS-RECORDS-ERROR
          SET ERROR-FOUND TO TRUE
          MOVE WS-ERROR-MESSAGE TO WS-ERR-DESC
          WRITE ERROR-RECORD FROM WS-ERROR-LINE.

      IDENTIFICATION DIVISION.
      PROGRAM-ID. TSTGEN00.
      AUTHOR. CLAUDE.
      DATE-WRITTEN. 2024-04-09.
     *****************************************************************
     * Test Data Generator                                           *
     *                                                               *
     * Generates test data for system testing:                      *
     * - Portfolio test data                                        *
     * - Transaction test scenarios                                 *
     * - Error condition data                                       *
     * - Performance test volumes                                   *
     *****************************************************************
      ENVIRONMENT DIVISION.
      CONFIGURATION SECTION.
      SPECIAL-NAMES.
          CONSOLE IS CONS.
          
      INPUT-OUTPUT SECTION.
      FILE-CONTROL.
          SELECT TEST-CONFIG ASSIGN TO TSTCFG
              ORGANIZATION IS SEQUENTIAL
              ACCESS MODE IS SEQUENTIAL
              FILE STATUS IS WS-CFG-STATUS.

          SELECT PORTFOLIO-OUT ASSIGN TO PORTOUT
              ORGANIZATION IS SEQUENTIAL
              FILE STATUS IS WS-PORT-STATUS.

          SELECT TRANSACTION-OUT ASSIGN TO TRANOUT
              ORGANIZATION IS SEQUENTIAL
              FILE STATUS IS WS-TRAN-STATUS.

          SELECT RANDOM-SEED ASSIGN TO RANDSEED
              ORGANIZATION IS SEQUENTIAL
              FILE STATUS IS WS-RAND-STATUS.

      DATA DIVISION.
      FILE SECTION.
      FD  TEST-CONFIG
          RECORDING MODE IS F
          BLOCK CONTAINS 0 RECORDS.
      01  CONFIG-RECORD.
          05  CFG-TEST-TYPE        PIC X(10).
          05  CFG-VOLUME           PIC 9(6).
          05  CFG-PARAMETERS       PIC X(64).

      FD  PORTFOLIO-OUT
          RECORDING MODE IS F
          BLOCK CONTAINS 0 RECORDS.
      01  PORTFOLIO-RECORD.
          COPY PORTFLIO REPLACING ==:PREFIX:== BY ==PORT==.

      FD  TRANSACTION-OUT
          RECORDING MODE IS F
          BLOCK CONTAINS 0 RECORDS.
      01  TRANSACTION-RECORD.
          COPY TRNREC REPLACING ==:PREFIX:== BY ==TRAN==.

      FD  RANDOM-SEED
          RECORDING MODE IS F
          BLOCK CONTAINS 0 RECORDS.
      01  SEED-RECORD             PIC 9(9).

      WORKING-STORAGE SECTION.
          COPY RTNCODE.
          COPY ERRHAND.

      01  WS-FILE-STATUS.
          05  WS-CFG-STATUS        PIC XX.
          05  WS-PORT-STATUS       PIC XX.
          05  WS-TRAN-STATUS       PIC XX.
          05  WS-RAND-STATUS       PIC XX.

      01  WS-TEST-TYPES.
          05  WS-PORTFOLIO         PIC X(10) VALUE 'PORTFOLIO'.
          05  WS-TRANSACTION       PIC X(10) VALUE 'TRANSACTN'.
          05  WS-ERROR-TEST        PIC X(10) VALUE 'ERROR'.
          05  WS-VOLUME-TEST       PIC X(10) VALUE 'VOLUME'.

      01  WS-PROCESSING-FLAGS.
          05  WS-END-OF-CONFIG     PIC X VALUE 'N'.
              88  END-OF-CONFIG    VALUE 'Y'.

      01  WS-COUNTERS.
          05  WS-RECORDS-WRITTEN   PIC 9(9) VALUE ZERO.
          05  WS-ERROR-COUNT       PIC 9(9) VALUE ZERO.

      01  WS-RANDOM-VALUES.
          05  WS-RANDOM-SEED       PIC 9(9).
          05  WS-RANDOM-NUM        PIC 9(9).
          05  WS-RANDOM-DECIMAL    PIC 9(9)V99.

      01  WS-PORTFOLIO-DATA.
          05  WS-PORT-ID           PIC X(10).
          05  WS-PORT-NAME         PIC X(30).
          05  WS-PORT-TYPE         PIC X(2).
          05  WS-PORT-STATUS       PIC X(1).
          05  WS-PORT-BALANCE      PIC 9(15)V99.

      01  WS-TRANSACTION-DATA.
          05  WS-TRAN-ID           PIC X(12).
          05  WS-TRAN-TYPE         PIC X(2).
          05  WS-TRAN-AMOUNT       PIC 9(15)V99.
          05  WS-TRAN-DATE         PIC X(8).
          05  WS-TRAN-STATUS       PIC X(1).
          05  WS-TRANSACTION-TYPE  PIC X(10). *> Added for new field

      PROCEDURE DIVISION.
      0000-MAIN.
          PERFORM 1000-INITIALIZE
          PERFORM 2000-PROCESS
          PERFORM 3000-CLEANUP
          GOBACK.

      1000-INITIALIZE.
          PERFORM 1100-OPEN-FILES
          PERFORM 1200-INIT-RANDOM
          PERFORM 1300-INIT-COUNTERS.

      1100-OPEN-FILES.
          OPEN INPUT TEST-CONFIG
          IF WS-CFG-STATUS NOT = '00'
              MOVE 'ERROR OPENING CONFIG FILE'
                TO WS-ERROR-MESSAGE
              PERFORM 9999-ERROR-HANDLER
          END-IF

          OPEN OUTPUT PORTFOLIO-OUT
          IF WS-PORT-STATUS NOT = '00'
              MOVE 'ERROR OPENING PORTFOLIO OUTPUT'
                TO WS-ERROR-MESSAGE
              PERFORM 9999-ERROR-HANDLER
          END-IF

          OPEN OUTPUT TRANSACTION-OUT
          IF WS-TRAN-STATUS NOT = '00'
              MOVE 'ERROR OPENING TRANSACTION OUTPUT'
                TO WS-ERROR-MESSAGE
              PERFORM 9999-ERROR-HANDLER
          END-IF

          OPEN INPUT RANDOM-SEED
          IF WS-RAND-STATUS NOT = '00'
              MOVE 'ERROR OPENING RANDOM SEED'
                TO WS-ERROR-MESSAGE
              PERFORM 9999-ERROR-HANDLER
          END-IF.

      1200-INIT-RANDOM.
          READ RANDOM-SEED
          MOVE SEED-RECORD TO WS-RANDOM-SEED.

      1300-INIT-COUNTERS.
          INITIALIZE WS-COUNTERS.

      2000-PROCESS.
          PERFORM UNTIL END-OF-CONFIG
              READ TEST-CONFIG
                  AT END
                      SET END-OF-CONFIG TO TRUE
                  NOT AT END
                      PERFORM 2100-GENERATE-TEST-DATA
              END-READ
          END-PERFORM.

      2100-GENERATE-TEST-DATA.
          EVALUATE CFG-TEST-TYPE
              WHEN WS-PORTFOLIO
                  PERFORM 2200-GEN-PORTFOLIO
              WHEN WS-TRANSACTION
                  PERFORM 2300-GEN-TRANSACTION
              WHEN WS-ERROR-TEST
                  PERFORM 2400-GEN-ERROR-DATA
              WHEN WS-VOLUME-TEST
                  PERFORM 2500-GEN-VOLUME-DATA
              WHEN OTHER
                  MOVE 'INVALID TEST TYPE'
                    TO WS-ERROR-MESSAGE
                  PERFORM 9999-ERROR-HANDLER
          END-EVALUATE.

      2200-GEN-PORTFOLIO.
          PERFORM VARYING WS-RECORDS-WRITTEN FROM 1 BY 1
                  UNTIL WS-RECORDS-WRITTEN > CFG-VOLUME
              PERFORM 2210-GEN-PORT-DATA
              PERFORM 2220-WRITE-PORT-RECORD
          END-PERFORM.

      2300-GEN-TRANSACTION.
          PERFORM VARYING WS-RECORDS-WRITTEN FROM 1 BY 1
                  UNTIL WS-RECORDS-WRITTEN > CFG-VOLUME
              PERFORM 2310-GEN-TRAN-DATA
              PERFORM 2320-WRITE-TRAN-RECORD
          END-PERFORM.

      2310-GEN-TRAN-DATA.
          *> Added: Populate TRANSACTION-TYPE with test value
          MOVE 'TESTTYPE' TO WS-TRANSACTION-TYPE
          .

      2320-WRITE-TRAN-RECORD.
          *> Map WS-TRANSACTION-TYPE to TRANSACTION-TYPE in record
          MOVE WS-TRANSACTION-TYPE TO TRANSACTION-TYPE
          *> Existing logic for writing record
          .

      2400-GEN-ERROR-DATA.
          PERFORM 2410-GEN-DATA-ERRORS
          PERFORM 2420-GEN-PROCESS-ERRORS.

      2500-GEN-VOLUME-DATA.
          PERFORM 2510-GEN-LARGE-PORTFOLIO
          PERFORM 2520-GEN-LARGE-TRANSACTION.

      3000-CLEANUP.
          CLOSE TEST-CONFIG
               PORTFOLIO-OUT
               TRANSACTION-OUT
               RANDOM-SEED.

      9999-ERROR-HANDLER.
          ADD 1 TO WS-ERROR-COUNT
          DISPLAY WS-ERROR-MESSAGE UPON CONS
          IF WS-ERROR-COUNT > 100
              MOVE 12 TO RETURN-CODE
              GOBACK
          END-IF.

      IDENTIFICATION DIVISION.
      PROGRAM-ID. TSTVAL00.
      AUTHOR. CLAUDE.
      DATE-WRITTEN. 2024-04-09.
     *****************************************************************
     * Test Validation Suite                                         *
     *                                                               *
     * Validates test results and system behavior:                   *
     * - Test case execution                                        *
     * - Result validation                                          *
     * - Error condition testing                                    *
     * - Performance benchmarking                                   *
     *****************************************************************
      ENVIRONMENT DIVISION.
      CONFIGURATION SECTION.
      SPECIAL-NAMES.
          CONSOLE IS CONS.
          
      INPUT-OUTPUT SECTION.
      FILE-CONTROL.
          SELECT TEST-CASES ASSIGN TO TESTCASE
              ORGANIZATION IS SEQUENTIAL
              ACCESS MODE IS SEQUENTIAL
              FILE STATUS IS WS-TEST-STATUS.

          SELECT EXPECTED-RESULTS ASSIGN TO EXPECTED
              ORGANIZATION IS SEQUENTIAL
              ACCESS MODE IS SEQUENTIAL
              FILE STATUS IS WS-EXP-STATUS.

          SELECT ACTUAL-RESULTS ASSIGN TO ACTUAL
              ORGANIZATION IS SEQUENTIAL
              FILE STATUS IS WS-ACT-STATUS.

          SELECT TEST-REPORT ASSIGN TO TESTRPT
              ORGANIZATION IS SEQUENTIAL
              FILE STATUS IS WS-RPT-STATUS.

      DATA DIVISION.
      FILE SECTION.
      FD  TEST-CASES
          RECORDING MODE IS F
          BLOCK CONTAINS 0 RECORDS.
      01  TEST-CASE-RECORD.
          05  TEST-ID              PIC X(10).
          05  TEST-TYPE            PIC X(10).
          05  TEST-DESCRIPTION     PIC X(50).
          05  TEST-PARAMETERS      PIC X(100).

      FD  EXPECTED-RESULTS
          RECORDING MODE IS F
          BLOCK CONTAINS 0 RECORDS.
      01  EXPECTED-RECORD         PIC X(200).

      FD  ACTUAL-RESULTS
          RECORDING MODE IS F
          BLOCK CONTAINS 0 RECORDS.
      01  ACTUAL-RECORD          PIC X(200).

      FD  TEST-REPORT
          RECORDING MODE IS F
          BLOCK CONTAINS 0 RECORDS.
      01  REPORT-RECORD          PIC X(132).

      WORKING-STORAGE SECTION.
          COPY RTNCODE.
          COPY ERRHAND.

      01  WS-FILE-STATUS.
          05  WS-TEST-STATUS       PIC XX.
          05  WS-EXP-STATUS        PIC XX.
          05  WS-ACT-STATUS        PIC XX.
          05  WS-RPT-STATUS        PIC XX.

      01  WS-TEST-TYPES.
          05  WS-FUNCTIONAL        PIC X(10) VALUE 'FUNCTIONAL'.
          05  WS-INTEGRATION       PIC X(10) VALUE 'INTEGRATE'.
          05  WS-PERFORMANCE       PIC X(10) VALUE 'PERFORM'.
          05  WS-ERROR            PIC X(10) VALUE 'ERROR'.

      01  WS-PROCESSING-FLAGS.
          05  WS-END-OF-TESTS      PIC X VALUE 'N'.
              88  END-OF-TESTS     VALUE 'Y'.
          05  WS-TEST-PASSED       PIC X VALUE 'N'.
              88  TEST-PASSED      VALUE 'Y'.

      01  WS-TEST-METRICS.
          05  WS-TOTAL-TESTS       PIC 9(5) VALUE ZERO.
          05  WS-TESTS-PASSED      PIC 9(5) VALUE ZERO.
          05  WS-TESTS-FAILED      PIC 9(5) VALUE ZERO.
          05  WS-START-TIME        PIC 9(8) VALUE ZERO.
          05  WS-END-TIME          PIC 9(8) VALUE ZERO.
          05  WS-ELAPSED-TIME      PIC 9(8) VALUE ZERO.

      01  WS-REPORT-HEADERS.
          05  WS-HEADER1.
              10  FILLER           PIC X(132) VALUE ALL '*'.
          05  WS-HEADER2.
              10  FILLER           PIC X(30) VALUE SPACES.
              10  FILLER           PIC X(72) 
                  VALUE 'TEST VALIDATION REPORT'.
              10  FILLER           PIC X(30) VALUE SPACES.

      01  WS-TEST-DETAIL.
          05  WS-TEST-ID-OUT       PIC X(10).
          05  FILLER               PIC X(2) VALUE SPACES.
          05  WS-TEST-TYPE-OUT     PIC X(10).
          05  FILLER               PIC X(2) VALUE SPACES.
          05  WS-TEST-DESC-OUT     PIC X(50).
          05  FILLER               PIC X(2) VALUE SPACES.
          05  WS-TEST-STATUS-OUT   PIC X(4).
          05  FILLER               PIC X(52) VALUE SPACES.

      01  WS-SUMMARY-LINE.
          05  FILLER               PIC X(15) VALUE 'TOTAL TESTS:'.
          05  WS-TOTAL-OUT         PIC ZZ,ZZ9.
          05  FILLER               PIC X(15) VALUE '  PASSED:'.
          05  WS-PASSED-OUT        PIC ZZ,ZZ9.
          05  FILLER               PIC X(15) VALUE '  FAILED:'.
          05  WS-FAILED-OUT        PIC ZZ,ZZ9.
          05  FILLER               PIC X(15) VALUE '  SUCCESS:'.
          05  WS-SUCCESS-RATE      PIC ZZ9.99.
          05  FILLER               PIC X(1) VALUE '%'.
          05  FILLER               PIC X(40) VALUE SPACES.

      01  WS-TRANSACTION-TYPE-TEST PIC X(10). *> Added for test validation

      PROCEDURE DIVISION.
      0000-MAIN.
          PERFORM 1000-INITIALIZE
          PERFORM 2000-PROCESS
          PERFORM 3000-CLEANUP
          GOBACK.

      1000-INITIALIZE.
          PERFORM 1100-OPEN-FILES
          PERFORM 1200-WRITE-HEADERS
          PERFORM 1300-INIT-METRICS.

      1100-OPEN-FILES.
          OPEN INPUT TEST-CASES
          IF WS-TEST-STATUS NOT = '00'
              MOVE 'ERROR OPENING TEST CASES'
                TO WS-ERROR-MESSAGE
              PERFORM 9999-ERROR-HANDLER
          END-IF

          OPEN INPUT EXPECTED-RESULTS
          IF WS-EXP-STATUS NOT = '00'
              MOVE 'ERROR OPENING EXPECTED RESULTS'
                TO WS-ERROR-MESSAGE
              PERFORM 9999-ERROR-HANDLER
          END-IF

          OPEN INPUT ACTUAL-RESULTS
          IF WS-ACT-STATUS NOT = '00'
              MOVE 'ERROR OPENING ACTUAL RESULTS'
                TO WS-ERROR-MESSAGE
              PERFORM 9999-ERROR-HANDLER
          END-IF

          OPEN OUTPUT TEST-REPORT
          IF WS-RPT-STATUS NOT = '00'
              MOVE 'ERROR OPENING TEST REPORT'
                TO WS-ERROR-MESSAGE
              PERFORM 9999-ERROR-HANDLER
          END-IF.

      1200-WRITE-HEADERS.
          WRITE REPORT-RECORD FROM WS-HEADER1
          WRITE REPORT-RECORD FROM WS-HEADER2.

      1300-INIT-METRICS.
          INITIALIZE WS-TEST-METRICS
          ACCEPT WS-START-TIME FROM TIME.

      2000-PROCESS.
          PERFORM UNTIL END-OF-TESTS
              READ TEST-CASES
                  AT END
                      SET END-OF-TESTS TO TRUE
                  NOT AT END
                      PERFORM 2100-EXECUTE-TEST
              END-READ
          END-PERFORM
          PERFORM 2900-WRITE-SUMMARY.

      2100-EXECUTE-TEST.
          *> Added: Validate TRANSACTION-TYPE field if present in test data
          IF TRANSACTION-TYPE NOT = SPACES AND TRANSACTION-TYPE NOT = LOW-VALUES
              MOVE TRANSACTION-TYPE TO WS-TRANSACTION-TYPE-TEST
          ELSE
              MOVE SPACES TO WS-TRANSACTION-TYPE-TEST
          END-IF
          *> Existing test logic follows
          EVALUATE TEST-TYPE
              WHEN WS-FUNCTIONAL
                  PERFORM 2200-RUN-FUNCTIONAL-TEST
              WHEN WS-INTEGRATION
                  PERFORM 2300-RUN-INTEGRATION-TEST
              WHEN WS-PERFORMANCE
                  PERFORM 2400-RUN-PERFORMANCE-TEST
              WHEN WS-ERROR
                  PERFORM 2500-RUN-ERROR-TEST
              WHEN OTHER
                  MOVE 'INVALID TEST TYPE'
                    TO WS-ERROR-MESSAGE
                  PERFORM 9999-ERROR-HANDLER
          END-EVALUATE
          PERFORM 2600-VALIDATE-RESULTS
          PERFORM 2700-UPDATE-METRICS
          PERFORM 2800-WRITE-TEST-DETAIL.

      2900-WRITE-SUMMARY.
          ACCEPT WS-END-TIME FROM TIME
          COMPUTE WS-ELAPSED-TIME = WS-END-TIME - WS-START-TIME
          MOVE WS-TOTAL-TESTS TO WS-TOTAL-OUT
          MOVE WS-TESTS-PASSED TO WS-PASSED-OUT
          MOVE WS-TESTS-FAILED TO WS-FAILED-OUT
          COMPUTE WS-SUCCESS-RATE = 
              (WS-TESTS-PASSED / WS-TOTAL-TESTS) * 100
          WRITE REPORT-RECORD FROM WS-SUMMARY-LINE.

      3000-CLEANUP.
          CLOSE TEST-CASES
               EXPECTED-RESULTS
               ACTUAL-RESULTS
               TEST-REPORT.

      9999-ERROR-HANDLER.
          DISPLAY WS-ERROR-MESSAGE UPON CONS
          MOVE 12 TO RETURN-CODE
          GOBACK. 

      *================================================================*
     * Program Name: HISTLD00
     * Description: Position History DB2 Load Program
     * Version: 1.0
     * Date: 2024
     *================================================================*
      IDENTIFICATION DIVISION.
      PROGRAM-ID. HISTLD00.
      
      ENVIRONMENT DIVISION.
      CONFIGURATION SECTION.
      SOURCE-COMPUTER. IBM-ZOS.
      OBJECT-COMPUTER. IBM-ZOS.
      
      INPUT-OUTPUT SECTION.
      FILE-CONTROL.
          SELECT TRANSACTION-HISTORY
              ASSIGN TO TRANHIST
              ORGANIZATION IS INDEXED
              ACCESS MODE IS SEQUENTIAL
              RECORD KEY IS TH-KEY
              FILE STATUS IS WS-TH-STATUS.
              
          SELECT BATCH-CONTROL-FILE
              ASSIGN TO BCHCTL
              ORGANIZATION IS INDEXED
              ACCESS MODE IS DYNAMIC
              RECORD KEY IS BCT-KEY
              FILE STATUS IS WS-BCT-STATUS.
      
      DATA DIVISION.
      FILE SECTION.
      FD  TRANSACTION-HISTORY.
          COPY HISTREC.
      
      FD  BATCH-CONTROL-FILE.
          COPY BCHCTL.
      
      WORKING-STORAGE SECTION.
          EXEC SQL BEGIN DECLARE SECTION END-EXEC.
          COPY DBTBLS.
          EXEC SQL END DECLARE SECTION END-EXEC.
          
          COPY SQLCA.
          COPY DBPROC.
          COPY ERRHAND.
          COPY BCHCON.
          
      01  WS-FILE-STATUS.
          05  WS-TH-STATUS          PIC X(2).
          05  WS-BCT-STATUS         PIC X(2).
          
      01  WS-COUNTERS.
          05  WS-RECORDS-READ       PIC S9(9) COMP VALUE 0.
          05  WS-RECORDS-WRITTEN    PIC S9(9) COMP VALUE 0.
          05  WS-ERROR-COUNT        PIC S9(9) COMP VALUE 0.
          05  WS-COMMIT-COUNT       PIC S9(4) COMP VALUE 0.
          
      01  WS-COMMIT-THRESHOLD       PIC S9(4) COMP VALUE 1000.
      
      01  WS-SWITCHES.
          05  WS-END-OF-FILE-SW     PIC X(1) VALUE 'N'.
              88  END-OF-FILE         VALUE 'Y'.
              88  MORE-RECORDS        VALUE 'N'.
              
      PROCEDURE DIVISION.
      0000-MAIN.
          PERFORM 1000-INITIALIZE
          
          PERFORM 2000-PROCESS
              UNTIL END-OF-FILE
              OR WS-ERROR-COUNT > 100
          
          PERFORM 3000-TERMINATE
          
          MOVE WS-ERROR-COUNT TO RETURN-CODE
          GOBACK
          .
          
      1000-INITIALIZE.
          PERFORM 1100-OPEN-FILES
          PERFORM 1200-CONNECT-DB2
          PERFORM 1300-INIT-CHECKPOINTS
          .
          
      2000-PROCESS.
          PERFORM 2100-READ-HISTORY
          
          IF MORE-RECORDS
              PERFORM 2200-LOAD-TO-DB2
              PERFORM 2300-CHECK-COMMIT
          END-IF
          .
          
      3000-TERMINATE.
          PERFORM 3100-FINAL-COMMIT
          PERFORM 3200-CLOSE-FILES
          PERFORM 3300-DISCONNECT-DB2
          PERFORM 3400-DISPLAY-STATS
          .
          
      1100-OPEN-FILES.
          OPEN INPUT TRANSACTION-HISTORY
          IF WS-TH-STATUS NOT = '00'
              MOVE 'Error opening history file' TO ERR-TEXT
              PERFORM 9000-ERROR-ROUTINE
          END-IF
          
          OPEN I-O BATCH-CONTROL-FILE
          IF WS-BCT-STATUS NOT = '00'
              MOVE 'Error opening control file' TO ERR-TEXT
              PERFORM 9000-ERROR-ROUTINE
          END-IF
          .
          
      1200-CONNECT-DB2.
          PERFORM CONNECT-TO-DB2
          .
          
      1300-INIT-CHECKPOINTS.
          MOVE SPACES TO BCT-KEY
          MOVE 'HISTLD00' TO BCT-JOB-NAME
          
          READ BATCH-CONTROL-FILE
              INVALID KEY
                  MOVE 'Control record not found' TO ERR-TEXT
                  PERFORM 9000-ERROR-ROUTINE
          END-READ
          
          MOVE BCT-STAT-ACTIVE TO BCT-STATUS
          REWRITE BATCH-CONTROL-RECORD
          .
          
      2100-READ-HISTORY.
          READ TRANSACTION-HISTORY
              AT END
                  SET END-OF-FILE TO TRUE
              NOT AT END
                  ADD 1 TO WS-RECORDS-READ
          END-READ
          .
          
      2200-LOAD-TO-DB2.
          INITIALIZE POSHIST-RECORD
          
          MOVE TH-ACCOUNT-NO    TO PH-ACCOUNT-NO
          MOVE TH-PORTFOLIO-ID  TO PH-PORTFOLIO-ID
          MOVE TH-TRANS-DATE    TO PH-TRANS-DATE
          MOVE TH-TRANS-TIME    TO PH-TRANS-TIME
          MOVE TH-TRANS-TYPE    TO PH-TRANS-TYPE
          MOVE TH-SECURITY-ID   TO PH-SECURITY-ID
          MOVE TH-QUANTITY      TO PH-QUANTITY
          MOVE TH-PRICE         TO PH-PRICE
          MOVE TH-AMOUNT        TO PH-AMOUNT
          MOVE TH-FEES          TO PH-FEES
          MOVE TH-TOTAL-AMOUNT  TO PH-TOTAL-AMOUNT
          MOVE TH-COST-BASIS    TO PH-COST-BASIS
          MOVE TH-GAIN-LOSS     TO PH-GAIN-LOSS
          *> Added: Move TRANSACTION-TYPE if present
          IF TRANSACTION-TYPE NOT = SPACES AND TRANSACTION-TYPE NOT = LOW-VALUES
              MOVE TRANSACTION-TYPE TO PH-TRANSACTION-TYPE
          END-IF
          .
          
          EXEC SQL
              INSERT INTO POSHIST
              VALUES (:POSHIST-RECORD)
          END-EXEC
          
          IF SQLCODE = 0
              ADD 1 TO WS-RECORDS-WRITTEN
          ELSE
              IF SQLCODE = -803
                  CONTINUE
              ELSE
                  ADD 1 TO WS-ERROR-COUNT
                  PERFORM DB2-ERROR-ROUTINE
              END-IF
          END-IF
          .
          
      2300-CHECK-COMMIT.
          ADD 1 TO WS-COMMIT-COUNT
          
          IF WS-COMMIT-COUNT >= WS-COMMIT-THRESHOLD
              EXEC SQL
                  COMMIT WORK
              END-EXEC
              
              MOVE 0 TO WS-COMMIT-COUNT
              
              PERFORM 2310-UPDATE-CHECKPOINT
          END-IF
          .
          
      2310-UPDATE-CHECKPOINT.
          MOVE WS-RECORDS-READ TO BCT-RECORDS-READ
          MOVE WS-RECORDS-WRITTEN TO BCT-RECORDS-WRITTEN
          
          REWRITE BATCH-CONTROL-RECORD
              INVALID KEY
                  MOVE 'Error updating checkpoint' TO ERR-TEXT
                  PERFORM 9000-ERROR-ROUTINE
          END-REWRITE
          .
          
      3100-FINAL-COMMIT.
          EXEC SQL
              COMMIT WORK
          END-EXEC
          
          PERFORM 2310-UPDATE-CHECKPOINT
          .
          
      3200-CLOSE-FILES.
          CLOSE TRANSACTION-HISTORY
                BATCH-CONTROL-FILE
          .
          
      3300-DISCONNECT-DB2.
          PERFORM DISCONNECT-FROM-DB2
          .
          
      3400-DISPLAY-STATS.
          DISPLAY 'HISTLD00 Processing Statistics:'
          DISPLAY '  Records Read:    ' WS-RECORDS-READ
          DISPLAY '  Records Written: ' WS-RECORDS-WRITTEN
          DISPLAY '  Errors:         ' WS-ERROR-COUNT
          .
          
      9000-ERROR-ROUTINE.
          MOVE 'HISTLD00' TO ERR-PROGRAM
          CALL 'ERRPROC' USING ERR-MESSAGE
          
          EXEC SQL
              ROLLBACK WORK
          END-EXEC
          .

      IDENTIFICATION DIVISION.
      PROGRAM-ID. UTLMNT00.
      AUTHOR. CLAUDE.
      DATE-WRITTEN. 2024-04-09.
     *****************************************************************
     * File Maintenance Utility                                       *
     *                                                               *
     * Performs maintenance operations on system files:              *
     * - Archive processing                                         *
     * - File cleanup                                               *
     * - VSAM reorganization                                        *
     * - Space management                                           *
     *****************************************************************
      ENVIRONMENT DIVISION.
      CONFIGURATION SECTION.
      SPECIAL-NAMES.
          CONSOLE IS CONS.
          
      INPUT-OUTPUT SECTION.
      FILE-CONTROL.
          SELECT CONTROL-FILE ASSIGN TO CTLFILE
              ORGANIZATION IS SEQUENTIAL
              ACCESS MODE IS SEQUENTIAL
              FILE STATUS IS WS-CTL-STATUS.

          SELECT ARCHIVE-FILE ASSIGN TO ARCHFILE
              ORGANIZATION IS SEQUENTIAL
              ACCESS MODE IS SEQUENTIAL
              FILE STATUS IS WS-ARCH-STATUS.

          SELECT REPORT-FILE ASSIGN TO RPTFILE
              ORGANIZATION IS SEQUENTIAL
              FILE STATUS IS WS-REPORT-STATUS.

      DATA DIVISION.
      FILE SECTION.
      FD  CONTROL-FILE
          RECORDING MODE IS F
          BLOCK CONTAINS 0 RECORDS.
      01  CONTROL-RECORD.
          05  CTL-FUNCTION         PIC X(8).
          05  CTL-FILE-NAME        PIC X(44).
          05  CTL-PARAMETERS       PIC X(100).

      FD  ARCHIVE-FILE
          RECORDING MODE IS V
          BLOCK CONTAINS 0 RECORDS.
      01  ARCHIVE-RECORD          PIC X(32760).

      FD  REPORT-FILE
          RECORDING MODE IS F
          BLOCK CONTAINS 0 RECORDS.
      01  REPORT-RECORD           PIC X(132).

      WORKING-STORAGE SECTION.
          COPY RTNCODE.
          COPY ERRHAND.

      01  WS-FILE-STATUS.
          05  WS-CTL-STATUS        PIC XX.
          05  WS-ARCH-STATUS       PIC XX.
          05  WS-REPORT-STATUS     PIC XX.

      01  WS-PROCESSING-FLAGS.
          05  WS-END-OF-CTL        PIC X VALUE 'N'.
              88  END-OF-CONTROL   VALUE 'Y'.
          05  WS-FUNCTION-FLAG     PIC X VALUE 'N'.
              88  VALID-FUNCTION   VALUE 'Y'.

      01  WS-FUNCTIONS.
          05  WS-ARCHIVE           PIC X(8) VALUE 'ARCHIVE'.
          05  WS-CLEANUP           PIC X(8) VALUE 'CLEANUP'.
          05  WS-REORG            PIC X(8) VALUE 'REORG'.
          05  WS-ANALYZE          PIC X(8) VALUE 'ANALYZE'.

      01  WS-COUNTERS.
          05  WS-RECORDS-READ      PIC 9(9) VALUE ZERO.
          05  WS-RECORDS-WRITTEN   PIC 9(9) VALUE ZERO.
          05  WS-ERROR-COUNT       PIC 9(9) VALUE ZERO.

      01  WS-VSAM-CONTROL.
          05  WS-VSAM-NAME         PIC X(44).
          05  WS-VSAM-FUNCTION     PIC X(8).
          05  WS-VSAM-STATUS       PIC XX.

      PROCEDURE DIVISION.
      0000-MAIN.
          PERFORM 1000-INITIALIZE
          PERFORM 2000-PROCESS
          PERFORM 3000-CLEANUP
          GOBACK.

      1000-INITIALIZE.
          PERFORM 1100-OPEN-FILES
          PERFORM 1200-INIT-PROCESSING.

      1100-OPEN-FILES.
          OPEN INPUT CONTROL-FILE
          IF WS-CTL-STATUS NOT = '00'
              MOVE 'ERROR OPENING CONTROL FILE'
                TO WS-ERROR-MESSAGE
              PERFORM 9999-ERROR-HANDLER
          END-IF

          OPEN OUTPUT ARCHIVE-FILE
          IF WS-ARCH-STATUS NOT = '00'
              MOVE 'ERROR OPENING ARCHIVE FILE'
                TO WS-ERROR-MESSAGE
              PERFORM 9999-ERROR-HANDLER
          END-IF

          OPEN OUTPUT REPORT-FILE
          IF WS-REPORT-STATUS NOT = '00'
              MOVE 'ERROR OPENING REPORT FILE'
                TO WS-ERROR-MESSAGE
              PERFORM 9999-ERROR-HANDLER
          END-IF.

      1200-INIT-PROCESSING.
          INITIALIZE WS-COUNTERS.

      2000-PROCESS.
          PERFORM UNTIL END-OF-CONTROL
              READ CONTROL-FILE
                  AT END
                      SET END-OF-CONTROL TO TRUE
                  NOT AT END
                      PERFORM 2100-PROCESS-FUNCTION
              END-READ
          END-PERFORM.

      2100-PROCESS-FUNCTION.
          EVALUATE CTL-FUNCTION
              WHEN WS-ARCHIVE
                  PERFORM 2200-ARCHIVE-PROCESS
              WHEN WS-CLEANUP
                  PERFORM 2300-CLEANUP-PROCESS
              WHEN WS-REORG
                  PERFORM 2400-REORG-PROCESS
              WHEN WS-ANALYZE
                  PERFORM 2500-ANALYZE-PROCESS
              WHEN OTHER
                  MOVE 'INVALID FUNCTION SPECIFIED'
                    TO WS-ERROR-MESSAGE
                  PERFORM 9999-ERROR-HANDLER
          END-EVALUATE.

      2200-ARCHIVE-PROCESS.
          MOVE CTL-FILE-NAME TO WS-VSAM-NAME
          PERFORM 2210-OPEN-VSAM
          PERFORM 2220-ARCHIVE-RECORDS
          PERFORM 2230-CLOSE-VSAM.

      2300-CLEANUP-PROCESS.
          MOVE CTL-FILE-NAME TO WS-VSAM-NAME
          PERFORM 2310-ANALYZE-SPACE
          PERFORM 2320-DELETE-OLD
          PERFORM 2330-UPDATE-CATALOG.

      2400-REORG-PROCESS.
          MOVE CTL-FILE-NAME TO WS-VSAM-NAME
          PERFORM 2410-EXPORT-DATA
          PERFORM 2420-DELETE-DEFINE
          PERFORM 2430-IMPORT-DATA.

      2500-ANALYZE-PROCESS.
          MOVE CTL-FILE-NAME TO WS-VSAM-NAME
          PERFORM 2510-COLLECT-STATS
          PERFORM 2520-GENERATE-REPORT.

      3000-CLEANUP.
          CLOSE CONTROL-FILE
               ARCHIVE-FILE
               REPORT-FILE.

      9999-ERROR-HANDLER.
          ADD 1 TO WS-ERROR-COUNT
          DISPLAY WS-ERROR-MESSAGE UPON CONS
          IF WS-ERROR-COUNT > 100
              MOVE 12 TO RETURN-CODE
              GOBACK
          END-IF.

[File 1] PORTUPDT.cbl src/programs/portfolio/PORTUPDT.cbl

       *================================================================*
      * Program Name: PORTUPDT
      * Description: Portfolio Update Program
      *             Updates existing portfolio records
      * Author: [Author name]
      * Date Written: 2024-03-20
      * Maintenance Log:
      * Date       Author        Description
      * ---------- ------------- -------------------------------------
      * 2024-03-20 [Author]     Initial Creation
      * 2024-06-XX [COBOL Impact Modifier] Enable real-time price feed integration, dynamic valuation, error handling, audit logging. *-- Change: Real-time price feed, valuation, audit, error handling logic added.
      *================================================================*
       IDENTIFICATION DIVISION.
       PROGRAM-ID. PORTUPDT.

       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SOURCE-COMPUTER. IBM-ZOS.
       OBJECT-COMPUTER. IBM-ZOS.

       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT PORTFOLIO-FILE
               ASSIGN TO PORTFILE
               ORGANIZATION IS INDEXED
               ACCESS MODE IS RANDOM
               RECORD KEY IS PORT-KEY
               FILE STATUS IS WS-FILE-STATUS.

           SELECT UPDATE-FILE
               ASSIGN TO UPDTFILE
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-UPDT-STATUS.

      *-- Change: Add real-time price feed file for integration
           SELECT PRICE-FEED-FILE
               ASSIGN TO PRCFEED
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-PRCFEED-STATUS.

       DATA DIVISION.
       FILE SECTION.
       FD  PORTFOLIO-FILE.
           COPY PORTFLIO.

       FD  UPDATE-FILE.
       01  UPDATE-RECORD.
           05  UPDT-KEY.
               10  UPDT-ID        PIC X(8).
               10  UPDT-ACCT-NO   PIC X(10).
           05  UPDT-ACTION        PIC X(1).
               88  UPDT-STATUS    VALUE 'S'.
               88  UPDT-VALUE     VALUE 'V'.
               88  UPDT-NAME      VALUE 'N'.
           05  UPDT-NEW-VALUE     PIC X(50).

      *-- Change: Add price feed record structure
       FD  PRICE-FEED-FILE.
       01  PRICE-FEED-RECORD.
           05  PRCFEED-ID         PIC X(8).
           05  PRCFEED-TIMESTAMP  PIC 9(14).
           05  PRCFEED-PRICE      PIC S9(13)V99 COMP-3.

       WORKING-STORAGE SECTION.
      *----------------------------------------------------------------*
      * Constants and switches
      *----------------------------------------------------------------*
       01  WS-CONSTANTS.
           05  WS-PROGRAM-NAME     PIC X(08) VALUE 'PORTUPDT '.
           05  WS-SUCCESS          PIC S9(4) VALUE +0.
           05  WS-ERROR            PIC S9(4) VALUE +8.

       01  WS-SWITCHES.
           05  WS-FILE-STATUS      PIC X(02).
               88  WS-SUCCESS-STATUS     VALUE '00'.
               88  WS-EOF-STATUS        VALUE '10'.
               88  WS-REC-NOT-FND       VALUE '23'.

           05  WS-UPDT-STATUS      PIC X(02).
               88  WS-UPDT-SUCCESS      VALUE '00'.
               88  WS-UPDT-EOF          VALUE '10'.

           05  WS-PRCFEED-STATUS   PIC X(02).
               88  WS-PRCFEED-SUCCESS   VALUE '00'.
               88  WS-PRCFEED-EOF       VALUE '10'.

           05  WS-END-OF-FILE-SW   PIC X     VALUE 'N'.
               88  END-OF-FILE              VALUE 'Y'.
               88  NOT-END-OF-FILE          VALUE 'N'.

      *----------------------------------------------------------------*
      * Work areas
      *----------------------------------------------------------------*
       01  WS-WORK-AREAS.
           05  WS-UPDATE-COUNT     PIC 9(7) VALUE ZERO.
           05  WS-ERROR-COUNT      PIC 9(7) VALUE ZERO.
           05  WS-RETURN-CODE      PIC S9(4) VALUE +0.
           05  WS-NUMERIC-WORK     PIC S9(13)V99.
      *-- Change: Add area for latest price feed
           05  WS-LATEST-PRICE     PIC S9(13)V99 COMP-3 VALUE ZERO.
           05  WS-LATEST-TIMESTAMP PIC 9(14) VALUE ZERO.

      *-- Change: Audit log and error message area
           05  WS-AUDIT-MSG        PIC X(80).
           05  WS-ERROR-MSG        PIC X(80).

       PROCEDURE DIVISION.
       0000-MAIN.
           PERFORM 1000-INITIALIZE

           PERFORM 1010-LOAD-PRICE-FEED *-- Change: Load latest price feed

           PERFORM 2000-PROCESS
              UNTIL END-OF-FILE

           PERFORM 3000-TERMINATE

           GOBACK.

       1000-INITIALIZE.
           INITIALIZE WS-WORK-AREAS

           OPEN I-O   PORTFOLIO-FILE
           OPEN INPUT UPDATE-FILE
      *-- Change: Open price feed file
           OPEN INPUT PRICE-FEED-FILE

           IF NOT WS-SUCCESS-STATUS OR
              NOT WS-UPDT-SUCCESS OR
              NOT WS-PRCFEED-SUCCESS
              DISPLAY 'Error opening files: '
                      'PORT=' WS-FILE-STATUS
                      'UPDT=' WS-UPDT-STATUS
                      'PRCFEED=' WS-PRCFEED-STATUS
              MOVE WS-ERROR TO WS-RETURN-CODE
              PERFORM 3000-TERMINATE
           END-IF
           .

      *-- Change: Load latest price feed for dynamic valuation
       1010-LOAD-PRICE-FEED.
           READ PRICE-FEED-FILE
               AT END
                   MOVE ZERO TO WS-LATEST-PRICE
                   MOVE ZERO TO WS-LATEST-TIMESTAMP
               NOT AT END
                   MOVE PRCFEED-PRICE TO WS-LATEST-PRICE
                   MOVE PRCFEED-TIMESTAMP TO WS-LATEST-TIMESTAMP
           END-READ
           .

       2000-PROCESS.
           READ UPDATE-FILE
               AT END
                   SET END-OF-FILE TO TRUE
               NOT AT END
                   PERFORM 2100-PROCESS-UPDATE
           END-READ
           .

       2100-PROCESS-UPDATE.
           MOVE UPDT-KEY TO PORT-KEY

           READ PORTFOLIO-FILE

           IF WS-SUCCESS-STATUS
               PERFORM 2200-APPLY-UPDATE
           ELSE
               ADD 1 TO WS-ERROR-COUNT
               DISPLAY 'Record not found: ' PORT-KEY
      *-- Change: Log error for audit
               MOVE 'Record not found for update' TO WS-ERROR-MSG
               PERFORM 4000-AUDIT-LOGGING
           END-IF
           .

       2200-APPLY-UPDATE.
           EVALUATE TRUE
               WHEN UPDT-STATUS
                   MOVE UPDT-NEW-VALUE TO PORT-STATUS
               WHEN UPDT-NAME
                   MOVE UPDT-NEW-VALUE TO PORT-CLIENT-NAME
               WHEN UPDT-VALUE
                   MOVE UPDT-NEW-VALUE TO WS-NUMERIC-WORK
                   MOVE WS-NUMERIC-WORK TO PORT-TOTAL-VALUE
           END-EVALUATE

      *-- Change: Apply latest price feed for dynamic valuation
           IF WS-LATEST-PRICE NOT = ZERO
               MOVE WS-LATEST-PRICE TO PORT-TOTAL-VALUE
               MOVE 'Valuation updated from real-time price feed' TO WS-AUDIT-MSG
               PERFORM 4000-AUDIT-LOGGING
           END-IF

           REWRITE PORT-RECORD

           IF WS-SUCCESS-STATUS
               ADD 1 TO WS-UPDATE-COUNT
           ELSE
               ADD 1 TO WS-ERROR-COUNT
               DISPLAY 'Update failed for: ' PORT-KEY
      *-- Change: Log error for audit
               MOVE 'Update failed for record' TO WS-ERROR-MSG
               PERFORM 4000-AUDIT-LOGGING
           END-IF
           .

       3000-TERMINATE.
           CLOSE PORTFOLIO-FILE
                 UPDATE-FILE
      *-- Change: Close price feed file
                 PRICE-FEED-FILE

           DISPLAY 'Updates processed: ' WS-UPDATE-COUNT
           DISPLAY 'Errors occurred:  ' WS-ERROR-COUNT

           MOVE WS-RETURN-CODE TO RETURN-CODE
           .

      *-- Change: Audit logging paragraph for traceability
       4000-AUDIT-LOGGING.
           DISPLAY 'AUDIT: ' WS-AUDIT-MSG
           DISPLAY 'ERROR: ' WS-ERROR-MSG
           .

[Summary Change Report]
- Added logic to load and apply real-time price feed for dynamic valuation in 1000-INITIALIZE, 1010-LOAD-PRICE-FEED, 2200-APPLY-UPDATE.
- Added audit logging and error handling in 2100-PROCESS-UPDATE, 2200-APPLY-UPDATE, and new 4000-AUDIT-LOGGING.
- Added new file control and FD for price feed.
- All changes are marked with *-- Change inline comments.

[File 2] PORTTRAN.cbl src/programs/portfolio/PORTTRAN.cbl

      *================================================================*
      * Program Name: PORTTRAN
      * Description: Portfolio Transaction Processing
      * Author: [Author name]
      * Date Written: 2024-03-20
      * 2024-06-XX [COBOL Impact Modifier] Enable valuation recalculation on price update. *-- Change: Trigger valuation recalculation on price update.
      *================================================================*
       IDENTIFICATION DIVISION.
       PROGRAM-ID. PORTTRAN.

       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SOURCE-COMPUTER. IBM-ZOS.
       OBJECT-COMPUTER. IBM-ZOS.

       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT TRANSACTION-FILE
               ASSIGN TO TRANFILE
               ORGANIZATION IS SEQUENTIAL
               ACCESS MODE IS SEQUENTIAL
               FILE STATUS IS WS-TRAN-STATUS.

           SELECT PORTFOLIO-FILE
               ASSIGN TO PORTFILE
               ORGANIZATION IS INDEXED
               ACCESS MODE IS RANDOM
               RECORD KEY IS PORT-ID
               FILE STATUS IS WS-PORT-STATUS.

      *-- Change: Add price feed file for valuation recalculation
           SELECT PRICE-FEED-FILE
               ASSIGN TO PRCFEED
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-PRCFEED-STATUS.

       DATA DIVISION.
       FILE SECTION.
       FD  TRANSACTION-FILE
           RECORDING MODE IS F
           BLOCK CONTAINS 0 RECORDS.
       COPY TRNREC.

       FD  PORTFOLIO-FILE
           RECORDING MODE IS F
           BLOCK CONTAINS 0 RECORDS.
       COPY PORTREC.

      *-- Change: Add price feed record structure
       FD  PRICE-FEED-FILE.
       01  PRICE-FEED-RECORD.
           05  PRCFEED-ID         PIC X(8).
           05  PRCFEED-TIMESTAMP  PIC 9(14).
           05  PRCFEED-PRICE      PIC S9(13)V99 COMP-3.

       WORKING-STORAGE SECTION.
           COPY ERRHAND.
           COPY AUDITLOG.

       01  WS-FILE-STATUS.
           05  WS-TRAN-STATUS      PIC X(2).
           05  WS-PORT-STATUS      PIC X(2).
      *-- Change: Add price feed status
           05  WS-PRCFEED-STATUS   PIC X(2).

       01  WS-COUNTERS.
           05  WS-READ-COUNT       PIC 9(8) COMP.
           05  WS-PROCESS-COUNT    PIC 9(8) COMP.
           05  WS-ERROR-COUNT      PIC 9(8) COMP.

       01  WS-EOF-FLAG            PIC X(1).
           88  END-OF-FILE          VALUE 'Y'.
           88  MORE-RECORDS         VALUE 'N'.

      *-- Change: Add area for latest price feed
       01  WS-LATEST-PRICE        PIC S9(13)V99 COMP-3 VALUE ZERO.
       01  WS-LATEST-TIMESTAMP    PIC 9(14) VALUE ZERO.

       PROCEDURE DIVISION.
       0000-MAIN.
           PERFORM 1000-INITIALIZE

      *-- Change: Load latest price feed for valuation recalculation
           PERFORM 1010-LOAD-PRICE-FEED

           IF WS-TRAN-STATUS = '00'
               PERFORM 2000-PROCESS-TRANSACTIONS
                   UNTIL END-OF-FILE
                   OR WS-ERROR-COUNT > 100
           END-IF

           PERFORM 3000-TERMINATE

           GOBACK
           .

       1000-INITIALIZE.
           INITIALIZE WS-FILE-STATUS
                      WS-COUNTERS
           SET MORE-RECORDS TO TRUE

           OPEN INPUT TRANSACTION-FILE
           IF WS-TRAN-STATUS NOT = '00'
               MOVE 'Error opening transaction file' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF

           OPEN I-O PORTFOLIO-FILE
           IF WS-PORT-STATUS NOT = '00'
               MOVE 'Error opening portfolio file' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF

      *-- Change: Open price feed file
           OPEN INPUT PRICE-FEED-FILE
           IF WS-PRCFEED-STATUS NOT = '00'
               MOVE 'Error opening price feed file' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           .

      *-- Change: Load latest price feed for valuation recalculation
       1010-LOAD-PRICE-FEED.
           READ PRICE-FEED-FILE
               AT END
                   MOVE ZERO TO WS-LATEST-PRICE
                   MOVE ZERO TO WS-LATEST-TIMESTAMP
               NOT AT END
                   MOVE PRCFEED-PRICE TO WS-LATEST-PRICE
                   MOVE PRCFEED-TIMESTAMP TO WS-LATEST-TIMESTAMP
           END-READ
           .

       2000-PROCESS-TRANSACTIONS.
           READ TRANSACTION-FILE
               AT END
                   SET END-OF-FILE TO TRUE
               NOT AT END
                   ADD 1 TO WS-READ-COUNT
                   PERFORM 2100-VALIDATE-TRANSACTION
           END-READ
           .

       2100-VALIDATE-TRANSACTION.
           MOVE SPACES TO ERR-TEXT

           PERFORM 2110-CHECK-PORTFOLIO
           IF ERR-TEXT = SPACES
               PERFORM 2120-CHECK-TRANSACTION-TYPE
           END-IF
           IF ERR-TEXT = SPACES
               PERFORM 2130-CHECK-AMOUNTS
           END-IF

           IF ERR-TEXT = SPACES
               ADD 1 TO WS-PROCESS-COUNT
      *-- Change: Trigger valuation recalculation on price update
               PERFORM 2150-TRIGGER-VALUATION-UPDATE
           ELSE
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           .

      *-- Change: New paragraph to trigger valuation recalculation
       2150-TRIGGER-VALUATION-UPDATE.
           IF WS-LATEST-PRICE NOT = ZERO
               MOVE WS-LATEST-PRICE TO PORT-TOTAL-VALUE
               DISPLAY 'Valuation recalculated for portfolio: ' PORT-ID
           END-IF
           .

       2110-CHECK-PORTFOLIO.
           IF TRN-PORTFOLIO-ID = SPACES
               MOVE 'Portfolio ID is required' TO ERR-TEXT
               EXIT PARAGRAPH
           END-IF

           MOVE TRN-PORTFOLIO-ID TO PORT-ID
           READ PORTFOLIO-FILE
               INVALID KEY
                   STRING 'Invalid Portfolio ID: '
                          TRN-PORTFOLIO-ID
                     DELIMITED BY SIZE
                     INTO ERR-TEXT
           END-READ
           .

       2120-CHECK-TRANSACTION-TYPE.
           EVALUATE TRN-TYPE
               WHEN 'BU'
               WHEN 'SL'
               WHEN 'TR'
               WHEN 'FE'
                   CONTINUE
               WHEN OTHER
                   STRING 'Invalid Transaction Type: '
                          TRN-TYPE
                     DELIMITED BY SIZE
                     INTO ERR-TEXT
           END-EVALUATE
           .

       2130-CHECK-AMOUNTS.
           IF TRN-QUANTITY <= ZERO
               MOVE 'Quantity must be greater than zero' TO ERR-TEXT
               EXIT PARAGRAPH
           END-IF

           IF TRN-PRICE <= ZERO AND TRN-TYPE NOT = 'TR'
               MOVE 'Price must be greater than zero' TO ERR-TEXT
               EXIT PARAGRAPH
           END-IF

           IF TRN-AMOUNT <= ZERO AND TRN-TYPE NOT = 'TR'
               MOVE 'Amount must be greater than zero' TO ERR-TEXT
           END-IF
           .

       2200-UPDATE-POSITIONS.
           EVALUATE TRN-TYPE
               WHEN 'BU'
                   PERFORM 2210-PROCESS-BUY
               WHEN 'SL'
                   PERFORM 2220-PROCESS-SELL
               WHEN 'TR'
                   PERFORM 2230-PROCESS-TRANSFER
               WHEN 'FE'
                   PERFORM 2240-PROCESS-FEE
           END-EVALUATE

           PERFORM 2300-UPDATE-AUDIT-TRAIL
           .

       2210-PROCESS-BUY.
           MOVE TRN-PORTFOLIO-ID TO PORT-ID
           READ PORTFOLIO-FILE
               INVALID KEY
                   MOVE 'Portfolio not found for update' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
                   EXIT PARAGRAPH
           END-READ

           ADD TRN-QUANTITY TO PORT-TOTAL-UNITS
           ADD TRN-AMOUNT   TO PORT-TOTAL-COST

           REWRITE PORTFOLIO-RECORD
               INVALID KEY
                   MOVE 'Error updating portfolio' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-REWRITE
           .

       2220-PROCESS-SELL.
           MOVE TRN-PORTFOLIO-ID TO PORT-ID
           READ PORTFOLIO-FILE
               INVALID KEY
                   MOVE 'Portfolio not found for update' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
                   EXIT PARAGRAPH
           END-READ

           IF PORT-TOTAL-UNITS < TRN-QUANTITY
               MOVE 'Insufficient units for sale' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
               EXIT PARAGRAPH
           END-IF

           SUBTRACT TRN-QUANTITY FROM PORT-TOTAL-UNITS
           SUBTRACT TRN-AMOUNT   FROM PORT-TOTAL-COST

           REWRITE PORTFOLIO-RECORD
               INVALID KEY
                   MOVE 'Error updating portfolio' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-REWRITE
           .

       2230-PROCESS-TRANSFER.
           MOVE 'Transfer processing not implemented' TO ERR-TEXT
           PERFORM 9000-ERROR-ROUTINE
           .

       2240-PROCESS-FEE.
           MOVE TRN-PORTFOLIO-ID TO PORT-ID
           READ PORTFOLIO-FILE
               INVALID KEY
                   MOVE 'Portfolio not found for fee' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
                   EXIT PARAGRAPH
           END-READ

           SUBTRACT TRN-AMOUNT FROM PORT-TOTAL-COST

           REWRITE PORTFOLIO-RECORD
               INVALID KEY
                   MOVE 'Error updating portfolio' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-REWRITE
           .

       2300-UPDATE-AUDIT-TRAIL.
           INITIALIZE AUDIT-RECORD

           MOVE FUNCTION CURRENT-DATE TO AUD-TIMESTAMP
           MOVE 'PORTTRAN'     TO AUD-PROGRAM
           MOVE FUNCTION USER-ID TO AUD-USER-ID
           MOVE 'TRAN'         TO AUD-TYPE

           EVALUATE TRN-TYPE
               WHEN 'BU'
                   MOVE 'CREATE  ' TO AUD-ACTION
               WHEN 'SL'
                   MOVE 'DELETE  ' TO AUD-ACTION
               WHEN 'TR'
                   MOVE 'UPDATE  ' TO AUD-ACTION
               WHEN 'FE'
                   MOVE 'UPDATE  ' TO AUD-ACTION
           END-EVALUATE

           IF WS-PORT-STATUS = '00'
               MOVE 'SUCC'     TO AUD-STATUS
           ELSE
               MOVE 'FAIL'     TO AUD-STATUS
           END-IF

           MOVE TRN-PORTFOLIO-ID TO AUD-PORTFOLIO-ID
           MOVE PORT-ACCOUNT-NO  TO AUD-ACCOUNT-NO

      *    Store original portfolio state
           MOVE PORT-RECORD      TO AUD-BEFORE-IMAGE

      *    Build audit message
           STRING 'Transaction: ' DELIMITED BY SIZE
                  TRN-TYPE       DELIMITED BY SIZE
                  ' Amount: '    DELIMITED BY SIZE
                  TRN-AMOUNT     DELIMITED BY SIZE
                  ' Units: '     DELIMITED BY SIZE
                  TRN-QUANTITY   DELIMITED BY SIZE
             INTO AUD-MESSAGE

           PERFORM 2310-WRITE-AUDIT-RECORD
           .

       2310-WRITE-AUDIT-RECORD.
      *    Call the audit processor
           CALL 'AUDPROC' USING AUDIT-RECORD

           IF RETURN-CODE NOT = ZERO
               MOVE 'Error writing audit record' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           .

       3000-TERMINATE.
           CLOSE TRANSACTION-FILE
                 PORTFOLIO-FILE
      *-- Change: Close price feed file
                 PRICE-FEED-FILE

           DISPLAY 'Transactions Read:    ' WS-READ-COUNT
           DISPLAY 'Transactions Process: ' WS-PROCESS-COUNT
           DISPLAY 'Errors Encountered:   ' WS-ERROR-COUNT
           .

       9000-ERROR-ROUTINE.
           ADD 1 TO WS-ERROR-COUNT
           MOVE ERR-CAT-PROC TO ERR-CATEGORY
           MOVE 'PORTTRAN' TO ERR-PROGRAM

           CALL 'ERRPROC' USING ERR-MESSAGE
           .

[Summary Change Report]
- Added logic to load and use real-time price feed for valuation recalculation in 1000-INITIALIZE, 1010-LOAD-PRICE-FEED, and 2150-TRIGGER-VALUATION-UPDATE.
- All changes are marked with *-- Change inline comments.

[File 3] RCVPRC00.cbl src/programs/batch/RCVPRC00.cbl

       *================================================================*
      * Program Name: RCVPRC00
      * Description: Process Recovery Handler
      * Version: 1.0
      * Date: 2024
      * 2024-06-XX [COBOL Impact Modifier] Real-time price feed integration logic added. *-- Change: Real-time price feed ingestion logic.
      *================================================================*
       IDENTIFICATION DIVISION.
       PROGRAM-ID. RCVPRC00.

       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SOURCE-COMPUTER. IBM-ZOS.
       OBJECT-COMPUTER. IBM-ZOS.

       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT BATCH-CONTROL-FILE
               ASSIGN TO BCHCTL
               ORGANIZATION IS INDEXED
               ACCESS MODE IS DYNAMIC
               RECORD KEY IS BCT-KEY
               FILE STATUS IS WS-BCT-STATUS.

           SELECT PROCESS-SEQ-FILE
               ASSIGN TO PRCSEQ
               ORGANIZATION IS INDEXED
               ACCESS MODE IS DYNAMIC
               RECORD KEY IS PSR-KEY
               FILE STATUS IS WS-PSR-STATUS.

      *-- Change: Add price feed file for real-time ingestion
           SELECT PRICE-FEED-FILE
               ASSIGN TO PRCFEED
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-PRCFEED-STATUS.

       DATA DIVISION.
       FILE SECTION.
       FD  BATCH-CONTROL-FILE.
           COPY BCHCTL.

       FD  PROCESS-SEQ-FILE.
           COPY PRCSEQ.

      *-- Change: Add price feed record structure
       FD  PRICE-FEED-FILE.
       01  PRICE-FEED-RECORD.
           05  PRCFEED-ID         PIC X(8).
           05  PRCFEED-TIMESTAMP  PIC 9(14).
           05  PRCFEED-PRICE      PIC S9(13)V99 COMP-3.

       WORKING-STORAGE SECTION.
           COPY BCHCON.
           COPY ERRHAND.

       01  WS-FILE-STATUS.
           05  WS-BCT-STATUS         PIC X(2).
           05  WS-PSR-STATUS         PIC X(2).
      *-- Change: Add price feed status
           05  WS-PRCFEED-STATUS     PIC X(2).

       01  WS-WORK-AREAS.
           05  WS-CURRENT-TIME       PIC X(26).
           05  WS-RECOVERY-MODE      PIC X(1).
               88  WS-RECOVER-PROCESS  VALUE 'P'.
               88  WS-RECOVER-SEQUENCE VALUE 'S'.
               88  WS-RECOVER-ALL      VALUE 'A'.
           05  WS-RECOVERY-ACTION    PIC X(1).
               88  WS-ACTION-RESTART   VALUE 'R'.
               88  WS-ACTION-BYPASS    VALUE 'B'.
               88  WS-ACTION-TERMINATE VALUE 'T'.
      *-- Change: Add area for price feed ingestion
           05  WS-PRICE-INGESTED     PIC X VALUE 'N'.
               88  PRICE-INGESTED     VALUE 'Y'.
               88  PRICE-NOT-INGESTED VALUE 'N'.

       LINKAGE SECTION.
       01  LS-RECOVERY-REQUEST.
           05  LS-FUNCTION          PIC X(4).
               88  FUNC-INIT          VALUE 'INIT'.
               88  FUNC-RECV          VALUE 'RECV'.
               88  FUNC-TERM          VALUE 'TERM'.
           05  LS-PROCESS-DATE     PIC X(8).
           05  LS-PROCESS-ID       PIC X(8).
           05  LS-RECOVERY-TYPE    PIC X(1).
           05  LS-RECOVERY-PARM    PIC X(50).
           05  LS-RETURN-CODE      PIC S9(4) COMP.

       PROCEDURE DIVISION USING LS-RECOVERY-REQUEST.
       0000-MAIN.
           EVALUATE TRUE
               WHEN FUNC-INIT
                   PERFORM 1000-INITIALIZE-RECOVERY
               WHEN FUNC-RECV
                   PERFORM 2000-PROCESS-RECOVERY
               WHEN FUNC-TERM
                   PERFORM 3000-TERMINATE-RECOVERY
               WHEN OTHER
                   MOVE 'Invalid function code' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-EVALUATE

           MOVE LS-RETURN-CODE TO RETURN-CODE
           GOBACK
           .

       1000-INITIALIZE-RECOVERY.
           PERFORM 1100-OPEN-FILES
           PERFORM 1200-VALIDATE-REQUEST
           PERFORM 1300-SET-RECOVERY-MODE
      *-- Change: Ingest price feed at initialization
           PERFORM 1400-INGEST-PRICE-FEED
           .

      *-- Change: New paragraph for price feed ingestion
       1400-INGEST-PRICE-FEED.
           OPEN INPUT PRICE-FEED-FILE
           IF WS-PRCFEED-STATUS = '00'
               READ PRICE-FEED-FILE
                   AT END
                       SET PRICE-NOT-INGESTED TO TRUE
                   NOT AT END
                       SET PRICE-INGESTED TO TRUE
                       DISPLAY 'Price feed ingested: ' PRCFEED-ID ' ' PRCFEED-PRICE
               END-READ
           ELSE
               DISPLAY 'Price feed file not available'
           END-IF
           CLOSE PRICE-FEED-FILE
           .

       2000-PROCESS-RECOVERY.
           EVALUATE WS-RECOVERY-MODE
               WHEN 'P'
                   PERFORM 2100-RECOVER-PROCESS
               WHEN 'S'
                   PERFORM 2200-RECOVER-SEQUENCE
               WHEN 'A'
                   PERFORM 2300-RECOVER-ALL
           END-EVALUATE
           .

       3000-TERMINATE-RECOVERY.
           PERFORM 3100-UPDATE-FINAL-STATUS
           PERFORM 3200-CLOSE-FILES
           .

       9000-ERROR-ROUTINE.
           MOVE 'RCVPRC00' TO ERR-PROGRAM
           MOVE BCT-RC-ERROR TO LS-RETURN-CODE
           CALL 'ERRPROC' USING ERR-MESSAGE
           .
      *================================================================*
      * Recovery Implementation Procedures
      *================================================================*
       1100-OPEN-FILES.
           OPEN I-O BATCH-CONTROL-FILE
           IF WS-BCT-STATUS NOT = '00'
               MOVE 'Error opening control file' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF

           OPEN INPUT PROCESS-SEQ-FILE
           IF WS-PSR-STATUS NOT = '00'
               MOVE 'Error opening sequence file' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           .

       1200-VALIDATE-REQUEST.
           IF LS-PROCESS-DATE = SPACES
               MOVE 'Process date required' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF

           EVALUATE LS-RECOVERY-TYPE
               WHEN 'P'
               WHEN 'S'
               WHEN 'A'
                   CONTINUE
               WHEN OTHER
                   MOVE 'Invalid recovery type' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-EVALUATE
           .

       1300-SET-RECOVERY-MODE.
           MOVE LS-RECOVERY-TYPE TO WS-RECOVERY-MODE

           IF WS-RECOVER-PROCESS AND LS-PROCESS-ID = SPACES
               MOVE 'Process ID required for process recovery'
                 TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           .

       2100-RECOVER-PROCESS.
           MOVE LS-PROCESS-ID   TO BCT-JOB-NAME
           MOVE LS-PROCESS-DATE TO BCT-PROCESS-DATE

           READ BATCH-CONTROL-FILE
               INVALID KEY
                   MOVE 'Process record not found' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-READ

           PERFORM 2110-DETERMINE-ACTION
           PERFORM 2120-EXECUTE-RECOVERY
           .

       2110-DETERMINE-ACTION.
           MOVE LS-PROCESS-ID TO PSR-PROCESS-ID

           READ PROCESS-SEQ-FILE
               INVALID KEY
                   MOVE 'Process definition not found' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-READ

           IF PSR-RESTARTABLE
               SET WS-ACTION-RESTART TO TRUE
           ELSE
               IF BCT-RESTART-COUNT > BCT-MAX-RESTARTS
                   SET WS-ACTION-TERMINATE TO TRUE
               ELSE
                   SET WS-ACTION-BYPASS TO TRUE
               END-IF
           END-IF
           .

       2120-EXECUTE-RECOVERY.
           EVALUATE TRUE
               WHEN WS-ACTION-RESTART
                   PERFORM 2121-RESTART-PROCESS
               WHEN WS-ACTION-BYPASS
                   PERFORM 2122-BYPASS-PROCESS
               WHEN WS-ACTION-TERMINATE
                   PERFORM 2123-TERMINATE-PROCESS
           END-EVALUATE
           .

       2121-RESTART-PROCESS.
           MOVE BCT-STAT-READY TO BCT-STATUS
           ADD 1 TO BCT-RESTART-COUNT
           ACCEPT WS-CURRENT-TIME FROM TIME STAMP
           MOVE WS-CURRENT-TIME TO BCT-ATTEMPT-TS

           REWRITE BATCH-CONTROL-RECORD
               INVALID KEY
                   MOVE 'Error updating control record' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-REWRITE
           .

       2122-BYPASS-PROCESS.
           MOVE BCT-STAT-DONE  TO BCT-STATUS
           MOVE BCT-RC-WARNING TO BCT-RETURN-CODE
           MOVE 'Process bypassed by recovery' TO BCT-ERROR-DESC

           REWRITE BATCH-CONTROL-RECORD
               INVALID KEY
                   MOVE 'Error updating control record' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-REWRITE
           .

       2123-TERMINATE-PROCESS.
           MOVE BCT-STAT-ERROR TO BCT-STATUS
           MOVE BCT-RC-ERROR  TO BCT-RETURN-CODE
           MOVE 'Process terminated by recovery' TO BCT-ERROR-DESC

           REWRITE BATCH-CONTROL-RECORD
               INVALID KEY
                   MOVE 'Error updating control record' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-REWRITE
           .

       2200-RECOVER-SEQUENCE.
           MOVE LS-PROCESS-DATE TO BCT-PROCESS-DATE
           MOVE LOW-VALUES TO BCT-JOB-NAME

           START BATCH-CONTROL-FILE KEY > BCT-KEY
               INVALID KEY
                   MOVE 'No processes found for date' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-START

           PERFORM UNTIL WS-BCT-STATUS = '10'
               READ BATCH-CONTROL-FILE NEXT RECORD
                   AT END
                       MOVE '10' TO WS-BCT-STATUS
                   NOT AT END
                       IF BCT-PROCESS-DATE = LS-PROCESS-DATE
                           PERFORM 2100-RECOVER-PROCESS
                       END-IF
               END-READ
           END-PERFORM
           .

       2300-RECOVER-ALL.
           MOVE LOW-VALUES TO BCT-KEY

           START BATCH-CONTROL-FILE KEY > BCT-KEY
               INVALID KEY
                   MOVE 'No processes found' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-START

           PERFORM UNTIL WS-BCT-STATUS = '10'
               READ BATCH-CONTROL-FILE NEXT RECORD
                   AT END
                       MOVE '10' TO WS-BCT-STATUS
                   NOT AT END
                       MOVE BCT-JOB-NAME TO LS-PROCESS-ID
                       PERFORM 2100-RECOVER-PROCESS
               END-READ
           END-PERFORM
           .

       3100-UPDATE-FINAL-STATUS.
           IF LS-RETURN-CODE = ZERO
               MOVE 'Recovery completed successfully' TO ERR-TEXT
           ELSE
               MOVE 'Recovery completed with errors' TO ERR-TEXT
           END-IF

           CALL 'ERRPROC' USING ERR-MESSAGE
           .

       3200-CLOSE-FILES.
           CLOSE BATCH-CONTROL-FILE
                 PROCESS-SEQ-FILE
      *-- Change: Close price feed file if open
                 PRICE-FEED-FILE

           IF WS-BCT-STATUS NOT = '00' OR
              WS-PSR-STATUS NOT = '00'
               MOVE 'Error closing files' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           .

[Summary Change Report]
- Added logic to ingest real-time price feed in 1000-INITIALIZE-RECOVERY and 1400-INGEST-PRICE-FEED.
- Added file control and FD for price feed.
- All changes are marked with *-- Change inline comments.

[File 4] RPTAUD00.cbl src/programs/batch/RPTAUD00.cbl

       IDENTIFICATION DIVISION.
       PROGRAM-ID. RPTAUD00.
       AUTHOR. CLAUDE.
       DATE-WRITTEN. 2024-04-09.
      *****************************************************************
      * Audit Report Generator                                         *
      *                                                               *
      * Generates comprehensive audit report including:                *
      * - Security audit trails                                       *
      * - Process audit reporting                                     *
      * - Error summary reporting                                     *
      * - Control verification                                        *
      * 2024-06-XX [COBOL Impact Modifier] Log price feed errors and valuation events. *-- Change: Log price feed errors and valuation events.
      *****************************************************************
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT AUDIT-FILE ASSIGN TO AUDITLOG
               ORGANIZATION IS INDEXED
               ACCESS MODE IS SEQUENTIAL
               RECORD KEY IS AUD-KEY
               FILE STATUS IS WS-AUDIT-STATUS.

           SELECT ERROR-FILE ASSIGN TO ERRLOG
               ORGANIZATION IS INDEXED
               ACCESS MODE IS SEQUENTIAL
               RECORD KEY IS ERR-KEY
               FILE STATUS IS WS-ERROR-STATUS.

           SELECT REPORT-FILE ASSIGN TO RPTFILE
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-REPORT-STATUS.

      *-- Change: Add price feed error log file
           SELECT PRICE-ERROR-FILE ASSIGN TO PRCERRLOG
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-PRCERR-STATUS.

       DATA DIVISION.
       FILE SECTION.
           COPY AUDITLOG.
           COPY ERRHAND.

       FD  REPORT-FILE
           RECORDING MODE IS F
           BLOCK CONTAINS 0 RECORDS.
       01  REPORT-RECORD             PIC X(132).

      *-- Change: Add price feed error record
       FD  PRICE-ERROR-FILE.
       01  PRICE-ERROR-RECORD.
           05  PRCERR-TIMESTAMP      PIC 9(14).
           05  PRCERR-PROGRAM        PIC X(8).
           05  PRCERR-MESSAGE        PIC X(80).

       WORKING-STORAGE SECTION.
           COPY RTNCODE.

       01  WS-FILE-STATUS.
           05  WS-AUDIT-STATUS       PIC XX.
           05  WS-ERROR-STATUS       PIC XX.
           05  WS-REPORT-STATUS      PIC XX.
      *-- Change: Add price feed error status
           05  WS-PRCERR-STATUS      PIC XX.

       01  WS-REPORT-HEADERS.
           05  WS-HEADER1.
               10  FILLER            PIC X(132) VALUE ALL '*'.
           05  WS-HEADER2.
               10  FILLER            PIC X(40) VALUE SPACES.
               10  FILLER            PIC X(52)
                   VALUE 'SYSTEM AUDIT REPORT'.
               10  FILLER            PIC X(40) VALUE SPACES.
           05  WS-HEADER3.
               10  FILLER            PIC X(15) VALUE 'REPORT DATE:'.
               10  WS-REPORT-DATE    PIC X(10).
               10  FILLER            PIC X(107) VALUE SPACES.

       01  WS-AUDIT-DETAIL.
           05  WS-AUD-TIMESTAMP     PIC X(26).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-AUD-PROGRAM       PIC X(8).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-AUD-TYPE          PIC X(10).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-AUD-MESSAGE       PIC X(80).

       01  WS-ERROR-DETAIL.
           05  WS-ERR-TIMESTAMP     PIC X(26).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-ERR-PROGRAM       PIC X(8).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-ERR-CODE          PIC X(4).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-ERR-MESSAGE       PIC X(80).

      *-- Change: Add area for price feed error detail
       01  WS-PRCERR-DETAIL.
           05  WS-PRCERR-TIMESTAMP  PIC 9(14).
           05  WS-PRCERR-PROGRAM    PIC X(8).
           05  WS-PRCERR-MESSAGE    PIC X(80).

       PROCEDURE DIVISION.
       0000-MAIN.
           PERFORM 1000-INITIALIZE
           PERFORM 2000-PROCESS-REPORT
           PERFORM 3000-CLEANUP
           GOBACK.

       1000-INITIALIZE.
           PERFORM 1100-OPEN-FILES
           PERFORM 1200-WRITE-HEADERS.

       1100-OPEN-FILES.
           OPEN INPUT AUDIT-FILE
           IF WS-AUDIT-STATUS NOT = '00'
               MOVE 'ERROR OPENING AUDIT FILE'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF

           OPEN INPUT ERROR-FILE
           IF WS-ERROR-STATUS NOT = '00'
               MOVE 'ERROR OPENING ERROR FILE'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF

           OPEN OUTPUT REPORT-FILE
           IF WS-REPORT-STATUS NOT = '00'
               MOVE 'ERROR OPENING REPORT FILE'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF

      *-- Change: Open price feed error file
           OPEN INPUT PRICE-ERROR-FILE
           IF WS-PRCERR-STATUS NOT = '00'
               MOVE 'ERROR OPENING PRICE FEED ERROR FILE'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF
           .

       1200-WRITE-HEADERS.
           ACCEPT WS-REPORT-DATE FROM DATE
           WRITE REPORT-RECORD FROM WS-HEADER1
           WRITE REPORT-RECORD FROM WS-HEADER2
           WRITE REPORT-RECORD FROM WS-HEADER3.

       2000-PROCESS-REPORT.
           PERFORM 2100-PROCESS-AUDIT-TRAIL
           PERFORM 2200-PROCESS-ERROR-LOG
      *-- Change: Process price feed error log
           PERFORM 2250-PROCESS-PRICE-ERROR-LOG
           PERFORM 2300-WRITE-SUMMARY.

       2100-PROCESS-AUDIT-TRAIL.
           PERFORM 2110-READ-AUDIT-RECORDS
           PERFORM 2120-SUMMARIZE-AUDIT.

       2200-PROCESS-ERROR-LOG.
           PERFORM 2210-READ-ERROR-RECORDS
           PERFORM 2220-SUMMARIZE-ERRORS.

      *-- Change: New paragraph for price feed error log
       2250-PROCESS-PRICE-ERROR-LOG.
           READ PRICE-ERROR-FILE
               AT END
                   CONTINUE
               NOT AT END
                   DISPLAY 'PRICE FEED ERROR: ' PRCERR-TIMESTAMP ' ' PRCERR-PROGRAM ' ' PRCERR-MESSAGE
           END-READ
           .

       2300-WRITE-SUMMARY.
           PERFORM 2310-WRITE-AUDIT-SUMMARY
           PERFORM 2320-WRITE-ERROR-SUMMARY
           PERFORM 2330-WRITE-CONTROL-SUMMARY.

       3000-CLEANUP.
           CLOSE AUDIT-FILE
                ERROR-FILE
                REPORT-FILE
      *-- Change: Close price feed error file
                PRICE-ERROR-FILE
                .

       9999-ERROR-HANDLER.
           DISPLAY WS-ERROR-MESSAGE
           MOVE 12 TO RETURN-CODE
           GOBACK.

[Summary Change Report]
- Added logic to log and process price feed errors and valuation events in 1100-OPEN-FILES, 2000-PROCESS-REPORT, 2250-PROCESS-PRICE-ERROR-LOG, and 3000-CLEANUP.
- All changes are marked with *-- Change inline comments.

[File 5] PORTFLIO.cpy src/copybook/common/PORTFLIO.cpy

      *================================================================*
      * Copybook Name: PORTFLIO
      * Description: Portfolio Master Record Layout
      * Author: [Author name]
      * Date Written: 2024-03-20
      * Maintenance Log:
      * Date       Author        Description
      * ---------- ------------- -------------------------------------
      * 2024-03-20 [Author]     Initial Creation
      * 2024-06-XX [COBOL Impact Modifier] Add price/time fields, historical records for real-time feed. *-- Change: Added price/time fields and historical records.
      *================================================================*
       01  PORT-RECORD.
           05  PORT-KEY.
               10  PORT-ID             PIC X(8).
               10  PORT-ACCOUNT-NO     PIC X(10).
           05  PORT-CLIENT-INFO.
               10  PORT-CLIENT-NAME    PIC X(30).
               10  PORT-CLIENT-TYPE    PIC X(1).
                   88  PORT-INDIVIDUAL    VALUE 'I'.
                   88  PORT-CORPORATE     VALUE 'C'.
                   88  PORT-TRUST         VALUE 'T'.
           05  PORT-PORTFOLIO-INFO.
               10  PORT-CREATE-DATE    PIC 9(8).
               10  PORT-LAST-MAINT     PIC 9(8).
               10  PORT-STATUS         PIC X(1).
                   88  PORT-ACTIVE       VALUE 'A'.
                   88  PORT-CLOSED       VALUE 'C'.
                   88  PORT-SUSPENDED    VALUE 'S'.
      *-- Change: Add real-time price and timestamp fields
               10  PORT-LAST-PRICE     PIC S9(13)V99 COMP-3.
               10  PORT-LAST-PRICE-TS  PIC 9(14).
           05  PORT-FINANCIAL-INFO.
               10  PORT-TOTAL-VALUE    PIC S9(13)V99 COMP-3.
               10  PORT-CASH-BALANCE   PIC S9(13)V99 COMP-3.
      *-- Change: Add historical price array
           05  PORT-PRICE-HISTORY OCCURS 10 TIMES.
               10  PORT-HIST-PRICE      PIC S9(13)V99 COMP-3.
               10  PORT-HIST-PRICE-TS   PIC 9(14).
           05  PORT-AUDIT-INFO.
               10  PORT-LAST-USER      PIC X(8).
               10  PORT-LAST-TRANS     PIC 9(8).
           05  PORT-FILLER            PIC X(50).

[Summary Change Report]
- Added fields for real-time price and timestamp, and a 10-entry price history array for historical records.
- All changes are marked with *-- Change inline comments.

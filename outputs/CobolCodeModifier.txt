      *****************************************************************
      * TRANSACTION RECORD STRUCTURE
      * VERSION: 1.1 (2024-06, Added TRANSACTION-TYPE field)
      * DATE: 2024
      *****************************************************************
       01  TRANSACTION-RECORD.
           05  TRN-KEY.
               10  TRN-DATE           PIC X(08).
               10  TRN-TIME           PIC X(06).
               10  TRN-PORTFOLIO-ID   PIC X(08).
               10  TRN-SEQUENCE-NO    PIC X(06).
           05  TRN-DATA.
               10  TRN-INVESTMENT-ID  PIC X(10).
               10  TRN-TYPE           PIC X(02).
                   88  TRN-TYPE-BUY     VALUE 'BU'.
                   88  TRN-TYPE-SELL    VALUE 'SL'.
                   88  TRN-TYPE-TRANS   VALUE 'TR'.
                   88  TRN-TYPE-FEE     VALUE 'FE'.
               10  TRN-TRANSACTION-TYPE PIC X(10). *> Added: Extended transaction type field for new business requirements
               10  TRN-QUANTITY       PIC S9(11)V9(4) COMP-3.
               10  TRN-PRICE         PIC S9(11)V9(4) COMP-3.
               10  TRN-AMOUNT        PIC S9(13)V9(2) COMP-3.
               10  TRN-CURRENCY      PIC X(03).
               10  TRN-STATUS        PIC X(01).
                   88  TRN-STATUS-PEND   VALUE 'P'.
                   88  TRN-STATUS-DONE   VALUE 'D'.
                   88  TRN-STATUS-FAIL   VALUE 'F'.
                   88  TRN-STATUS-REV    VALUE 'R'.
           05  TRN-AUDIT.
               10  TRN-PROCESS-DATE  PIC X(26).
               10  TRN-PROCESS-USER  PIC X(08).
           05  TRN-FILLER           PIC X(40). *> Reduced filler by 10 to accommodate new field
      *****************************************************************
      * FIELD DESCRIPTIONS:
      * TRN-DATE        : TRANSACTION DATE (YYYYMMDD)
      * TRN-TIME        : TRANSACTION TIME (HHMMSS)
      * TRN-PORTFOLIO-ID: PORTFOLIO IDENTIFIER
      * TRN-SEQUENCE-NO : SEQUENCE NUMBER FOR MULTIPLE TRANS
      * TRN-TYPE        : BU=BUY, SL=SELL, TR=TRANSFER, FE=FEE
      * TRN-TRANSACTION-TYPE: EXTENDED TRANSACTION TYPE (NEW FIELD, X(10))
      * TRN-STATUS      : P=PENDING, D=DONE, F=FAILED, R=REVERSED
      *****************************************************************

      *================================================================*
      * Program Name: PORTTRAN
      * Description: Portfolio Transaction Processing
      * Author: [Author name]
      * Date Written: 2024-03-20
      *================================================================*
       IDENTIFICATION DIVISION.
       PROGRAM-ID. PORTTRAN.
       
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SOURCE-COMPUTER. IBM-ZOS.
       OBJECT-COMPUTER. IBM-ZOS.
       
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT TRANSACTION-FILE
               ASSIGN TO TRANFILE
               ORGANIZATION IS SEQUENTIAL
               ACCESS MODE IS SEQUENTIAL
               FILE STATUS IS WS-TRAN-STATUS.
               
           SELECT PORTFOLIO-FILE
               ASSIGN TO PORTFILE
               ORGANIZATION IS INDEXED
               ACCESS MODE IS RANDOM
               RECORD KEY IS PORT-ID
               FILE STATUS IS WS-PORT-STATUS.
       
       DATA DIVISION.
       FILE SECTION.
       FD  TRANSACTION-FILE
           RECORDING MODE IS F
           BLOCK CONTAINS 0 RECORDS.
       COPY TRNREC.
       
       FD  PORTFOLIO-FILE
           RECORDING MODE IS F
           BLOCK CONTAINS 0 RECORDS.
       COPY PORTREC.
       
       WORKING-STORAGE SECTION.
           COPY ERRHAND.
           COPY AUDITLOG.
           
       01  WS-FILE-STATUS.
           05  WS-TRAN-STATUS      PIC X(2).
           05  WS-PORT-STATUS      PIC X(2).
           
       01  WS-COUNTERS.
           05  WS-READ-COUNT       PIC 9(8) COMP.
           05  WS-PROCESS-COUNT    PIC 9(8) COMP.
           05  WS-ERROR-COUNT      PIC 9(8) COMP.
           
       01  WS-EOF-FLAG            PIC X(1).
           88  END-OF-FILE          VALUE 'Y'.
           88  MORE-RECORDS         VALUE 'N'.

      *-- Begin: Add working storage for backward compatibility and new field
       01  WS-TRAN-TYPE-BACKUP     PIC X(02).
       01  WS-TRANSACTION-TYPE-BACKUP PIC X(10).
      *-- End: Add working storage for backward compatibility and new field
           
       PROCEDURE DIVISION.
       0000-MAIN.
           PERFORM 1000-INITIALIZE
           
           IF WS-TRAN-STATUS = '00'
               PERFORM 2000-PROCESS-TRANSACTIONS
                   UNTIL END-OF-FILE
                   OR WS-ERROR-COUNT > 100
           END-IF
           
           PERFORM 3000-TERMINATE
           
           GOBACK
           .
           
       1000-INITIALIZE.
           INITIALIZE WS-FILE-STATUS
                      WS-COUNTERS
           SET MORE-RECORDS TO TRUE
           
           OPEN INPUT TRANSACTION-FILE
           IF WS-TRAN-STATUS NOT = '00'
               MOVE 'Error opening transaction file' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           
           OPEN I-O PORTFOLIO-FILE
           IF WS-PORT-STATUS NOT = '00'
               MOVE 'Error opening portfolio file' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           .
           
       2000-PROCESS-TRANSACTIONS.
           READ TRANSACTION-FILE
               AT END
                   SET END-OF-FILE TO TRUE
               NOT AT END
                   ADD 1 TO WS-READ-COUNT

      *-- Begin: Backward compatibility for TRANSACTION-TYPE
                   IF TRN-TRANSACTION-TYPE = SPACES OR TRN-TRANSACTION-TYPE = LOW-VALUES
                       MOVE TRN-TYPE TO TRN-TRANSACTION-TYPE
                   END-IF
      *-- End: Backward compatibility for TRANSACTION-TYPE

                   PERFORM 2100-VALIDATE-TRANSACTION
           END-READ
           .
           
       2100-VALIDATE-TRANSACTION.
           MOVE SPACES TO ERR-TEXT
           
           PERFORM 2110-CHECK-PORTFOLIO
           IF ERR-TEXT = SPACES
               PERFORM 2120-CHECK-TRANSACTION-TYPE
           END-IF
           IF ERR-TEXT = SPACES
               PERFORM 2130-CHECK-AMOUNTS
           END-IF
           
           IF ERR-TEXT = SPACES
               ADD 1 TO WS-PROCESS-COUNT
           ELSE
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           .
           
       2110-CHECK-PORTFOLIO.
           IF TRN-PORTFOLIO-ID = SPACES
               MOVE 'Portfolio ID is required' TO ERR-TEXT
               EXIT PARAGRAPH
           END-IF
           
           MOVE TRN-PORTFOLIO-ID TO PORT-ID
           READ PORTFOLIO-FILE
               INVALID KEY
                   STRING 'Invalid Portfolio ID: '
                          TRN-PORTFOLIO-ID
                     DELIMITED BY SIZE
                     INTO ERR-TEXT
           END-READ
           .
           
       2120-CHECK-TRANSACTION-TYPE.
      *-- Begin: Enhanced validation for new TRANSACTION-TYPE field
           IF TRN-TRANSACTION-TYPE = SPACES OR TRN-TRANSACTION-TYPE = LOW-VALUES
               MOVE TRN-TYPE TO TRN-TRANSACTION-TYPE
           END-IF
           EVALUATE TRN-TRANSACTION-TYPE(1:2)
               WHEN 'BU'
               WHEN 'SL'
               WHEN 'TR'
               WHEN 'FE'
                   CONTINUE
               WHEN OTHER
                   STRING 'Invalid Transaction Type: '
                          TRN-TRANSACTION-TYPE
                     DELIMITED BY SIZE
                     INTO ERR-TEXT
           END-EVALUATE
      *-- End: Enhanced validation for new TRANSACTION-TYPE field
           .
           
       2130-CHECK-AMOUNTS.
           IF TRN-QUANTITY <= ZERO
               MOVE 'Quantity must be greater than zero' TO ERR-TEXT
               EXIT PARAGRAPH
           END-IF
           
           IF TRN-PRICE <= ZERO AND TRN-TYPE NOT = 'TR'
               MOVE 'Price must be greater than zero' TO ERR-TEXT
               EXIT PARAGRAPH
           END-IF
           
           IF TRN-AMOUNT <= ZERO AND TRN-TYPE NOT = 'TR'
               MOVE 'Amount must be greater than zero' TO ERR-TEXT
           END-IF
           .
           
       2200-UPDATE-POSITIONS.
      *-- Begin: Use new TRANSACTION-TYPE field for processing
           EVALUATE TRN-TRANSACTION-TYPE(1:2)
               WHEN 'BU'
                   PERFORM 2210-PROCESS-BUY
               WHEN 'SL'
                   PERFORM 2220-PROCESS-SELL
               WHEN 'TR'
                   PERFORM 2230-PROCESS-TRANSFER
               WHEN 'FE'
                   PERFORM 2240-PROCESS-FEE
               WHEN OTHER
                   MOVE 'Unknown transaction type in update positions' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-EVALUATE
      *-- End: Use new TRANSACTION-TYPE field for processing
           
           PERFORM 2300-UPDATE-AUDIT-TRAIL
           .
           
       2210-PROCESS-BUY.
           MOVE TRN-PORTFOLIO-ID TO PORT-ID
           READ PORTFOLIO-FILE
               INVALID KEY
                   MOVE 'Portfolio not found for update' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
                   EXIT PARAGRAPH
           END-READ
           
           ADD TRN-QUANTITY TO PORT-TOTAL-UNITS
           ADD TRN-AMOUNT   TO PORT-TOTAL-COST
           
           REWRITE PORTFOLIO-RECORD
               INVALID KEY
                   MOVE 'Error updating portfolio' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-REWRITE
           .
           
       2220-PROCESS-SELL.
           MOVE TRN-PORTFOLIO-ID TO PORT-ID
           READ PORTFOLIO-FILE
               INVALID KEY
                   MOVE 'Portfolio not found for update' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
                   EXIT PARAGRAPH
           END-READ
           
           IF PORT-TOTAL-UNITS < TRN-QUANTITY
               MOVE 'Insufficient units for sale' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
               EXIT PARAGRAPH
           END-IF
           
           SUBTRACT TRN-QUANTITY FROM PORT-TOTAL-UNITS
           SUBTRACT TRN-AMOUNT   FROM PORT-TOTAL-COST
           
           REWRITE PORTFOLIO-RECORD
               INVALID KEY
                   MOVE 'Error updating portfolio' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-REWRITE
           .
           
       2230-PROCESS-TRANSFER.
           MOVE 'Transfer processing not implemented' TO ERR-TEXT
           PERFORM 9000-ERROR-ROUTINE
           .
           
       2240-PROCESS-FEE.
           MOVE TRN-PORTFOLIO-ID TO PORT-ID
           READ PORTFOLIO-FILE
               INVALID KEY
                   MOVE 'Portfolio not found for fee' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
                   EXIT PARAGRAPH
           END-READ
           
           SUBTRACT TRN-AMOUNT FROM PORT-TOTAL-COST
           
           REWRITE PORTFOLIO-RECORD
               INVALID KEY
                   MOVE 'Error updating portfolio' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-REWRITE
           .
           
       2300-UPDATE-AUDIT-TRAIL.
           INITIALIZE AUDIT-RECORD
           
           MOVE FUNCTION CURRENT-DATE TO AUD-TIMESTAMP
           MOVE 'PORTTRAN'     TO AUD-PROGRAM
           MOVE FUNCTION USER-ID TO AUD-USER-ID
           MOVE 'TRAN'         TO AUD-TYPE

      *-- Begin: Audit new TRANSACTION-TYPE field
           MOVE TRN-TRANSACTION-TYPE TO AUD-TRANSACTION-TYPE
      *-- End: Audit new TRANSACTION-TYPE field

           EVALUATE TRN-TRANSACTION-TYPE(1:2)
               WHEN 'BU'
                   MOVE 'CREATE  ' TO AUD-ACTION
               WHEN 'SL'
                   MOVE 'DELETE  ' TO AUD-ACTION
               WHEN 'TR'
                   MOVE 'UPDATE  ' TO AUD-ACTION
               WHEN 'FE'
                   MOVE 'UPDATE  ' TO AUD-ACTION
               WHEN OTHER
                   MOVE 'UNKNOWN ' TO AUD-ACTION
           END-EVALUATE
           
           IF WS-PORT-STATUS = '00'
               MOVE 'SUCC'     TO AUD-STATUS
           ELSE
               MOVE 'FAIL'     TO AUD-STATUS
           END-IF
           
           MOVE TRN-PORTFOLIO-ID TO AUD-PORTFOLIO-ID
           MOVE PORT-ACCOUNT-NO  TO AUD-ACCOUNT-NO
           
      *    Store original portfolio state
           MOVE PORT-RECORD      TO AUD-BEFORE-IMAGE
           
      *    Build audit message
           STRING 'Transaction: ' DELIMITED BY SIZE
                  TRN-TRANSACTION-TYPE DELIMITED BY SIZE
                  ' Amount: '    DELIMITED BY SIZE
                  TRN-AMOUNT     DELIMITED BY SIZE
                  ' Units: '     DELIMITED BY SIZE
                  TRN-QUANTITY   DELIMITED BY SIZE
             INTO AUD-MESSAGE
           
           PERFORM 2310-WRITE-AUDIT-RECORD
           .
           
       2310-WRITE-AUDIT-RECORD.
      *    Call the audit processor
           CALL 'AUDPROC' USING AUDIT-RECORD
           
           IF RETURN-CODE NOT = ZERO
               MOVE 'Error writing audit record' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           .
           
       3000-TERMINATE.
           CLOSE TRANSACTION-FILE
                 PORTFOLIO-FILE
                 
           DISPLAY 'Transactions Read:    ' WS-READ-COUNT
           DISPLAY 'Transactions Process: ' WS-PROCESS-COUNT
           DISPLAY 'Errors Encountered:   ' WS-ERROR-COUNT
           .
           
       9000-ERROR-ROUTINE.
           ADD 1 TO WS-ERROR-COUNT
           MOVE ERR-CAT-PROC TO ERR-CATEGORY
           MOVE 'PORTTRAN' TO ERR-PROGRAM
           
           CALL 'ERRPROC' USING ERR-MESSAGE
           . 

       IDENTIFICATION DIVISION.
       PROGRAM-ID. RPTPOS00.
       AUTHOR. CLAUDE.
       DATE-WRITTEN. 2024-04-09.
      *****************************************************************
      * Daily Position Report Generator                                 *
      *                                                               *
      * This program generates the daily position report including:    *
      * - Portfolio position summary                                   *
      * - Transaction activity                                         *
      * - Exception reporting                                          *
      * - Performance metrics                                          *
      *****************************************************************
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT POSITION-MASTER ASSIGN TO POSMSTRE
               ORGANIZATION IS INDEXED
               ACCESS MODE IS SEQUENTIAL
               RECORD KEY IS POS-KEY
               FILE STATUS IS WS-POSITION-STATUS.

           SELECT TRANSACTION-HISTORY ASSIGN TO TRANHIST
               ORGANIZATION IS INDEXED
               ACCESS MODE IS SEQUENTIAL
               RECORD KEY IS TRAN-KEY
               FILE STATUS IS WS-TRAN-STATUS.

           SELECT REPORT-FILE ASSIGN TO RPTFILE
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-REPORT-STATUS.

       DATA DIVISION.
       FILE SECTION.
           COPY POSREC.
           COPY TRNREC.
           
       FD  REPORT-FILE
           RECORDING MODE IS F
           BLOCK CONTAINS 0 RECORDS.
       01  REPORT-RECORD             PIC X(132).

       WORKING-STORAGE SECTION.
           COPY RTNCODE.
           COPY ERRHAND.

       01  WS-FILE-STATUS.
           05  WS-POSITION-STATUS    PIC XX.
           05  WS-TRAN-STATUS        PIC XX.
           05  WS-REPORT-STATUS      PIC XX.

       01  WS-REPORT-HEADERS.
           05  WS-HEADER1.
               10  FILLER            PIC X(132) VALUE ALL '*'.
           05  WS-HEADER2.
               10  FILLER            PIC X(40) VALUE SPACES.
               10  FILLER            PIC X(52) 
                   VALUE 'DAILY POSITION REPORT'.
               10  FILLER            PIC X(40) VALUE SPACES.
           05  WS-HEADER3.
               10  FILLER            PIC X(15) VALUE 'REPORT DATE:'.
               10  WS-REPORT-DATE    PIC X(10).
               10  FILLER            PIC X(107) VALUE SPACES.

      *-- Begin: Add field for displaying transaction type
       01  WS-TRANSACTION-DETAIL.
           05  WS-TRAN-DATE         PIC X(08).
           05  FILLER               PIC X(1) VALUE ' '.
           05  WS-TRAN-TIME         PIC X(06).
           05  FILLER               PIC X(1) VALUE ' '.
           05  WS-TRAN-PORTFOLIO    PIC X(08).
           05  FILLER               PIC X(1) VALUE ' '.
           05  WS-TRAN-INVESTMENT   PIC X(10).
           05  FILLER               PIC X(1) VALUE ' '.
           05  WS-TRAN-TYPE         PIC X(10).
           05  FILLER               PIC X(1) VALUE ' '.
           05  WS-TRAN-QUANTITY     PIC -ZZZZZZZZ9.9999.
           05  FILLER               PIC X(1) VALUE ' '.
           05  WS-TRAN-AMOUNT       PIC -ZZZZZZZZ9.99.
           05  FILLER               PIC X(80) VALUE SPACES.
      *-- End: Add field for displaying transaction type

       01  WS-POSITION-DETAIL.
           05  WS-POS-PORTFOLIO     PIC X(10).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-POS-DESCRIPTION   PIC X(30).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-POS-QUANTITY      PIC ZZZ,ZZZ,ZZ9.99.
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-POS-VALUE         PIC $$$$,$$$,$$9.99.
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-POS-CHANGE-PCT    PIC +ZZ9.99.
           05  FILLER               PIC X(40) VALUE SPACES.

       PROCEDURE DIVISION.
       0000-MAIN.
           PERFORM 1000-INITIALIZE
           PERFORM 2000-PROCESS-REPORT
           PERFORM 3000-CLEANUP
           GOBACK.

       1000-INITIALIZE.
           PERFORM 1100-OPEN-FILES
           PERFORM 1200-WRITE-HEADERS.

       1100-OPEN-FILES.
           OPEN INPUT POSITION-MASTER
           IF WS-POSITION-STATUS NOT = '00'
               MOVE 'ERROR OPENING POSITION MASTER'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF

           OPEN INPUT TRANSACTION-HISTORY
           IF WS-TRAN-STATUS NOT = '00'
               MOVE 'ERROR OPENING TRANSACTION HISTORY'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF

           OPEN OUTPUT REPORT-FILE
           IF WS-REPORT-STATUS NOT = '00'
               MOVE 'ERROR OPENING REPORT FILE'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF.

       1200-WRITE-HEADERS.
           ACCEPT WS-REPORT-DATE FROM DATE
           WRITE REPORT-RECORD FROM WS-HEADER1
           WRITE REPORT-RECORD FROM WS-HEADER2
           WRITE REPORT-RECORD FROM WS-HEADER3.

       2000-PROCESS-REPORT.
           PERFORM 2100-READ-POSITIONS
           PERFORM 2200-PROCESS-TRANSACTIONS
           PERFORM 2300-WRITE-SUMMARY.

       2100-READ-POSITIONS.
           READ POSITION-MASTER
               AT END SET END-OF-POSITIONS TO TRUE
           END-READ
           
           PERFORM UNTIL END-OF-POSITIONS
               PERFORM 2110-FORMAT-POSITION
               READ POSITION-MASTER
                   AT END SET END-OF-POSITIONS TO TRUE
               END-READ
           END-PERFORM.

       2110-FORMAT-POSITION.
           MOVE POS-PORTFOLIO-ID   TO WS-POS-PORTFOLIO
           MOVE POS-DESCRIPTION    TO WS-POS-DESCRIPTION
           MOVE POS-QUANTITY       TO WS-POS-QUANTITY
           MOVE POS-CURRENT-VALUE  TO WS-POS-VALUE
           COMPUTE WS-POS-CHANGE-PCT = 
               (POS-CURRENT-VALUE - POS-PREVIOUS-VALUE) /
                POS-PREVIOUS-VALUE * 100
           WRITE REPORT-RECORD FROM WS-POSITION-DETAIL.

       2200-PROCESS-TRANSACTIONS.
           PERFORM 2210-READ-TRANSACTIONS
           PERFORM 2220-SUMMARIZE-ACTIVITY.

      *-- Begin: Read and display new TRANSACTION-TYPE field
       2210-READ-TRANSACTIONS.
           READ TRANSACTION-HISTORY
               AT END SET END-OF-TRANSACTIONS TO TRUE
           END-READ

           PERFORM UNTIL END-OF-TRANSACTIONS
               PERFORM 2215-WRITE-TRANSACTION-DETAIL
               READ TRANSACTION-HISTORY
                   AT END SET END-OF-TRANSACTIONS TO TRUE
               END-READ
           END-PERFORM.

       2215-WRITE-TRANSACTION-DETAIL.
           MOVE TRN-DATE           TO WS-TRAN-DATE
           MOVE TRN-TIME           TO WS-TRAN-TIME
           MOVE TRN-PORTFOLIO-ID   TO WS-TRAN-PORTFOLIO
           MOVE TRN-INVESTMENT-ID  TO WS-TRAN-INVESTMENT

      *-- Handle backward compatibility for TRANSACTION-TYPE
           IF TRN-TRANSACTION-TYPE = SPACES OR TRN-TRANSACTION-TYPE = LOW-VALUES
               MOVE TRN-TYPE TO WS-TRAN-TYPE
           ELSE
               MOVE TRN-TRANSACTION-TYPE TO WS-TRAN-TYPE
           END-IF

           MOVE TRN-QUANTITY       TO WS-TRAN-QUANTITY
           MOVE TRN-AMOUNT         TO WS-TRAN-AMOUNT

           WRITE REPORT-RECORD FROM WS-TRANSACTION-DETAIL.
      *-- End: Read and display new TRANSACTION-TYPE field

       2220-SUMMARIZE-ACTIVITY.
      * (existing logic unchanged)

       2300-WRITE-SUMMARY.
           PERFORM 2310-WRITE-TOTALS
           PERFORM 2320-WRITE-EXCEPTIONS
           PERFORM 2330-WRITE-METRICS.

       3000-CLEANUP.
           CLOSE POSITION-MASTER
                TRANSACTION-HISTORY
                REPORT-FILE.

       9999-ERROR-HANDLER.
           DISPLAY WS-ERROR-MESSAGE
           MOVE 12 TO RETURN-CODE
           GOBACK. 

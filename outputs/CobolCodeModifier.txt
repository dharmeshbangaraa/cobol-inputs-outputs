[File 1] TRNREC.CPY src/copybook/common/TRNREC.cpy

      *****************************************************************
      * TRANSACTION RECORD STRUCTURE
      * VERSION: 1.1
      * DATE: 2024
      *****************************************************************
       01  TRANSACTION-RECORD.
           05  TRN-KEY.
               10  TRN-DATE           PIC X(08).
               10  TRN-TIME           PIC X(06).
               10  TRN-PORTFOLIO-ID   PIC X(08).
               10  TRN-SEQUENCE-NO    PIC X(06).
           05  TRN-DATA.
               10  TRN-INVESTMENT-ID  PIC X(10).
               10  TRN-TYPE           PIC X(02).
                   88  TRN-TYPE-BUY     VALUE 'BU'.
                   88  TRN-TYPE-SELL    VALUE 'SL'.
                   88  TRN-TYPE-TRANS   VALUE 'TR'.
                   88  TRN-TYPE-FEE     VALUE 'FE'.
               10  TRN-QUANTITY       PIC S9(11)V9(4) COMP-3.
               10  TRN-PRICE         PIC S9(11)V9(4) COMP-3.
               10  TRN-AMOUNT        PIC S9(13)V9(2) COMP-3.
               10  TRN-CURRENCY      PIC X(03).
               10  TRN-STATUS        PIC X(01).
                   88  TRN-STATUS-PEND   VALUE 'P'.
                   88  TRN-STATUS-DONE   VALUE 'D'.
                   88  TRN-STATUS-FAIL   VALUE 'F'.
                   88  TRN-STATUS-REV    VALUE 'R'.
               10  TRN-CHANNEL-CODE   PIC X(04).    *-- Change: Added CHANNEL-CODE for channel identification
           05  TRN-AUDIT.
               10  TRN-PROCESS-DATE  PIC X(26).
               10  TRN-PROCESS-USER  PIC X(08).
           05  TRN-FILLER           PIC X(46).      *-- Change: Reduced filler size to accommodate CHANNEL-CODE
      *****************************************************************
      * FIELD DESCRIPTIONS:
      * TRN-DATE        : TRANSACTION DATE (YYYYMMDD)
      * TRN-TIME        : TRANSACTION TIME (HHMMSS)
      * TRN-PORTFOLIO-ID: PORTFOLIO IDENTIFIER
      * TRN-SEQUENCE-NO : SEQUENCE NUMBER FOR MULTIPLE TRANS
      * TRN-TYPE        : BU=BUY, SL=SELL, TR=TRANSFER, FE=FEE
      * TRN-STATUS      : P=PENDING, D=DONE, F=FAILED, R=REVERSED
      * TRN-CHANNEL-CODE: CHANNEL IDENTIFICATION (e.g., 'BRCH', 'ONLN', 'IVR', 'MOBL')
      *****************************************************************

[Summary Change Report]
- Added field `TRN-CHANNEL-CODE PIC X(04)` to transaction record for channel identification.
- Reduced TRN-FILLER by 4 bytes to maintain record length.
- Added inline comments for traceability.

[File 2] PORTTRAN.CBL src/programs/portfolio/PORTTRAN.cbl

      *================================================================*
      * Program Name: PORTTRAN
      * Description: Portfolio Transaction Processing
      * Author: [Author name]
      * Date Written: 2024-03-20
      *================================================================*
       IDENTIFICATION DIVISION.
       PROGRAM-ID. PORTTRAN.
       
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SOURCE-COMPUTER. IBM-ZOS.
       OBJECT-COMPUTER. IBM-ZOS.
       
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT TRANSACTION-FILE
               ASSIGN TO TRANFILE
               ORGANIZATION IS SEQUENTIAL
               ACCESS MODE IS SEQUENTIAL
               FILE STATUS IS WS-TRAN-STATUS.
               
           SELECT PORTFOLIO-FILE
               ASSIGN TO PORTFILE
               ORGANIZATION IS INDEXED
               ACCESS MODE IS RANDOM
               RECORD KEY IS PORT-ID
               FILE STATUS IS WS-PORT-STATUS.
       
       DATA DIVISION.
       FILE SECTION.
       FD  TRANSACTION-FILE
           RECORDING MODE IS F
           BLOCK CONTAINS 0 RECORDS.
       COPY TRNREC.
       
       FD  PORTFOLIO-FILE
           RECORDING MODE IS F
           BLOCK CONTAINS 0 RECORDS.
       COPY PORTREC.
       
       WORKING-STORAGE SECTION.
           COPY ERRHAND.
           COPY AUDITLOG.
           
       01  WS-FILE-STATUS.
           05  WS-TRAN-STATUS      PIC X(2).
           05  WS-PORT-STATUS      PIC X(2).
           
       01  WS-COUNTERS.
           05  WS-READ-COUNT       PIC 9(8) COMP.
           05  WS-PROCESS-COUNT    PIC 9(8) COMP.
           05  WS-ERROR-COUNT      PIC 9(8) COMP.
           
       01  WS-EOF-FLAG            PIC X(1).
           88  END-OF-FILE          VALUE 'Y'.
           88  MORE-RECORDS         VALUE 'N'.

       01  WS-DEFAULT-CHANNEL-CODE PIC X(04) VALUE 'BRCH'. *-- Change: Default channel code for legacy transactions
           
       PROCEDURE DIVISION.
       0000-MAIN.
           PERFORM 1000-INITIALIZE
           
           IF WS-TRAN-STATUS = '00'
               PERFORM 2000-PROCESS-TRANSACTIONS
                   UNTIL END-OF-FILE
                   OR WS-ERROR-COUNT > 100
           END-IF
           
           PERFORM 3000-TERMINATE
           
           GOBACK
           .
           
       1000-INITIALIZE.
           INITIALIZE WS-FILE-STATUS
                      WS-COUNTERS
           SET MORE-RECORDS TO TRUE
           
           OPEN INPUT TRANSACTION-FILE
           IF WS-TRAN-STATUS NOT = '00'
               MOVE 'Error opening transaction file' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           
           OPEN I-O PORTFOLIO-FILE
           IF WS-PORT-STATUS NOT = '00'
               MOVE 'Error opening portfolio file' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           .
           
       2000-PROCESS-TRANSACTIONS.
           READ TRANSACTION-FILE
               AT END
                   SET END-OF-FILE TO TRUE
               NOT AT END
                   ADD 1 TO WS-READ-COUNT
                   PERFORM 2100-VALIDATE-TRANSACTION
           END-READ
           .
           
       2100-VALIDATE-TRANSACTION.
           MOVE SPACES TO ERR-TEXT

      *-- Change: Validate CHANNEL-CODE is present and valid
           IF TRN-CHANNEL-CODE = SPACES OR TRN-CHANNEL-CODE = LOW-VALUES
               MOVE WS-DEFAULT-CHANNEL-CODE TO TRN-CHANNEL-CODE
               *-- Change: Defaulted missing CHANNEL-CODE to 'BRCH'
           END-IF

           IF TRN-CHANNEL-CODE NOT = 'BRCH'
              AND TRN-CHANNEL-CODE NOT = 'ONLN'
              AND TRN-CHANNEL-CODE NOT = 'IVR'
              AND TRN-CHANNEL-CODE NOT = 'MOBL'
               MOVE 'Invalid Channel Code' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
               EXIT PARAGRAPH
           END-IF

           PERFORM 2110-CHECK-PORTFOLIO
           IF ERR-TEXT = SPACES
               PERFORM 2120-CHECK-TRANSACTION-TYPE
           END-IF
           IF ERR-TEXT = SPACES
               PERFORM 2130-CHECK-AMOUNTS
           END-IF
           
           IF ERR-TEXT = SPACES
               ADD 1 TO WS-PROCESS-COUNT
           ELSE
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           .
           
       2110-CHECK-PORTFOLIO.
           IF TRN-PORTFOLIO-ID = SPACES
               MOVE 'Portfolio ID is required' TO ERR-TEXT
               EXIT PARAGRAPH
           END-IF
           
           MOVE TRN-PORTFOLIO-ID TO PORT-ID
           READ PORTFOLIO-FILE
               INVALID KEY
                   STRING 'Invalid Portfolio ID: '
                          TRN-PORTFOLIO-ID
                     DELIMITED BY SIZE
                     INTO ERR-TEXT
           END-READ
           .
           
       2120-CHECK-TRANSACTION-TYPE.
           EVALUATE TRN-TYPE
               WHEN 'BU'
               WHEN 'SL'
               WHEN 'TR'
               WHEN 'FE'
                   CONTINUE
               WHEN OTHER
                   STRING 'Invalid Transaction Type: '
                          TRN-TYPE
                     DELIMITED BY SIZE
                     INTO ERR-TEXT
           END-EVALUATE
           .
           
       2130-CHECK-AMOUNTS.
           IF TRN-QUANTITY <= ZERO
               MOVE 'Quantity must be greater than zero' TO ERR-TEXT
               EXIT PARAGRAPH
           END-IF
           
           IF TRN-PRICE <= ZERO AND TRN-TYPE NOT = 'TR'
               MOVE 'Price must be greater than zero' TO ERR-TEXT
               EXIT PARAGRAPH
           END-IF
           
           IF TRN-AMOUNT <= ZERO AND TRN-TYPE NOT = 'TR'
               MOVE 'Amount must be greater than zero' TO ERR-TEXT
           END-IF
           .
           
       2200-UPDATE-POSITIONS.
           EVALUATE TRN-TYPE
               WHEN 'BU'
                   PERFORM 2210-PROCESS-BUY
               WHEN 'SL'
                   PERFORM 2220-PROCESS-SELL
               WHEN 'TR'
                   PERFORM 2230-PROCESS-TRANSFER
               WHEN 'FE'
                   PERFORM 2240-PROCESS-FEE
           END-EVALUATE
           
           PERFORM 2300-UPDATE-AUDIT-TRAIL
           .
           
       2210-PROCESS-BUY.
           MOVE TRN-PORTFOLIO-ID TO PORT-ID
           READ PORTFOLIO-FILE
               INVALID KEY
                   MOVE 'Portfolio not found for update' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
                   EXIT PARAGRAPH
           END-READ
           
           ADD TRN-QUANTITY TO PORT-TOTAL-UNITS
           ADD TRN-AMOUNT   TO PORT-TOTAL-COST
           
           REWRITE PORTFOLIO-RECORD
               INVALID KEY
                   MOVE 'Error updating portfolio' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-REWRITE
           .
           
       2220-PROCESS-SELL.
           MOVE TRN-PORTFOLIO-ID TO PORT-ID
           READ PORTFOLIO-FILE
               INVALID KEY
                   MOVE 'Portfolio not found for update' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
                   EXIT PARAGRAPH
           END-READ
           
           IF PORT-TOTAL-UNITS < TRN-QUANTITY
               MOVE 'Insufficient units for sale' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
               EXIT PARAGRAPH
           END-IF
           
           SUBTRACT TRN-QUANTITY FROM PORT-TOTAL-UNITS
           SUBTRACT TRN-AMOUNT   FROM PORT-TOTAL-COST
           
           REWRITE PORTFOLIO-RECORD
               INVALID KEY
                   MOVE 'Error updating portfolio' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-REWRITE
           .
           
       2230-PROCESS-TRANSFER.
           MOVE 'Transfer processing not implemented' TO ERR-TEXT
           PERFORM 9000-ERROR-ROUTINE
           .
           
       2240-PROCESS-FEE.
           MOVE TRN-PORTFOLIO-ID TO PORT-ID
           READ PORTFOLIO-FILE
               INVALID KEY
                   MOVE 'Portfolio not found for fee' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
                   EXIT PARAGRAPH
           END-READ
           
           SUBTRACT TRN-AMOUNT FROM PORT-TOTAL-COST
           
           REWRITE PORTFOLIO-RECORD
               INVALID KEY
                   MOVE 'Error updating portfolio' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-REWRITE
           .
           
       2300-UPDATE-AUDIT-TRAIL.
           INITIALIZE AUDIT-RECORD
           
           MOVE FUNCTION CURRENT-DATE TO AUD-TIMESTAMP
           MOVE 'PORTTRAN'     TO AUD-PROGRAM
           MOVE FUNCTION USER-ID TO AUD-USER-ID
           MOVE 'TRAN'         TO AUD-TYPE

      *-- Change: Include CHANNEL-CODE in audit message for traceability
           STRING 'Channel: ' DELIMITED BY SIZE
                  TRN-CHANNEL-CODE DELIMITED BY SIZE
                  ' ' DELIMITED BY SIZE
                  INTO AUD-MESSAGE WITH POINTER 1

           EVALUATE TRN-TYPE
               WHEN 'BU'
                   MOVE 'CREATE  ' TO AUD-ACTION
               WHEN 'SL'
                   MOVE 'DELETE  ' TO AUD-ACTION
               WHEN 'TR'
                   MOVE 'UPDATE  ' TO AUD-ACTION
               WHEN 'FE'
                   MOVE 'UPDATE  ' TO AUD-ACTION
           END-EVALUATE
           
           IF WS-PORT-STATUS = '00'
               MOVE 'SUCC'     TO AUD-STATUS
           ELSE
               MOVE 'FAIL'     TO AUD-STATUS
           END-IF
           
           MOVE TRN-PORTFOLIO-ID TO AUD-PORTFOLIO-ID
           MOVE PORT-ACCOUNT-NO  TO AUD-ACCOUNT-NO
           
      *    Store original portfolio state
           MOVE PORT-RECORD      TO AUD-BEFORE-IMAGE
           
      *    Build audit message
           STRING 'Transaction: ' DELIMITED BY SIZE
                  TRN-TYPE       DELIMITED BY SIZE
                  ' Amount: '    DELIMITED BY SIZE
                  TRN-AMOUNT     DELIMITED BY SIZE
                  ' Units: '     DELIMITED BY SIZE
                  TRN-QUANTITY   DELIMITED BY SIZE
                  ' Channel: '   DELIMITED BY SIZE
                  TRN-CHANNEL-CODE DELIMITED BY SIZE
             INTO AUD-MESSAGE
           
           PERFORM 2310-WRITE-AUDIT-RECORD
           .
           
       2310-WRITE-AUDIT-RECORD.
      *    Call the audit processor
           CALL 'AUDPROC' USING AUDIT-RECORD
           
           IF RETURN-CODE NOT = ZERO
               MOVE 'Error writing audit record' TO ERR-TEXT
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           .
           
       3000-TERMINATE.
           CLOSE TRANSACTION-FILE
                 PORTFOLIO-FILE
                 
           DISPLAY 'Transactions Read:    ' WS-READ-COUNT
           DISPLAY 'Transactions Process: ' WS-PROCESS-COUNT
           DISPLAY 'Errors Encountered:   ' WS-ERROR-COUNT
           .
           
       9000-ERROR-ROUTINE.
           ADD 1 TO WS-ERROR-COUNT
           MOVE ERR-CAT-PROC TO ERR-CATEGORY
           MOVE 'PORTTRAN' TO ERR-PROGRAM
           
           CALL 'ERRPROC' USING ERR-MESSAGE
           .

[Summary Change Report]
- Added validation and defaulting for `TRN-CHANNEL-CODE` in 2100-VALIDATE-TRANSACTION.
- Updated audit logic to include `TRN-CHANNEL-CODE` in audit trail.
- Added WS-DEFAULT-CHANNEL-CODE for legacy/missing channel code.
- Inline comments added for all changes.

[File 3] RPTAUD00.CBL src/programs/batch/RPTAUD00.cbl

       IDENTIFICATION DIVISION.
       PROGRAM-ID. RPTAUD00.
       AUTHOR. CLAUDE.
       DATE-WRITTEN. 2024-04-09.
      *****************************************************************
      * Audit Report Generator                                         *
      *                                                               *
      * Generates comprehensive audit report including:                *
      * - Security audit trails                                       *
      * - Process audit reporting                                     *
      * - Error summary reporting                                     *
      * - Control verification                                        *
      *****************************************************************
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT AUDIT-FILE ASSIGN TO AUDITLOG
               ORGANIZATION IS INDEXED
               ACCESS MODE IS SEQUENTIAL
               RECORD KEY IS AUD-KEY
               FILE STATUS IS WS-AUDIT-STATUS.

           SELECT ERROR-FILE ASSIGN TO ERRLOG
               ORGANIZATION IS INDEXED
               ACCESS MODE IS SEQUENTIAL
               RECORD KEY IS ERR-KEY
               FILE STATUS IS WS-ERROR-STATUS.

           SELECT REPORT-FILE ASSIGN TO RPTFILE
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-REPORT-STATUS.

       DATA DIVISION.
       FILE SECTION.
           COPY AUDITLOG.
           COPY ERRHAND.
           
       FD  REPORT-FILE
           RECORDING MODE IS F
           BLOCK CONTAINS 0 RECORDS.
       01  REPORT-RECORD             PIC X(132).

       WORKING-STORAGE SECTION.
           COPY RTNCODE.

       01  WS-FILE-STATUS.
           05  WS-AUDIT-STATUS       PIC XX.
           05  WS-ERROR-STATUS       PIC XX.
           05  WS-REPORT-STATUS      PIC XX.

       01  WS-REPORT-HEADERS.
           05  WS-HEADER1.
               10  FILLER            PIC X(132) VALUE ALL '*'.
           05  WS-HEADER2.
               10  FILLER            PIC X(40) VALUE SPACES.
               10  FILLER            PIC X(52) 
                   VALUE 'SYSTEM AUDIT REPORT'.
               10  FILLER            PIC X(40) VALUE SPACES.
           05  WS-HEADER3.
               10  FILLER            PIC X(15) VALUE 'REPORT DATE:'.
               10  WS-REPORT-DATE    PIC X(10).
               10  FILLER            PIC X(107) VALUE SPACES.

       01  WS-AUDIT-DETAIL.
           05  WS-AUD-TIMESTAMP     PIC X(26).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-AUD-PROGRAM       PIC X(8).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-AUD-TYPE          PIC X(10).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-AUD-CHANNEL-CODE  PIC X(04).      *-- Change: Added CHANNEL-CODE to report detail
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-AUD-MESSAGE       PIC X(74).      *-- Change: Reduced message length to fit channel code

       01  WS-ERROR-DETAIL.
           05  WS-ERR-TIMESTAMP     PIC X(26).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-ERR-PROGRAM       PIC X(8).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-ERR-CODE          PIC X(4).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-ERR-MESSAGE       PIC X(80).

       PROCEDURE DIVISION.
       0000-MAIN.
           PERFORM 1000-INITIALIZE
           PERFORM 2000-PROCESS-REPORT
           PERFORM 3000-CLEANUP
           GOBACK.

       1000-INITIALIZE.
           PERFORM 1100-OPEN-FILES
           PERFORM 1200-WRITE-HEADERS.

       1100-OPEN-FILES.
           OPEN INPUT AUDIT-FILE
           IF WS-AUDIT-STATUS NOT = '00'
               MOVE 'ERROR OPENING AUDIT FILE'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF

           OPEN INPUT ERROR-FILE
           IF WS-ERROR-STATUS NOT = '00'
               MOVE 'ERROR OPENING ERROR FILE'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF

           OPEN OUTPUT REPORT-FILE
           IF WS-REPORT-STATUS NOT = '00'
               MOVE 'ERROR OPENING REPORT FILE'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF.

       1200-WRITE-HEADERS.
           ACCEPT WS-REPORT-DATE FROM DATE
           WRITE REPORT-RECORD FROM WS-HEADER1
           WRITE REPORT-RECORD FROM WS-HEADER2
           WRITE REPORT-RECORD FROM WS-HEADER3.

       2000-PROCESS-REPORT.
           PERFORM 2100-PROCESS-AUDIT-TRAIL
           PERFORM 2200-PROCESS-ERROR-LOG
           PERFORM 2300-WRITE-SUMMARY.

       2100-PROCESS-AUDIT-TRAIL.
           PERFORM 2110-READ-AUDIT-RECORDS
           PERFORM 2120-SUMMARIZE-AUDIT.

      *-- Change: When writing audit details, include CHANNEL-CODE in output
       2110-READ-AUDIT-RECORDS.
           PERFORM UNTIL WS-AUDIT-STATUS = '10'
               READ AUDIT-FILE NEXT
                   AT END
                       EXIT PERFORM
                   NOT AT END
                       MOVE AUD-TIMESTAMP TO WS-AUD-TIMESTAMP
                       MOVE AUD-PROGRAM   TO WS-AUD-PROGRAM
                       MOVE AUD-TYPE      TO WS-AUD-TYPE
                       MOVE AUD-MESSAGE   TO WS-AUD-MESSAGE
                       IF AUD-CHANNEL-CODE NOT = SPACES
                           MOVE AUD-CHANNEL-CODE TO WS-AUD-CHANNEL-CODE
                       ELSE
                           MOVE '    ' TO WS-AUD-CHANNEL-CODE
                       END-IF
                       WRITE REPORT-RECORD FROM WS-AUDIT-DETAIL
               END-READ
           END-PERFORM.

       2200-PROCESS-ERROR-LOG.
           PERFORM 2210-READ-ERROR-RECORDS
           PERFORM 2220-SUMMARIZE-ERRORS.

       2300-WRITE-SUMMARY.
           PERFORM 2310-WRITE-AUDIT-SUMMARY
           PERFORM 2320-WRITE-ERROR-SUMMARY
           PERFORM 2330-WRITE-CONTROL-SUMMARY.

       3000-CLEANUP.
           CLOSE AUDIT-FILE
                ERROR-FILE
                REPORT-FILE.

       9999-ERROR-HANDLER.
           DISPLAY WS-ERROR-MESSAGE
           MOVE 12 TO RETURN-CODE
           GOBACK.

[Summary Change Report]
- Added CHANNEL-CODE to audit report output (WS-AUDIT-DETAIL).
- Modified logic to extract and display CHANNEL-CODE if present.
- Adjusted message length accordingly.
- Inline comments for all changes.

[File 4] TSTGEN00.CBL src/programs/test/TSTGEN00.cbl

       IDENTIFICATION DIVISION.
       PROGRAM-ID. TSTGEN00.
       AUTHOR. CLAUDE.
       DATE-WRITTEN. 2024-04-09.
      *****************************************************************
      * Test Data Generator                                           *
      *                                                               *
      * Generates test data for system testing:                      *
      * - Portfolio test data                                        *
      * - Transaction test scenarios                                 *
      * - Error condition data                                       *
      * - Performance test volumes                                   *
      *****************************************************************
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SPECIAL-NAMES.
           CONSOLE IS CONS.
           
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT TEST-CONFIG ASSIGN TO TSTCFG
               ORGANIZATION IS SEQUENTIAL
               ACCESS MODE IS SEQUENTIAL
               FILE STATUS IS WS-CFG-STATUS.

           SELECT PORTFOLIO-OUT ASSIGN TO PORTOUT
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-PORT-STATUS.

           SELECT TRANSACTION-OUT ASSIGN TO TRANOUT
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-TRAN-STATUS.

           SELECT RANDOM-SEED ASSIGN TO RANDSEED
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-RAND-STATUS.

       DATA DIVISION.
       FILE SECTION.
       FD  TEST-CONFIG
           RECORDING MODE IS F
           BLOCK CONTAINS 0 RECORDS.
       01  CONFIG-RECORD.
           05  CFG-TEST-TYPE        PIC X(10).
           05  CFG-VOLUME           PIC 9(6).
           05  CFG-PARAMETERS       PIC X(64).

       FD  PORTFOLIO-OUT
           RECORDING MODE IS F
           BLOCK CONTAINS 0 RECORDS.
       01  PORTFOLIO-RECORD.
           COPY PORTFLIO REPLACING ==:PREFIX:== BY ==PORT==.

       FD  TRANSACTION-OUT
           RECORDING MODE IS F
           BLOCK CONTAINS 0 RECORDS.
       01  TRANSACTION-RECORD.
           COPY TRNREC REPLACING ==:PREFIX:== BY ==TRAN==.

       FD  RANDOM-SEED
           RECORDING MODE IS F
           BLOCK CONTAINS 0 RECORDS.
       01  SEED-RECORD             PIC 9(9).

       WORKING-STORAGE SECTION.
           COPY RTNCODE.
           COPY ERRHAND.

       01  WS-FILE-STATUS.
           05  WS-CFG-STATUS        PIC XX.
           05  WS-PORT-STATUS       PIC XX.
           05  WS-TRAN-STATUS       PIC XX.
           05  WS-RAND-STATUS       PIC XX.

       01  WS-TEST-TYPES.
           05  WS-PORTFOLIO         PIC X(10) VALUE 'PORTFOLIO'.
           05  WS-TRANSACTION       PIC X(10) VALUE 'TRANSACTN'.
           05  WS-ERROR-TEST        PIC X(10) VALUE 'ERROR'.
           05  WS-VOLUME-TEST       PIC X(10) VALUE 'VOLUME'.

       01  WS-PROCESSING-FLAGS.
           05  WS-END-OF-CONFIG     PIC X VALUE 'N'.
               88  END-OF-CONFIG    VALUE 'Y'.

       01  WS-COUNTERS.
           05  WS-RECORDS-WRITTEN   PIC 9(9) VALUE ZERO.
           05  WS-ERROR-COUNT       PIC 9(9) VALUE ZERO.

       01  WS-RANDOM-VALUES.
           05  WS-RANDOM-SEED       PIC 9(9).
           05  WS-RANDOM-NUM        PIC 9(9).
           05  WS-RANDOM-DECIMAL    PIC 9(9)V99.

       01  WS-PORTFOLIO-DATA.
           05  WS-PORT-ID           PIC X(10).
           05  WS-PORT-NAME         PIC X(30).
           05  WS-PORT-TYPE         PIC X(2).
           05  WS-PORT-STATUS       PIC X(1).
           05  WS-PORT-BALANCE      PIC 9(15)V99.

       01  WS-TRANSACTION-DATA.
           05  WS-TRAN-ID           PIC X(12).
           05  WS-TRAN-TYPE         PIC X(2).
           05  WS-TRAN-AMOUNT       PIC 9(15)V99.
           05  WS-TRAN-DATE         PIC X(8).
           05  WS-TRAN-STATUS       PIC X(1).
           05  WS-TRAN-CHANNEL-CODE PIC X(04). *-- Change: Added for test data generation

       PROCEDURE DIVISION.
       0000-MAIN.
           PERFORM 1000-INITIALIZE
           PERFORM 2000-PROCESS
           PERFORM 3000-CLEANUP
           GOBACK.

       1000-INITIALIZE.
           PERFORM 1100-OPEN-FILES
           PERFORM 1200-INIT-RANDOM
           PERFORM 1300-INIT-COUNTERS.

       1100-OPEN-FILES.
           OPEN INPUT TEST-CONFIG
           IF WS-CFG-STATUS NOT = '00'
               MOVE 'ERROR OPENING CONFIG FILE'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF

           OPEN OUTPUT PORTFOLIO-OUT
           IF WS-PORT-STATUS NOT = '00'
               MOVE 'ERROR OPENING PORTFOLIO OUTPUT'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF

           OPEN OUTPUT TRANSACTION-OUT
           IF WS-TRAN-STATUS NOT = '00'
               MOVE 'ERROR OPENING TRANSACTION OUTPUT'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF

           OPEN INPUT RANDOM-SEED
           IF WS-RAND-STATUS NOT = '00'
               MOVE 'ERROR OPENING RANDOM SEED'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF.

       1200-INIT-RANDOM.
           READ RANDOM-SEED
           MOVE SEED-RECORD TO WS-RANDOM-SEED.

       1300-INIT-COUNTERS.
           INITIALIZE WS-COUNTERS.

       2000-PROCESS.
           PERFORM UNTIL END-OF-CONFIG
               READ TEST-CONFIG
                   AT END
                       SET END-OF-CONFIG TO TRUE
                   NOT AT END
                       PERFORM 2100-GENERATE-TEST-DATA
               END-READ
           END-PERFORM.

       2100-GENERATE-TEST-DATA.
           EVALUATE CFG-TEST-TYPE
               WHEN WS-PORTFOLIO
                   PERFORM 2200-GEN-PORTFOLIO
               WHEN WS-TRANSACTION
                   PERFORM 2300-GEN-TRANSACTION
               WHEN WS-ERROR-TEST
                   PERFORM 2400-GEN-ERROR-DATA
               WHEN WS-VOLUME-TEST
                   PERFORM 2500-GEN-VOLUME-DATA
               WHEN OTHER
                   MOVE 'INVALID TEST TYPE'
                     TO WS-ERROR-MESSAGE
                   PERFORM 9999-ERROR-HANDLER
           END-EVALUATE.

       2200-GEN-PORTFOLIO.
           PERFORM VARYING WS-RECORDS-WRITTEN FROM 1 BY 1
                   UNTIL WS-RECORDS-WRITTEN > CFG-VOLUME
               PERFORM 2210-GEN-PORT-DATA
               PERFORM 2220-WRITE-PORT-RECORD
           END-PERFORM.

       2300-GEN-TRANSACTION.
           PERFORM VARYING WS-RECORDS-WRITTEN FROM 1 BY 1
                   UNTIL WS-RECORDS-WRITTEN > CFG-VOLUME
               PERFORM 2310-GEN-TRAN-DATA
               PERFORM 2320-WRITE-TRAN-RECORD
           END-PERFORM.

      *-- Change: Populate CHANNEL-CODE for test transactions
       2310-GEN-TRAN-DATA.
           MOVE FUNCTION RANDOM(1 4) TO WS-RANDOM-NUM
           EVALUATE WS-RANDOM-NUM
               WHEN 1
                   MOVE 'BRCH' TO WS-TRAN-CHANNEL-CODE
               WHEN 2
                   MOVE 'ONLN' TO WS-TRAN-CHANNEL-CODE
               WHEN 3
                   MOVE 'IVR ' TO WS-TRAN-CHANNEL-CODE
               WHEN 4
                   MOVE 'MOBL' TO WS-TRAN-CHANNEL-CODE
               WHEN OTHER
                   MOVE 'BRCH' TO WS-TRAN-CHANNEL-CODE
           END-EVALUATE

       2320-WRITE-TRAN-RECORD.
           MOVE WS-TRAN-CHANNEL-CODE TO TRAN-CHANNEL-CODE *-- Change: Assign generated channel code
           WRITE TRANSACTION-RECORD.

       2400-GEN-ERROR-DATA.
           PERFORM 2410-GEN-DATA-ERRORS
           PERFORM 2420-GEN-PROCESS-ERRORS.

       2500-GEN-VOLUME-DATA.
           PERFORM 2510-GEN-LARGE-PORTFOLIO
           PERFORM 2520-GEN-LARGE-TRANSACTION.

       3000-CLEANUP.
           CLOSE TEST-CONFIG
                PORTFOLIO-OUT
                TRANSACTION-OUT
                RANDOM-SEED.

       9999-ERROR-HANDLER.
           ADD 1 TO WS-ERROR-COUNT
           DISPLAY WS-ERROR-MESSAGE UPON CONS
           IF WS-ERROR-COUNT > 100
               MOVE 12 TO RETURN-CODE
               GOBACK
           END-IF.

[Summary Change Report]
- Added WS-TRAN-CHANNEL-CODE to working-storage and test data logic.
- Populated TRAN-CHANNEL-CODE with valid values during test data generation.
- Wrote value to output record.
- Inline comments for all changes.

[File 5] UTLVAL00.CBL src/programs/utility/UTLVAL00.cbl

       IDENTIFICATION DIVISION.
       PROGRAM-ID. UTLVAL00.
       AUTHOR. CLAUDE.
       DATE-WRITTEN. 2024-04-09.
      *****************************************************************
      * Data Validation Utility                                        *
      *                                                               *
      * Performs comprehensive data validation:                       *
      * - Data integrity checks                                      *
      * - Cross-reference validation                                 *
      * - Format verification                                        *
      * - Balance reconciliation                                     *
      *****************************************************************
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SPECIAL-NAMES.
           CONSOLE IS CONS.
           
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT VALIDATION-CONTROL ASSIGN TO VALCTL
               ORGANIZATION IS SEQUENTIAL
               ACCESS MODE IS SEQUENTIAL
               FILE STATUS IS WS-VAL-STATUS.

           SELECT POSITION-MASTER ASSIGN TO POSMSTRE
               ORGANIZATION IS INDEXED
               ACCESS MODE IS DYNAMIC
               RECORD KEY IS POS-KEY
               FILE STATUS IS WS-POS-STATUS.

           SELECT TRANSACTION-HISTORY ASSIGN TO TRANHIST
               ORGANIZATION IS INDEXED
               ACCESS MODE IS DYNAMIC
               RECORD KEY IS TRAN-KEY
               FILE STATUS IS WS-TRAN-STATUS.

           SELECT ERROR-REPORT ASSIGN TO ERRRPT
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-RPT-STATUS.

       DATA DIVISION.
       FILE SECTION.
           COPY POSREC.
           COPY TRNREC.
           
       FD  VALIDATION-CONTROL
           RECORDING MODE IS F
           BLOCK CONTAINS 0 RECORDS.
       01  VALIDATION-RECORD.
           05  VAL-TYPE             PIC X(10).
           05  VAL-PARAMETERS       PIC X(70).

       FD  ERROR-REPORT
           RECORDING MODE IS F
           BLOCK CONTAINS 0 RECORDS.
       01  ERROR-RECORD            PIC X(132).

       WORKING-STORAGE SECTION.
           COPY RTNCODE.
           COPY ERRHAND.

       01  WS-FILE-STATUS.
           05  WS-VAL-STATUS        PIC XX.
           05  WS-POS-STATUS        PIC XX.
           05  WS-TRAN-STATUS       PIC XX.
           05  WS-RPT-STATUS        PIC XX.

       01  WS-VALIDATION-TYPES.
           05  WS-INTEGRITY         PIC X(10) VALUE 'INTEGRITY'.
           05  WS-XREF              PIC X(10) VALUE 'XREF'.
           05  WS-FORMAT            PIC X(10) VALUE 'FORMAT'.
           05  WS-BALANCE           PIC X(10) VALUE 'BALANCE'.

       01  WS-PROCESSING-FLAGS.
           05  WS-END-OF-VAL        PIC X VALUE 'N'.
               88  END-OF-VALIDATION VALUE 'Y'.
           05  WS-ERROR-FOUND       PIC X VALUE 'N'.
               88  ERROR-FOUND      VALUE 'Y'.

       01  WS-VALIDATION-TOTALS.
           05  WS-RECORDS-READ      PIC 9(9) VALUE ZERO.
           05  WS-RECORDS-VALID     PIC 9(9) VALUE ZERO.
           05  WS-RECORDS-ERROR     PIC 9(9) VALUE ZERO.
           05  WS-TOTAL-AMOUNT      PIC S9(15)V99 VALUE ZERO.
           05  WS-CONTROL-TOTAL     PIC S9(15)V99 VALUE ZERO.

       01  WS-ERROR-LINE.
           05  WS-ERR-TYPE          PIC X(10).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-ERR-KEY           PIC X(20).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-ERR-DESC          PIC X(98).

       PROCEDURE DIVISION.
       0000-MAIN.
           PERFORM 1000-INITIALIZE
           PERFORM 2000-PROCESS
           PERFORM 3000-CLEANUP
           GOBACK.

       1000-INITIALIZE.
           PERFORM 1100-OPEN-FILES
           PERFORM 1200-INIT-PROCESSING.

       1100-OPEN-FILES.
           OPEN INPUT VALIDATION-CONTROL
           IF WS-VAL-STATUS NOT = '00'
               MOVE 'ERROR OPENING VALIDATION CONTROL'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF

           OPEN INPUT POSITION-MASTER
           IF WS-POS-STATUS NOT = '00'
               MOVE 'ERROR OPENING POSITION MASTER'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF

           OPEN INPUT TRANSACTION-HISTORY
           IF WS-TRAN-STATUS NOT = '00'
               MOVE 'ERROR OPENING TRANSACTION HISTORY'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF

           OPEN OUTPUT ERROR-REPORT
           IF WS-RPT-STATUS NOT = '00'
               MOVE 'ERROR OPENING ERROR REPORT'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF.

       1200-INIT-PROCESSING.
           INITIALIZE WS-VALIDATION-TOTALS.

       2000-PROCESS.
           PERFORM UNTIL END-OF-VALIDATION
               READ VALIDATION-CONTROL
                   AT END
                       SET END-OF-VALIDATION TO TRUE
                   NOT AT END
                       PERFORM 2100-PROCESS-VALIDATION
               END-READ
           END-PERFORM.

       2100-PROCESS-VALIDATION.
           EVALUATE VAL-TYPE
               WHEN WS-INTEGRITY
                   PERFORM 2200-CHECK-INTEGRITY
               WHEN WS-XREF
                   PERFORM 2300-CHECK-XREF
               WHEN WS-FORMAT
                   PERFORM 2400-CHECK-FORMAT
               WHEN WS-BALANCE
                   PERFORM 2500-CHECK-BALANCE
               WHEN OTHER
                   MOVE 'INVALID VALIDATION TYPE'
                     TO WS-ERROR-MESSAGE
                   PERFORM 9999-ERROR-HANDLER
           END-EVALUATE.

       2200-CHECK-INTEGRITY.
           PERFORM 2210-CHECK-POSITION-INTEGRITY
           PERFORM 2220-CHECK-TRANSACTION-INTEGRITY.

      *-- Change: Validate CHANNEL-CODE in transaction integrity check
       2220-CHECK-TRANSACTION-INTEGRITY.
           IF TRN-CHANNEL-CODE = SPACES OR TRN-CHANNEL-CODE = LOW-VALUES
               MOVE 'Missing Channel Code' TO WS-ERR-DESC
               WRITE ERROR-RECORD FROM WS-ERROR-LINE
           ELSE
               IF TRN-CHANNEL-CODE NOT = 'BRCH'
                  AND TRN-CHANNEL-CODE NOT = 'ONLN'
                  AND TRN-CHANNEL-CODE NOT = 'IVR '
                  AND TRN-CHANNEL-CODE NOT = 'MOBL'
                   MOVE 'Invalid Channel Code' TO WS-ERR-DESC
                   WRITE ERROR-RECORD FROM WS-ERROR-LINE
               END-IF
           END-IF

       2300-CHECK-XREF.
           PERFORM 2310-CHECK-POSITION-XREF
           PERFORM 2320-CHECK-TRANSACTION-XREF.

       2400-CHECK-FORMAT.
           PERFORM 2410-CHECK-POSITION-FORMAT
           PERFORM 2420-CHECK-TRANSACTION-FORMAT.

       2500-CHECK-BALANCE.
           PERFORM 2510-ACCUMULATE-POSITIONS
           PERFORM 2520-VERIFY-BALANCES.

       3000-CLEANUP.
           CLOSE VALIDATION-CONTROL
                POSITION-MASTER
                TRANSACTION-HISTORY
                ERROR-REPORT.

       9999-ERROR-HANDLER.
           ADD 1 TO WS-RECORDS-ERROR
           SET ERROR-FOUND TO TRUE
           MOVE WS-ERROR-MESSAGE TO WS-ERR-DESC
           WRITE ERROR-RECORD FROM WS-ERROR-LINE.

[Summary Change Report]
- Added validation for presence and correctness of CHANNEL-CODE in transaction records.
- Wrote error to report if missing or invalid.
- Inline comments for traceability.

[File 6] POSREC.CPY src/copybook/common/POSREC.cpy

      *****************************************************************
      * POSITION RECORD STRUCTURE
      * VERSION: 1.1
      * DATE: 2024
      *****************************************************************
       01  POSITION-RECORD.
           05  POS-KEY.
               10  POS-PORTFOLIO-ID   PIC X(08).
               10  POS-DATE           PIC X(08).
               10  POS-INVESTMENT-ID  PIC X(10).
               10  POS-CHANNEL-CODE   PIC X(04).    *-- Change: Added CHANNEL-CODE for reporting/validation
           05  POS-DATA.
               10  POS-QUANTITY       PIC S9(11)V9(4) COMP-3.
               10  POS-COST-BASIS     PIC S9(13)V9(2) COMP-3.
               10  POS-MARKET-VALUE   PIC S9(13)V9(2) COMP-3.
               10  POS-CURRENCY       PIC X(03).
               10  POS-STATUS         PIC X(01).
                   88  POS-STATUS-ACTIVE  VALUE 'A'.
                   88  POS-STATUS-CLOSED  VALUE 'C'.
                   88  POS-STATUS-PEND    VALUE 'P'.
           05  POS-AUDIT.
               10  POS-LAST-MAINT-DATE   PIC X(26).
               10  POS-LAST-MAINT-USER   PIC X(08).
           05  POS-FILLER               PIC X(46).  *-- Change: Reduced filler to accommodate CHANNEL-CODE
      *****************************************************************
      * FIELD DESCRIPTIONS:
      * POS-PORTFOLIO-ID : PORTFOLIO IDENTIFIER
      * POS-DATE         : POSITION DATE (YYYYMMDD)
      * POS-INVESTMENT-ID: INVESTMENT IDENTIFIER
      * POS-CHANNEL-CODE : CHANNEL IDENTIFICATION (e.g., 'BRCH', 'ONLN', 'IVR', 'MOBL')
      * POS-QUANTITY     : HOLDING QUANTITY
      * POS-COST-BASIS   : TOTAL COST BASIS
      * POS-MARKET-VALUE : CURRENT MARKET VALUE
      * POS-STATUS       : A=ACTIVE, C=CLOSED, P=PENDING
      ***************************************************************** 

[Summary Change Report]
- Added field POS-CHANNEL-CODE PIC X(04) to position record for channel identification.
- Reduced POS-FILLER by 4 bytes to maintain record length.
- Inline comments for traceability.

[File 7] UTLMNT00.CBL src/programs/utility/UTLMNT00.cbl

       IDENTIFICATION DIVISION.
       PROGRAM-ID. UTLMNT00.
       AUTHOR. CLAUDE.
       DATE-WRITTEN. 2024-04-09.
      *****************************************************************
      * File Maintenance Utility                                       *
      *                                                               *
      * Performs maintenance operations on system files:              *
      * - Archive processing                                         *
      * - File cleanup                                               *
      * - VSAM reorganization                                        *
      * - Space management                                           *
      *****************************************************************
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SPECIAL-NAMES.
           CONSOLE IS CONS.
           
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT CONTROL-FILE ASSIGN TO CTLFILE
               ORGANIZATION IS SEQUENTIAL
               ACCESS MODE IS SEQUENTIAL
               FILE STATUS IS WS-CTL-STATUS.

           SELECT ARCHIVE-FILE ASSIGN TO ARCHFILE
               ORGANIZATION IS SEQUENTIAL
               ACCESS MODE IS SEQUENTIAL
               FILE STATUS IS WS-ARCH-STATUS.

           SELECT REPORT-FILE ASSIGN TO RPTFILE
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-REPORT-STATUS.

       DATA DIVISION.
       FILE SECTION.
       FD  CONTROL-FILE
           RECORDING MODE IS F
           BLOCK CONTAINS 0 RECORDS.
       01  CONTROL-RECORD.
           05  CTL-FUNCTION         PIC X(8).
           05  CTL-FILE-NAME        PIC X(44).
           05  CTL-PARAMETERS       PIC X(100).

       FD  ARCHIVE-FILE
           RECORDING MODE IS V
           BLOCK CONTAINS 0 RECORDS.
       01  ARCHIVE-RECORD          PIC X(32760).

       FD  REPORT-FILE
           RECORDING MODE IS F
           BLOCK CONTAINS 0 RECORDS.
       01  REPORT-RECORD           PIC X(132).

       WORKING-STORAGE SECTION.
           COPY RTNCODE.
           COPY ERRHAND.

       01  WS-FILE-STATUS.
           05  WS-CTL-STATUS        PIC XX.
           05  WS-ARCH-STATUS       PIC XX.
           05  WS-REPORT-STATUS     PIC XX.

       01  WS-PROCESSING-FLAGS.
           05  WS-END-OF-CTL        PIC X VALUE 'N'.
               88  END-OF-CONTROL   VALUE 'Y'.
           05  WS-FUNCTION-FLAG     PIC X VALUE 'N'.
               88  VALID-FUNCTION   VALUE 'Y'.

       01  WS-FUNCTIONS.
           05  WS-ARCHIVE           PIC X(8) VALUE 'ARCHIVE'.
           05  WS-CLEANUP           PIC X(8) VALUE 'CLEANUP'.
           05  WS-REORG            PIC X(8) VALUE 'REORG'.
           05  WS-ANALYZE          PIC X(8) VALUE 'ANALYZE'.

       01  WS-COUNTERS.
           05  WS-RECORDS-READ      PIC 9(9) VALUE ZERO.
           05  WS-RECORDS-WRITTEN   PIC 9(9) VALUE ZERO.
           05  WS-ERROR-COUNT       PIC 9(9) VALUE ZERO.

       01  WS-VSAM-CONTROL.
           05  WS-VSAM-NAME         PIC X(44).
           05  WS-VSAM-FUNCTION     PIC X(8).
           05  WS-VSAM-STATUS       PIC XX.

       01  WS-CHANNEL-CODE          PIC X(04) VALUE 'BRCH'. *-- Change: Default channel code for maintenance

       PROCEDURE DIVISION.
       0000-MAIN.
           PERFORM 1000-INITIALIZE
           PERFORM 2000-PROCESS
           PERFORM 3000-CLEANUP
           GOBACK.

       1000-INITIALIZE.
           PERFORM 1100-OPEN-FILES
           PERFORM 1200-INIT-PROCESSING.

       1100-OPEN-FILES.
           OPEN INPUT CONTROL-FILE
           IF WS-CTL-STATUS NOT = '00'
               MOVE 'ERROR OPENING CONTROL FILE'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF

           OPEN OUTPUT ARCHIVE-FILE
           IF WS-ARCH-STATUS NOT = '00'
               MOVE 'ERROR OPENING ARCHIVE FILE'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF

           OPEN OUTPUT REPORT-FILE
           IF WS-REPORT-STATUS NOT = '00'
               MOVE 'ERROR OPENING REPORT FILE'
                 TO WS-ERROR-MESSAGE
               PERFORM 9999-ERROR-HANDLER
           END-IF.

       1200-INIT-PROCESSING.
           INITIALIZE WS-COUNTERS.

       2000-PROCESS.
           PERFORM UNTIL END-OF-CONTROL
               READ CONTROL-FILE
                   AT END
                       SET END-OF-CONTROL TO TRUE
                   NOT AT END
                       PERFORM 2100-PROCESS-FUNCTION
               END-READ
           END-PERFORM.

      *-- Change: Set CHANNEL-CODE for maintenance transactions if needed
       2100-PROCESS-FUNCTION.
           MOVE WS-CHANNEL-CODE TO TRN-CHANNEL-CODE *-- Change: Assign default channel code for maintenance
           EVALUATE CTL-FUNCTION
               WHEN WS-ARCHIVE
                   PERFORM 2200-ARCHIVE-PROCESS
               WHEN WS-CLEANUP
                   PERFORM 2300-CLEANUP-PROCESS
               WHEN WS-REORG
                   PERFORM 2400-REORG-PROCESS
               WHEN WS-ANALYZE
                   PERFORM 2500-ANALYZE-PROCESS
               WHEN OTHER
                   MOVE 'INVALID FUNCTION SPECIFIED'
                     TO WS-ERROR-MESSAGE
                   PERFORM 9999-ERROR-HANDLER
           END-EVALUATE.

       2200-ARCHIVE-PROCESS.
           MOVE CTL-FILE-NAME TO WS-VSAM-NAME
           PERFORM 2210-OPEN-VSAM
           PERFORM 2220-ARCHIVE-RECORDS
           PERFORM 2230-CLOSE-VSAM.

       2300-CLEANUP-PROCESS.
           MOVE CTL-FILE-NAME TO WS-VSAM-NAME
           PERFORM 2310-ANALYZE-SPACE
           PERFORM 2320-DELETE-OLD
           PERFORM 2330-UPDATE-CATALOG.

       2400-REORG-PROCESS.
           MOVE CTL-FILE-NAME TO WS-VSAM-NAME
           PERFORM 2410-EXPORT-DATA
           PERFORM 2420-DELETE-DEFINE
           PERFORM 2430-IMPORT-DATA.

       2500-ANALYZE-PROCESS.
           MOVE CTL-FILE-NAME TO WS-VSAM-NAME
           PERFORM 2510-COLLECT-STATS
           PERFORM 2520-GENERATE-REPORT.

       3000-CLEANUP.
           CLOSE CONTROL-FILE
                ARCHIVE-FILE
                REPORT-FILE.

       9999-ERROR-HANDLER.
           ADD 1 TO WS-ERROR-COUNT
           DISPLAY WS-ERROR-MESSAGE UPON CONS
           IF WS-ERROR-COUNT > 100
               MOVE 12 TO RETURN-CODE
               GOBACK
           END-IF.

[Summary Change Report]
- Added WS-CHANNEL-CODE and assigned to TRN-CHANNEL-CODE for maintenance operations.
- Inline comments for traceability.

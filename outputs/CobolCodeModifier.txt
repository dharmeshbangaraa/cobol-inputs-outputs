[File 1] RPTPOS00.cbl src/programs/batch/RPTPOS00.cbl

       IDENTIFICATION DIVISION.
       PROGRAM-ID. RPTPOS00.
       *-- Change: Integrated real-time market price feed for dynamic portfolio valuation

       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT POS-FILE ASSIGN TO 'POS.DAT'.
           SELECT PRICE-FEED-FILE ASSIGN TO 'PRICEFEED.DAT'.
           SELECT AUDIT-LOG-FILE ASSIGN TO 'AUDITLOG.DAT'.

       DATA DIVISION.
       FILE SECTION.
       FD  POS-FILE.
       COPY POSREC.
       FD  PRICE-FEED-FILE.
       01  PRICE-FEED-RECORD.
           05  FEED-PORTFOLIO-ID   PIC X(08).
           05  FEED-SECURITY-ID    PIC X(12).
           05  FEED-PRICE          PIC 9(11)V99.
           05  FEED-TIMESTAMP      PIC X(20).
       FD  AUDIT-LOG-FILE.
       COPY AUDITLOG.

       WORKING-STORAGE SECTION.
       01  WS-EOF                 PIC X VALUE 'N'.
       01  WS-PRICE-FOUND         PIC X VALUE 'N'.
       01  WS-REALTIME-PRICE      PIC 9(11)V99 VALUE 0.
       01  WS-REALTIME-TIMESTAMP  PIC X(20) VALUE SPACES.
       01  WS-ERROR-CODE          PIC 9(04) VALUE ZEROS.
       01  WS-ALARM-RAISED        PIC X VALUE 'N'.
       01  WS-OLD-POSITION-VALUE  PIC 9(13)V99 VALUE 0.
       01  WS-NEW-POSITION-VALUE  PIC 9(13)V99 VALUE 0.
       01  WS-POSITION-PNL        PIC S9(13)V99 VALUE 0.
       01  WS-REPORT-LINE         PIC X(132).

       PROCEDURE DIVISION.
       MAIN-LOGIC.
           PERFORM 1000-INITIALIZE
           PERFORM 2000-PROCESS-REPORT
           PERFORM 3000-FINALIZE
           STOP RUN.

       1000-INITIALIZE.
           OPEN INPUT POS-FILE
           OPEN INPUT PRICE-FEED-FILE
           OPEN OUTPUT AUDIT-LOG-FILE.

       2000-PROCESS-REPORT.
           READ POS-FILE
               AT END
                   MOVE 'Y' TO WS-EOF
           END-READ
           PERFORM UNTIL WS-EOF = 'Y'
               PERFORM 2100-GET-REALTIME-PRICE
               IF WS-PRICE-FOUND = 'Y'
                   PERFORM 2110-FORMAT-POSITION
               ELSE
                   *-- Change: Log feed failure to audit log
                   MOVE 'FEED-FAILURE' TO AUDITLOG-ALARM-TYPE
                   MOVE POS-PORTFOLIO-ID TO AUDITLOG-PORTFOLIO-ID
                   MOVE 'REALTIME PRICE NOT FOUND' TO AUDITLOG-DESCRIPTION
                   PERFORM 2200-LOG-AUDIT
               END-IF
               READ POS-FILE
                   AT END
                       MOVE 'Y' TO WS-EOF
               END-READ
           END-PERFORM.

       2100-GET-REALTIME-PRICE.
           *-- Change: Ingest real-time price feed and update working storage
           MOVE 'N' TO WS-PRICE-FOUND
           REWRITE-PRICE-FEED.
               READ PRICE-FEED-FILE
                   AT END
                       GO TO END-PRICE-FEED
               END-READ
               IF FEED-PORTFOLIO-ID = POS-PORTFOLIO-ID
                   MOVE FEED-PRICE TO WS-REALTIME-PRICE
                   MOVE FEED-TIMESTAMP TO WS-REALTIME-TIMESTAMP
                   MOVE 'Y' TO WS-PRICE-FOUND
               END-IF
               GO TO REWRITE-PRICE-FEED
           END-PRICE-FEED.

       2110-FORMAT-POSITION.
           *-- Change: Recalculate position value and P&L using real-time price
           MOVE POS-POSITION-VALUE TO WS-OLD-POSITION-VALUE
           COMPUTE WS-NEW-POSITION-VALUE = POS-QUANTITY * WS-REALTIME-PRICE
           COMPUTE WS-POSITION-PNL = WS-NEW-POSITION-VALUE - WS-OLD-POSITION-VALUE
           MOVE WS-REALTIME-PRICE TO POS-REALTIME-PRICE
           MOVE WS-REALTIME-TIMESTAMP TO POS-PRICE-TIMESTAMP
           MOVE WS-POSITION-PNL TO POS-POSITION-PNL
           *-- Change: Store recalculated values in position record
           *-- Change: Log successful update to audit log
           MOVE 'UPDATE' TO AUDITLOG-ALARM-TYPE
           MOVE POS-PORTFOLIO-ID TO AUDITLOG-PORTFOLIO-ID
           MOVE 'POSITION UPDATED WITH REALTIME PRICE' TO AUDITLOG-DESCRIPTION
           PERFORM 2200-LOG-AUDIT.

       2200-LOG-AUDIT.
           *-- Change: Centralized audit logging for feed failures and updates
           WRITE AUDITLOG-RECORD.

       3000-FINALIZE.
           CLOSE POS-FILE
           CLOSE PRICE-FEED-FILE
           CLOSE AUDIT-LOG-FILE.

[Summary Change Report]
- Integrated real-time price feed ingestion in 2100-GET-REALTIME-PRICE.
- Modified 2000-PROCESS-REPORT and 2110-FORMAT-POSITION to recalculate position value and P&L using real-time prices.
- Added audit logging for feed failures and successful updates.
- Preserved COBOL formatting and added inline comments for traceability.

[File 2] POSREC.cpy src/copybook/common/POSREC.cpy

       01  POSITION-RECORD.
           05  POS-KEY.
               10  POS-PORTFOLIO-ID   PIC X(08).
               10  POS-DATE           PIC X(08).
               10  POS-SECURITY-ID    PIC X(12).
           05  POS-QUANTITY          PIC 9(11).
           05  POS-POSITION-VALUE    PIC 9(13)V99.
           *-- Change: Added fields for real-time price, P&L, and timestamp
           05  POS-REALTIME-PRICE    PIC 9(11)V99.
           05  POS-POSITION-PNL      PIC S9(13)V99.
           05  POS-PRICE-TIMESTAMP   PIC X(20).

[Summary Change Report]
- Added POS-REALTIME-PRICE, POS-POSITION-PNL, and POS-PRICE-TIMESTAMP fields to support real-time valuation and audit requirements.

[File 3] POSUPDT.cbl src/programs/batch/POSUPDT.cbl

       IDENTIFICATION DIVISION.
       PROGRAM-ID. POSUPDT.
       *-- Change: Enhanced to recalculate P&L and persist new values on each price update

       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT POS-FILE ASSIGN TO 'POS.DAT'.
           SELECT AUDIT-LOG-FILE ASSIGN TO 'AUDITLOG.DAT'.

       DATA DIVISION.
       FILE SECTION.
       FD  POS-FILE.
       COPY POSREC.
       FD  AUDIT-LOG-FILE.
       COPY AUDITLOG.

       WORKING-STORAGE SECTION.
       01  WS-EOF                 PIC X VALUE 'N'.
       01  WS-REALTIME-PRICE      PIC 9(11)V99 VALUE 0.
       01  WS-REALTIME-TIMESTAMP  PIC X(20) VALUE SPACES.
       01  WS-OLD-POSITION-VALUE  PIC 9(13)V99 VALUE 0.
       01  WS-NEW-POSITION-VALUE  PIC 9(13)V99 VALUE 0.
       01  WS-POSITION-PNL        PIC S9(13)V99 VALUE 0.

       PROCEDURE DIVISION.
       MAIN-LOGIC.
           OPEN INPUT POS-FILE
           OPEN OUTPUT AUDIT-LOG-FILE
           PERFORM UNTIL WS-EOF = 'Y'
               READ POS-FILE
                   AT END
                       MOVE 'Y' TO WS-EOF
                   NOT AT END
                       PERFORM 1000-UPDATE-POSITION
               END-READ
           END-PERFORM
           CLOSE POS-FILE
           CLOSE AUDIT-LOG-FILE
           STOP RUN.

       1000-UPDATE-POSITION.
           *-- Change: Recalculate P&L and update position record
           MOVE POS-POSITION-VALUE TO WS-OLD-POSITION-VALUE
           MOVE POS-REALTIME-PRICE TO WS-REALTIME-PRICE
           COMPUTE WS-NEW-POSITION-VALUE = POS-QUANTITY * WS-REALTIME-PRICE
           COMPUTE WS-POSITION-PNL = WS-NEW-POSITION-VALUE - WS-OLD-POSITION-VALUE
           MOVE WS-NEW-POSITION-VALUE TO POS-POSITION-VALUE
           MOVE WS-POSITION-PNL TO POS-POSITION-PNL
           *-- Change: Persist new values and log update
           WRITE POS-RECORD
           MOVE 'UPDATE' TO AUDITLOG-ALARM-TYPE
           MOVE POS-PORTFOLIO-ID TO AUDITLOG-PORTFOLIO-ID
           MOVE 'POSITION UPDATED WITH REALTIME PRICE' TO AUDITLOG-DESCRIPTION
           WRITE AUDITLOG-RECORD.

[Summary Change Report]
- Enhanced to recalculate and persist P&L and position value on each price update.
- Added audit logging for each update.
- Preserved COBOL formatting and added inline comments for traceability.

[File 4] AUDPROC.cbl src/programs/common/AUDPROC.cbl

       IDENTIFICATION DIVISION.
       PROGRAM-ID. AUDPROC.
       *-- Change: Enhanced to log feed failures, stale data, and alarms for real-time feed monitoring

       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT AUDIT-LOG-FILE ASSIGN TO 'AUDITLOG.DAT'.

       DATA DIVISION.
       FILE SECTION.
       FD  AUDIT-LOG-FILE.
       COPY AUDITLOG.

       WORKING-STORAGE SECTION.
       01  WS-EOF                 PIC X VALUE 'N'.

       PROCEDURE DIVISION.
       MAIN-LOGIC.
           OPEN OUTPUT AUDIT-LOG-FILE
           PERFORM 2000-PROCESS-AUDIT
           CLOSE AUDIT-LOG-FILE
           STOP RUN.

       2000-PROCESS-AUDIT.
           *-- Change: Centralized audit logging for feed failures, stale data, and alarms
           IF AUDITLOG-ALARM-TYPE = 'FEED-FAILURE'
               *-- Change: Log feed failure
               WRITE AUDITLOG-RECORD
           ELSE IF AUDITLOG-ALARM-TYPE = 'STALE-DATA'
               *-- Change: Log stale data alarm
               WRITE AUDITLOG-RECORD
           ELSE IF AUDITLOG-ALARM-TYPE = 'UPDATE'
               *-- Change: Log successful update
               WRITE AUDITLOG-RECORD
           END-IF.

[Summary Change Report]
- Enhanced 2000-PROCESS-AUDIT to log new alarm and error conditions for real-time feed monitoring.
- Preserved COBOL formatting and added inline comments for traceability.

[File 5] AUDITLOG.cpy src/copybook/common/AUDITLOG.cpy

       01  AUDITLOG-RECORD.
           05  AUDITLOG-ALARM-TYPE     PIC X(20).
           05  AUDITLOG-PORTFOLIO-ID   PIC X(08).
           05  AUDITLOG-DESCRIPTION    PIC X(60).
           *-- Change: Added fields for new alarm and error conditions
           05  AUDITLOG-FEED-TIMESTAMP PIC X(20).
           05  AUDITLOG-ERROR-CODE     PIC 9(04).

[Summary Change Report]
- Added AUDITLOG-FEED-TIMESTAMP and AUDITLOG-ERROR-CODE fields to support new alarm and error conditions for real-time feed monitoring.
- Preserved COBOL formatting and added inline comments for traceability.



---

## Summary

**User Story:**  
Title: Fix rounding discrepancies in portfolio P&L calculation  
As an Operations Analyst, I want all P&L values to be rounded consistently to two decimal places so that financial reports and statements match downstream accounting systems exactly.

**Acceptance Criteria:**
1. Update COBOL arithmetic in PNL-CALC-PROG (or relevant copybook routines) to use ROUNDED when moving computed P&L from WORK-DIVIDE fields to output fields.
2. Ensure the DB2 PORTVAL.PNL_AMT column (DECIMAL(15,2)) stores values exactly with two decimal places.
3. Add unit tests in TSTVAL.jcl that feed known inputs and expect correct rounding.
4. Verify that batch reports (RPTPOS00 and RPTAUD00) display P&L amounts correctly rounded in both TXT and CSV outputs.

**Total impacted components:** 6  
**High-level assessment:**  
This is a medium-to-high complexity change. It directly affects core calculation logic, database storage, and reporting, with ripple effects into testing and validation. The change impacts both batch and reporting programs, as well as copybooks and JCL for regression testing.

---

## Ranked Impact List

| Program/Component         | Impact   | Nature   | Affected Paragraphs/Sections         | Dependency Path                                  |
|--------------------------|----------|----------|--------------------------------------|--------------------------------------------------|
| PNL-CALC-PROG            | High     | Direct   | PNL-CALC, MOVE-TO-OUTPUT, WORK-DIVIDE | [PNL-CALC-PROG]                                  |
| PORTVAL (DB2 Table)      | High     | Direct   | PNL_AMT column, DB2 I/O routines     | [PNL-CALC-PROG, DB2 PORTVAL]                     |
| RPTPOS00                 | High     | Direct   | 2000-PROCESS-REPORT, 2110-FORMAT-POSITION | [RPTPOS00]                                   |
| RPTAUD00                 | High     | Direct   | 2000-PROCESS-REPORT, 2100-PROCESS-AUDIT-TRAIL | [RPTAUD00]                                |
| TSTVAL00 (TSTVAL.jcl)    | Medium   | Direct   | 2000-PROCESS, 2100-EXECUTE-TEST, 2600-VALIDATE-RESULTS | [TSTVAL00]                       |
| POSREC (Copybook)        | Medium   | Indirect | P&L field definitions, record layouts | [PNL-CALC-PROG, POSREC], [RPTPOS00, POSREC]      |

---

## JSON Metadata

```json
{
  "impactAnalysis": {
    "userStory": "Fix rounding discrepancies in portfolio P&L calculation",
    "impactedComponents": [
      {
        "programName": "PNL-CALC-PROG",
        "impactScore": 0.98,
        "impactLevel": "High",
        "impactType": "Direct",
        "affectedParagraphs": ["PNL-CALC", "MOVE-TO-OUTPUT", "WORK-DIVIDE"],
        "dependencyPath": ["PNL-CALC-PROG"],
        "rationale": "Core calculation logic for P&L; must implement ROUNDED in arithmetic and ensure output fields are set to two decimals."
      },
      {
        "programName": "PORTVAL (DB2 Table)",
        "impactScore": 0.95,
        "impactLevel": "High",
        "impactType": "Direct",
        "affectedParagraphs": ["PNL_AMT column", "DB2 I/O routines"],
        "dependencyPath": ["PNL-CALC-PROG", "DB2 PORTVAL"],
        "rationale": "Database storage for P&L; must ensure values stored are exactly two decimals as per schema and business rule."
      },
      {
        "programName": "RPTPOS00",
        "impactScore": 0.92,
        "impactLevel": "High",
        "impactType": "Direct",
        "affectedParagraphs": ["2000-PROCESS-REPORT", "2110-FORMAT-POSITION"],
        "dependencyPath": ["RPTPOS00"],
        "rationale": "Batch report program that displays P&L; must show rounded values in TXT and CSV outputs."
      },
      {
        "programName": "RPTAUD00",
        "impactScore": 0.90,
        "impactLevel": "High",
        "impactType": "Direct",
        "affectedParagraphs": ["2000-PROCESS-REPORT", "2100-PROCESS-AUDIT-TRAIL"],
        "dependencyPath": ["RPTAUD00"],
        "rationale": "Audit report program that displays P&L; must show rounded values in TXT and CSV outputs."
      },
      {
        "programName": "TSTVAL00 (TSTVAL.jcl)",
        "impactScore": 0.80,
        "impactLevel": "Medium",
        "impactType": "Direct",
        "affectedParagraphs": ["2000-PROCESS", "2100-EXECUTE-TEST", "2600-VALIDATE-RESULTS"],
        "dependencyPath": ["TSTVAL00"],
        "rationale": "Regression/unit test driver; must validate rounding logic with known test cases."
      },
      {
        "programName": "POSREC (Copybook)",
        "impactScore": 0.75,
        "impactLevel": "Medium",
        "impactType": "Indirect",
        "affectedParagraphs": ["P&L field definitions", "record layouts"],
        "dependencyPath": ["PNL-CALC-PROG", "POSREC"],
        "rationale": "Defines P&L fields used in calculations and reports; changes may be needed to ensure correct picture/rounding."
      }
    ]
  }
}
```

---

## Visualization

```mermaid
graph TD
    PNL-CALC-PROG["PNL-CALC-PROG<br/>(High)"]:::high
    PORTVAL["PORTVAL (DB2 Table)<br/>(High)"]:::high
    RPTPOS00["RPTPOS00<br/>(High)"]:::high
    RPTAUD00["RPTAUD00<br/>(High)"]:::high
    TSTVAL00["TSTVAL00 (TSTVAL.jcl)<br/>(Medium)"]:::medium
    POSREC["POSREC (Copybook)<br/>(Medium)"]:::medium

    PNL-CALC-PROG --> PORTVAL
    PNL-CALC-PROG --> POSREC
    RPTPOS00 --> POSREC
    RPTAUD00 --> POSREC
    TSTVAL00 -.-> PNL-CALC-PROG
    TSTVAL00 -.-> RPTPOS00
    TSTVAL00 -.-> RPTAUD00

    classDef high fill:#ffcccc,stroke:#b22222,stroke-width:2px;
    classDef medium fill:#fff2cc,stroke:#b8860b,stroke-width:2px;
```

---

**Reasoning:**  
- **PNL-CALC-PROG** is the core calculation engine for P&L and must be updated for rounding logic.
- **PORTVAL (DB2 Table)** is where P&L is stored; must ensure values are stored with correct precision.
- **RPTPOS00** and **RPTAUD00** are batch reporting programs that output P&L; must display rounded values.
- **TSTVAL00** (unit test JCL) is used to validate the rounding logic.
- **POSREC** (copybook) defines the P&L field structure and is included in both calculation and reporting programs.

**Note:**  
Other programs and copybooks were reviewed but excluded due to lack of direct or indirect logical connection to the P&L calculation or reporting chain for this user story. Only components that process, store, or display P&L values, or validate their correctness, are included.

User Story: Integrate real-time market price feed for dynamic portfolio valuation  
- 6 impacted components identified (**High impact only**)  
- High complexity: Real-time data ingestion, dynamic valuation, CICS screen refresh, audit logging, and new VSAM integration impact multiple core programs and copybooks.

---

**Ranked Impact List**:

| Program File Path                        | Impact | Nature  | Affected Paragraphs/Sections           | Dependency Path                        |
|------------------------------------------|--------|---------|----------------------------------------|----------------------------------------|
| src/programs/batch/POSVAL00.cbl          | High   | Direct  | 1000-INIT, 2000-INGEST-PRICES, 3000-REVAL, 4000-STORE-RESULTS | POSVAL00                               |
| src/programs/batch/POSUPDT.cbl           | High   | Direct  | 2000-UPDATE-POSITIONS, 3000-RECALC-PNL | POSVAL00 → POSUPDT                     |
| src/programs/cics/PORTDISP.cbl           | High   | Direct  | 1000-INIT, 2100-REFRESH-SCREEN         | PORTDISP                               |
| src/programs/common/AUDPROC.cbl          | High   | Direct  | 2000-PROCESS-AUDIT, 3000-TERMINATE     | POSVAL00 → AUDPROC                     |
| src/copybook/common/AUDITLOG.cpy         | High   | Direct  | AUDITLOG-RECORD, AUDITLOG-WRITE        | POSVAL00/PORTDISP → AUDPROC → AUDITLOG |
| src/copybook/vsam/PRICEHIST.cpy          | High   | Direct  | PRICEHIST-RECORD, PRICEHIST-UPDATE     | POSVAL00 → PRICEHIST                   |

---

**JSON Metadata**:
```json
{
  "impactAnalysis": {
    "userStory": "Integrate real-time market price feed for dynamic portfolio valuation",
    "impactedComponents": [
      {
        "programFilePath": "src/programs/batch/POSVAL00.cbl",
        "impactScore": 0.98,
        "impactLevel": "High",
        "impactType": "Direct",
        "affectedParagraphs": ["1000-INIT", "2000-INGEST-PRICES", "3000-REVAL", "4000-STORE-RESULTS"],
        "dependencyPath": ["POSVAL00"],
        "rationale": "Primary batch program for ingesting price feed, recalculating valuations, and storing results. All real-time valuation logic and error handling are centered here."
      },
      {
        "programFilePath": "src/programs/batch/POSUPDT.cbl",
        "impactScore": 0.96,
        "impactLevel": "High",
        "impactType": "Direct",
        "affectedParagraphs": ["2000-UPDATE-POSITIONS", "3000-RECALC-PNL"],
        "dependencyPath": ["POSVAL00", "POSUPDT"],
        "rationale": "Handles position updates and P&L recalculation on each price update. Called by POSVAL00 after ingestion."
      },
      {
        "programFilePath": "src/programs/cics/PORTDISP.cbl",
        "impactScore": 0.95,
        "impactLevel": "High",
        "impactType": "Direct",
        "affectedParagraphs": ["1000-INIT", "2100-REFRESH-SCREEN"],
        "dependencyPath": ["PORTDISP"],
        "rationale": "CICS screen program for 'View Portfolio'. Must refresh and display updated valuations within 10 seconds of market feed."
      },
      {
        "programFilePath": "src/programs/common/AUDPROC.cbl",
        "impactScore": 0.93,
        "impactLevel": "High",
        "impactType": "Direct",
        "affectedParagraphs": ["2000-PROCESS-AUDIT", "3000-TERMINATE"],
        "dependencyPath": ["POSVAL00", "AUDPROC"],
        "rationale": "Handles audit logging for feed failures and stale prices. Called by POSVAL00 and PORTDISP for error/audit events."
      },
      {
        "programFilePath": "src/copybook/common/AUDITLOG.cpy",
        "impactScore": 0.92,
        "impactLevel": "High",
        "impactType": "Direct",
        "affectedParagraphs": ["AUDITLOG-RECORD", "AUDITLOG-WRITE"],
        "dependencyPath": ["POSVAL00", "AUDPROC", "AUDITLOG"],
        "rationale": "Defines the audit log structure and write logic. Required for new audit events per user story."
      },
      {
        "programFilePath": "src/copybook/vsam/PRICEHIST.cpy",
        "impactScore": 0.91,
        "impactLevel": "High",
        "impactType": "Direct",
        "affectedParagraphs": ["PRICEHIST-RECORD", "PRICEHIST-UPDATE"],
        "dependencyPath": ["POSVAL00", "PRICEHIST"],
        "rationale": "Defines the new VSAM KSDS for historical price feeds, required for backtesting and persistence."
      }
    ]
  }
}
```

---

**Visualization**:

```mermaid
graph TD
  A[src/programs/batch/POSVAL00.cbl]:::high
  B[src/programs/batch/POSUPDT.cbl]:::high
  C[src/programs/cics/PORTDISP.cbl]:::high
  D[src/programs/common/AUDPROC.cbl]:::high
  E[src/copybook/common/AUDITLOG.cpy]:::high
  F[src/copybook/vsam/PRICEHIST.cpy]:::high

  A --> B
  A --> D
  A --> F
  D --> E
  C --> D
  classDef high fill:#ffcccc,stroke:#b30000,stroke-width:2px;
```

---

**Reasoning**:
- **POSVAL00.cbl**: Central to price ingestion and valuation; must handle new feed, recalculation, and error/audit logic.
- **POSUPDT.cbl**: Directly updates positions and P&L, triggered by price changes.
- **PORTDISP.cbl**: CICS screen for portfolio display; must refresh based on new valuations.
- **AUDPROC.cbl** & **AUDITLOG.cpy**: Required for new audit events and error handling per business rules.
- **PRICEHIST.cpy**: Implements new VSAM structure for historical price storage.

All components listed are present in the repository and are directly impacted by the user story’s requirements. No extraneous files included.

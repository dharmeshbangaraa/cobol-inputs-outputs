# Technical Document and Low-Level Design (LLD)

## 1. Introduction  
This document details the technical changes and low-level design for the COBOL portfolio management suite, specifically focusing on the integration of real-time price feed functionality. The changes impact the portfolio update, audit reporting, and associated data structures to support ingestion, processing, and audit of real-time price data.

## 2. Existing Logic and Flow  
### 2.1 Overview  
The portfolio management application processes updates to portfolio records, maintains audit trails, and generates audit reports. The main modules are:
- **PORTUPDT**: Updates portfolio records based on input updates.
- **RPTAUD00**: Generates audit reports from audit and error logs.
- **Copybooks (PORTFLIO, AUDITLOG)**: Define the structure of portfolio and audit records.

### 2.2 Detailed Logic  
#### PORTUPDT (Portfolio Update Program)
- **Initialization (1000-INITIALIZE)**: Sets up working storage, opens files, and initializes real-time price fields.
- **Processing (2000-PROCESS, 2100-PROCESS-UPDATE)**: Reads update records, applies updates to portfolio records, and processes real-time price data if present.
- **Apply Update (2200-APPLY-UPDATE)**: Applies changes to portfolio fields, including real-time price and timestamp if provided.
- **Termination (3000-TERMINATE)**: Closes files and displays summary.

#### RPTAUD00 (Audit Report Generator)
- **Initialization**: Opens files and writes report headers.
- **Processing**: Reads audit and error logs, summarizes, and writes reports.
- **Cleanup**: Closes all files.

#### Flowchart:  
```
flowchart TD
    Start(["Start"])
    Init["1000-INITIALIZE
(Open files, init fields)"]
    Process["2000-PROCESS
(Read update file)"]
    ProcUpdate["2100-PROCESS-UPDATE
(Move keys, check real-time price)"]
    ReadPortfolio["READ PORTFOLIO-FILE"]
    ApplyUpdate["2200-APPLY-UPDATE
(Evaluate action, apply real-time price)"]
    Rewrite["REWRITE PORT-RECORD"]
    Terminate["3000-TERMINATE
(Close files, display summary)"]
    End(["End"])

    Start --> Init
    Init --> Process
    Process --> ProcUpdate
    ProcUpdate --> ReadPortfolio
    ReadPortfolio --> ApplyUpdate
    ApplyUpdate --> Rewrite
    Rewrite --> Process
    Process --> Terminate
    Terminate --> End
```

## 3. Impacted Changes  
### 3.1 User Story or Analysis Report Summary  
Enable real-time price feed integration for portfolio updates, ensuring that real-time price and timestamp can be ingested, stored, and audited throughout the portfolio management process.

### 3.2 Impacted Code Changes Summary:
#### 3.2.1 Impacted Sections and Files:
- **src/programs/portfolio/PORTUPDT.cbl**
- **src/copybook/common/PORTFLIO.cpy**
- **src/programs/batch/RPTAUD00.cbl**
- **src/copybook/common/AUDITLOG.cpy**

  - **Purpose of Changes:**  
    To support real-time price feed integration, new fields for price and timestamp are added to portfolio and audit records. The update logic is enhanced to ingest and apply these values, and audit/reporting modules are extended to track and report on real-time price updates.

  - **Impact:**  
    - Portfolio records can now store and be updated with real-time price and timestamp.
    - Update logic applies real-time price if present, overriding standard value updates.
    - Audit logs and reports now capture real-time price changes for traceability and compliance.

### 3.3 Insertion Points  
- **PORTUPDT.cbl**
  - **DATA DIVISION, FILE SECTION:**  
    - Added `UPDT-PRICE-FEED` and `UPDT-PRICE-TIMESTAMP` to `UPDATE-RECORD`.
  - **WORKING-STORAGE SECTION:**  
    - Added `WS-REALTIME-PRICE` and `WS-PRICE-TIMESTAMP`.
  - **1000-INITIALIZE:**  
    - Initialize new real-time price fields.
  - **2100-PROCESS-UPDATE:**  
    - Capture real-time price and timestamp from update record if present.
  - **2200-APPLY-UPDATE:**  
    - Apply real-time price and timestamp to portfolio record if present.

- **PORTFLIO.cpy**
  - **PORT-PORTFOLIO-INFO:**  
    - Added `PORT-REALTIME-PRICE` and `PORT-PRICE-TIMESTAMP`.

- **RPTAUD00.cbl**
  - **WS-AUDIT-DETAIL:**  
    - Added `WS-AUD-REALTIME-PRICE` and `WS-AUD-PRICE-TIMESTAMP`.

- **AUDITLOG.cpy**
  - **AUDIT-RECORD:**  
    - Added `AUD-REALTIME-PRICE` and `AUD-PRICE-TIMESTAMP`.

### 3.4 Structured Diffs  

#### src/programs/portfolio/PORTUPDT.cbl

**Before:**
```cobol
       FD  UPDATE-FILE.
       01  UPDATE-RECORD.
           05  UPDT-KEY.
               10  UPDT-ID        PIC X(8).
               10  UPDT-ACCT-NO   PIC X(10).
           05  UPDT-ACTION        PIC X(1).
               88  UPDT-STATUS    VALUE 'S'.
               88  UPDT-VALUE     VALUE 'V'.
               88  UPDT-NAME      VALUE 'N'.
           05  UPDT-NEW-VALUE     PIC X(50).
```
**After:**
```cobol
       FD  UPDATE-FILE.
       01  UPDATE-RECORD.
           05  UPDT-KEY.
               10  UPDT-ID        PIC X(8).
               10  UPDT-ACCT-NO   PIC X(10).
           05  UPDT-ACTION        PIC X(1).
               88  UPDT-STATUS    VALUE 'S'.
               88  UPDT-VALUE     VALUE 'V'.
               88  UPDT-NAME      VALUE 'N'.
           05  UPDT-NEW-VALUE     PIC X(50).
      *-- Change: Added fields for real-time price feed integration
           05  UPDT-PRICE-FEED    PIC S9(13)V99 COMP-3.   *-- Change: Real-time price
           05  UPDT-PRICE-TIMESTAMP PIC 9(14).            *-- Change: Price feed timestamp
```

**Before:**
```cobol
       01  WS-WORK-AREAS.
           05  WS-UPDATE-COUNT     PIC 9(7) VALUE ZERO.
           05  WS-ERROR-COUNT      PIC 9(7) VALUE ZERO.
           05  WS-RETURN-CODE      PIC S9(4) VALUE +0.
           05  WS-NUMERIC-WORK     PIC S9(13)V99.
```
**After:**
```cobol
       01  WS-WORK-AREAS.
           05  WS-UPDATE-COUNT     PIC 9(7) VALUE ZERO.
           05  WS-ERROR-COUNT      PIC 9(7) VALUE ZERO.
           05  WS-RETURN-CODE      PIC S9(4) VALUE +0.
           05  WS-NUMERIC-WORK     PIC S9(13)V99.
      *-- Change: Work area for real-time price and timestamp
           05  WS-REALTIME-PRICE   PIC S9(13)V99 COMP-3.   *-- Change: Real-time price
           05  WS-PRICE-TIMESTAMP  PIC 9(14).              *-- Change: Price feed timestamp
```

**Before:**
```cobol
       1000-INITIALIZE.
           INITIALIZE WS-WORK-AREAS
           
           OPEN I-O   PORTFOLIO-FILE
           OPEN INPUT UPDATE-FILE
           
           IF NOT WS-SUCCESS-STATUS OR 
              NOT WS-UPDT-SUCCESS
              DISPLAY 'Error opening files: ' 
                      'PORT=' WS-FILE-STATUS
                      'UPDT=' WS-UPDT-STATUS
              MOVE WS-ERROR TO WS-RETURN-CODE
              PERFORM 3000-TERMINATE
           END-IF
```
**After:**
```cobol
       1000-INITIALIZE.
           INITIALIZE WS-WORK-AREAS
           
           OPEN I-O   PORTFOLIO-FILE
           OPEN INPUT UPDATE-FILE
           
           IF NOT WS-SUCCESS-STATUS OR 
              NOT WS-UPDT-SUCCESS
              DISPLAY 'Error opening files: ' 
                      'PORT=' WS-FILE-STATUS
                      'UPDT=' WS-UPDT-STATUS
              MOVE WS-ERROR TO WS-RETURN-CODE
              PERFORM 3000-TERMINATE
           END-IF
      *-- Change: Initialize real-time price fields
           MOVE ZERO TO WS-REALTIME-PRICE
           MOVE ZERO TO WS-PRICE-TIMESTAMP
```

**Before:**
```cobol
       2100-PROCESS-UPDATE.
           MOVE UPDT-KEY TO PORT-KEY
           
           READ PORTFOLIO-FILE
           
           IF WS-SUCCESS-STATUS
               PERFORM 2200-APPLY-UPDATE
           ELSE
               ADD 1 TO WS-ERROR-COUNT
               DISPLAY 'Record not found: ' PORT-KEY
           END-IF
           .
```
**After:**
```cobol
       2100-PROCESS-UPDATE.
           MOVE UPDT-KEY TO PORT-KEY
      *-- Change: Capture real-time price and timestamp if present
           IF UPDT-PRICE-FEED NOT = ZERO
               MOVE UPDT-PRICE-FEED TO WS-REALTIME-PRICE
               MOVE UPDT-PRICE-TIMESTAMP TO WS-PRICE-TIMESTAMP
           END-IF
           
           READ PORTFOLIO-FILE
           
           IF WS-SUCCESS-STATUS
               PERFORM 2200-APPLY-UPDATE
           ELSE
               ADD 1 TO WS-ERROR-COUNT
               DISPLAY 'Record not found: ' PORT-KEY
           END-IF
           .
```

**Before:**
```cobol
       2200-APPLY-UPDATE.
           EVALUATE TRUE
               WHEN UPDT-STATUS
                   MOVE UPDT-NEW-VALUE TO PORT-STATUS
               WHEN UPDT-NAME
                   MOVE UPDT-NEW-VALUE TO PORT-CLIENT-NAME
               WHEN UPDT-VALUE
                   MOVE UPDT-NEW-VALUE TO WS-NUMERIC-WORK
                   MOVE WS-NUMERIC-WORK TO PORT-TOTAL-VALUE
           END-EVALUATE
           
           REWRITE PORT-RECORD
           
           IF WS-SUCCESS-STATUS
               ADD 1 TO WS-UPDATE-COUNT
           ELSE
               ADD 1 TO WS-ERROR-COUNT
               DISPLAY 'Update failed for: ' PORT-KEY
           END-IF
           .
```
**After:**
```cobol
       2200-APPLY-UPDATE.
           EVALUATE TRUE
               WHEN UPDT-STATUS
                   MOVE UPDT-NEW-VALUE TO PORT-STATUS
               WHEN UPDT-NAME
                   MOVE UPDT-NEW-VALUE TO PORT-CLIENT-NAME
               WHEN UPDT-VALUE
                   MOVE UPDT-NEW-VALUE TO WS-NUMERIC-WORK
                   MOVE WS-NUMERIC-WORK TO PORT-TOTAL-VALUE
           END-EVALUATE
      *-- Change: Apply real-time price feed if present
           IF WS-REALTIME-PRICE NOT = ZERO
               MOVE WS-REALTIME-PRICE TO PORT-TOTAL-VALUE
               MOVE WS-PRICE-TIMESTAMP TO PORT-LAST-MAINT
               DISPLAY 'Real-time price update applied for: ' PORT-KEY
           END-IF
           
           REWRITE PORT-RECORD
           
           IF WS-SUCCESS-STATUS
               ADD 1 TO WS-UPDATE-COUNT
           ELSE
               ADD 1 TO WS-ERROR-COUNT
               DISPLAY 'Update failed for: ' PORT-KEY
           END-IF
           .
```

#### src/copybook/common/PORTFLIO.cpy

**Before:**
```cobol
           05  PORT-PORTFOLIO-INFO.
               10  PORT-CREATE-DATE    PIC 9(8).
               10  PORT-LAST-MAINT     PIC 9(8).
               10  PORT-STATUS         PIC X(1).
                   88  PORT-ACTIVE       VALUE 'A'.
                   88  PORT-CLOSED       VALUE 'C'.
                   88  PORT-SUSPENDED    VALUE 'S'.
               10  PORT-TOTAL-VALUE    PIC S9(13)V99 COMP-3.
               10  PORT-CASH-BALANCE   PIC S9(13)V99 COMP-3.
```
**After:**
```cobol
           05  PORT-PORTFOLIO-INFO.
               10  PORT-CREATE-DATE    PIC 9(8).
               10  PORT-LAST-MAINT     PIC 9(8).
               10  PORT-STATUS         PIC X(1).
                   88  PORT-ACTIVE       VALUE 'A'.
                   88  PORT-CLOSED       VALUE 'C'.
                   88  PORT-SUSPENDED    VALUE 'S'.
      *-- Change: Added real-time price and timestamp fields for integration
               10  PORT-REALTIME-PRICE PIC S9(13)V99 COMP-3.   *-- Change: Real-time price
               10  PORT-PRICE-TIMESTAMP PIC 9(14).              *-- Change: Price feed timestamp
               10  PORT-TOTAL-VALUE    PIC S9(13)V99 COMP-3.
               10  PORT-CASH-BALANCE   PIC S9(13)V99 COMP-3.
```

#### src/programs/batch/RPTAUD00.cbl

**Before:**
```cobol
       01  WS-AUDIT-DETAIL.
           05  WS-AUD-TIMESTAMP     PIC X(26).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-AUD-PROGRAM       PIC X(8).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-AUD-TYPE          PIC X(10).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-AUD-MESSAGE       PIC X(80).
```
**After:**
```cobol
       01  WS-AUDIT-DETAIL.
           05  WS-AUD-TIMESTAMP     PIC X(26).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-AUD-PROGRAM       PIC X(8).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-AUD-TYPE          PIC X(10).
           05  FILLER               PIC X(2) VALUE SPACES.
           05  WS-AUD-MESSAGE       PIC X(80).
      *-- Change: Added fields for real-time price update audit
           05  WS-AUD-REALTIME-PRICE   PIC S9(13)V99 COMP-3.   *-- Change: Real-time price
           05  WS-AUD-PRICE-TIMESTAMP  PIC 9(14).              *-- Change: Price feed timestamp
```

#### src/copybook/common/AUDITLOG.cpy

**Before:**
```cobol
           05  AUD-KEY-INFO.
               10  AUD-PORTFOLIO-ID  PIC X(8).
               10  AUD-ACCOUNT-NO    PIC X(10).
           05  AUD-BEFORE-IMAGE     PIC X(100).
           05  AUD-AFTER-IMAGE      PIC X(100).
           05  AUD-MESSAGE          PIC X(100).
```
**After:**
```cobol
           05  AUD-KEY-INFO.
               10  AUD-PORTFOLIO-ID  PIC X(8).
               10  AUD-ACCOUNT-NO    PIC X(10).
      *-- Change: Added real-time price and timestamp fields for audit
           05  AUD-REALTIME-PRICE   PIC S9(13)V99 COMP-3.   *-- Change: Real-time price
           05  AUD-PRICE-TIMESTAMP  PIC 9(14).              *-- Change: Price feed timestamp
           05  AUD-BEFORE-IMAGE     PIC X(100).
           05  AUD-AFTER-IMAGE      PIC X(100).
           05  AUD-MESSAGE          PIC X(100).
```

## 4. Conclusion  
The implemented changes enable the portfolio management system to ingest, store, and audit real-time price feed data, enhancing the accuracy and timeliness of portfolio valuations. All impacted modules and data structures have been updated to support these new requirements, with clear traceability and auditability for compliance and operational transparency.

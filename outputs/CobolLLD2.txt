
# Technical Document and Low-Level Design (LLD)

## 1. Introduction  
This document details the recent changes and low-level design for the COBOL application modules related to position record management and audit trail processing. The changes introduce new fields for real-time market price ingestion, enhanced audit logging for market feed errors and alarms, and prepare for future logic to apply real-time prices and store P&L in batch processing.

## 2. Existing Logic and Flow  
### 2.1 Overview  
The application manages financial position records and maintains an audit trail for all significant events. The core modules include copybooks for data structures (`POSREC.CPY`, `AUDITLOG.CPY`), an audit processing subroutine (`AUDPROC.CBL`), and a batch update program (`POSUPDT.CBL`).

### 2.2 Detailed Logic  
- **Position Record Structure (`POSREC.CPY`):**  
  Defines the data layout for position records, including portfolio, investment, quantity, cost basis, market value, and status.  
  - *Change:* Added fields for last real-time market price and its timestamp.

- **Audit Trail Record (`AUDITLOG.CPY`):**  
  Defines the audit record structure, capturing system/user info, action types, status, key info, before/after images, and messages.  
  - *Change:* Added fields for market feed error code, feed status, and alarm indicator.

- **Audit Trail Processing (`AUDPROC.CBL`):**  
  Handles initialization, processing, and termination of audit records.  
  - *Change:* Enhanced to process and log new feed error/status/alarm fields.

- **Batch Position Update (`POSUPDT.CBL`):**  
  Currently empty; to be implemented for real-time price application and P&L storage.

#### Flowchart:  
```
flowchart TD
    Start(["Start"])
    Init["1000-INITIALIZE:
Accept
System Time
Open Audit File"]
    ProcessAudit["2000-PROCESS-AUDIT:
Initialize Audit Record
Move Linkage Data
Move Feed Error/Status/Alarm
Write Audit Record"]
    Terminate["3000-TERMINATE:
Close Audit File"]
    End(["End"])

    Start --> Init
    Init --> ProcessAudit
    ProcessAudit --> Terminate
    Terminate --> End
```

## 3. Impacted Changes  
### 3.1 User Story or Analysis Report Summary  
Enhance position and audit record structures to support real-time market price ingestion and detailed market feed error/alarm logging. Prepare batch update logic for real-time price application and P&L storage.

### 3.2 Impacted Code Changes Summary:

#### 3.2.1 Impacted Sections and Files:
- **src/copybook/common/POSREC.cpy**
  - *Purpose of Changes:* Add fields for last real-time market price and its timestamp to support real-time valuation and audit/backtesting.
  - *Impact:* Enables storage and tracking of the most recent market price and its ingestion time for each position.

- **src/copybook/common/AUDITLOG.cpy**
  - *Purpose of Changes:* Add fields for market feed error code, feed status, and alarm indicator to enhance audit traceability.
  - *Impact:* Allows detailed logging of market feed issues and alarm states for operational monitoring and compliance.

- **src/programs/common/AUDPROC.cbl**
  - *Purpose of Changes:* Add working-storage and linkage for new audit fields; update audit processing logic to populate these fields.
  - *Impact:* Ensures all relevant feed error/status/alarm information is captured in the audit trail.

- **src/programs/batch/POSUPDT.cbl**
  - *Purpose of Changes:* File is empty; serves as a placeholder for new logic to apply real-time prices and store P&L.
  - *Impact:* Prepares for future implementation as per requirements.

### 3.3 Insertion Points  
- **POSREC.CPY:**  
  - *Insertion Point:* After `POS-STATUS` in the `POS-DATA` group.
  - *Description:*  
    - Added `POS-LAST-PRICE` (PIC S9(13)V9(6) COMP-3) for last real-time market price.
    - Added `POS-PRICE-TIMESTAMP` (PIC X(26)) for the timestamp of last price ingestion.

- **AUDITLOG.CPY:**  
  - *Insertion Point:* After `AUD-KEY-INFO`.
  - *Description:*  
    - Added `AUD-ERROR-CODE` (PIC X(10)) for market feed error codes.
    - Added `AUD-FEED-STATUS` (PIC X(8)) for feed status (OK/STALE/FAIL).
    - Added `AUD-FEED-ALARM` (PIC X(1)) for alarm state (Y/N).

- **AUDPROC.CBL:**  
  - *Insertion Points:*  
    - *WORKING-STORAGE SECTION:* Added variables for feed error code, status, and alarm.
    - *LINKAGE SECTION:* Added fields for feed error code, status, and alarm in `LS-AUDIT-REQUEST`.
    - *2000-PROCESS-AUDIT:* Added logic to move new linkage fields to audit record before writing.

- **POSUPDT.CBL:**  
  - *Insertion Point:* Entire file is empty; new logic to be implemented by the next agent.

### 3.4 Structured Diffs  

#### src/copybook/common/POSREC.cpy

**Before:**  
```cobol
     05  POS-DATA.
         10  POS-QUANTITY       PIC S9(11)V9(4) COMP-3.
         10  POS-COST-BASIS     PIC S9(13)V9(2) COMP-3.
         10  POS-MARKET-VALUE   PIC S9(13)V9(2) COMP-3.
         10  POS-CURRENCY       PIC X(03).
         10  POS-STATUS         PIC X(01).
             88  POS-STATUS-ACTIVE  VALUE 'A'.
             88  POS-STATUS-CLOSED  VALUE 'C'.
             88  POS-STATUS-PEND    VALUE 'P'.
```

**After:**  
```cobol
     05  POS-DATA.
         10  POS-QUANTITY       PIC S9(11)V9(4) COMP-3.
         10  POS-COST-BASIS     PIC S9(13)V9(2) COMP-3.
         10  POS-MARKET-VALUE   PIC S9(13)V9(2) COMP-3.
         10  POS-CURRENCY       PIC X(03).
         10  POS-STATUS         PIC X(01).
             88  POS-STATUS-ACTIVE  VALUE 'A'.
             88  POS-STATUS-CLOSED  VALUE 'C'.
             88  POS-STATUS-PEND    VALUE 'P'.
*-- Change: Added new field for last-ingested real-time market price
         10  POS-LAST-PRICE      PIC S9(13)V9(6) COMP-3.
*-- Change: Added new field for real-time valuation timestamp
         10  POS-PRICE-TIMESTAMP PIC X(26).
```

#### src/copybook/common/AUDITLOG.cpy

**Before:**  
```cobol
     05  AUD-KEY-INFO.
         10  AUD-PORTFOLIO-ID  PIC X(8).
         10  AUD-ACCOUNT-NO    PIC X(10).
     05  AUD-BEFORE-IMAGE     PIC X(100).
     05  AUD-AFTER-IMAGE      PIC X(100).
     05  AUD-MESSAGE          PIC X(100). 
```

**After:**  
```cobol
     05  AUD-KEY-INFO.
         10  AUD-PORTFOLIO-ID  PIC X(8).
         10  AUD-ACCOUNT-NO    PIC X(10).
*-- Change: Added field for market feed error code
     05  AUD-ERROR-CODE       PIC X(10).
*-- Change: Added field for market feed status (OK/STALE/FAIL)
     05  AUD-FEED-STATUS      PIC X(8).
*-- Change: Added field for feed alarm indicator
     05  AUD-FEED-ALARM       PIC X(1).
         88  AUD-ALARM-ON     VALUE 'Y'.
         88  AUD-ALARM-OFF    VALUE 'N'.
     05  AUD-BEFORE-IMAGE     PIC X(100).
     05  AUD-AFTER-IMAGE      PIC X(100).
     05  AUD-MESSAGE          PIC X(100). 
```

#### src/programs/common/AUDPROC.cbl

**Before (WORKING-STORAGE SECTION):**  
```cobol
 01  WS-FILE-STATUS          PIC X(2).
 01  WS-FORMATTED-TIME       PIC X(26).
```

**After (WORKING-STORAGE SECTION):**  
```cobol
 01  WS-FILE-STATUS          PIC X(2).
 01  WS-FORMATTED-TIME       PIC X(26).
*-- Change: Add working-storage for feed error/alert handling
 01  WS-FEED-ERROR-CODE      PIC X(10).
 01  WS-FEED-STATUS          PIC X(8).
 01  WS-FEED-ALARM           PIC X(1).
```

**Before (LINKAGE SECTION):**  
```cobol
 01  LS-AUDIT-REQUEST.
     05  LS-SYSTEM-INFO.
         10  LS-SYSTEM-ID    PIC X(8).
         10  LS-USER-ID      PIC X(8).
         10  LS-PROGRAM      PIC X(8).
         10  LS-TERMINAL     PIC X(8).
     05  LS-TYPE            PIC X(4).
     05  LS-ACTION          PIC X(8).
     05  LS-STATUS          PIC X(4).
     05  LS-KEY-INFO.
         10  LS-PORT-ID     PIC X(8).
         10  LS-ACCT-NO     PIC X(10).
     05  LS-BEFORE-IMAGE    PIC X(100).
     05  LS-AFTER-IMAGE     PIC X(100).
     05  LS-MESSAGE         PIC X(100).
     05  LS-RETURN-CODE     PIC S9(4) COMP.
```

**After (LINKAGE SECTION):**  
```cobol
 01  LS-AUDIT-REQUEST.
     05  LS-SYSTEM-INFO.
         10  LS-SYSTEM-ID    PIC X(8).
         10  LS-USER-ID      PIC X(8).
         10  LS-PROGRAM      PIC X(8).
         10  LS-TERMINAL     PIC X(8).
     05  LS-TYPE            PIC X(4).
     05  LS-ACTION          PIC X(8).
     05  LS-STATUS          PIC X(4).
     05  LS-KEY-INFO.
         10  LS-PORT-ID     PIC X(8).
         10  LS-ACCT-NO     PIC X(10).
     05  LS-BEFORE-IMAGE    PIC X(100).
     05  LS-AFTER-IMAGE     PIC X(100).
     05  LS-MESSAGE         PIC X(100).
     05  LS-RETURN-CODE     PIC S9(4) COMP.
*-- Change: Add linkage for feed error/alert handling
     05  LS-FEED-ERROR-CODE PIC X(10).
     05  LS-FEED-STATUS     PIC X(8).
     05  LS-FEED-ALARM      PIC X(1).
```

**Before (2000-PROCESS-AUDIT):**  
```cobol
     MOVE LS-MESSAGE         TO AUD-MESSAGE
```

**After (2000-PROCESS-AUDIT):**  
```cobol
     MOVE LS-MESSAGE         TO AUD-MESSAGE
*-- Change: Move feed error/status/alarm to audit record for traceability
     MOVE LS-FEED-ERROR-CODE TO AUD-ERROR-CODE
     MOVE LS-FEED-STATUS     TO AUD-FEED-STATUS
     MOVE LS-FEED-ALARM      TO AUD-FEED-ALARM
```

#### src/programs/batch/POSUPDT.cbl

**Before:**  
```cobol
*-- Change: File exists but is empty. No legacy logic to update. 
*-- Change: New logic will be implemented by the next agent as per impact analysis requirements.
```

**After:**  
```cobol
*-- Change: File exists but is empty. No legacy logic to update. 
*-- Change: New logic will be implemented by the next agent as per impact analysis requirements.
```
*(No changes; file remains empty for next agent's implementation.)*

## 4. Conclusion  
The changes introduce new fields for real-time market price and timestamp in position records, and enhance audit logging with market feed error, status, and alarm indicators. The audit processing subroutine is updated to handle these new fields, ensuring comprehensive traceability and operational monitoring. The batch update program is prepared for future logic to apply real-time prices and store P&L, supporting evolving business and compliance requirements.

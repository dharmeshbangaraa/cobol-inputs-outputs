# Technical Document and Low-Level Design (LLD)

## 1. Introduction  
This document details the technical changes and low-level design updates made to the COBOL applications `PORTTRAN` (Portfolio Transaction Processing) and `RPTPOS00` (Daily Position Report Generator) to support enhanced transaction categorization using a new `TRANSACTION-TYPE` field. The document explains the rationale, impacted logic, insertion points, and provides structured diffs and flow diagrams.

## 2. Existing Logic and Flow  
### 2.1 Overview  
- **PORTTRAN** processes portfolio transactions by reading transaction records, validating them, updating portfolio positions, and logging audit information.
- **RPTPOS00** generates daily position reports by summarizing portfolio positions, transaction activity, and exceptions.

### 2.2 Detailed Logic  
#### PORTTRAN
- **Initialization:** Opens transaction and portfolio files, initializes counters and flags (Lines: 1000-INITIALIZE).
- **Transaction Processing:** Reads each transaction, defaults missing `TRANSACTION-TYPE`, validates, and updates positions (Lines: 2000-PROCESS-TRANSACTIONS).
- **Validation:** Checks portfolio ID, transaction type, and amounts (Lines: 2100-2130).
- **Audit Trail:** Records transaction details, including the new `TRANSACTION-TYPE` (Lines: 2300-UPDATE-AUDIT-TRAIL).
- **Termination:** Closes files and displays summary statistics (Lines: 3000-TERMINATE).

#### RPTPOS00
- **Initialization:** Opens required files and writes report headers (Lines: 1000-1200).
- **Report Generation:** Reads positions and transactions, formats and writes details, including the new `TRANSACTION-TYPE` (Lines: 2000-2210).
- **Summary:** Writes totals, exceptions, and metrics (Lines: 2300-2330).
- **Cleanup:** Closes files and handles errors (Lines: 3000, 9999).

#### Flowchart:  
```
flowchart TD
    Start(["Start"])
    Init["Initialize\n(Open files, set counters)"]
    ReadTrans["Read Transaction"]
    DefaultType["Default TRANSACTION-TYPE\nif missing"]
    Validate["Validate Transaction"]
    Valid?{"Valid?"}
    UpdatePos["Update Portfolio Positions"]
    AuditTrail["Update Audit Trail"]
    ErrorRoutine["Error Routine"]
    NextTrans["Next Transaction"]
    Terminate["Terminate\n(Close files, display stats)"]
    End(["End"])

    Start --> Init
    Init --> ReadTrans
    ReadTrans --> DefaultType
    DefaultType --> Validate
    Validate --> Valid?
    Valid? -- Yes --> UpdatePos
    Valid? -- No --> ErrorRoutine
    UpdatePos --> AuditTrail
    AuditTrail --> NextTrans
    ErrorRoutine --> NextTrans
    NextTrans -->|More records| ReadTrans
    NextTrans -->|End of file| Terminate
    Terminate --> End
```

## 3. Impacted Changes  
### 3.1 User Story or Analysis Report Summary  
Enhance transaction processing and reporting by introducing a new `TRANSACTION-TYPE` field to:
- Allow extended categorization of transactions.
- Ensure backward compatibility by defaulting missing values.
- Display the new field in reports and audit logs.

### 3.2 Impacted Code Changes Summary:
#### 3.2.1 Impacted Sections and Files:
- **Files:**  
  - `TRNREC` copybook (transaction record structure)
  - `PORTTRAN` (Portfolio Transaction Processing)
  - `RPTPOS00` (Daily Position Report Generator)
- **Purpose of Changes:**  
  - Add `TRANSACTION-TYPE` field to transaction records for enhanced classification.
  - Ensure backward compatibility by defaulting missing values.
  - Include the new field in audit logs and reports.
- **Impact:**  
  - Enables more granular transaction reporting and processing.
  - Maintains compatibility with legacy data.
  - Improves auditability and transparency of transaction processing.

### 3.3 Insertion Points  
- **TRNREC Copybook:**  
  - Added `TRN-TRANSACTION-TYPE` (PIC X(10)) after `TRN-TYPE` in the transaction record structure.
  - Reduced filler by 10 bytes to accommodate the new field.
- **PORTTRAN:**
  - **WORKING-STORAGE:**  
    - Added `WS-DEFAULT-TRAN-TYPE` for defaulting.
  - **2000-PROCESS-TRANSACTIONS:**  
    - After reading each transaction, if `TRANSACTION-TYPE` is missing, set it to default.
  - **2300-UPDATE-AUDIT-TRAIL:**  
    - Added `TRANSACTION-TYPE` to audit message.
- **RPTPOS00:**
  - **WORKING-STORAGE:**  
    - Added fields to handle and display `TRANSACTION-TYPE`.
  - **2210-READ-TRANSACTIONS:**  
    - If `TRANSACTION-TYPE` is missing, default and track missing count.
    - Display `TRANSACTION-TYPE` in the transaction detail section of the report.

### 3.4 Structured Diffs  
#### TRNREC Copybook  
**Before:**  
```cobol
     10  TRN-TYPE           PIC X(02).
         88  TRN-TYPE-BUY     VALUE 'BU'.
         88  TRN-TYPE-SELL    VALUE 'SL'.
         88  TRN-TYPE-TRANS   VALUE 'TR'.
         88  TRN-TYPE-FEE     VALUE 'FE'.
     10  TRN-QUANTITY       PIC S9(11)V9(4) COMP-3.
     10  TRN-PRICE         PIC S9(11)V9(4) COMP-3.
     10  TRN-AMOUNT        PIC S9(13)V9(2) COMP-3.
     10  TRN-CURRENCY      PIC X(03).
     10  TRN-STATUS        PIC X(01).
```
**After:**  
```cobol
     10  TRN-TYPE           PIC X(02).
         88  TRN-TYPE-BUY     VALUE 'BU'.
         88  TRN-TYPE-SELL    VALUE 'SL'.
         88  TRN-TYPE-TRANS   VALUE 'TR'.
         88  TRN-TYPE-FEE     VALUE 'FE'.
     10  TRN-TRANSACTION-TYPE PIC X(10).
*        ^^^ Added: TRANSACTION-TYPE field for enhanced transaction categorization
     10  TRN-QUANTITY       PIC S9(11)V9(4) COMP-3.
     10  TRN-PRICE         PIC S9(11)V9(4) COMP-3.
     10  TRN-AMOUNT        PIC S9(13)V9(2) COMP-3.
     10  TRN-CURRENCY      PIC X(03).
     10  TRN-STATUS        PIC X(01).
```

#### PORTTRAN (2000-PROCESS-TRANSACTIONS)
**Before:**  
```cobol
     READ TRANSACTION-FILE
         AT END
             SET END-OF-FILE TO TRUE
         NOT AT END
             ADD 1 TO WS-READ-COUNT
             PERFORM 2100-VALIDATE-TRANSACTION
     END-READ
     .
```
**After:**  
```cobol
     READ TRANSACTION-FILE
         AT END
             SET END-OF-FILE TO TRUE
         NOT AT END
             ADD 1 TO WS-READ-COUNT

*-- Ensure backward compatibility: Default TRANSACTION-TYPE if missing
             IF TRN-TRANSACTION-TYPE = SPACES OR TRN-TRANSACTION-TYPE = LOW-VALUES
                 MOVE WS-DEFAULT-TRAN-TYPE TO TRN-TRANSACTION-TYPE
             END-IF
*-- End backward compatibility logic

             PERFORM 2100-VALIDATE-TRANSACTION
     END-READ
     .
```

#### PORTTRAN (2300-UPDATE-AUDIT-TRAIL)
**Before:**  
```cobol
     STRING 'Transaction: ' DELIMITED BY SIZE
            TRN-TYPE       DELIMITED BY SIZE
            ' Amount: '    DELIMITED BY SIZE
            TRN-AMOUNT     DELIMITED BY SIZE
            ' Units: '     DELIMITED BY SIZE
            TRN-QUANTITY   DELIMITED BY SIZE
       INTO AUD-MESSAGE
```
**After:**  
```cobol
     STRING 'Transaction: ' DELIMITED BY SIZE
            TRN-TYPE       DELIMITED BY SIZE
            ' Type: '      DELIMITED BY SIZE
            TRN-TRANSACTION-TYPE DELIMITED BY SIZE
*        ^^^ Added TRANSACTION-TYPE to audit message
            ' Amount: '    DELIMITED BY SIZE
            TRN-AMOUNT     DELIMITED BY SIZE
            ' Units: '     DELIMITED BY SIZE
            TRN-QUANTITY   DELIMITED BY SIZE
       INTO AUD-MESSAGE
```

#### RPTPOS00 (WORKING-STORAGE and 2210-READ-TRANSACTIONS)
**Before:**  
```cobol
 01  WS-TRANSACTION-DETAIL.
     05  WS-TRAN-DATE         PIC X(8).
     05  FILLER               PIC X(1) VALUE ' '.
     05  WS-TRAN-TIME         PIC X(6).
     05  FILLER               PIC X(1) VALUE ' '.
     05  WS-TRAN-PORTFOLIO    PIC X(8).
     05  FILLER               PIC X(1) VALUE ' '.
     05  WS-TRAN-TYPE         PIC X(2).
     05  FILLER               PIC X(1) VALUE ' '.
     05  WS-TRAN-AMOUNT       PIC -ZZZZZZZZ9.99.
     05  FILLER               PIC X(1) VALUE ' '.
     05  WS-TRAN-STATUS       PIC X(1).
     05  FILLER               PIC X(97) VALUE SPACES.
```
**After:**  
```cobol
 01  WS-TRANSACTION-DETAIL.
     05  WS-TRAN-DATE         PIC X(8).
     05  FILLER               PIC X(1) VALUE ' '.
     05  WS-TRAN-TIME         PIC X(6).
     05  FILLER               PIC X(1) VALUE ' '.
     05  WS-TRAN-PORTFOLIO    PIC X(8).
     05  FILLER               PIC X(1) VALUE ' '.
     05  WS-TRAN-TYPE         PIC X(2).
     05  FILLER               PIC X(1) VALUE ' '.
     05  WS-TRAN-TRAN-TYPE    PIC X(10).
     05  FILLER               PIC X(1) VALUE ' '.
     05  WS-TRAN-AMOUNT       PIC -ZZZZZZZZ9.99.
     05  FILLER               PIC X(1) VALUE ' '.
     05  WS-TRAN-STATUS       PIC X(1).
     05  FILLER               PIC X(97) VALUE SPACES.
```
**Insertion in 2210-READ-TRANSACTIONS:**
```cobol
 *-- Backward compatibility: Default TRANSACTION-TYPE if missing
         IF TRN-TRANSACTION-TYPE = SPACES OR TRN-TRANSACTION-TYPE = LOW-VALUES
             MOVE WS-REPORT-TRAN-TYPE-DEFAULT TO WS-REPORT-TRAN-TYPE-DISPLAY
             ADD 1 TO WS-REPORT-TRAN-MISSING-TYPE
         ELSE
             MOVE TRN-TRANSACTION-TYPE TO WS-REPORT-TRAN-TYPE-DISPLAY
         END-IF
 *-- End backward compatibility logic

         MOVE TRN-DATE           TO WS-TRAN-DATE
         MOVE TRN-TIME           TO WS-TRAN-TIME
         MOVE TRN-PORTFOLIO-ID   TO WS-TRAN-PORTFOLIO
         MOVE TRN-TYPE           TO WS-TRAN-TYPE
         MOVE WS-REPORT-TRAN-TYPE-DISPLAY TO WS-TRAN-TRAN-TYPE
         MOVE TRN-AMOUNT         TO WS-TRAN-AMOUNT
         MOVE TRN-STATUS         TO WS-TRAN-STATUS

         WRITE REPORT-RECORD FROM WS-TRANSACTION-DETAIL
```

## 4. Conclusion  
The introduction of the `TRANSACTION-TYPE` field in transaction records, processing, and reporting modules enhances the systemâ€™s ability to classify and report on transactions with greater granularity. The changes ensure backward compatibility, maintain data integrity, and improve audit and reporting capabilities. All impacted areas have been updated to handle the new field, default missing values, and display the information in audit logs and reports, ensuring a seamless transition and improved business insight.

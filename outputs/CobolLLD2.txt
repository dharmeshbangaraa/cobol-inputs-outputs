# Technical Document and Low-Level Design (LLD)

## 1. Introduction  
This document details the technical changes and low-level design (LLD) for the COBOL application module `PORTUPDT`, which is responsible for updating portfolio records. The recent enhancements integrate a real-time price feed, dynamic valuation, improved error handling, and comprehensive audit logging. This document aims to provide a clear understanding of the new logic, impacted areas, and the rationale behind these changes.

## 2. Existing Logic and Flow  
### 2.1 Overview  
The `PORTUPDT` program processes portfolio updates by reading update instructions, applying them to portfolio records, and maintaining an audit trail. The application now incorporates real-time price data to ensure up-to-date valuations and logs all significant events, including failures in price feed retrieval.

### 2.2 Detailed Logic  
- **Initialization:**  
  - Initializes working storage and opens all required files, including the new real-time price feed file.  
  - Validates successful file openings and terminates if any file fails to open.

- **Processing:**  
  - Reads update records sequentially.
  - For each update:
    - Locates the corresponding portfolio record.
    - Retrieves the latest price from the real-time price feed.
    - Updates the portfolio record with new values and real-time price if available.
    - Handles errors if the price feed is unavailable.
    - Logs all update and error events in the audit trail.

- **Termination:**  
  - Closes all files and displays summary statistics.

#### Flowchart:  
```
flowchart TD
    Start(["Start"])
    Init["Initialize
Working Storage
Open Files"]
    CheckFiles["Check File
Open Status"]
    ErrorOpen["File Open
Error?"]
    ProcessLoop["Read Update
Record"]
    EOF["End of
File?"]
    ProcessUpdate["Process
Update"]
    FindPortfolio["Read Portfolio
Record"]
    FoundPortfolio["Portfolio
Found?"]
    GetPrice["Get Real-Time
Price"]
    PriceFound["Price
Found?"]
    UpdatePortfolio["Update Portfolio
with Real-Time Price"]
    FeedError["Log Feed
Error"]
    ApplyUpdate["Apply
Update"]
    AuditUpdate["Audit
Update"]
    AuditFailure["Audit Feed
Failure"]
    NotFound["Log Record
Not Found"]
    NextRecord["Next
Record"]
    Terminate["Terminate:
Close Files,
Display Stats"]
    End(["End"])

    Start --> Init
    Init --> CheckFiles
    CheckFiles --> ErrorOpen
    ErrorOpen -- Yes --> Terminate
    ErrorOpen -- No --> ProcessLoop
    ProcessLoop --> EOF
    EOF -- Yes --> Terminate
    EOF -- No --> ProcessUpdate
    ProcessUpdate --> FindPortfolio
    FindPortfolio --> FoundPortfolio
    FoundPortfolio -- No --> NotFound
    NotFound --> NextRecord
    NextRecord --> ProcessLoop
    FoundPortfolio -- Yes --> GetPrice
    GetPrice --> PriceFound
    PriceFound -- Yes --> UpdatePortfolio
    UpdatePortfolio --> ApplyUpdate
    ApplyUpdate --> AuditUpdate
    AuditUpdate --> NextRecord
    PriceFound -- No --> FeedError
    FeedError --> AuditFailure
    AuditFailure --> ApplyUpdate
    ApplyUpdate --> AuditUpdate
    AuditUpdate --> NextRecord
```

## 3. Impacted Changes  
### 3.1 User Story or Analysis Report Summary  
Enhance the portfolio update process to use real-time price data for dynamic valuation, improve error handling when price data is unavailable, and ensure all significant events are logged for audit purposes.

### 3.2 Impacted Code Changes Summary:

#### 3.2.1 Impacted Sections and Files:
- **src/programs/portfolio/PORTUPDT.cbl**
- **src/copybook/common/PORTFLIO.cpy**
- **src/copybook/common/AUDITLOG.cpy**

  - **Purpose of Changes:**  
    - Integrate a real-time price feed for up-to-date portfolio valuations.
    - Add error handling for missing or invalid price data.
    - Enhance audit logging to capture both successful updates and failures related to the price feed.

  - **Impact:**  
    - Portfolio valuations are now based on the latest available prices, improving accuracy.
    - The system is more robust, with explicit handling and logging of price feed errors.
    - Audit trails are more comprehensive, supporting compliance and troubleshooting.

### 3.3 Insertion Points  
- **PORTUPDT.cbl**
  - **File Control Section:**  
    - Added `PRICEFEED-FILE` definition for real-time price data.
  - **File Section:**  
    - Added FD for `PRICEFEED-FILE` and its record layout.
  - **Working-Storage Section:**  
    - Added variables for real-time price, timestamp, feed status, and audit record.
  - **1000-INITIALIZE:**  
    - Opened `PRICEFEED-FILE` and checked its status.
  - **2100-PROCESS-UPDATE:**  
    - Invoked `2150-GET-REALTIME-PRICE` after reading the portfolio record.
    - Updated logic to use real-time price if found; otherwise, set error and audit.
  - **2150-GET-REALTIME-PRICE:**  
    - New paragraph to read and validate real-time price feed.
  - **2200-APPLY-UPDATE:**  
    - Modified to recalculate valuation using real-time price if available.
    - Audit successful updates.
  - **2500-AUDIT-FEED-FAILURE & 2600-AUDIT-REALTIME-UPDATE:**  
    - New/modified paragraphs for audit logging.
  - **3000-TERMINATE:**  
    - Close `PRICEFEED-FILE`.

- **PORTFLIO.cpy**
  - Added `PORT-REALTIME-PRICE` and `PORT-PRICE-TIMESTAMP` fields to the portfolio record.

- **AUDITLOG.cpy**
  - Added fields for feed failure, outdated price, and update event indicators.

### 3.4 Structured Diffs  

#### **PORTUPDT.cbl**

**Before (File Control Section):**
```cobol
SELECT PORTFOLIO-FILE
    ASSIGN TO PORTFILE
    ORGANIZATION IS INDEXED
    ACCESS MODE IS RANDOM
    RECORD KEY IS PORT-KEY
    FILE STATUS IS WS-FILE-STATUS.

SELECT UPDATE-FILE
    ASSIGN TO UPDTFILE
    ORGANIZATION IS SEQUENTIAL
    FILE STATUS IS WS-UPDT-STATUS.
```
**After:**
```cobol
SELECT PORTFOLIO-FILE
    ASSIGN TO PORTFILE
    ORGANIZATION IS INDEXED
    ACCESS MODE IS RANDOM
    RECORD KEY IS PORT-KEY
    FILE STATUS IS WS-FILE-STATUS.

SELECT UPDATE-FILE
    ASSIGN TO UPDTFILE
    ORGANIZATION IS SEQUENTIAL
    FILE STATUS IS WS-UPDT-STATUS.
*-- Change: Add real-time price feed file definition
SELECT PRICEFEED-FILE
    ASSIGN TO PRICEFEED
    ORGANIZATION IS SEQUENTIAL
    FILE STATUS IS WS-PRICEFEED-STATUS.
```

**Before (File Section):**
```cobol
FD  PORTFOLIO-FILE.
    COPY PORTFLIO.

FD  UPDATE-FILE.
01  UPDATE-RECORD.
    ...
```
**After:**
```cobol
FD  PORTFOLIO-FILE.
    COPY PORTFLIO.

FD  UPDATE-FILE.
01  UPDATE-RECORD.
    ...
*-- Change: Add real-time price feed record
FD  PRICEFEED-FILE.
01  PRICEFEED-RECORD.
    05  PF-PORT-ID         PIC X(8).
    05  PF-PRICE           PIC S9(13)V99 COMP-3.
    05  PF-TIMESTAMP       PIC X(26).
    05  PF-STATUS          PIC X(1).
        88  PF-VALID       VALUE 'Y'.
        88  PF-INVALID     VALUE 'N'.
```

**Before (Working-Storage Section):**
```cobol
01  WS-WORK-AREAS.
    05  WS-UPDATE-COUNT     PIC 9(7) VALUE ZERO.
    05  WS-ERROR-COUNT      PIC 9(7) VALUE ZERO.
    05  WS-RETURN-CODE      PIC S9(4) VALUE +0.
    05  WS-NUMERIC-WORK     PIC S9(13)V99.
```
**After:**
```cobol
01  WS-WORK-AREAS.
    05  WS-UPDATE-COUNT     PIC 9(7) VALUE ZERO.
    05  WS-ERROR-COUNT      PIC 9(7) VALUE ZERO.
    05  WS-RETURN-CODE      PIC S9(4) VALUE +0.
    05  WS-NUMERIC-WORK     PIC S9(13)V99.
*-- Change: Add real-time price and timestamp work areas
    05  WS-REALTIME-PRICE   PIC S9(13)V99 COMP-3 VALUE ZERO.
    05  WS-REALTIME-TIMESTAMP PIC X(26) VALUE SPACES.
    05  WS-PRICE-FOUND      PIC X VALUE 'N'.
        88  PRICE-FOUND     VALUE 'Y'.
        88  PRICE-NOT-FOUND VALUE 'N'.
    05  WS-FEED-ERROR       PIC X VALUE 'N'.
        88  FEED-ERROR      VALUE 'Y'.
        88  NO-FEED-ERROR   VALUE 'N'.
*-- Change: Add audit log record
01  WS-AUDIT-RECORD.
    COPY AUDITLOG.
```

**Before (1000-INITIALIZE):**
```cobol
OPEN I-O   PORTFOLIO-FILE
OPEN INPUT UPDATE-FILE

IF NOT WS-SUCCESS-STATUS OR 
   NOT WS-UPDT-SUCCESS
   DISPLAY 'Error opening files: ' 
           'PORT=' WS-FILE-STATUS
           'UPDT=' WS-UPDT-STATUS
   MOVE WS-ERROR TO WS-RETURN-CODE
   PERFORM 3000-TERMINATE
END-IF
```
**After:**
```cobol
OPEN I-O   PORTFOLIO-FILE
OPEN INPUT UPDATE-FILE
*-- Change: Open price feed file
OPEN INPUT PRICEFEED-FILE

IF NOT WS-SUCCESS-STATUS OR 
   NOT WS-UPDT-SUCCESS
   DISPLAY 'Error opening files: ' 
           'PORT=' WS-FILE-STATUS
           'UPDT=' WS-UPDT-STATUS
   MOVE WS-ERROR TO WS-RETURN-CODE
   PERFORM 3000-TERMINATE
END-IF
*-- Change: Check price feed file open status
IF NOT WS-PRICEFEED-SUCCESS
   DISPLAY 'Error opening price feed file: ' WS-PRICEFEED-STATUS
   MOVE WS-ERROR TO WS-RETURN-CODE
   PERFORM 3000-TERMINATE
END-IF
```

**Before (2100-PROCESS-UPDATE):**
```cobol
MOVE UPDT-KEY TO PORT-KEY

READ PORTFOLIO-FILE

IF WS-SUCCESS-STATUS
    PERFORM 2200-APPLY-UPDATE
ELSE
    ADD 1 TO WS-ERROR-COUNT
    DISPLAY 'Record not found: ' PORT-KEY
END-IF
.
```
**After:**
```cobol
MOVE UPDT-KEY TO PORT-KEY

READ PORTFOLIO-FILE

IF WS-SUCCESS-STATUS
*-- Change: Integrate real-time price feed lookup
    PERFORM 2150-GET-REALTIME-PRICE
    IF PRICE-FOUND
        MOVE WS-REALTIME-PRICE TO PORT-REALTIME-PRICE
        MOVE WS-REALTIME-TIMESTAMP TO PORT-PRICE-TIMESTAMP
    ELSE
        SET FEED-ERROR TO TRUE
        DISPLAY 'Real-time price not found for: ' PORT-KEY
*-- Change: Audit feed failure
        PERFORM 2500-AUDIT-FEED-FAILURE
    END-IF
    PERFORM 2200-APPLY-UPDATE
ELSE
    ADD 1 TO WS-ERROR-COUNT
    DISPLAY 'Record not found: ' PORT-KEY
END-IF
.
```

**New Paragraph (2150-GET-REALTIME-PRICE):**
```cobol
2150-GET-REALTIME-PRICE.
    MOVE 'N' TO WS-PRICE-FOUND
    MOVE 'N' TO WS-FEED-ERROR
    MOVE ZERO TO WS-REALTIME-PRICE
    MOVE SPACES TO WS-REALTIME-TIMESTAMP
    READ PRICEFEED-FILE
        AT END
            SET WS-PRICEFEED-EOF TO TRUE
        NOT AT END
            IF PF-PORT-ID = PORT-ID AND PF-VALID
                MOVE PF-PRICE TO WS-REALTIME-PRICE
                MOVE PF-TIMESTAMP TO WS-REALTIME-TIMESTAMP
                SET PRICE-FOUND TO TRUE
            ELSE
                SET PRICE-NOT-FOUND TO TRUE
            END-IF
    END-READ
    .
```

**Before (2200-APPLY-UPDATE):**
```cobol
EVALUATE TRUE
    WHEN UPDT-STATUS
        MOVE UPDT-NEW-VALUE TO PORT-STATUS
    WHEN UPDT-NAME
        MOVE UPDT-NEW-VALUE TO PORT-CLIENT-NAME
    WHEN UPDT-VALUE
        MOVE UPDT-NEW-VALUE TO WS-NUMERIC-WORK
        MOVE WS-NUMERIC-WORK TO PORT-TOTAL-VALUE
END-EVALUATE

REWRITE PORT-RECORD

IF WS-SUCCESS-STATUS
    ADD 1 TO WS-UPDATE-COUNT
ELSE
    ADD 1 TO WS-ERROR-COUNT
    DISPLAY 'Update failed for: ' PORT-KEY
END-IF
.
```
**After:**
```cobol
EVALUATE TRUE
    WHEN UPDT-STATUS
        MOVE UPDT-NEW-VALUE TO PORT-STATUS
    WHEN UPDT-NAME
        MOVE UPDT-NEW-VALUE TO PORT-CLIENT-NAME
    WHEN UPDT-VALUE
        MOVE UPDT-NEW-VALUE TO WS-NUMERIC-WORK
        MOVE WS-NUMERIC-WORK TO PORT-TOTAL-VALUE
*-- Change: Recalculate valuation using real-time price if available
        IF PRICE-FOUND
            COMPUTE PORT-TOTAL-VALUE = WS-REALTIME-PRICE
        END-IF
END-EVALUATE

REWRITE PORT-RECORD

IF WS-SUCCESS-STATUS
    ADD 1 TO WS-UPDATE-COUNT
*-- Change: Audit successful update
    PERFORM 2600-AUDIT-REALTIME-UPDATE
ELSE
    ADD 1 TO WS-ERROR-COUNT
    DISPLAY 'Update failed for: ' PORT-KEY
END-IF
.
```

**New Paragraphs (2500-AUDIT-FEED-FAILURE and 2600-AUDIT-REALTIME-UPDATE):**
```cobol
2500-AUDIT-FEED-FAILURE.
    MOVE FUNCTION CURRENT-DATE TO AUD-TIMESTAMP OF WS-AUDIT-RECORD
    MOVE WS-PROGRAM-NAME TO AUD-PROGRAM OF WS-AUDIT-RECORD
    MOVE 'SYST' TO AUD-TYPE OF WS-AUDIT-RECORD
    MOVE 'FAIL' TO AUD-STATUS OF WS-AUDIT-RECORD
    MOVE PORT-ID TO AUD-PORTFOLIO-ID OF WS-AUDIT-RECORD
    MOVE PORT-ACCOUNT-NO TO AUD-ACCOUNT-NO OF WS-AUDIT-RECORD
    MOVE 'FEEDFAIL' TO AUD-ACTION OF WS-AUDIT-RECORD
    MOVE 'Real-time price feed failure' TO AUD-MESSAGE OF WS-AUDIT-RECORD
    .

2600-AUDIT-REALTIME-UPDATE.
    MOVE FUNCTION CURRENT-DATE TO AUD-TIMESTAMP OF WS-AUDIT-RECORD
    MOVE WS-PROGRAM-NAME TO AUD-PROGRAM OF WS-AUDIT-RECORD
    MOVE 'TRAN' TO AUD-TYPE OF WS-AUDIT-RECORD
    MOVE 'SUCC' TO AUD-STATUS OF WS-AUDIT-RECORD
    MOVE PORT-ID TO AUD-PORTFOLIO-ID OF WS-AUDIT-RECORD
    MOVE PORT-ACCOUNT-NO TO AUD-ACCOUNT-NO OF WS-AUDIT-RECORD
    MOVE 'UPDATE' TO AUD-ACTION OF WS-AUDIT-RECORD
    MOVE 'Real-time update applied' TO AUD-MESSAGE OF WS-AUDIT-RECORD
    .
```

**Before (3000-TERMINATE):**
```cobol
CLOSE PORTFOLIO-FILE
      UPDATE-FILE

DISPLAY 'Updates processed: ' WS-UPDATE-COUNT
DISPLAY 'Errors occurred:  ' WS-ERROR-COUNT

MOVE WS-RETURN-CODE TO RETURN-CODE
.
```
**After:**
```cobol
CLOSE PORTFOLIO-FILE
      UPDATE-FILE
*-- Change: Close price feed file
      PRICEFEED-FILE

DISPLAY 'Updates processed: ' WS-UPDATE-COUNT
DISPLAY 'Errors occurred:  ' WS-ERROR-COUNT

MOVE WS-RETURN-CODE TO RETURN-CODE
.
```

---

#### **PORTFLIO.cpy**

**Before:**
```cobol
05  PORT-FINANCIAL-INFO.
    10  PORT-TOTAL-VALUE    PIC S9(13)V99 COMP-3.
    10  PORT-CASH-BALANCE   PIC S9(13)V99 COMP-3.
```
**After:**
```cobol
05  PORT-FINANCIAL-INFO.
    10  PORT-TOTAL-VALUE    PIC S9(13)V99 COMP-3.
    10  PORT-CASH-BALANCE   PIC S9(13)V99 COMP-3.
*-- Change: Add real-time price and timestamp fields
    10  PORT-REALTIME-PRICE PIC S9(13)V99 COMP-3.
    10  PORT-PRICE-TIMESTAMP PIC X(26).
```

---

#### **AUDITLOG.cpy**

**Before:**
```cobol
01  AUDIT-RECORD.
    ...
    05  AUD-MESSAGE          PIC X(100).
```
**After:**
```cobol
01  AUDIT-RECORD.
    ...
    05  AUD-MESSAGE          PIC X(100).
*-- Change: Add feed failure, outdated price, update event fields
    05  AUD-FEED-FAILURE     PIC X(1).
        88  AUD-FEED-FAIL      VALUE 'Y'.
        88  AUD-FEED-OK        VALUE 'N'.
    05  AUD-OUTDATED-PRICE   PIC X(1).
        88  AUD-PRICE-OLD      VALUE 'Y'.
        88  AUD-PRICE-OK       VALUE 'N'.
    05  AUD-UPDATE-EVENT     PIC X(1).
        88  AUD-UPDATE-REALTIME VALUE 'Y'.
        88  AUD-UPDATE-BATCH    VALUE 'N'.
```

## 4. Conclusion  
The implemented changes enable the `PORTUPDT` program to leverage real-time price data for portfolio valuation, improving the accuracy and timeliness of updates. Enhanced error handling ensures that missing or invalid price data is detected and logged, while the expanded audit trail supports compliance and operational transparency. These improvements collectively strengthen the reliability and auditability of the portfolio update process.

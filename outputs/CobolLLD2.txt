# Technical Document and Low-Level Design (LLD)

## 1. Introduction  
This document details the recent enhancements made to the COBOL-based portfolio management system. The primary focus of these changes is the introduction of a new transaction classification field (`TRN-TRANSACTION-TYPE`) across the transaction record structure, transaction processing, and reporting modules. This document provides a comprehensive low-level design (LLD2) and technical explanation of the changes, including logic insertion points, structured diffs, and rationale.

## 2. Existing Logic and Flow  
### 2.1 Overview  
The application manages portfolio transactions, including buying, selling, transferring, and fee processing. It validates transactions, updates portfolio positions, maintains audit trails, and generates daily reports summarizing positions and transaction activities.

### 2.2 Detailed Logic  
- **Transaction Record Structure:**  
  The transaction record (`TRNREC.cpy`) defines the data structure for all transaction processing and reporting.
- **Transaction Processing (`PORTTRAN.cbl`):**  
  1. Initializes file and working storage.
  2. Reads and validates each transaction.
  3. Updates portfolio positions based on transaction type.
  4. Maintains an audit trail for each processed transaction.
- **Reporting (`RPTPOS00.cbl`):**  
  1. Reads position and transaction history.
  2. Generates a daily report, including transaction details and summary metrics.

#### Flowchart:  
```
flowchart TD
    Start([Start])
    Init([Initialize Files & Counters])
    ReadTrans([Read Transaction])
    Validate([Validate Transaction])
    CheckClass([Check TRANSACTION-TYPE])
    Update([Update Portfolio])
    Audit([Update Audit Trail])
    NextTrans{More Transactions?}
    Report([Generate Report])
    End([End])

    Start --> Init
    Init --> ReadTrans
    ReadTrans --> Validate
    Validate --> CheckClass
    CheckClass --> Update
    Update --> Audit
    Audit --> NextTrans
    NextTrans -- Yes --> ReadTrans
    NextTrans -- No --> Report
    Report --> End
```

## 3. Impacted Changes  
### 3.1 User Story or Analysis Report Summary  
**User Story:**  
As a system administrator, I want to classify transactions using a new `TRANSACTION-TYPE` field (e.g., 'REG', 'INTL') so that reporting and validation can distinguish between regular and international transactions.

### 3.2 Impacted Code Changes Summary:

#### 3.2.1 Impacted Sections and Files:  
- **/src/copybook/common/TRNREC.cpy**  
  - *Purpose of Changes:* Added new field `TRN-TRANSACTION-TYPE` (PIC X(04)) to support transaction classification.
  - *Impact:* All modules using this copybook now have access to the new field.
- **/src/programs/portfolio/PORTTRAN.cbl**  
  - *Purpose of Changes:* Added validation for the new field and included it in the audit trail.
  - *Impact:* Transactions are now validated for the new classification; audit logs include this detail.
- **/src/programs/batch/RPTPOS00.cbl**  
  - *Purpose of Changes:* Enhanced reporting to display the transaction class in headers and details.
  - *Impact:* Daily reports now show the new classification for each transaction.

### 3.3 Insertion Points  
- **TRNREC.cpy:**  
  - Inserted `TRN-TRANSACTION-TYPE` after `TRN-STATUS` in the transaction record structure.
  - Adjusted filler to maintain record length.
- **PORTTRAN.cbl:**  
  - In `2100-VALIDATE-TRANSACTION`, added call to new paragraph `2140-CHECK-TRANSACTION-CLASS`.
  - Implemented `2140-CHECK-TRANSACTION-CLASS` to validate allowed values (`REG`, `INTL`).
  - In `2300-UPDATE-AUDIT-TRAIL`, included `TRN-TRANSACTION-TYPE` in the audit message.
- **RPTPOS00.cbl:**  
  - In report header (`WS-HEADER4`), added a new column for `CLASS`.
  - In transaction detail (`WS-TRANSACTION-DETAIL`), added field for transaction class.
  - In `2210-READ-TRANSACTIONS`, moved `TRN-TRANSACTION-TYPE` to the new detail field for output.

### 3.4 Structured Diffs  

#### **1. TRNREC.cpy**  
**Before:**  
```cobol
          05  TRN-DATA.
              10  TRN-INVESTMENT-ID  PIC X(10).
              10  TRN-TYPE           PIC X(02).
                  88  TRN-TYPE-BUY     VALUE 'BU'.
                  88  TRN-TYPE-SELL    VALUE 'SL'.
                  88  TRN-TYPE-TRANS   VALUE 'TR'.
                  88  TRN-TYPE-FEE     VALUE 'FE'.
              10  TRN-QUANTITY       PIC S9(11)V9(4) COMP-3.
              10  TRN-PRICE         PIC S9(11)V9(4) COMP-3.
              10  TRN-AMOUNT        PIC S9(13)V9(2) COMP-3.
              10  TRN-CURRENCY      PIC X(03).
              10  TRN-STATUS        PIC X(01).
                  88  TRN-STATUS-PEND   VALUE 'P'.
                  88  TRN-STATUS-DONE   VALUE 'D'.
                  88  TRN-STATUS-FAIL   VALUE 'F'.
                  88  TRN-STATUS-REV    VALUE 'R'.
```
**After:**  
```cobol
              10  TRN-STATUS        PIC X(01).
                  88  TRN-STATUS-PEND   VALUE 'P'.
                  88  TRN-STATUS-DONE   VALUE 'D'.
                  88  TRN-STATUS-FAIL   VALUE 'F'.
                  88  TRN-STATUS-REV    VALUE 'R'.
              10  TRN-TRANSACTION-TYPE PIC X(04). *> ADDED: New field for transaction type (e.g., 'REG', 'INTL', etc.)
```

#### **2. PORTTRAN.cbl**  
**Before:**  
```cobol
       2100-VALIDATE-TRANSACTION.
           MOVE SPACES TO ERR-TEXT
           
           PERFORM 2110-CHECK-PORTFOLIO
           IF ERR-TEXT = SPACES
               PERFORM 2120-CHECK-TRANSACTION-TYPE
           END-IF
           IF ERR-TEXT = SPACES
               PERFORM 2130-CHECK-AMOUNTS
           END-IF
           IF ERR-TEXT = SPACES
               ADD 1 TO WS-PROCESS-COUNT
           ELSE
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           .
```
**After:**  
```cobol
       2100-VALIDATE-TRANSACTION.
           MOVE SPACES TO ERR-TEXT
           
           PERFORM 2110-CHECK-PORTFOLIO
           IF ERR-TEXT = SPACES
               PERFORM 2120-CHECK-TRANSACTION-TYPE
           END-IF
           IF ERR-TEXT = SPACES
               PERFORM 2130-CHECK-AMOUNTS
           END-IF
           *> BEGIN: Validate new TRANSACTION-TYPE field
           IF ERR-TEXT = SPACES
               PERFORM 2140-CHECK-TRANSACTION-CLASS
           END-IF
           *> END: Validate new TRANSACTION-TYPE field
           IF ERR-TEXT = SPACES
               ADD 1 TO WS-PROCESS-COUNT
           ELSE
               PERFORM 9000-ERROR-ROUTINE
           END-IF
           .
```
**New Paragraph Added:**  
```cobol
       2140-CHECK-TRANSACTION-CLASS.
           IF TRN-TRANSACTION-TYPE = SPACES
               MOVE 'Transaction class is required' TO ERR-TEXT
               EXIT PARAGRAPH
           END-IF
           *> Example: Only allow REG or INTL for now
           IF TRN-TRANSACTION-TYPE NOT = 'REG'
              AND TRN-TRANSACTION-TYPE NOT = 'INTL'
               STRING 'Invalid Transaction Class: '
                      TRN-TRANSACTION-TYPE
                  DELIMITED BY SIZE
                  INTO ERR-TEXT
           END-IF
           .
```
**Audit Trail Update:**  
**Before:**  
```cobol
           STRING 'Transaction: ' DELIMITED BY SIZE
                  TRN-TYPE       DELIMITED BY SIZE
                  ' Amount: '    DELIMITED BY SIZE
                  TRN-AMOUNT     DELIMITED BY SIZE
                  ' Units: '     DELIMITED BY SIZE
                  TRN-QUANTITY   DELIMITED BY SIZE
             INTO AUD-MESSAGE
```
**After:**  
```cobol
           STRING 'Transaction: ' DELIMITED BY SIZE
                  TRN-TYPE       DELIMITED BY SIZE
                  ' Class: '     DELIMITED BY SIZE
                  TRN-TRANSACTION-TYPE DELIMITED BY SIZE
                  ' Amount: '    DELIMITED BY SIZE
                  TRN-AMOUNT     DELIMITED BY SIZE
                  ' Units: '     DELIMITED BY SIZE
                  TRN-QUANTITY   DELIMITED BY SIZE
             INTO AUD-MESSAGE
           *> ADDED: Include TRANSACTION-TYPE in audit message
```

#### **3. RPTPOS00.cbl**  
**Header Update:**  
**Before:**  
```cobol
           05  WS-HEADER4.
               10  FILLER            PIC X(20) VALUE 'TRAN TYPE'.
               10  FILLER            PIC X(10) VALUE 'PORTFOLIO'.
               10  FILLER            PIC X(10) VALUE 'INVESTMENT'.
               10  FILLER            PIC X(10) VALUE 'AMOUNT'.
               10  FILLER            PIC X(10) VALUE 'STATUS'.
               10  FILLER            PIC X(72) VALUE SPACES.
```
**After:**  
```cobol
           05  WS-HEADER4.
               10  FILLER            PIC X(20) VALUE 'TRAN TYPE'.
               10  FILLER            PIC X(10) VALUE 'CLASS'.
               10  FILLER            PIC X(10) VALUE 'PORTFOLIO'.
               10  FILLER            PIC X(10) VALUE 'INVESTMENT'.
               10  FILLER            PIC X(10) VALUE 'AMOUNT'.
               10  FILLER            PIC X(10) VALUE 'STATUS'.
               10  FILLER            PIC X(62) VALUE SPACES.
           *> ADDED: New header for TRANSACTION-TYPE
```
**Detail Update:**  
**Before:**  
```cobol
       01  WS-TRANSACTION-DETAIL.
           05  WS-TRAN-TYPE         PIC X(02).
           05  FILLER               PIC X(1) VALUE SPACE.
           05  WS-TRAN-PORTFOLIO    PIC X(08).
           05  FILLER               PIC X(1) VALUE SPACE.
           05  WS-TRAN-INVESTMENT   PIC X(10).
           05  FILLER               PIC X(1) VALUE SPACE.
           05  WS-TRAN-AMOUNT       PIC ZZZ,ZZZ,ZZ9.99.
           05  FILLER               PIC X(1) VALUE SPACE.
           05  WS-TRAN-STATUS       PIC X(01).
           05  FILLER               PIC X(99) VALUE SPACES.
```
**After:**  
```cobol
       01  WS-TRANSACTION-DETAIL.
           05  WS-TRAN-TYPE         PIC X(02).
           05  FILLER               PIC X(1) VALUE SPACE.
           05  WS-TRAN-CLASS        PIC X(04).
           05  FILLER               PIC X(1) VALUE SPACE.
           05  WS-TRAN-PORTFOLIO    PIC X(08).
           05  FILLER               PIC X(1) VALUE SPACE.
           05  WS-TRAN-INVESTMENT   PIC X(10).
           05  FILLER               PIC X(1) VALUE SPACE.
           05  WS-TRAN-AMOUNT       PIC ZZZ,ZZZ,ZZ9.99.
           05  FILLER               PIC X(1) VALUE SPACE.
           05  WS-TRAN-STATUS       PIC X(01).
           05  FILLER               PIC X(99) VALUE SPACES.
           *> ADDED: TRANSACTION-CLASS field
```
**Transaction Output Logic:**  
**Before:**  
```cobol
               MOVE TRN-TYPE              TO WS-TRAN-TYPE
               MOVE TRN-PORTFOLIO-ID      TO WS-TRAN-PORTFOLIO
               MOVE TRN-INVESTMENT-ID     TO WS-TRAN-INVESTMENT
               MOVE TRN-AMOUNT            TO WS-TRAN-AMOUNT
               MOVE TRN-STATUS            TO WS-TRAN-STATUS
               WRITE REPORT-RECORD FROM WS-TRANSACTION-DETAIL
```
**After:**  
```cobol
               MOVE TRN-TYPE              TO WS-TRAN-TYPE
               MOVE TRN-TRANSACTION-TYPE  TO WS-TRAN-CLASS
               MOVE TRN-PORTFOLIO-ID      TO WS-TRAN-PORTFOLIO
               MOVE TRN-INVESTMENT-ID     TO WS-TRAN-INVESTMENT
               MOVE TRN-AMOUNT            TO WS-TRAN-AMOUNT
               MOVE TRN-STATUS            TO WS-TRAN-STATUS
               WRITE REPORT-RECORD FROM WS-TRANSACTION-DETAIL
               *> Output transaction details with new TRANSACTION-TYPE field
```

## 4. Conclusion  
The introduction of the `TRN-TRANSACTION-TYPE` field enhances the system's ability to classify and report on transactions, supporting future business requirements for transaction differentiation. The changes are isolated, backward-compatible, and thoroughly validated at both the processing and reporting levels. This update paves the way for more granular analytics and compliance with evolving business needs.


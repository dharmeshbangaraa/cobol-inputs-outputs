# Technical Document and Low-Level Design (LLD)

## 1. Introduction  
This document details the recent enhancements and modifications made to the COBOL application modules responsible for portfolio updates, recovery processing, and audit reporting. The primary focus of these changes is the integration of real-time market data feeds, timestamping of price updates, audit triggers, and improved error logging for feed processing. This document serves as a comprehensive reference for developers, testers, and maintainers to understand the low-level design and implementation details of the impacted modules.

## 2. Existing Logic and Flow  
### 2.1 Overview  
The application suite consists of several modules:
- **PORTUPDT**: Updates portfolio records based on incoming update files.
- **RCVPRC00**: Handles batch process recovery, including error handling and process restarts.
- **RPTAUD00**: Generates audit and error reports for system processes.
- **PORTFLIO**: Defines the portfolio master record structure.

### 2.2 Detailed Logic  
#### PORTUPDT (Portfolio Update Program)
- **Initialization**: Opens portfolio, update, and (now) price feed files. (Lines 1000-INITIALIZE)
- **Processing**: 
  - Processes real-time price feed records before standard updates (Lines 1500-PROCESS-PRICEFEED).
  - Applies updates from the update file, including status, name, and value changes (Lines 2000-PROCESS, 2100-PROCESS-UPDATE, 2200-APPLY-UPDATE).
  - Updates last price timestamp and triggers audit logs on value changes.
- **Termination**: Closes all files and displays summary statistics (Lines 3000-TERMINATE).

#### RCVPRC00 (Process Recovery Handler)
- **Initialization**: Opens control, sequence, and (now) market data feed files (1000-INITIALIZE-RECOVERY).
- **Processing**: 
  - Handles recovery based on process, sequence, or all modes (2000-PROCESS-RECOVERY).
  - Polls real-time market data feed, logs errors, and triggers audit logs for invalid prices (2500-POLL-MARKETDATA).
- **Termination**: Updates final status and closes all files (3000-TERMINATE-RECOVERY).

#### RPTAUD00 (Audit Report Generator)
- **Initialization**: Opens audit, error, report, and (now) feed error log files (1100-OPEN-FILES).
- **Processing**: 
  - Processes audit trails, error logs, and feed error logs (2000-PROCESS-REPORT).
  - Summarizes and writes reports for each log type.
- **Termination**: Closes all files (3000-CLEANUP).

#### PORTFLIO (Portfolio Master Record Layout)
- Defines the structure of portfolio records, now including last price timestamp and a historical price array.

#### Flowchart:
```
flowchart TD
    Start(["Start"])
    Init["Initialize
Files"]
    PriceFeed["Process
Real-Time Price Feed"]
    Updates["Process
Update File"]
    ApplyUpdate["Apply
Update to Portfolio"]
    AuditLog["Trigger
Audit Log"]
    Terminate["Terminate
and Close Files"]
    MarketFeed["Poll
Market Data Feed"]
    FeedError["Log
Feed Errors"]
    Report["Generate
Audit/Error/Feed Reports"]
    End(["End"])

    Start --> Init
    Init --> PriceFeed
    PriceFeed --> Updates
    Updates --> ApplyUpdate
    ApplyUpdate --> AuditLog
    AuditLog --> Terminate
    Terminate --> End

    PriceFeed -.-> MarketFeed
    MarketFeed -.-> FeedError
    FeedError -.-> Report
    Report -.-> End
```

## 3. Impacted Changes  
### 3.1 User Story or Analysis Report Summary  
- Integrate real-time market price feeds into portfolio and batch recovery processing.
- Timestamp all price updates and maintain historical price data.
- Trigger audit logs for all value changes and feed errors.
- Enhance audit reporting to include feed error logs.

### 3.2 Impacted Code Changes Summary:
#### 3.2.1 Impacted Sections and Files:
- **src/programs/portfolio/PORTUPDT.cbl**: Portfolio update logic, price feed integration, audit triggers.
- **src/programs/batch/RCVPRC00.cbl**: Batch recovery, market data polling, audit/error logging.
- **src/copybook/common/PORTFLIO.cpy**: Portfolio record structure, timestamp, and historical price fields.
- **src/programs/batch/RPTAUD00.cbl**: Audit report generation, feed error log integration.

  - **Purpose of Changes**:  
    To enable real-time integration of market data, ensure all price changes are timestamped and auditable, and provide comprehensive reporting of feed-related errors for compliance and operational transparency.

  - **Impact**:  
    - Real-time price and market data can now update portfolios and recovery processes.
    - All price changes are timestamped and historical data is retained.
    - Audit logs are triggered for all value changes and feed errors.
    - Audit reports now include feed error logs, improving traceability and error analysis.

### 3.3 Insertion Points  
- **PORTUPDT.cbl**:
  - File-control and file section: Add `PRICEFEED-FILE` and related record definitions.
  - Working-storage: Add timestamp and price work areas.
  - 0000-MAIN: Insert `PERFORM 1500-PROCESS-PRICEFEED` before update processing.
  - 1000-INITIALIZE: Open `PRICEFEED-FILE`.
  - 1500-PROCESS-PRICEFEED: New section for processing price feed records.
  - 2200-APPLY-UPDATE: Insert timestamp update and audit log call after value update.
  - 3000-TERMINATE: Close `PRICEFEED-FILE`.

- **RCVPRC00.cbl**:
  - File-control and file section: Add `MARKETDATA-FILE` and related record definitions.
  - Working-storage: Add market data status and error count.
  - 0000-MAIN: Insert `PERFORM 2500-POLL-MARKETDATA` after recovery processing.
  - 1000-INITIALIZE-RECOVERY: Open `MARKETDATA-FILE`.
  - 2500-POLL-MARKETDATA: New section for polling market data, error handling, and audit log calls.
  - 3000-TERMINATE-RECOVERY: Close `MARKETDATA-FILE`.

- **PORTFLIO.cpy**:
  - Add `PORT-LAST-PRICE-TS` and `PORT-HIST-PRICE` array to `PORT-FINANCIAL-INFO`.

- **RPTAUD00.cbl**:
  - File-control and file section: Add `FEEDERR-FILE` and related record definitions.
  - Working-storage: Add feed error status and detail.
  - 1100-OPEN-FILES: Open `FEEDERR-FILE`.
  - 2000-PROCESS-REPORT: Insert `PERFORM 2250-PROCESS-FEED-ERRORS`.
  - 2250-PROCESS-FEED-ERRORS: New section for reading and summarizing feed errors.
  - 3000-CLEANUP: Close `FEEDERR-FILE`.

### 3.4 Structured Diffs  
#### src/programs/portfolio/PORTUPDT.cbl

**Before:**
```cobol
       FILE-CONTROL.
           SELECT PORTFOLIO-FILE
               ASSIGN TO PORTFILE
               ORGANIZATION IS INDEXED
               ACCESS MODE IS RANDOM
               RECORD KEY IS PORT-KEY
               FILE STATUS IS WS-FILE-STATUS.

           SELECT UPDATE-FILE
               ASSIGN TO UPDTFILE
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-UPDT-STATUS.
```
**After:**
```cobol
       FILE-CONTROL.
           SELECT PORTFOLIO-FILE
               ASSIGN TO PORTFILE
               ORGANIZATION IS INDEXED
               ACCESS MODE IS RANDOM
               RECORD KEY IS PORT-KEY
               FILE STATUS IS WS-FILE-STATUS.

           SELECT UPDATE-FILE
               ASSIGN TO UPDTFILE
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-UPDT-STATUS.

      *-- Change: Add real-time price feed file
           SELECT PRICEFEED-FILE
               ASSIGN TO PRICEFEED
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-PRICEFEED-STATUS.
```

**Before:**
```cobol
       PROCEDURE DIVISION.
       0000-MAIN.
           PERFORM 1000-INITIALIZE
           PERFORM 2000-PROCESS
              UNTIL END-OF-FILE
           PERFORM 3000-TERMINATE
           GOBACK.
```
**After:**
```cobol
       PROCEDURE DIVISION.
       0000-MAIN.
           PERFORM 1000-INITIALIZE

      *-- Change: Process real-time price feed before update file
           PERFORM 1500-PROCESS-PRICEFEED UNTIL WS-PRICEFEED-EOF

           PERFORM 2000-PROCESS
              UNTIL END-OF-FILE

           PERFORM 3000-TERMINATE
           GOBACK.
```

**Before:**
```cobol
       2200-APPLY-UPDATE.
           EVALUATE TRUE
               WHEN UPDT-STATUS
                   MOVE UPDT-NEW-VALUE TO PORT-STATUS
               WHEN UPDT-NAME
                   MOVE UPDT-NEW-VALUE TO PORT-CLIENT-NAME
               WHEN UPDT-VALUE
                   MOVE UPDT-NEW-VALUE TO WS-NUMERIC-WORK
                   MOVE WS-NUMERIC-WORK TO PORT-TOTAL-VALUE
           END-EVALUATE

           REWRITE PORT-RECORD

           IF WS-SUCCESS-STATUS
               ADD 1 TO WS-UPDATE-COUNT
           ELSE
               ADD 1 TO WS-ERROR-COUNT
               DISPLAY 'Update failed for: ' PORT-KEY
           END-IF
           .
```
**After:**
```cobol
       2200-APPLY-UPDATE.
           EVALUATE TRUE
               WHEN UPDT-STATUS
                   MOVE UPDT-NEW-VALUE TO PORT-STATUS
               WHEN UPDT-NAME
                   MOVE UPDT-NEW-VALUE TO PORT-CLIENT-NAME
               WHEN UPDT-VALUE
                   MOVE UPDT-NEW-VALUE TO WS-NUMERIC-WORK
                   MOVE WS-NUMERIC-WORK TO PORT-TOTAL-VALUE
           END-EVALUATE

      *-- Change: Update last price timestamp if value updated
           IF UPDT-VALUE
               ACCEPT WS-PRICE-TIMESTAMP FROM TIME
               MOVE WS-PRICE-TIMESTAMP TO PORT-LAST-PRICE-TS
           END-IF

      *-- Change: Trigger audit log for update
           CALL 'AUDITLOG' USING PORT-KEY UPDT-ACTION UPDT-NEW-VALUE

           REWRITE PORT-RECORD

           IF WS-SUCCESS-STATUS
               ADD 1 TO WS-UPDATE-COUNT
           ELSE
               ADD 1 TO WS-ERROR-COUNT
               DISPLAY 'Update failed for: ' PORT-KEY
           END-IF
           .
```

#### src/programs/batch/RCVPRC00.cbl

**Before:**
```cobol
       FILE-CONTROL.
           SELECT BATCH-CONTROL-FILE
               ASSIGN TO BCHCTL
               ORGANIZATION IS INDEXED
               ACCESS MODE IS DYNAMIC
               RECORD KEY IS BCT-KEY
               FILE STATUS IS WS-BCT-STATUS.

           SELECT PROCESS-SEQ-FILE
               ASSIGN TO PRCSEQ
               ORGANIZATION IS INDEXED
               ACCESS MODE IS DYNAMIC
               RECORD KEY IS PSR-KEY
               FILE STATUS IS WS-PSR-STATUS.
```
**After:**
```cobol
       FILE-CONTROL.
           SELECT BATCH-CONTROL-FILE
               ASSIGN TO BCHCTL
               ORGANIZATION IS INDEXED
               ACCESS MODE IS DYNAMIC
               RECORD KEY IS BCT-KEY
               FILE STATUS IS WS-BCT-STATUS.

           SELECT PROCESS-SEQ-FILE
               ASSIGN TO PRCSEQ
               ORGANIZATION IS INDEXED
               ACCESS MODE IS DYNAMIC
               RECORD KEY IS PSR-KEY
               FILE STATUS IS WS-PSR-STATUS.

      *-- Change: Add real-time market data feed file
           SELECT MARKETDATA-FILE
               ASSIGN TO MARKETFEED
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-MARKETDATA-STATUS.
```

**Before:**
```cobol
       0000-MAIN.
           EVALUATE TRUE
               WHEN FUNC-INIT
                   PERFORM 1000-INITIALIZE-RECOVERY
               WHEN FUNC-RECV
                   PERFORM 2000-PROCESS-RECOVERY
               WHEN FUNC-TERM
                   PERFORM 3000-TERMINATE-RECOVERY
               WHEN OTHER
                   MOVE 'Invalid function code' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-EVALUATE

           MOVE LS-RETURN-CODE TO RETURN-CODE
           GOBACK
           .
```
**After:**
```cobol
       0000-MAIN.
           EVALUATE TRUE
               WHEN FUNC-INIT
                   PERFORM 1000-INITIALIZE-RECOVERY
               WHEN FUNC-RECV
                   PERFORM 2000-PROCESS-RECOVERY
      *-- Change: Real-time polling for market data feed
                   PERFORM 2500-POLL-MARKETDATA UNTIL WS-MARKETDATA-EOF
               WHEN FUNC-TERM
                   PERFORM 3000-TERMINATE-RECOVERY
               WHEN OTHER
                   MOVE 'Invalid function code' TO ERR-TEXT
                   PERFORM 9000-ERROR-ROUTINE
           END-EVALUATE

           MOVE LS-RETURN-CODE TO RETURN-CODE
           GOBACK
           .
```

**Before:**
```cobol
       3000-TERMINATE-RECOVERY.
           PERFORM 3100-UPDATE-FINAL-STATUS
           PERFORM 3200-CLOSE-FILES
           .
```
**After:**
```cobol
       3000-TERMINATE-RECOVERY.
           PERFORM 3100-UPDATE-FINAL-STATUS
           PERFORM 3200-CLOSE-FILES
      *-- Change: Close market data file
           CLOSE MARKETDATA-FILE
           .
```

#### src/copybook/common/PORTFLIO.cpy

**Before:**
```cobol
           05  PORT-FINANCIAL-INFO.
               10  PORT-TOTAL-VALUE    PIC S9(13)V99 COMP-3.
               10  PORT-CASH-BALANCE   PIC S9(13)V99 COMP-3.
           05  PORT-AUDIT-INFO.
               10  PORT-LAST-USER      PIC X(8).
               10  PORT-LAST-TRANS     PIC 9(8).
           05  PORT-FILLER            PIC X(50).
```
**After:**
```cobol
           05  PORT-FINANCIAL-INFO.
               10  PORT-TOTAL-VALUE    PIC S9(13)V99 COMP-3.
               10  PORT-CASH-BALANCE   PIC S9(13)V99 COMP-3.
      *-- Change: Add last price timestamp
               10  PORT-LAST-PRICE-TS  PIC 9(14).
      *-- Change: Add historical price array
               10  PORT-HIST-PRICE OCCURS 10 TIMES.
                   15  PORT-HIST-PRICE-AMT PIC S9(13)V99 COMP-3.
                   15  PORT-HIST-PRICE-TS  PIC 9(14).
           05  PORT-AUDIT-INFO.
               10  PORT-LAST-USER      PIC X(8).
               10  PORT-LAST-TRANS     PIC 9(8).
           05  PORT-FILLER            PIC X(50).
```

#### src/programs/batch/RPTAUD00.cbl

**Before:**
```cobol
       FILE-CONTROL.
           SELECT AUDIT-FILE ASSIGN TO AUDITLOG
               ORGANIZATION IS INDEXED
               ACCESS MODE IS SEQUENTIAL
               RECORD KEY IS AUD-KEY
               FILE STATUS IS WS-AUDIT-STATUS.

           SELECT ERROR-FILE ASSIGN TO ERRLOG
               ORGANIZATION IS INDEXED
               ACCESS MODE IS SEQUENTIAL
               RECORD KEY IS ERR-KEY
               FILE STATUS IS WS-ERROR-STATUS.

           SELECT REPORT-FILE ASSIGN TO RPTFILE
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-REPORT-STATUS.
```
**After:**
```cobol
       FILE-CONTROL.
           SELECT AUDIT-FILE ASSIGN TO AUDITLOG
               ORGANIZATION IS INDEXED
               ACCESS MODE IS SEQUENTIAL
               RECORD KEY IS AUD-KEY
               FILE STATUS IS WS-AUDIT-STATUS.

           SELECT ERROR-FILE ASSIGN TO ERRLOG
               ORGANIZATION IS INDEXED
               ACCESS MODE IS SEQUENTIAL
               RECORD KEY IS ERR-KEY
               FILE STATUS IS WS-ERROR-STATUS.

           SELECT REPORT-FILE ASSIGN TO RPTFILE
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-REPORT-STATUS.

      *-- Change: Add market feed error log file
           SELECT FEEDERR-FILE ASSIGN TO FEEDERRLOG
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-FEEDERR-STATUS.
```

**Before:**
```cobol
       2000-PROCESS-REPORT.
           PERFORM 2100-PROCESS-AUDIT-TRAIL
           PERFORM 2200-PROCESS-ERROR-LOG
           PERFORM 2300-WRITE-SUMMARY.
```
**After:**
```cobol
       2000-PROCESS-REPORT.
           PERFORM 2100-PROCESS-AUDIT-TRAIL
           PERFORM 2200-PROCESS-ERROR-LOG
           PERFORM 2250-PROCESS-FEED-ERRORS *-- Change: Process feed errors
           PERFORM 2300-WRITE-SUMMARY.
```

**Before:**
```cobol
       3000-CLEANUP.
           CLOSE AUDIT-FILE
                ERROR-FILE
                REPORT-FILE
           .
```
**After:**
```cobol
       3000-CLEANUP.
           CLOSE AUDIT-FILE
                ERROR-FILE
                REPORT-FILE
      *-- Change: Close feed error file
                FEEDERR-FILE.
```

## 4. Conclusion  
The implemented changes enable seamless integration of real-time market and price feeds into the portfolio and batch recovery processes, ensuring all price updates are timestamped and auditable. The addition of historical price tracking and enhanced audit/error reporting improves traceability, compliance, and operational transparency. These enhancements position the system for robust, real-time financial data processing and reporting.


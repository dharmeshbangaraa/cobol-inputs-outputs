# Technical Document and Low-Level Design (LLD)

## 1. Introduction  
This document provides a comprehensive technical overview and Low-Level Design (LLD) for the enhancement of the COBOL legacy application suite, specifically to add a `CHANNEL-CODE` field to the transaction file. This change enables channel identification in batch processing and reporting, and impacts the transaction record structure, batch reporting, and validation utilities. The document details the existing logic, the rationale and scope of the change, and provides clear guidance and code diffs for implementation.

## 2. Existing Logic and Flow  
### 2.1 Overview  
The COBOL application processes business-critical transaction data through a modular structure, with clear separation of initialization, processing, and termination. The transaction record is centrally defined in a copybook (`TRNREC.cpy`), which is included by all programs that read or write transaction data. Two key programs are directly impacted:
- **RPTPOS00.cbl**: Batch reporting program that reads transaction history and generates reports.
- **UTLVAL00.cbl**: Utility program that validates transaction data for integrity, cross-reference, format, and balance.

### 2.2 Detailed Logic  

#### Transaction Record Structure (`TRNREC.cpy`)
The transaction record is defined as follows:
```cobol
01  TRANSACTION-RECORD.
    05  TRN-KEY.
        10  TRN-DATE           PIC X(08).
        10  TRN-TIME           PIC X(06).
        10  TRN-PORTFOLIO-ID   PIC X(08).
        10  TRN-SEQUENCE-NO    PIC X(06).
    05  TRN-DATA.
        10  TRN-INVESTMENT-ID  PIC X(10).
        10  TRN-TYPE           PIC X(02).
            88  TRN-TYPE-BUY     VALUE 'BU'.
            88  TRN-TYPE-SELL    VALUE 'SL'.
            88  TRN-TYPE-TRANS   VALUE 'TR'.
            88  TRN-TYPE-FEE     VALUE 'FE'.
        10  TRN-QUANTITY       PIC S9(11)V9(4) COMP-3.
        10  TRN-PRICE         PIC S9(11)V9(4) COMP-3.
        10  TRN-AMOUNT        PIC S9(13)V9(2) COMP-3.
        10  TRN-CURRENCY      PIC X(03).
        10  TRN-STATUS        PIC X(01).
            88  TRN-STATUS-PEND   VALUE 'P'.
            88  TRN-STATUS-DONE   VALUE 'D'.
            88  TRN-STATUS-FAIL   VALUE 'F'.
            88  TRN-STATUS-REV    VALUE 'R'.
    05  TRN-AUDIT.
        10  TRN-PROCESS-DATE  PIC X(26).
        10  TRN-PROCESS-USER  PIC X(08).
    05  TRN-FILLER           PIC X(50).
```

#### Batch Reporting Program (`RPTPOS00.cbl`)
- **Initialization**: Opens position master, transaction history, and report files. Handles file status errors.
- **Processing**: Reads position records, formats them, and writes to the report. Processes transactions by reading transaction history and summarizing activity.
- **Termination**: Closes all files and handles errors.

#### Validation Utility Program (`UTLVAL00.cbl`)
- **Initialization**: Opens validation control, position master, transaction history, and error report files.
- **Processing**: Reads validation control records and dispatches to integrity, cross-reference, format, or balance checks. Transaction records are validated in dedicated sections.
- **Termination**: Closes all files and writes error records as needed.

#### Flowchart:  
```mermaid
flowchart TD
    Start(["Start"])
    Init["Initialization:
Open Files"]
    Process["Main Processing:
Read/Write/Validate
Transactions"]
    Term["Termination:
Close Files"]
    Error["Error
Handling"]

    Start --> Init
    Init --> Process
    Process --> Term
    Init --> Error
    Process --> Error
    Term --> Error
```

## 3. Proposed Changes  
### 3.1 User Story or Analysis Report Summary  
**User Story:**  
Add `CHANNEL-CODE` Field to Transaction File for Channel Identification in Batch Processing and Reporting.

**Summary:**  
The transaction record must be extended to include a new `CHANNEL-CODE` field. This field will be used to identify the channel (e.g., branch, online, mobile) through which each transaction was processed. All programs that read or write transaction records must be updated to accommodate this new field, including file layouts, processing logic, and reporting/validation routines.

### 3.2 Proposed Code Changes Summary

#### 3.2.1 Impacted Sections and Files:
- **src/copybook/common/TRNREC.cpy** (copybook structure)
- **src/programs/batch/RPTPOS00.cbl** (1100-OPEN-FILES, 2200-PROCESS-TRANSACTIONS)
- **src/programs/utility/UTLVAL00.cbl** (1100-OPEN-FILES, 2400-CHECK-FORMAT)

**Purpose of Changes:**  
To enable channel-based reporting and analytics by capturing the channel of origin for each transaction. This supports business requirements for channel attribution, auditing, and operational insights.

**Impact:**  
- All transaction-processing programs must be recompiled to recognize the new field.
- File layouts and LRECL must be updated.
- Batch and utility programs must read, write, and validate the new field.
- Downstream reporting and analytics will have access to channel information.

### 3.3 Insertion Points  
- **TRNREC.cpy**: Add `CHANNEL-CODE` field to the transaction record structure, ideally after `TRN-CURRENCY` for logical grouping.
- **RPTPOS00.cbl**: Update all references to the transaction record, including file section, processing, and reporting logic to include `CHANNEL-CODE`.
- **UTLVAL00.cbl**: Update file section, format validation, and any logic that reads/writes transaction records to include and validate `CHANNEL-CODE`.

References to specific code sections:
- **TRNREC.cpy**: After `TRN-CURRENCY` in the `TRN-DATA` group.
- **RPTPOS00.cbl**: In the FILE SECTION (COPY TRNREC), and in `2200-PROCESS-TRANSACTIONS` and any report output that includes transaction details.
- **UTLVAL00.cbl**: In the FILE SECTION (COPY TRNREC), and in `2400-CHECK-FORMAT` and related validation logic.

### 3.4 Structured Diffs  

#### **A. src/copybook/common/TRNREC.cpy**

**Before:**
```cobol
     05  TRN-DATA.
         10  TRN-INVESTMENT-ID  PIC X(10).
         10  TRN-TYPE           PIC X(02).
             88  TRN-TYPE-BUY     VALUE 'BU'.
             88  TRN-TYPE-SELL    VALUE 'SL'.
             88  TRN-TYPE-TRANS   VALUE 'TR'.
             88  TRN-TYPE-FEE     VALUE 'FE'.
         10  TRN-QUANTITY       PIC S9(11)V9(4) COMP-3.
         10  TRN-PRICE         PIC S9(11)V9(4) COMP-3.
         10  TRN-AMOUNT        PIC S9(13)V9(2) COMP-3.
         10  TRN-CURRENCY      PIC X(03).
         10  TRN-STATUS        PIC X(01).
             88  TRN-STATUS-PEND   VALUE 'P'.
             88  TRN-STATUS-DONE   VALUE 'D'.
             88  TRN-STATUS-FAIL   VALUE 'F'.
             88  TRN-STATUS-REV    VALUE 'R'.
```

**After:**
```cobol
     05  TRN-DATA.
         10  TRN-INVESTMENT-ID  PIC X(10).
         10  TRN-TYPE           PIC X(02).
             88  TRN-TYPE-BUY     VALUE 'BU'.
             88  TRN-TYPE-SELL    VALUE 'SL'.
             88  TRN-TYPE-TRANS   VALUE 'TR'.
             88  TRN-TYPE-FEE     VALUE 'FE'.
         10  TRN-QUANTITY       PIC S9(11)V9(4) COMP-3.
         10  TRN-PRICE         PIC S9(11)V9(4) COMP-3.
         10  TRN-AMOUNT        PIC S9(13)V9(2) COMP-3.
         10  TRN-CURRENCY      PIC X(03).
         10  TRN-CHANNEL-CODE  PIC X(04).
         10  TRN-STATUS        PIC X(01).
             88  TRN-STATUS-PEND   VALUE 'P'.
             88  TRN-STATUS-DONE   VALUE 'D'.
             88  TRN-STATUS-FAIL   VALUE 'F'.
             88  TRN-STATUS-REV    VALUE 'R'.
```
*Rationale: `TRN-CHANNEL-CODE` is added after `TRN-CURRENCY` for logical grouping with other transaction attributes.*

---

#### **B. src/programs/batch/RPTPOS00.cbl**

**Before (FILE SECTION):**
```cobol
    COPY TRNREC.
```

**After (FILE SECTION):**
```cobol
    COPY TRNREC.
    * Now includes TRN-CHANNEL-CODE in TRANSACTION-RECORD
```

**Before (Processing/Reporting Example):**
```cobol
    MOVE TRN-DATE           TO WS-TRN-DATE
    MOVE TRN-TIME           TO WS-TRN-TIME
    MOVE TRN-PORTFOLIO-ID   TO WS-TRN-PORTFOLIO
    MOVE TRN-TYPE           TO WS-TRN-TYPE
    MOVE TRN-AMOUNT         TO WS-TRN-AMOUNT
    MOVE TRN-CURRENCY       TO WS-TRN-CURRENCY
    MOVE TRN-STATUS         TO WS-TRN-STATUS
```

**After (Processing/Reporting Example):**
```cobol
    MOVE TRN-DATE           TO WS-TRN-DATE
    MOVE TRN-TIME           TO WS-TRN-TIME
    MOVE TRN-PORTFOLIO-ID   TO WS-TRN-PORTFOLIO
    MOVE TRN-TYPE           TO WS-TRN-TYPE
    MOVE TRN-AMOUNT         TO WS-TRN-AMOUNT
    MOVE TRN-CURRENCY       TO WS-TRN-CURRENCY
    MOVE TRN-CHANNEL-CODE   TO WS-TRN-CHANNEL-CODE
    MOVE TRN-STATUS         TO WS-TRN-STATUS
```
*Rationale: All transaction processing and reporting logic must now handle the new field.*

---

#### **C. src/programs/utility/UTLVAL00.cbl**

**Before (FILE SECTION):**
```cobol
    COPY TRNREC.
```

**After (FILE SECTION):**
```cobol
    COPY TRNREC.
    * Now includes TRN-CHANNEL-CODE in TRANSACTION-RECORD
```

**Before (Format Validation Example in 2400-CHECK-FORMAT):**
```cobol
    IF TRN-CURRENCY = SPACES OR TRN-CURRENCY = LOW-VALUES
        MOVE 'MISSING CURRENCY' TO WS-ERROR-MESSAGE
        PERFORM 9999-ERROR-HANDLER
    END-IF
```

**After (Format Validation Example in 2400-CHECK-FORMAT):**
```cobol
    IF TRN-CURRENCY = SPACES OR TRN-CURRENCY = LOW-VALUES
        MOVE 'MISSING CURRENCY' TO WS-ERROR-MESSAGE
        PERFORM 9999-ERROR-HANDLER
    END-IF

    IF TRN-CHANNEL-CODE = SPACES OR TRN-CHANNEL-CODE = LOW-VALUES
        MOVE 'MISSING CHANNEL CODE' TO WS-ERROR-MESSAGE
        PERFORM 9999-ERROR-HANDLER
    END-IF
```
*Rationale: The new field must be validated for presence and correctness.*

---

## 4. Conclusion  
The addition of the `CHANNEL-CODE` field to the transaction record structure enables robust channel-based reporting and analytics, meeting new business requirements. All impacted programs and copybooks have been identified and updated to handle the new field, ensuring data integrity and consistency across batch processing and validation utilities. The structured diffs and detailed guidance provided in this document will facilitate accurate and efficient implementation of the required changes.

# Technical Document and Low-Level Design (LLD)

## 1. Introduction  
This document provides a comprehensive technical overview and Low-Level Design (LLD) for the COBOL application modules impacted by the user story: **Enable Real-Time Market Price Feed Integration for Dynamic Portfolio Updates**.  
It details the existing logic, identifies insertion points for the required changes, and presents structured before-and-after code diffs for all affected files. The goal is to facilitate accurate implementation, review, and testing of the modernization initiative.

---

## 2. Existing Logic and Flow  

### 2.1 Overview  
The application is a batch portfolio update system. It processes update records, applies changes to portfolio master records, and maintains an audit trail. The main program (`PORTUPDT.cbl`) orchestrates initialization, processing, and termination. Data structures are defined in copybooks (`PORTFLIO.cpy` for portfolio records, `AUDITLOG.cpy` for audit logs).

### 2.2 Detailed Logic  

#### Main Program: `PORTUPDT.cbl`
- **Initialization (`1000-INITIALIZE`, Lines 93-107):**  
  - Initializes working storage.
  - Opens portfolio and update files.
  - Handles file open errors.

- **Processing (`2000-PROCESS`, Lines 109-116):**  
  - Reads update records sequentially.
  - For each record, calls update logic (`2100-PROCESS-UPDATE`).

- **Update Logic (`2100-PROCESS-UPDATE`, Lines 118-129):**  
  - Locates the portfolio record by key.
  - If found, applies the update (`2200-APPLY-UPDATE`).
  - If not found, logs error.

- **Apply Update (`2200-APPLY-UPDATE`, Lines 131-150):**  
  - Depending on update type, modifies status, client name, or total value.
  - Rewrites the portfolio record.
  - Logs success or failure.

- **Termination (`3000-TERMINATE`, Lines 152-160):**  
  - Closes files.
  - Displays summary statistics.

#### Portfolio Record Structure: `PORTFLIO.cpy`
- Defines fields for portfolio key, client info, portfolio info, financial info, audit info, and filler.

#### Audit Log Structure: `AUDITLOG.cpy`
- Defines fields for audit header, type, action, status, key info, before/after images, and message.

#### Flowchart:  
```mermaid
flowchart TD
    Start(["Start"])
    Init["1000-INITIALIZE
Initialize work areas
Open files"]
    Process["2000-PROCESS
Read update records"]
    ProcUpdate["2100-PROCESS-UPDATE
Locate portfolio record
If found, apply update"]
    ApplyUpdate["2200-APPLY-UPDATE
Update status/name/value
Rewrite record"]
    Terminate["3000-TERMINATE
Close files
Display summary"]
    End(["End"])

    Start --> Init
    Init --> Process
    Process --> ProcUpdate
    ProcUpdate -->|Found| ApplyUpdate
    ProcUpdate -->|Not Found| Process
    ApplyUpdate --> Process
    Process -->|End of File| Terminate
    Terminate --> End
```

---

## 3. Proposed Changes  

### 3.1 User Story or Analysis Report Summary  
**User Story:**  
Enable Real-Time Market Price Feed Integration for Dynamic Portfolio Updates

- Integrate real-time market price feed ingestion.
- Dynamically recalculate portfolio valuations.
- Implement error handling for feed failures.
- Enhance audit logging for all real-time update events.

### 3.2 Proposed Code Changes Summary:

#### 3.2.1 Impacted Sections and Files:
- **src/programs/portfolio/PORTUPDT.cbl**
  - Paragraphs: `1000-INITIALIZE`, `2000-PROCESS`, `2100-PROCESS-UPDATE`, `2200-APPLY-UPDATE`
- **src/copybook/common/PORTFLIO.cpy**
  - Portfolio record structure
- **src/copybook/common/AUDITLOG.cpy**
  - Audit log structure

**Purpose of Changes:**  
To support dynamic portfolio updates based on real-time market prices, track update timestamps, and provide robust error/audit logging.

**Impact:**  
- Portfolio records will reflect real-time valuations.
- Audit logs will capture feed events and errors.
- System will handle feed failures gracefully.

### 3.3 Insertion Points  

- **PORTUPDT.cbl**
  - *1000-INITIALIZE*: Add initialization for price feed connection.
  - *2000-PROCESS*: Integrate logic to fetch real-time price before applying update.
  - *2100-PROCESS-UPDATE*: Add error handling for feed failures.
  - *2200-APPLY-UPDATE*: Update portfolio record with real-time price and timestamp; log audit event.

- **PORTFLIO.cpy**
  - Add fields for real-time price, price timestamp, and historical price tracking.

- **AUDITLOG.cpy**
  - Add fields for feed event type, error code, and update timestamp.

### 3.4 Structured Diffs  

#### **A. src/programs/portfolio/PORTUPDT.cbl**

**Before:**  
```cobol
93.   1000-INITIALIZE.
94.       INITIALIZE WS-WORK-AREAS
95.       
96.       OPEN I-O   PORTFOLIO-FILE
97.       OPEN INPUT UPDATE-FILE
98.       
99.       IF NOT WS-SUCCESS-STATUS OR 
100.         NOT WS-UPDT-SUCCESS
101.         DISPLAY 'Error opening files: ' 
102.                 'PORT=' WS-FILE-STATUS
103.                 'UPDT=' WS-UPDT-STATUS
104.         MOVE WS-ERROR TO WS-RETURN-CODE
105.         PERFORM 3000-TERMINATE
106.     END-IF
107.     .
...
118. 2100-PROCESS-UPDATE.
119.     MOVE UPDT-KEY TO PORT-KEY
120.     
121.     READ PORTFOLIO-FILE
122.     
123.     IF WS-SUCCESS-STATUS
124.         PERFORM 2200-APPLY-UPDATE
125.     ELSE
126.         ADD 1 TO WS-ERROR-COUNT
127.         DISPLAY 'Record not found: ' PORT-KEY
128.     END-IF
129.     .
...
131. 2200-APPLY-UPDATE.
132.     EVALUATE TRUE
133.         WHEN UPDT-STATUS
134.             MOVE UPDT-NEW-VALUE TO PORT-STATUS
135.         WHEN UPDT-NAME
136.             MOVE UPDT-NEW-VALUE TO PORT-CLIENT-NAME
137.         WHEN UPDT-VALUE
138.             MOVE UPDT-NEW-VALUE TO WS-NUMERIC-WORK
139.             MOVE WS-NUMERIC-WORK TO PORT-TOTAL-VALUE
140.     END-EVALUATE
141.     
142.     REWRITE PORT-RECORD
143.     
144.     IF WS-SUCCESS-STATUS
145.         ADD 1 TO WS-UPDATE-COUNT
146.     ELSE
147.         ADD 1 TO WS-ERROR-COUNT
148.         DISPLAY 'Update failed for: ' PORT-KEY
149.     END-IF
150.     .
```

**After:**  
```cobol
93.   1000-INITIALIZE.
94.       INITIALIZE WS-WORK-AREAS
95.       
95a.      * Initialize real-time price feed connection
95b.      CALL 'PRICEFEEDINIT' USING WS-FEED-STATUS
95c.      IF WS-FEED-STATUS NOT = 'OK'
95d.          DISPLAY 'Error initializing price feed'
95e.          MOVE WS-ERROR TO WS-RETURN-CODE
95f.          PERFORM 3000-TERMINATE
95g.      END-IF
96.       OPEN I-O   PORTFOLIO-FILE
97.       OPEN INPUT UPDATE-FILE
...
118. 2100-PROCESS-UPDATE.
119.     MOVE UPDT-KEY TO PORT-KEY
120.     
120a.    * Fetch real-time market price for portfolio
120b.    CALL 'GETREALTIMEPRICE' USING PORT-ID PORT-ACCOUNT-NO WS-REALTIME-PRICE WS-PRICE-TIMESTAMP WS-FEED-ERROR
120c.    IF WS-FEED-ERROR NOT = 'OK'
120d.        ADD 1 TO WS-ERROR-COUNT
120e.        DISPLAY 'Price feed error for: ' PORT-KEY
120f.        PERFORM AUDIT-FEED-FAILURE
120g.        EXIT PARAGRAPH
120h.    END-IF
121.     READ PORTFOLIO-FILE
...
123.     IF WS-SUCCESS-STATUS
124.         PERFORM 2200-APPLY-UPDATE
125.     ELSE
126.         ADD 1 TO WS-ERROR-COUNT
127.         DISPLAY 'Record not found: ' PORT-KEY
128.         PERFORM AUDIT-REC-NOT-FOUND
129.     END-IF
...
131. 2200-APPLY-UPDATE.
132.     EVALUATE TRUE
133.         WHEN UPDT-STATUS
134.             MOVE UPDT-NEW-VALUE TO PORT-STATUS
135.         WHEN UPDT-NAME
136.             MOVE UPDT-NEW-VALUE TO PORT-CLIENT-NAME
137.         WHEN UPDT-VALUE
138.             MOVE UPDT-NEW-VALUE TO WS-NUMERIC-WORK
139.             MOVE WS-NUMERIC-WORK TO PORT-TOTAL-VALUE
139a.            * Apply real-time price to portfolio
139b.            MOVE WS-REALTIME-PRICE TO PORT-REALTIME-PRICE
139c.            MOVE WS-PRICE-TIMESTAMP TO PORT-PRICE-TIMESTAMP
139d.            * Optionally update historical price tracking
139e.            PERFORM UPDATE-HISTORICAL-PRICE
140.     END-EVALUATE
141.     
142.     REWRITE PORT-RECORD
143.     
143a.    * Log audit event for real-time update
143b.    PERFORM AUDIT-REALTIME-UPDATE
...
```

#### **B. src/copybook/common/PORTFLIO.cpy**

**Before:**  
```cobol
28.       05  PORT-FINANCIAL-INFO.
29.           10  PORT-TOTAL-VALUE    PIC S9(13)V99 COMP-3.
30.           10  PORT-CASH-BALANCE   PIC S9(13)V99 COMP-3.
31.       05  PORT-AUDIT-INFO.
32.           10  PORT-LAST-USER      PIC X(8).
33.           10  PORT-LAST-TRANS     PIC 9(8).
34.       05  PORT-FILLER            PIC X(50).
```

**After:**  
```cobol
28.       05  PORT-FINANCIAL-INFO.
29.           10  PORT-TOTAL-VALUE    PIC S9(13)V99 COMP-3.
30.           10  PORT-CASH-BALANCE   PIC S9(13)V99 COMP-3.
30a.          10  PORT-REALTIME-PRICE PIC S9(13)V99 COMP-3.
30b.          10  PORT-PRICE-TIMESTAMP PIC X(26).
30c.          10  PORT-HIST-PRICE-ARR OCCURS 10 TIMES.
30d.              15  PORT-HIST-PRICE  PIC S9(13)V99 COMP-3.
30e.              15  PORT-HIST-TIMESTAMP PIC X(26).
31.       05  PORT-AUDIT-INFO.
32.           10  PORT-LAST-USER      PIC X(8).
33.           10  PORT-LAST-TRANS     PIC 9(8).
34.       05  PORT-FILLER            PIC X(50).
```

#### **C. src/copybook/common/AUDITLOG.cpy**

**Before:**  
```cobol
36.       05  AUD-MESSAGE          PIC X(100). 
```

**After:**  
```cobol
36.       05  AUD-MESSAGE          PIC X(100).
36a.      05  AUD-FEED-EVENT-TYPE  PIC X(10).
36b.      05  AUD-FEED-ERROR-CODE  PIC X(10).
36c.      05  AUD-UPDATE-TIMESTAMP PIC X(26).
```

---

## 4. Conclusion  
The proposed changes enable seamless integration of real-time market price feeds into the portfolio update process. Portfolio records are dynamically updated with current market valuations and timestamps, while robust error handling and audit logging ensure traceability and reliability. The structured diffs and insertion points provide clear guidance for implementation, review, and testing, supporting the organization's modernization and maintenance objectives.

Technical Document and Low-Level Design (LLD)

## 1. Introduction  
This document provides a comprehensive technical overview and Low-Level Design (LLD) for the enhancement of the COBOL legacy application suite, specifically to introduce a new `CHANNEL-CODE` field to the transaction file. This change is required to support channel identification in batch processing and reporting, and impacts core transaction data structures, file layouts, batch processing, reporting, and associated copybooks. The document details the existing logic, the rationale and scope of the change, and provides structured diffs and guidance for seamless integration.

---

## 2. Existing Logic and Flow  

### 2.1 Overview  
The COBOL application suite processes business-critical transaction data through a set of modular programs. The core transaction record structure is defined in a common copybook (`TRNREC.cpy`), which is referenced by all programs that read, write, or validate transaction data. The main processing flow across the impacted programs consists of:

- **Initialization:** Opening required files and preparing the environment.
- **Processing:** Reading transaction records, performing business logic, generating reports, or validating data.
- **Termination:** Writing outputs, closing files, and handling errors.

### 2.2 Detailed Logic  

#### 2.2.1 Transaction Record Structure (`src/copybook/common/TRNREC.cpy`)
Defines the canonical layout for all transaction records, including keys, data fields, audit information, and filler.

```cobol
 6   01  TRANSACTION-RECORD.
 7       05  TRN-KEY.
 8           10  TRN-DATE           PIC X(08).
 9           10  TRN-TIME           PIC X(06).
10           10  TRN-PORTFOLIO-ID   PIC X(08).
11           10  TRN-SEQUENCE-NO    PIC X(06).
12       05  TRN-DATA.
13           10  TRN-INVESTMENT-ID  PIC X(10).
14           10  TRN-TYPE           PIC X(02).
19           10  TRN-QUANTITY       PIC S9(11)V9(4) COMP-3.
20           10  TRN-PRICE         PIC S9(11)V9(4) COMP-3.
21           10  TRN-AMOUNT        PIC S9(13)V9(2) COMP-3.
22           10  TRN-CURRENCY      PIC X(03).
23           10  TRN-STATUS        PIC X(01).
28       05  TRN-AUDIT.
29           10  TRN-PROCESS-DATE  PIC X(26).
30           10  TRN-PROCESS-USER  PIC X(08).
31       05  TRN-FILLER           PIC X(50).
```

#### 2.2.2 Batch Reporting (`src/programs/batch/RPTPOS00.cbl`)
- **1100-OPEN-FILES (Lines 54-74):** Opens position master, transaction history, and report files. Handles errors if files cannot be opened.
- **2200-PROCESS-TRANSACTIONS (Lines 109-111):** Orchestrates reading and summarizing transaction activity.

#### 2.2.3 Utility Validation (`src/programs/utility/UTLVAL00.cbl`)
- **1100-OPEN-FILES (Lines 61-88):** Opens validation control, position master, transaction history, and error report files.
- **2400-CHECK-FORMAT (Lines 129-131):** Performs format checks on position and transaction files.

#### 2.2.4 Test Data Generation (`src/programs/test/TSTGEN00.cbl`)
- **2300-GEN-TRANSACTION (Lines 120-133):** Populates transaction record fields from working storage and system date/time, then triggers record writing.
- **2320-WRITE-TRAN-RECORD (Lines 136-139):** Writes the transaction record and increments a counter.

#### 2.2.5 Test Data Validation (`src/programs/test/TSTVAL00.cbl`)
- **1100-OPEN-FILES (Lines 54-67):** Opens transaction history and test report files.
- **2100-EXECUTE-TEST (Lines 90-94):** Reads, validates, and writes results for test transactions.

#### 2.2.6 Flowchart

```mermaid
flowchart TD
    Start(["Start"])
    OpenFiles["Open
Files"]
    ReadTrans["Read
Transaction
Records"]
    ProcessLogic["Process/
Validate/
Summarize"]
    WriteOutput["Write
Output/
Reports"]
    End(["End"])

    Start --> OpenFiles
    OpenFiles --> ReadTrans
    ReadTrans --> ProcessLogic
    ProcessLogic --> WriteOutput
    WriteOutput --> End
```

---

## 3. Proposed Changes  

### 3.1 User Story or Analysis Report Summary  
**User Story:**  
Add `CHANNEL-CODE` Field to Transaction File for Channel Identification in Batch Processing and Reporting.

- All programs that read/write transaction data or generate reports must be updated for the new field.
- The field will be added to the canonical transaction record copybook and propagated to all dependent programs.

### 3.2 Proposed Code Changes Summary

#### 3.2.1 Impacted Sections and Files

| File Path                                   | Sections/Paragraphs                  |
|---------------------------------------------|--------------------------------------|
| src/copybook/common/TRNREC.cpy              | Entire file (add CHANNEL-CODE)       |
| src/programs/batch/RPTPOS00.cbl             | 1100-OPEN-FILES, 2200-PROCESS-TRANSACTIONS, FD section |
| src/programs/utility/UTLVAL00.cbl           | 1100-OPEN-FILES, 2400-CHECK-FORMAT, FD section |
| src/programs/test/TSTGEN00.cbl              | 2300-GEN-TRANSACTION, 2320-WRITE-TRAN-RECORD, FD section |
| src/programs/test/TSTVAL00.cbl              | 1100-OPEN-FILES, 2100-EXECUTE-TEST, FD section |

- **Purpose of Changes:**  
  To enable identification of the channel (e.g., online, branch, mobile) through which each transaction was processed, supporting enhanced reporting and auditability.

- **Impact:**  
  - All transaction file layouts and processing logic must accommodate the new field.
  - Test data generation and validation must include the field.
  - Reporting and validation utilities must read, process, and output the new field.
  - Data integrity and backward compatibility must be maintained.

### 3.3 Insertion Points  

- **TRNREC.cpy:**  
  Add `CHANNEL-CODE` field to the transaction record structure, ideally after `TRN-CURRENCY` and before `TRN-STATUS` for logical grouping.

- **All impacted programs:**  
  - Update FD (File Description) and record layouts to include `CHANNEL-CODE`.
  - Update all `MOVE`, `WRITE`, `READ`, and validation logic to handle the new field.
  - In test generation, populate `CHANNEL-CODE` with appropriate test values.
  - In reporting, include `CHANNEL-CODE` in output where relevant.

**References to specific line numbers and code snippets are provided in the structured diffs below.**

---

### 3.4 Structured Diffs  

#### 3.4.1 `src/copybook/common/TRNREC.cpy`

**Before:**
```cobol
22           10  TRN-CURRENCY      PIC X(03).
23           10  TRN-STATUS        PIC X(01).
```

**After:**
```cobol
22           10  TRN-CURRENCY      PIC X(03).
22A          10  CHANNEL-CODE      PIC X(04).
23           10  TRN-STATUS        PIC X(01).
```
*(Add field after TRN-CURRENCY, adjust filler size if necessary.)*

---

#### 3.4.2 `src/programs/batch/RPTPOS00.cbl`

**Before (FD Section):**
```cobol
FD  TRANSACTION-HISTORY
    RECORD CONTAINS ... CHARACTERS
    BLOCK CONTAINS ... RECORDS
    DATA RECORD IS TRANSACTION-RECORD.
```
*(Record layout matches pre-change TRNREC.cpy)*

**After (FD Section):**
```cobol
FD  TRANSACTION-HISTORY
    RECORD CONTAINS ... CHARACTERS
    BLOCK CONTAINS ... RECORDS
    DATA RECORD IS TRANSACTION-RECORD.
    01  TRANSACTION-RECORD.
        05  TRN-KEY.
            10  TRN-DATE           PIC X(08).
            10  TRN-TIME           PIC X(06).
            10  TRN-PORTFOLIO-ID   PIC X(08).
            10  TRN-SEQUENCE-NO    PIC X(06).
        05  TRN-DATA.
            10  TRN-INVESTMENT-ID  PIC X(10).
            10  TRN-TYPE           PIC X(02).
            10  TRN-QUANTITY       PIC S9(11)V9(4) COMP-3.
            10  TRN-PRICE          PIC S9(11)V9(4) COMP-3.
            10  TRN-AMOUNT         PIC S9(13)V9(2) COMP-3.
            10  TRN-CURRENCY       PIC X(03).
            10  CHANNEL-CODE       PIC X(04).
            10  TRN-STATUS         PIC X(01).
        05  TRN-AUDIT.
            10  TRN-PROCESS-DATE   PIC X(26).
            10  TRN-PROCESS-USER   PIC X(08).
        05  TRN-FILLER             PIC X(46).
```
*(Or, if using COPY, ensure COPY TRNREC. is updated and referenced.)*

**Before (Processing):**
```cobol
-- 2200-PROCESS-TRANSACTIONS.
110      PERFORM 2210-READ-TRANSACTIONS
111      PERFORM 2220-SUMMARIZE-ACTIVITY.
```

**After (Processing):**
```cobol
-- 2200-PROCESS-TRANSACTIONS.
110      PERFORM 2210-READ-TRANSACTIONS
111      PERFORM 2220-SUMMARIZE-ACTIVITY
112      DISPLAY "CHANNEL-CODE: " CHANNEL-CODE.
```
*(Add logic to process or report CHANNEL-CODE as required.)*

---

#### 3.4.3 `src/programs/utility/UTLVAL00.cbl`

**Before (FD Section):**
```cobol
FD  TRANSACTION-HISTORY
    ...
    DATA RECORD IS TRANSACTION-RECORD.
```

**After (FD Section):**
```cobol
FD  TRANSACTION-HISTORY
    ...
    DATA RECORD IS TRANSACTION-RECORD.
    01  TRANSACTION-RECORD.
        ...
            10  TRN-CURRENCY      PIC X(03).
            10  CHANNEL-CODE      PIC X(04).
            10  TRN-STATUS        PIC X(01).
        ...
```

**Before (2400-CHECK-FORMAT):**
```cobol
129  2400-CHECK-FORMAT.
130      PERFORM 2410-CHECK-POSITION-FORMAT
131      PERFORM 2420-CHECK-TRANSACTION-FORMAT.
```

**After (2400-CHECK-FORMAT):**
```cobol
129  2400-CHECK-FORMAT.
130      PERFORM 2410-CHECK-POSITION-FORMAT
131      PERFORM 2420-CHECK-TRANSACTION-FORMAT
132      IF CHANNEL-CODE = SPACES OR CHANNEL-CODE = LOW-VALUES
133          MOVE 'MISSING CHANNEL-CODE' TO WS-ERROR-MESSAGE
134          PERFORM 9999-ERROR-HANDLER
135      END-IF.
```
*(Add validation for CHANNEL-CODE.)*

---

#### 3.4.4 `src/programs/test/TSTGEN00.cbl`

**Before (2300-GEN-TRANSACTION):**
```cobol
128      MOVE WS-CURRENCY          TO TRN-CURRENCY
129      MOVE 'P'                  TO TRN-STATUS
```

**After (2300-GEN-TRANSACTION):**
```cobol
128      MOVE WS-CURRENCY          TO TRN-CURRENCY
128A     MOVE WS-CHANNEL-CODE      TO CHANNEL-CODE
129      MOVE 'P'                  TO TRN-STATUS
```
*(Populate CHANNEL-CODE in test data.)*

---

#### 3.4.5 `src/programs/test/TSTVAL00.cbl`

**Before (FD Section):**
```cobol
FD  TRANSACTION-HISTORY
    ...
    DATA RECORD IS TRANSACTION-RECORD.
```

**After (FD Section):**
```cobol
FD  TRANSACTION-HISTORY
    ...
    DATA RECORD IS TRANSACTION-RECORD.
    01  TRANSACTION-RECORD.
        ...
            10  TRN-CURRENCY      PIC X(03).
            10  CHANNEL-CODE      PIC X(04).
            10  TRN-STATUS        PIC X(01).
        ...
```

**Before (2100-EXECUTE-TEST):**
```cobol
91       PERFORM 2110-READ-TRANSACTION
92       PERFORM 2120-VALIDATE-TRANSACTION
```

**After (2100-EXECUTE-TEST):**
```cobol
91       PERFORM 2110-READ-TRANSACTION
92       PERFORM 2120-VALIDATE-TRANSACTION
93       IF CHANNEL-CODE = SPACES OR CHANNEL-CODE = LOW-VALUES
94           MOVE 'CHANNEL-CODE MISSING IN TEST DATA' TO WS-ERROR-MESSAGE
95           PERFORM 9999-ERROR-HANDLER
96       END-IF
```
*(Add test validation for CHANNEL-CODE.)*

---

## 4. Conclusion  
The addition of the `CHANNEL-CODE` field to the transaction record structure and all dependent programs enhances the system's ability to track and report the origin of each transaction. This change requires coordinated updates to copybooks, file layouts, processing logic, and test utilities. The structured diffs and insertion points provided ensure that the changes can be implemented accurately and efficiently, preserving data integrity and supporting future business requirements.

---

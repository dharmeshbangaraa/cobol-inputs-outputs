# Technical Document and Low-Level Design (LLD)

## 1. Introduction  
This document provides a comprehensive technical overview and Low-Level Design (LLD) for the enhancement of the legacy COBOL application suite, specifically addressing the addition of a `CHANNEL-CODE` field to the transaction file structure. The change is driven by the need to identify the channel of origin for each transaction, enabling improved batch processing and reporting. This document details the existing logic, the rationale and scope of the required changes, and provides clear guidance for implementation and review.

---

## 2. Existing Logic and Flow  

### 2.1 Overview  
The COBOL application suite processes business-critical transaction data through a set of modular programs and copybooks. The core transaction record structure is defined in a central copybook (`TRNREC.cpy`), which is included by all programs that read or write transaction data. Two key programs are directly impacted:

- **RPTPOS00.cbl**: Batch reporting program that generates daily position and transaction activity reports.
- **UTLVAL00.cbl**: Utility program that performs comprehensive validation on transaction and position data.

The application flow is structured into initialization (file open/setup), main processing (transaction/position processing, validation, reporting), and termination (file closure, cleanup).

---

### 2.2 Detailed Logic  

#### 2.2.1 `src/copybook/common/TRNREC.cpy`  
Defines the transaction record structure used throughout the application.  
- **TRN-KEY**: Composite key fields (date, time, portfolio, sequence).
- **TRN-DATA**: Transaction details (investment ID, type, quantity, price, amount, currency, status).
- **TRN-AUDIT**: Audit trail (process date, user).
- **TRN-FILLER**: Reserved space for future expansion.

#### 2.2.2 `src/programs/batch/RPTPOS00.cbl`  
- **Initialization**: Opens position, transaction, and report files (`1100-OPEN-FILES`).
- **Processing**: Reads positions, processes transactions (`2200-PROCESS-TRANSACTIONS`), writes summaries.
- **Termination**: Closes files, handles errors.

#### 2.2.3 `src/programs/utility/UTLVAL00.cbl`  
- **Initialization**: Opens validation, position, transaction, and error report files (`1100-OPEN-FILES`).
- **Processing**: Reads validation control records, dispatches to validation routines (integrity, cross-reference, format, balance). Format checks are performed in `2400-CHECK-FORMAT`.
- **Termination**: Closes files, writes error reports.

---

#### Flowchart:  
```mermaid
flowchart TD
    Start(["Start"])
    Init["Initialization:
Open Files"]
    MainProc["Main Processing:
Read/Process Transactions
and Positions"]
    Report["Reporting/
Validation"]
    Term["Termination:
Close Files"]
    End(["End"])

    Start --> Init
    Init --> MainProc
    MainProc --> Report
    Report --> Term
    Term --> End
```

---

## 3. Proposed Changes  

### 3.1 User Story or Analysis Report Summary  
**User Story:**  
Add `CHANNEL-CODE` Field to Transaction File for Channel Identification in Batch Processing and Reporting.

**Summary:**  
A new field, `CHANNEL-CODE`, must be added to the transaction record structure to capture the channel of origin for each transaction. This change impacts the transaction copybook and all programs that read or write transaction records, requiring updates to file layouts, processing logic, and validation routines.

---

### 3.2 Proposed Code Changes Summary

#### 3.2.1 Impacted Sections and Files

- **src/copybook/common/TRNREC.cpy**  
  - *Purpose of Changes*: Add `CHANNEL-CODE` field to the transaction record structure.
  - *Impact*: All programs using this copybook will inherit the new field, requiring updates to file layouts and logic.

- **src/programs/batch/RPTPOS00.cbl**  
  - *Purpose of Changes*: Update file section and processing logic to handle the new `CHANNEL-CODE` field for reporting.
  - *Impact*: Ensures the batch report includes channel information for each transaction.

- **src/programs/utility/UTLVAL00.cbl**  
  - *Purpose of Changes*: Update file section and validation logic to recognize and validate the new `CHANNEL-CODE` field.
  - *Impact*: Ensures transaction data is validated for the presence and correctness of channel information.

---

### 3.3 Insertion Points  

- **TRNREC.cpy**:  
  - Insert `CHANNEL-CODE` field in the `TRN-DATA` group, after `TRN-CURRENCY` and before `TRN-STATUS`.
  - Update comments and field descriptions accordingly.

- **RPTPOS00.cbl**:  
  - Update `COPY TRNREC` inclusion to recognize the new field.
  - Update any logic in `2200-PROCESS-TRANSACTIONS` that reads or writes transaction records to include `CHANNEL-CODE` in reporting output.

- **UTLVAL00.cbl**:  
  - Update `COPY TRNREC` inclusion to recognize the new field.
  - Update `2400-CHECK-FORMAT` to validate the presence and format of `CHANNEL-CODE`.

---

### 3.4 Structured Diffs  

#### 3.4.1 `src/copybook/common/TRNREC.cpy`

**Before:**
```cobol
     05  TRN-DATA.
         10  TRN-INVESTMENT-ID  PIC X(10).
         10  TRN-TYPE           PIC X(02).
             88  TRN-TYPE-BUY     VALUE 'BU'.
             88  TRN-TYPE-SELL    VALUE 'SL'.
             88  TRN-TYPE-TRANS   VALUE 'TR'.
             88  TRN-TYPE-FEE     VALUE 'FE'.
         10  TRN-QUANTITY       PIC S9(11)V9(4) COMP-3.
         10  TRN-PRICE         PIC S9(11)V9(4) COMP-3.
         10  TRN-AMOUNT        PIC S9(13)V9(2) COMP-3.
         10  TRN-CURRENCY      PIC X(03).
         10  TRN-STATUS        PIC X(01).
             88  TRN-STATUS-PEND   VALUE 'P'.
             88  TRN-STATUS-DONE   VALUE 'D'.
             88  TRN-STATUS-FAIL   VALUE 'F'.
             88  TRN-STATUS-REV    VALUE 'R'.
```

**After:**
```cobol
     05  TRN-DATA.
         10  TRN-INVESTMENT-ID  PIC X(10).
         10  TRN-TYPE           PIC X(02).
             88  TRN-TYPE-BUY     VALUE 'BU'.
             88  TRN-TYPE-SELL    VALUE 'SL'.
             88  TRN-TYPE-TRANS   VALUE 'TR'.
             88  TRN-TYPE-FEE     VALUE 'FE'.
         10  TRN-QUANTITY       PIC S9(11)V9(4) COMP-3.
         10  TRN-PRICE         PIC S9(11)V9(4) COMP-3.
         10  TRN-AMOUNT        PIC S9(13)V9(2) COMP-3.
         10  TRN-CURRENCY      PIC X(03).
         10  TRN-CHANNEL-CODE  PIC X(04).
         10  TRN-STATUS        PIC X(01).
             88  TRN-STATUS-PEND   VALUE 'P'.
             88  TRN-STATUS-DONE   VALUE 'D'.
             88  TRN-STATUS-FAIL   VALUE 'F'.
             88  TRN-STATUS-REV    VALUE 'R'.
```
*Field Descriptions section should also be updated:*
```cobol
* TRN-CHANNEL-CODE : CHANNEL IDENTIFIER (e.g., BRCH, MOBL, WEB, IVR)
```

---

#### 3.4.2 `src/programs/batch/RPTPOS00.cbl`

**Before (Excerpt from 2200-PROCESS-TRANSACTIONS):**
```cobol
2200-PROCESS-TRANSACTIONS.
    PERFORM 2210-READ-TRANSACTIONS
    PERFORM 2220-SUMMARIZE-ACTIVITY.
```
*(Assume transaction reporting logic does not reference CHANNEL-CODE)*

**After:**
```cobol
2200-PROCESS-TRANSACTIONS.
    PERFORM 2210-READ-TRANSACTIONS
    PERFORM 2220-SUMMARIZE-ACTIVITY
    PERFORM 2230-REPORT-CHANNEL-ACTIVITY.

2230-REPORT-CHANNEL-ACTIVITY.
    * New logic to summarize/report by TRN-CHANNEL-CODE
    MOVE TRN-CHANNEL-CODE TO WS-CHANNEL-CODE
    * Add logic to aggregate or display channel information as required
    DISPLAY 'CHANNEL: ' WS-CHANNEL-CODE
    * (Further reporting logic as per requirements)
```
*Also ensure that the `COPY TRNREC.` statement in the FILE SECTION now includes the new field.*

---

#### 3.4.3 `src/programs/utility/UTLVAL00.cbl`

**Before (Excerpt from 2400-CHECK-FORMAT):**
```cobol
2400-CHECK-FORMAT.
    PERFORM 2410-CHECK-POSITION-FORMAT
    PERFORM 2420-CHECK-TRANSACTION-FORMAT.
```
*(Assume 2420-CHECK-TRANSACTION-FORMAT does not validate CHANNEL-CODE)*

**After:**
```cobol
2400-CHECK-FORMAT.
    PERFORM 2410-CHECK-POSITION-FORMAT
    PERFORM 2420-CHECK-TRANSACTION-FORMAT.

2420-CHECK-TRANSACTION-FORMAT.
    * Existing format checks...
    IF TRN-CHANNEL-CODE = SPACES OR TRN-CHANNEL-CODE = LOW-VALUES
        MOVE 'MISSING CHANNEL-CODE' TO WS-ERROR-MESSAGE
        PERFORM 9999-ERROR-HANDLER
    END-IF
    IF TRN-CHANNEL-CODE NOT IN ('BRCH' 'MOBL' 'WEB' 'IVR')
        MOVE 'INVALID CHANNEL-CODE' TO WS-ERROR-MESSAGE
        PERFORM 9999-ERROR-HANDLER
    END-IF
    * (Continue with other format checks)
```
*Also ensure that the `COPY TRNREC.` statement in the FILE SECTION now includes the new field.*

---

## 4. Conclusion  
The addition of the `CHANNEL-CODE` field to the transaction record structure enables the identification of transaction origin channels, supporting enhanced batch processing, reporting, and data validation. The changes are centralized in the transaction copybook and propagate to all dependent programs, ensuring consistency and maintainability. All impacted programs have been updated to recognize, process, and validate the new field, with clear insertion points and structured diffs provided for seamless integration and review.
